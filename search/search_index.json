{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"2025/02/20/an-interesting-m365-billing-scam/","title":"An Interesting M365 Billing Scam","text":""},{"location":"2025/09/02/entra-useless-insights-report/","title":"Entra Useless Insights Report","text":"<p>Yes. The name is snarky on purpose.</p> <p>With the drive to using phishing-resistant MFA something on the mind of many organizations, I\u2019ve been taking a look at the Usage &amp; Insights Report features in Entra, specifically the Authentication methods activity report.</p> <p>Enumerating the type of authentication methods registered on a user, on a per-user basis, can be time consuming, and would become untenable in extremely large organizations.</p> <p>Authentication methods activity reporting to the rescue \u2013 right? Not so much.</p> <p>In digging into the report, whether it\u2019s through the Entra admin center or through Microsoft Graph PowerShell SDK, the data reported through this is just astoundingly awful if you want to try and build some basic measurements around who is actually registered for passkeys (FIDO2); I haven\u2019t looked to see if it\u2019s as awful with other methods.</p> <p>Luckily in the tenant I\u2019m examining, there are only a few hundred user objects, so it\u2019s also feasible to enumerate each user the long way, which I\u2019ll cover below as the workaround. I\u2019ve posed a complaint to Microsoft in some channels and have yet to hear anything back, other than similar experiences from a few others.</p>"},{"location":"2025/09/02/entra-useless-insights-report/#the-problem","title":"The Problem","text":"<p>I\u2019m focused on finding users registered for passkeys in Entra, and by passkeys I mean using the Microsoft Authenticator App on either Android or iOS devices.</p> <p>The behavior I\u2019m seeing has been problematic over the last month, but I suspect the report has been broken for quite some time.</p> <p>In this instance, I go into the Usage &amp; Insights reports, Authentication methods, and filter by Method: Passkey (Microsoft Authenticator), and I see the following:</p> <p></p> <p>But based on what I know, that seems way off, so I decide to run a Graph PowerShell SDK command and get the same results:</p> <pre><code>(Get-MgReportAuthenticationMethodUserRegistrationDetail `\n -Filter \"methodsRegistered/any(x:x eq 'passKeyDeviceBoundAuthenticator')\" `\n | Select-Object -Property UserPrincipalName).count\n54\n</code></pre> <p>Note that in Graph passkeyDeviceBoundAuthenticator is what differentiates this from just passkeyDeviceBound, which would include FIDO2 security keys.</p> <p>Back to the point, this number is low, and it\u2019s been historically low. One thing that I find interesting, and while I\u2019m redacting the actual data, is when I run:</p> <pre><code>Get-MgReportAuthenticationMethodUserRegistrationDetail `\n -Filter \"methodsRegistered/any(x:x eq 'passKeyDeviceBoundAuthenticator')\"\n</code></pre> <p>and examine the LastUpdatedDateTime value, for most of the users it\u2019s showing a date that is about a week old. I know that Usage &amp; Insights reports are not real-time; trying to think back to my Microsoft days, in my head the delay I thought was roughly two hours. But there are other issues \u2013 a user who has registered for a passkey back in Feburary 2025 is missing from the report. If the report never does anything to reconcile itself, it\u2019s of zero value.</p> <p>To spot check this user I run:</p> <p><pre><code>Get-MgReportAuthenticationMethodUserRegistrationDetail `\n -Filter \"methodsRegistered/any(x:x eq 'passKeyDeviceBoundAuthenticator')\" `\n | Select-Object -Property UserPrincipalName,LastUpdatedDateTime `\n | Where-Object {$_.UserPrincipalName -eq \"user@domain.com\"}\n</code></pre> And receive nothing back.</p> <p>I went to check the Microsoft docs here, Usage and insights report \u2013 Microsoft Entra ID | Microsoft Learn, to see if there is any details around the frequency this runs or known issues, but found nothing.</p>"},{"location":"2025/09/02/entra-useless-insights-report/#the-workaround","title":"The Workaround","text":"<p>So, it\u2019s back to doing essentially what the report should do, which is enumerate all users within Entra.</p> <p>Of course, Microsoft specifically recommends that you don\u2019t do this in the docs, Microsoft Entra authentication methods API overview \u2013 Microsoft Graph v1.0 | Microsoft Learn, where they state:</p> <p>We don\u2019t recommend using the authentication methods APIs for scenarios where you need to iterate over your entire user population for auditing or security check purposes. For these types of scenarios, we recommend using the authentication method registration and usage reporting APIs (available on the beta endpoint only).</p> <p>registration and usage reporting APIs (available on the beta endpoint only).</p> <p>The code I slapped together is a mix of my brain and some vibe coding, it ended up looking like the following, with a bit of parralel processing thrown in:</p> <pre><code># Authenticator App AAGUIDS\n$targetAAGUIDs = @(\n    '90a3ccdf-635c-4729-a248-9b709135078f',\n    'de1e552d-db1d-4423-a619-566b625cdc84'\n)\n\n# Grab all users\n#$AllEmployees = Get-MgBetaUser -All -Filter \"userType eq 'Member'\" -Property Id,UserPrincipalName\n\n# Run up to 10 employees in parallel\n$PasskeysRegistered =\n    $AllEmployees |\n    ForEach-Object -Parallel {\n\n        $emp = $_\n\n        $fidos = Get-MgBetaUserAuthenticationFido2Method -UserId $emp.Id -All -ErrorAction SilentlyContinue |\n                 Where-Object { $_.AaGuid -in $using:targetAAGUIDs }\n\n        foreach ($key in $fidos) {\n            [pscustomobject]@{\n                UserPrincipalName       = $emp.UserPrincipalName\n                ObjectId     = $emp.Id\n                Passkey      = $key.Model\n                RegisteredOn = $key.CreatedDateTime\n            }\n        }\n    } -ThrottleLimit 10\n\n$PasskeysRegistered\n</code></pre> <p>And then if I run a count, and ensure I\u2019m focused on unique users, since the results could have multiple entries for some users:</p> <pre><code>($PasskeysRegistered | Select-Object -Property UserPrincipalName -Unique).count\n92\n</code></pre> <p>Further, if I go search for my missing user, sure enough they are there:</p> <pre><code>$PasskeysRegistered | Where-Object {$_.UserID -eq \"user@domain.com\"}\n\nUserID              ObjectId                             Passkey                       RegisteredOn\n------              --------                             -------                       ------------\nuser@domain.com     xxxxx                                Microsoft Authenticator - iOS 2/27/2025 10:23:40 PM\n</code></pre> <p>As a side not the problem, one could theorize something was broken around that time in Entra, and hence the user somehow fell off the report. But I can actually find another user on the report who registered within twenty minutes of the missing user \ud83e\udd14.</p>"},{"location":"2025/09/02/entra-useless-insights-report/#the-takeaway","title":"The Takeaway","text":"<p>Don\u2019t trust Usage &amp; Insights reports for passkey reporting. Hopefully this post can become irrelevant down the road.</p>"},{"location":"archive/2025/","title":"2025","text":""}]}