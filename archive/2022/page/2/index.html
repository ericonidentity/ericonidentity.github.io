
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://new.ericonidentity.com/archive/2022/page/2/">
      
      
        <link rel="prev" href="../../../2023/">
      
      
        <link rel="next" href="../../../2021/">
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>2022 - Eric on Identity</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.2a3383ac.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


  
  
    
      
      
        
      
      
    
  
  
  <style>:root{.md-tag.md-tag--nfc{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22M23.958%201.98C23.895%201%2023.143.256%2022.145.197c-1.102-.066-4.668-.12-5.693-.12%201.832%201.264%202.082%203.644%202.255%208.066.101%202.62.01%2011.799.002%2012.188l-.049%202.504-9.628-9.63v-3.014l7.656%207.658c.02-1.516.04-3.492.04-5.299%200-1.76-.026-3.354-.076-4.193-.288-4.819-.737-7.077-3.253-7.962-.77-.27-1.487-.335-2.683-.351C9.728.032%202.848.037%201.854.091.8.147.09.914.042%201.9c-.048.977-.064%2019.174%200%2020.165.062.98.815%201.724%201.812%201.782%201.102.067%204.668.075%205.694.075-1.832-1.264-2.083-3.643-2.255-8.066-.1-2.62-.009-11.8%200-12.188l.047-2.504%209.629%209.63v3.013L7.312%206.152c-.02%201.514-.04%203.49-.04%205.298%200%201.76.026%203.354.077%204.192.288%204.82.736%207.077%203.252%207.962.77.271%201.487.337%202.683.352.987.012%207.868.006%208.861-.047%201.056-.056%201.765-.822%201.813-1.811.048-.976.064-19.127%200-20.118%22/%3E%3C/svg%3E');}}</style>

    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2022" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Eric on Identity" class="md-header__button md-logo" aria-label="Eric on Identity" data-md-component="logo">
      
  <img src="../../../../images/eidlogo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Eric on Identity
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2022
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Eric on Identity" class="md-nav__button md-logo" aria-label="Eric on Identity" data-md-component="logo">
      
  <img src="../../../../images/eidlogo.svg" alt="logo">

    </a>
    Eric on Identity
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Archive
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2025
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2024/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2024
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2023/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2023
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
      
    
  
  
    <li class="md-nav__item">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="../../" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    2022
    
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2021/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2021
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="2022">2022</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-03-29 00:00:00+00:00">March 29, 2022</time></li>
        
        
          
          <li class="md-meta__item">
            
              9 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="azure-ad-the-arrival-of-dynamic-administrative-units"><a class="toclink" href="../../../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/">Azure AD: The Arrival of Dynamic Administrative Units</a></h2>
<p>Administrative units. The Azure AD sort-of equivalent of organizational units (OU’s). For those less familiar, administrative units (AU’s) allow for granular assignment of RBAC roles in Azure AD.</p>
<p>Organizations initially struggled with the limited ability to delegate granular RBAC roles in Azure AD, with the directories flat structure; especially for all of us coming from an Active Directory background. When administrative units were introduced, they started to open up the door for organizations that needed to delegate access to a subset of users in an Azure AD tenant.</p>
<p>The one catch with AU’s that <strong>was</strong> a non-starter for many organizations – they weren’t dynamic. And while OU’s are not dynamic in Active Directory, it’s a different take when the tenant is usually secondary to AD being authoritative. Move a user in AD, one would hope that the location in Azure AD would follow. While there are some PowerShell scripts out there that feel very akin to those used for AD shadow groups, overall maintenance of AU’s could prove cumbersome in dynamic organizations.</p>
<p>The struggle, however, is no more – administrative units now support <strong>dynamic</strong> user and device membership!</p>
<h3 id="administrative-unite-use-cases"><a class="toclink" href="../../../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#administrative-unite-use-cases">Administrative Unite use cases</a></h3>
<p>Before exploring dynamic membership, I just wanted to touch on some of the use cases that have already existed, and many that can greatly improve with dynamic membership. This is just a mere tip of the iceberg for use cases – if you see ones that I’ve missed let me know, and I’ll gladly add it.</p>
<p>While they feel similar to OU’s, the fact that AU’s are virtual units of structure, they provide much greater flexibility than OU’s. A user can belong to several AUs, and you don’t have to worry about users being linked as child objects that are deleted if an AU is removed – everyone remembers that time that their AD backups were tested with an accidental OU deletion.</p>
<h4 id="regional-it-delegation"><a class="toclink" href="../../../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#regional-it-delegation">Regional IT delegation</a></h4>
<p>Many global organizations that operate out of a single Azure AD tenant still have localized and regional support desks. With AU’s, you can create multiple layers of support structure to provide for things like password reset and user object management, without needing to deal with the complications of trying to fit complex delegations of ACL’s onto objects the same way we would have to with Active Directory.</p>
<h4 id="state-and-local-government-agency-delegation"><a class="toclink" href="../../../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#state-and-local-government-agency-delegation">State and local government agency delegation</a></h4>
<p>Many organizations in the public sector operate out of the same Azure AD tenant to support a single O365 environment. However, many agencies still want to retain levels of autonomy over managing their user objects. Administrative units can provide for that granular level of RBAC control.</p>
<h4 id="my-staff-management"><a class="toclink" href="../../../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#my-staff-management">My Staff management</a></h4>
<p>My Staff came out to primarily help assist with managers performing basic tasks for front line workers. The goal is to bring the power to non-IT employees the ability to do things like reset passwords or manage phone numbers for MFA. My Staff is driven by administrative units, with AU’s that are built to replicate an organizational staffing structure. For more information on My Staff, take a look at the Microsoft documentation, <a href="https://docs.microsoft.com/en-us/azure/active-directory/roles/my-staff-configure">Use My Staff to delegate user management – Azure AD | Microsoft Docs</a>.</p>
<p>It takes a bit of work in Azure AD Connect, because the manager attribute is a reference attribute in Active Directory, to synchronize the manager UPN as a custom attribute (even though manager is synchronized by Azure AD Connect, it is not exposed as a dynamic attribute option). But one could configure a system where managers have control over their employees objects, and with dynamic membership, their manager changes in AD can easily follow them in My Staff.</p>
<h3 id="exploring-administrative-unit-dynamic-membership"><a class="toclink" href="../../../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#exploring-administrative-unit-dynamic-membership">Exploring Administrative Unit dynamic membership</a></h3>
<p>If you’ve used dynamic membership for groups, the logic and expressions for dynamic administrative units is the same. I won’t deep dive into all the rules available, but the options for evaluation are both flexible and immensely powerful. For more details on the rules, take a look at this Microsoft documentation, <a href="https://docs.microsoft.com/en-us/azure/active-directory/enterprise-users/groups-dynamic-membership">Rules for dynamically populated groups membership – Azure AD | Microsoft Docs</a>.</p>
<h4 id="licensing"><a class="toclink" href="../../../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#licensing">Licensing</a></h4>
<p>As with dynamic group membership, current documentation indicates that any user who is a member of an AU that is dynamically populates requires an Azure AD P1 or P2 license assigned to them. This contrasts static membership, where only those managing the AU’s require a P1 or P2 license; users can be members of the AU’s with an Azure AD free license. Dynamic device membership does not require any special license for AU’s. For more information, see the Microsoft documentation, <a href="https://docs.microsoft.com/en-us/azure/active-directory/roles/admin-units-members-dynamic#prerequisites">Manage users or devices for an administrative unit with dynamic membership rules (Preview) – Azure Active Directory | Microsoft Docs</a>.</p>
<h4 id="configuring-administrative-unit-dynamic-membership"><a class="toclink" href="../../../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#configuring-administrative-unit-dynamic-membership">Configuring Administrative Unit dynamic membership</a></h4>
<p>While the expression set is the same as dynamic groups, currently you have to adjust the administrative unit to be dynamic post-creation. Also, as we go through this, I’ll be referencing the current Microsoft documentation on dynamic membership for administrative units, which can be found here, <a href="https://docs.microsoft.com/en-us/azure/active-directory/roles/admin-units-members-dynamic">Manage users or devices for an administrative unit with dynamic membership rules (Preview) – Azure Active Directory | Microsoft Docs</a>.</p>
<p>First we create a new administrative unit:</p>
<p><img alt="Figure 1" src="/images/2022/03/29/img1.png" /></p>
<p>And after creation of the AU, we can go look at the Properties for it. Within here we will find <strong>Membership type</strong>, which we can drop down and select <strong>Dynamic User</strong>:</p>
<p><img alt="Figure 2" src="/images/2022/03/29/img2.png" /></p>
<p>After setting the <strong>Membership type</strong> to <strong>Dynamic User</strong>, we will need to <strong>Add dynamic query</strong> before we can save the changes. The dynamic query is the secret sauce to what makes the dynamic AU, dynamic. Note that until we set this query, we cannot save these changes; the save is grayed out.</p>
<p><img alt="Figure 3" src="/images/2022/03/29/img3.png" /></p>
<p>In our example here, we are going to use a rule for physicalDeliveryOfficeName equals Schenectady:</p>
<p><img alt="Figure 4" src="/images/2022/03/29/img4.png" /></p>
<p>We save the rule, and now the Save button will be available on the administrative unit properties. Before saving, we will be presented with a warning:</p>
<p><em>After changing the administrative unit type, the existing membership may change based on the dynamic membership rules you provide. Click Yes to continue.</em></p>
<p><img alt="Figure 5" src="/images/2022/03/29/img5.png" /></p>
<p>The warning here will show up, regardless of whether it’s a new, unpopulated AU, or if it’s an existing AU with thousands of users within it.</p>
<p>After a few minutes of churning, the AU will be populated:</p>
<p><img alt="Figure 6" src="/images/2022/03/29/img6.png" /></p>
<h4 id="converting-an-administrative-unit-to-dynamic"><a class="toclink" href="../../../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#converting-an-administrative-unit-to-dynamic">Converting an Administrative Unit to dynamic</a></h4>
<p>During testing of conversion of an assigned AU to dynamic, I was curious to see how it operated. Does it wipe out all membership and start from scratch, or does Azure AD evaluate the users within the AU to determine who still belongs? Luckily, it appears to be the latter.</p>
<p>Checking my Azure AD Audit logs, we can see users who no longer belong in a specific administrative unit being removed:</p>
<p><img alt="Figure 7" src="/images/2022/03/29/img7.png" /></p>
<p>Note that if you are going the other direction, from dynamic membership to assigned, Azure AD will indicate that the existing users in the AU will be retained, but will not be dynamically processed anymore.</p>
<h4 id="exploring-with-powershell"><a class="toclink" href="../../../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#exploring-with-powershell">Exploring with PowerShell</a></h4>
<p>As with most things Azure AD, anything that can be done in the portal can be done with PowerShell (which really is just indirect Graph) and Graph.</p>
<p>I’ve been making a concerted effort to use the Microsoft Graph PowerShell SDK, <a href="https://docs.microsoft.com/en-us/graph/powershell/installation">Install the Microsoft Graph PowerShell SDK – Microsoft Graph | Microsoft Docs</a>, over the Azure Active Directory PowerShell for Graph modules. Why? The PowerShell SDK supports PowerShell 7, is cross-platform, and provides access to all of Graph, not just Azure AD.</p>
<p>That being said, I’ve found the PowerShell SDK modules for dynamic administrative units to be, well, rather lacking. While there are indirect parameters to provide dynamic information, I haven’t spent the cycles yet figuring things out. The docs/get-help provide almost no information on commands like <strong>New-MGAdministrativeUnit</strong></p>
<p><img alt="Figure 8" src="/images/2022/03/29/img8.png" /></p>
<p><em>The (lacking) documentation</em></p>
<p>As such, for the purpose of getting this post published, I’ll be using the Azure AD PowerShell modules.</p>
<p>First, let’s take a look at the administrative unit named ATZ:</p>
<div class="highlight"><pre><span></span><code>Get-AzureADMSAdministrativeUnit -Filter &quot;DisplayName eq &#39;ATZ&#39;&quot; | fl
</code></pre></div>
<p><img alt="Figure 9" src="/images/2022/03/29/img9.png" /></p>
<p>We can see that the membership type is dynamic, and also see the membership rule. In this case, we are using the in rule to allow for matching the country attribute against a defined list.</p>
<p>And if we then enumerate the membership of the AU, we can see that the logic works:</p>
<div class="highlight"><pre><span></span><code>Get-AzureADAdministrativeUnitMember -ObjectId a5175ada-f6f1-4c72-a986-65c65f662bde `
| Get-AzureADUser | ft ObjectId,UserPrincipalName,Country
</code></pre></div>
<p><img alt="Figure 10" src="/images/2022/03/29/img10.png" /></p>
<p>We can also create an administrative unit rather easily with PowerShell, which has an advantage, at least currently over the portal, in that we can define the dynamic rules upon creation.</p>
<div class="highlight"><pre><span></span><code>New-AzureADMSAdministrativeUnit -DisplayName &quot;US&quot; -Description &quot;US Employees&quot; `
-MembershipType &quot;Dynamic&quot; -MembershipRuleProcessingState &quot;On&quot; -MembershipRule `
&#39;(user.country -eq &quot;United States&quot;)&#39;
</code></pre></div>
<p><img alt="Figure 11" src="/images/2022/03/29/img11.png" /></p>
<h3 id="faq"><a class="toclink" href="../../../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#faq">FAQ</a></h3>
<h4 id="limitations"><a class="toclink" href="../../../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#limitations">Limitations</a></h4>
<p>Microsoft does not publish a size limitation for administrative units, but the standard limitations for administrative units still exist with resources being members of no more than 30 administrative units, and an organization can have a maximum of 5,000 dynamic groups and dynamic administrative units combined. The latter bit is an interesting item to note, as it would seem the evaluation engine is then shared in a tenant between dynamic groups and administrative units (which makes sense really).</p>
<p>I would also then speculate, while I cannot find it published yet, that administrative units may fall into the same rule evaluation service level, which is up to 24 hours, per this document, <a href="https://docs.microsoft.com/en-us/azure/active-directory/enterprise-users/groups-troubleshooting#troubleshooting-dynamic-memberships-for-groups">Fix problems with dynamic group memberships – Azure AD | Microsoft Docs</a>.</p>
<h4 id="how-can-i-test-preview-a-dynamic-membership-rule"><a class="toclink" href="../../../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#how-can-i-test-preview-a-dynamic-membership-rule">How can I test / preview a dynamic membership rule?</a></h4>
<p>Currently, the dynamic membership rule settings in an administrative unit does not have a rule validation option available. However, we can simply create a test dynamic group in Azure AD for evaluating the rule, and can also use the Validate Rules option to get a more instant verification of whether our rule works.</p>
<p><img alt="Figure 12" src="/images/2022/03/29/img12.png" /></p>
<p><em>An example of rule validation in dynamic groups</em></p>
<h4 id="can-i-combine-different-object-types-in-a-dynamic-administrative-unit"><a class="toclink" href="../../../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#can-i-combine-different-object-types-in-a-dynamic-administrative-unit">Can I combine different object types in a dynamic Administrative Unit?</a></h4>
<p>Unfortunately this is one trade-off between statically assigned groups and dynamic ones. Whereas in static groups we can assign users, groups and devices to the same AU, for dynamic membership you are limited to the type of dynamic object assignment you are looking to use – either user or device. Also, groups are not an option for dynamic administrative unit rules, and can belong to neither dynamic user or dynamic device AU’s.</p>
<h3 id="final-notes"><a class="toclink" href="../../../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#final-notes">Final notes</a></h3>
<p>Dynamic groups are already such a powerful option for organizations, it’s great to see that same logic added into administrative units, an area where it fits so well. If I had the time I would reach out to all those customers who had the “this is great, but it’s too inflexible” mindset upon seeing administrative units. I’m curious to see what new doors this opens for organizations; if you have some interesting use cases, give me a shout.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-03-23 00:00:00+00:00">March 23, 2022</time></li>
        
        
          
          <li class="md-meta__item">
            
              8 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="windows-hello-for-business-hybrid-cloud-trust"><a class="toclink" href="../../../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/">Windows Hello for Business: Hybrid Cloud Trust</a></h2>
<p>When we talk about Windows Hello for Business (WHfB) rollout scenarios, the one that has consistently been the preferred path is Hybrid Key Trust. It is the lowest weight scenario for deployment requirements, and if you already had Active Directory Certificate Services (AD CS), it was only a matter of a few hours to configure your directory to be ready to start a rollout.</p>
<p>While there are some smaller niche limitations, the most common limitation that <strong>every</strong> organization will encounter with Hybrid Key Trust, is that initial Windows of needing to wait for Azure AD Connect to synchronize the <strong>msDS-KeyCredentialLink</strong> attribute from Azure AD to the user object in Active Directory.</p>
<p>This process is what informs Active Directory of the public side of the users WHfB key pair, and is what enables the user for certificate-based authentication, through WHfB, to AD. Historically this leaves many organizations needing to communicate to users that it will “take some time” between when they enroll and when they can first start using WHfB – not the greatest way to introduce users into a passwordless experience.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>I’ve received feedback from readers who have gone through this post, and following up with me that for their users who were already enrolled in Windows Hello for Business with Hybrid Key Trust are having issues with authentication when switching to Hybrid Cloud Trust.</p>
<p>From my own conversations with folks at Microsoft, the path explained in this document is how an organization would go about switching existing Hybrid Key Trust users to Hybrid Cloud Trust.</p>
</div>
<h3 id="enter-hybrid-cloud-trust"><a class="toclink" href="../../../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#enter-hybrid-cloud-trust">Enter Hybrid Cloud Trust</a></h3>
<p>The technology behind WHfB Hybrid Cloud Trust has existed for a while; it’s the same mechanism that has been used to support hybrid FIDO2 Security Key authentication.</p>
<p>Microsoft already has some very good documentation, <a href="https://docs.microsoft.com/en-us/azure/active-directory/authentication/howto-authentication-passwordless-security-key-on-premises#use-sso-to-sign-in-to-on-premises-resources-by-using-fido2-keys">Passwordless security key sign-in to on-premises resources – Azure Active Directory | Microsoft Docs</a>, that explains how the whole process works, so I won’t dive deep into paraphrasing things. But essentially we now are able to obtain a partial TGT from Azure AD, and subsequently exchange that for a full TGT in AD. Because of this key piece, we <strong>no longer</strong> need to wait for Azure AD Connect to inform AD of our users public key.</p>
<h3 id="why-should-i-convert"><a class="toclink" href="../../../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#why-should-i-convert">Why should I convert?</a></h3>
<p>If you’re asking yourself why you would want to convert from a Hybrid Key Trust to a Hybrid Cloud Trust, there are several benefits:</p>
<h4 id="goodbye-pki"><a class="toclink" href="../../../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#goodbye-pki">Goodbye PKI</a></h4>
<p>In reality, if you have a PKI in your environment, you likely are using it for several things. However, you will no longer need to maintain certificates on your Domain Controllers to be used for certificate-based authentication. That partial TGT is all you’ll need to obtain a full Kerberos TGT from Active Directory.</p>
<h4 id="no-more-enrollment-delays"><a class="toclink" href="../../../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#no-more-enrollment-delays">No more enrollment delays</a></h4>
<p>Not having to wait for the sync back to AD of msDS-KeyCredentialLink, users will be able to use their WHfB credentials <strong>immediately</strong> after enrollment.</p>
<h4 id="sets-the-stage-for-fido2-security-keys"><a class="toclink" href="../../../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#sets-the-stage-for-fido2-security-keys">Sets the stage for FIDO2 security keys</a></h4>
<p>The mechanisms to configure Hybrid Cloud Trust is the same leveraged for FIDO2 Security Key authentication in a hybrid scenario. This puts your environment in a great position to start exploring FIDO2 if you have not already.</p>
<h3 id="convert-to-hybrid-cloud-trust"><a class="toclink" href="../../../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#convert-to-hybrid-cloud-trust">Convert to Hybrid Cloud Trust</a></h3>
<h4 id="prerequisites"><a class="toclink" href="../../../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#prerequisites">Prerequisites</a></h4>
<p>You’ll need to first configure your tenant to support the ability for Azure AD to issue a Kerberos TGT for your Active Directory domain. I won’t run through the process here, but it’s straightforward, and the instructions can be found here, <a href="https://docs.microsoft.com/en-us/azure/active-directory/authentication/howto-authentication-passwordless-security-key-on-premises#install-the-azure-ad-kerberos-powershell-module">Passwordless security key sign-in to on-premises resources – Azure Active Directory | Microsoft Docs</a>.</p>
<h4 id="method-for-conversion"><a class="toclink" href="../../../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#method-for-conversion">Method for conversion</a></h4>
<p>Microsoft has documented both the mechanisms for enabling Hybrid Cloud Trust through both Intune and Group Policy; here we will be examining the GPO route. The Microsoft documentation regarding the enablement of <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/hello-for-business/hello-hybrid-cloud-trust#configure-windows-hello-for-business-policy">Hybrid Cloud Trust can be found here, Hybrid Cloud Trust Deployment (Windows Hello for Business) – Windows security | Microsoft Docs</a>.</p>
<p>Let’s take a look at our existing GPO settings, which can be found under <strong>Computer Configuration, Windows Components, Windows Hello for Business</strong>:</p>
<p><img alt="Figure 1" src="/images/2022/03/23/img1.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>While we can enable WHfB either as a Computer or User Configuration, the ability to modify the trust model only exists under the Computer Group Policy.</p>
</div>
<p>The setting we want to toggle is <strong>Use cloud trust for on-premises authentication</strong>:</p>
<p><img alt="Figure 2" src="/images/2022/03/23/img2.png" /></p>
<p>We just need to select OK to save our policy change, and let (or force) our clients pick up the changed GPO.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you do not find the option for Use cloud trust for on-premises authentication within your GPO, you likely need to update your ADMX templates to a newer version.</p>
</div>
<p>And <strong>that's it</strong>. The devices scoped to this group policy will be configured for Hybrid Cloud Trust.</p>
<h3 id="verification-transition-and-cleanup"><a class="toclink" href="../../../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#verification-transition-and-cleanup">Verification, transition, and cleanup</a></h3>
<h4 id="verification"><a class="toclink" href="../../../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#verification">Verification</a></h4>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Please note that the process explained below for verification is not a required process. This verification piece is provided to explain the steps that would invalidate any local certificates in Active Directory, to ultimately prove that Hybrid Cloud Trust is working. For migration purposes, you only need to perform the group policy change indicated above.</p>
</div>
<p>So we have our GPO updated and refreshed on our client. How can we tell that the device is in fact using Hybrid Cloud Trust and not Hybrid Key Trust?</p>
<p>After the configuration change, we can look at some Event Viewer logs. If we expand Applications and Services Logs, Microsoft, Windows, Hello for Business, Operational, we can see the following Event that shows the device configured and having obtained a Cloud TGT:</p>
<p><img alt="Figure 3" src="/images/2022/03/23/img3.png" /></p>
<p>We can further test things by deleting the msDS-KeyCredentialLink contents on the user object within Active Directory.</p>
<p>If we look at Lee Gu, we can see there is a public key on his account in AD:</p>
<p><img alt="Figure 4" src="/images/2022/03/23/img4.png" /></p>
<p>We can easily clear this, and then verify the attribute is empty:</p>
<p><img alt="Figure 5" src="/images/2022/03/23/img5.png" /></p>
<p>After another sign-on with WHfB, we can go look at our Security logs in Active Directory, and find a successful 4624:</p>
<p><img alt="Figure 6" src="/images/2022/03/23/img6.png" /></p>
<h4 id="transition"><a class="toclink" href="../../../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#transition">Transition</a></h4>
<p>Even though the transition has no visible impact on our end users, many organizations may still want to take a staged approach to transition to a Hybrid Cloud Trust. To that point, because we are altering the mechanism for authentication on a per-device level, there is <strong>nothing</strong> stopping an organization from moving to a Hybrid Cloud Trust in a staged approach.</p>
<p>Long-term, from a troubleshooting perspective, it would behoove most organizations to not draw out the transition. Conversely, if an organization has edge use cases that are only supported by a Hybrid Key Trust, those users and their devices should still be able to continue to use Hybrid Key Trust while the rest of the organization operates with Hybrid Cloud Trust.</p>
<h4 id="cleanup"><a class="toclink" href="../../../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#cleanup">Cleanup</a></h4>
<p>While in the demonstration above, we see that authentication happens without the need for the msDS-KeyCredentialLink to be populated in Active Directory, the behavior of Azure AD Connect is to still synchronize that value back ton AD, even for a Hybrid Cloud Trust. Remember – we are still performing asymmetric key-based authentication to Azure AD, so there is still a keypair that exists. The behavior change is on the client; the public key in the way it is written to Azure AD appears to have no mechanism to differentiate the type of authentication the client intends with it. Due to this, downstream, Azure AD Connect is still going to synchronize back to Active Directory the public key. I would be curious if Microsoft has intentions to modify this behavior down the road, but for the meantime, we can just ignore those attributes in AD.</p>
<p>At this point, we can also evaluate whether to roll back the certificate policies issuing certs to our DC’s for certificate-based authentication. If configured properly, this process should be no-maintenance, so it’s not a critical item, but likely should be removed to clear up any confusion down the road. Would also caution though to ensure that you do not negatively impact anything else that might be leveraging AD for certificate-based auth before backing that out of Active Directory.</p>
<h3 id="faq"><a class="toclink" href="../../../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#faq">FAQ</a></h3>
<h4 id="do-i-still-need-line-of-sight-of-active-directory-for-enrollment"><a class="toclink" href="../../../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#do-i-still-need-line-of-sight-of-active-directory-for-enrollment">Do I still need line-of-sight of Active Directory for enrollment?</a></h4>
<p>Yes. For the underlying mechanisms that configure Windows for a cached sign-on experience, line-of-sight is required for Active Directory during the first use of the WHfB credentials that were configured.</p>
<h4 id="what-identity-provider-is-authoritative-for-the-client"><a class="toclink" href="../../../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#what-identity-provider-is-authoritative-for-the-client">What Identity Provider is Authoritative for the client?</a></h4>
<p>One of the topics that almost always comes up when talking about a Hybrid device, is what Identity Provider (IdP) is authoritative for user authentication – Azure AD or Active Directory. This question arises because there is this <strong>duality</strong> of identity on the device; our user object is tied to two different identity providers. However, one of the identity providers is still considered the <strong>authoritative</strong> identity provider. The authoritative identity provider is the one that would handle things like providing account lockout for a disabled user account.</p>
<p>For Hybrid Key Trust, Active Directory was authoritative, and Azure AD was secondary – you would receive/refresh your PRT after successful authentication to AD.</p>
<p><img alt="Figure 7" src="/images/2022/03/23/img7.png" /></p>
<p>With Hybrid Cloud Trust, the model is now flipped, and Azure AD is authoritative, with AD as secondary.</p>
<p><img alt="Figure 8" src="/images/2022/03/23/img8.png" /></p>
<p>We can observe this behavior in the security events on the device. When you first sign in to the device, you will receive a 4624 user logon event with a logon type of 11, which is cached interactive. This is observed even with line-of-sight of Active Directory. Very soon after, if you have line-of-sight of Active Directory, you will see another 4624 user logon event with a type of 7, which normally indicates workstation unlock.</p>
<p>Now, during testing, you will notice that even if the user account is disabled in Azure AD and Active Directory, even with line-of-sight of both AAD and AD, local logon will still occur. However, when the user attempts to access cloud-based resources, they will receive an error in thick-client applications like Teams indicating they need to sign in (which will fail), and through the web, they will be informed their account is locked out. For AD resources, access will also be denied, and in the security event log, we will find a failed sign-on event, with a failure indicating the account is currently disabled.</p>
<h3 id="final-notes"><a class="toclink" href="../../../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#final-notes">Final notes</a></h3>
<p>If you’ve happened to read this whole post and your organization is not using WHfB yet, now is a great time to strengthen the security posture of your organization, and to start examining what it takes to go passwordless.</p>
<p>If you’ve rolled out Windows Hello for Business, and want to take a look at what the next steps are to eliminating the use of passwords for those passwordless people, take a look at my post on SCRIL, <a href="https://ericonidentity.com/2021/12/13/living-in-a-passwordless-world-hybrid-identity-and-password-management/">Living in a Passwordless World: Password Management – Eric on Identity</a>.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-02-22 00:00:00+00:00">February 22, 2022</time></li>
        
        
          
          <li class="md-meta__item">
            
              8 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="azure-ad-increasing-security-within-the-mfa-experience"><a class="toclink" href="../../../../2022/02/22/azure-ad-increasing-security-within-the-mfa-experience/">Azure AD: Increasing Security Within The MFA Experience</a></h2>
<p>MFA push notifications – one of the more polarizing MFA options available within Azure AD. From a usability perspective, the perception is that it’s less interruptive and less complex for end users. From a security perspective, it’s a low barrier of entry for a malicious actor; especially when targeting a user who may approve push notifications for MFA without much thought.</p>
<p>We have seen Microsoft implement various methods of interaction into push notifications to try and combat users just hitting Approve without a second thought. The Authenticator App for passwordless, sometimes referred to as phone sign-in, already has number matching implemented. But this never made it into our more common corporate MFA scenarios – until recently when additional options for the Authenticator App showed up in Public Preview.</p>
<p>After reviewing the details within enabling of number matching and additional context, the effort is a handful of minutes of work – organizations can categorize this one under the ‘low effort/high return’ security bucket.</p>
<p><img alt="Figure 1" src="/images/2022/02/22/img1.png" /> <img alt="Figure 2" src="/images/2022/02/22/img2.png" /></p>
<p><em>Before and after</em></p>
<h3 id="number-matching"><a class="toclink" href="../../../../2022/02/22/azure-ad-increasing-security-within-the-mfa-experience/#number-matching">Number matching</a></h3>
<p>Number matching is the component that creates a stronger second factor for our end users, because they will no longer be able to just hit Approve to that push notification. According to the <a href="https://docs.microsoft.com/en-us/azure/active-directory/authentication/how-to-mfa-number-match">Microsoft Docs article</a>, once number matching goes GA, it will be enabled within all tenants a few months after. It’s tough to tell at this point whether customers will then have the option to retroactively disable number matching, but the interface makes it seem like it could be possible – not that it would be recommended.</p>
<p><img alt="Figure 3" src="/images/2022/02/22/img3.png" /></p>
<p><em>Number matching dialogue after primary authentication</em></p>
<p>Per Microsoft number matching will support the following scenarios:</p>
<ul>
<li>Multi-factor</li>
<li>Self-service password reset</li>
<li>Combined SSPR and MFA registration</li>
<li>AD FS adapter</li>
<li>NPS extension</li>
</ul>
<p>Probably should place an asterisk on the NPS extension, because unless you are using PAP as your RADIUS protocol, push notifications will “downgrade” to an Approve/Deny without number matching (there is no ability to interact with EAP/MS-CHAPv2).</p>
<h4 id="enabling-number-matching"><a class="toclink" href="../../../../2022/02/22/azure-ad-increasing-security-within-the-mfa-experience/#enabling-number-matching">Enabling number matching</a></h4>
<p>Again, will speculate that the long term goal is that number matching will be enabled by default in all tenants, and it’s going to become the new normal for our end users. But with this in Public Preview at the moment, it’s something we have to opt into.</p>
<p>Also, we have the choice of either enabling number matching for the entire organization or for a group of users; the latter allowing for more finesse in testing, piloting, staged rollouts, and the such.</p>
<p>Referencing the docs article linked above, it’s a relatively straightforward process. The article itself actually comes across at first as if you <strong>have</strong> to use Graph for updating/creating the policy; when you scroll down within it, you’ll see that it can also be performed through the portal. We’ll run through here looking at the options through Graph and seeing how they impact what the portal looks like.</p>
<p>Before jumping into things, I will note that the changes were relatively quick to notice within my test tenant – within a few minutes the changes were apparent to my test users. Likewise with testing of disabling the settings.</p>
<h5 id="gathering-the-current-state"><a class="toclink" href="../../../../2022/02/22/azure-ad-increasing-security-within-the-mfa-experience/#gathering-the-current-state">Gathering the current state</a></h5>
<p>Before making any changes, let’s check out the current state of our policy.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In order to perform the actions within Graph Explorer, you will want to sign-in, and make sure that you consent to <strong>Policy.Read.All</strong> and <strong>Policy.ReadWrite.AuthenticationMethod</strong> permissions.</p>
</div>
<p>We can do this by running the following query in Graph Explorer:</p>
<div class="highlight"><pre><span></span><code>GET https://graph.microsoft.com/beta/authenticationMethodsPolicy/authenticationMethodConfigurations/MicrosoftAuthenticator
</code></pre></div>
<p>Which in our current tenant returns the following:</p>
<div class="highlight"><pre><span></span><code>{
    &quot;@odata.context&quot;: &quot;https://graph.microsoft.com/beta/$metadata#authenticationMethodConfigurations/$entity&quot;,
    &quot;@odata.type&quot;: &quot;#microsoft.graph.microsoftAuthenticatorAuthenticationMethodConfiguration&quot;,
    &quot;id&quot;: &quot;MicrosoftAuthenticator&quot;,
    &quot;state&quot;: &quot;enabled&quot;,
    &quot;includeTargets@odata.context&quot;: &quot;https://graph.microsoft.com/beta/$metadata#authenticationMethodsPolicy/authenticationMethodConfigurations(&#39;MicrosoftAuthenticator&#39;)/microsoft.graph.microsoftAuthenticatorAuthenticationMethodConfiguration/includeTargets&quot;,
    &quot;includeTargets&quot;: [
        {
            &quot;targetType&quot;: &quot;group&quot;,
            &quot;id&quot;: &quot;all_users&quot;,
            &quot;isRegistrationRequired&quot;: false,
            &quot;authenticationMode&quot;: &quot;any&quot;,
            &quot;outlookMobileAllowedState&quot;: &quot;default&quot;,
            &quot;displayAppInformationRequiredState&quot;: &quot;default&quot;,
            &quot;numberMatchingRequiredState&quot;: &quot;default&quot;
        }
    ]
}
</code></pre></div>
<p>When we look in the portal we see the following:</p>
<p><img alt="Figure 4" src="/images/2022/02/22/img4.png" /></p>
<p>It’s important to note that <strong>default = Microsoft managed</strong>. And you may be asking what exactly is Microsoft managed? Microsoft managed effectively is the setting that allows Microsoft to make a decision whether these settings should be enabled in your tenant. Back to the thought earlier, eventually Microsoft managed will likely be the way in which Microsoft makes the decision to enable things in your tenant once it’s GA.</p>
<h5 id="enabling-for-a-group"><a class="toclink" href="../../../../2022/02/22/azure-ad-increasing-security-within-the-mfa-experience/#enabling-for-a-group">Enabling for a group</a></h5>
<p>If you are looking to enable this for a single group, it’s just a matter of updating the returned content from our Graph query, and running a PATCH. We simply will replace the <strong>all_users</strong> portion of the policy with the Azure AD groups ObjectID, and update <strong>numberMatchingRequiredState</strong> with <strong>enabled</strong>.</p>
<div class="highlight"><pre><span></span><code>PATCH https://graph.microsoft.com/beta/authenticationMethodsPolicy/authenticationMethodConfigurations/MicrosoftAuthenticator

{
    &quot;@odata.context&quot;: &quot;https://graph.microsoft.com/beta/$metadata#authenticationMethodConfigurations/$entity&quot;,
    &quot;@odata.type&quot;: &quot;#microsoft.graph.microsoftAuthenticatorAuthenticationMethodConfiguration&quot;,
    &quot;id&quot;: &quot;MicrosoftAuthenticator&quot;,
    &quot;state&quot;: &quot;enabled&quot;,
    &quot;includeTargets@odata.context&quot;: &quot;https://graph.microsoft.com/beta/$metadata#authenticationMethodsPolicy/authenticationMethodConfigurations(&#39;MicrosoftAuthenticator&#39;)/microsoft.graph.microsoftAuthenticatorAuthenticationMethodConfiguration/includeTargets&quot;,
    &quot;includeTargets&quot;: [
        {
            &quot;targetType&quot;: &quot;group&quot;,
            &quot;id&quot;: &quot;e39dfee7-4551-4836-adbb-859953e2cba6&quot;,
            &quot;isRegistrationRequired&quot;: false,
            &quot;authenticationMode&quot;: &quot;any&quot;,
            &quot;outlookMobileAllowedState&quot;: &quot;default&quot;,
            &quot;displayAppInformationRequiredState&quot;: &quot;default&quot;,
            &quot;numberMatchingRequiredState&quot;: &quot;enabled&quot;
        }
    ]
}
</code></pre></div>
<p>As long as we get a 204 response, everything was successful. Looking in the portal again, after a refresh we will see:</p>
<p><img alt="Figure 5" src="/images/2022/02/22/img5.png" /></p>
<p>If you’re using the Authenticator App for passwordless (phone sign-in), this is where it can become confusing. If you had previously targeted all users for allowing passwordless through the Authenticator App, and now you’ve added this group, you’ll notice the targeting has changed. Subsequently, if you have users go to enroll for passwordless through the Authenticator App, they will see:</p>
<p><img alt="Figure 6" src="/images/2022/02/22/img6.png" /></p>
<p>We will want to make sure that we are now targeting two groups – a group that will allow for passwordless through Authenticator App, and the second being used for number matching. In our tenant this looks like:</p>
<div class="highlight"><pre><span></span><code>PATCH https://graph.microsoft.com/beta/authenticationMethodsPolicy/authenticationMethodConfigurations/MicrosoftAuthenticator

{
    &quot;@odata.context&quot;: &quot;https://graph.microsoft.com/beta/$metadata#authenticationMethodConfigurations/$entity&quot;,
    &quot;@odata.type&quot;: &quot;#microsoft.graph.microsoftAuthenticatorAuthenticationMethodConfiguration&quot;,
    &quot;id&quot;: &quot;MicrosoftAuthenticator&quot;,
    &quot;state&quot;: &quot;enabled&quot;,
    &quot;includeTargets@odata.context&quot;: &quot;https://graph.microsoft.com/beta/$metadata#authenticationMethodsPolicy/authenticationMethodConfigurations(&#39;MicrosoftAuthenticator&#39;)/microsoft.graph.microsoftAuthenticatorAuthenticationMethodConfiguration/includeTargets&quot;,
    &quot;includeTargets&quot;: [
        {
            &quot;targetType&quot;: &quot;group&quot;,
            &quot;id&quot;: &quot;e39dfee7-4551-4836-adbb-859953e2cba6&quot;,
            &quot;isRegistrationRequired&quot;: false,
            &quot;authenticationMode&quot;: &quot;any&quot;,
            &quot;outlookMobileAllowedState&quot;: &quot;default&quot;,
            &quot;displayAppInformationRequiredState&quot;: &quot;default&quot;,
            &quot;numberMatchingRequiredState&quot;: &quot;enabled&quot;
        },
        {
            &quot;targetType&quot;: &quot;group&quot;,
            &quot;id&quot;: &quot;44a9449d-ae6e-4d0b-bd40-c599dcb07441&quot;,
            &quot;isRegistrationRequired&quot;: false,
            &quot;authenticationMode&quot;: &quot;any&quot;,
            &quot;outlookMobileAllowedState&quot;: &quot;default&quot;,
            &quot;displayAppInformationRequiredState&quot;: &quot;default&quot;,
            &quot;numberMatchingRequiredState&quot;: &quot;default&quot;
        }
    ]
}
</code></pre></div>
<p>And if we look in the portal we will see:</p>
<p><img alt="Figure 7" src="/images/2022/02/22/img7.png" /></p>
<p>In this instance, <strong>Security Ring 0</strong> is the group with number matching <strong>enabled</strong>, and <strong>Security Ring 1</strong> is the group with number matching left to <strong>default (Microsoft managed)</strong>.</p>
<p>A few items to note:</p>
<ul>
<li>You cannot enable number matching on more than one group, if you attempt to do so through Graph you’ll receive a 400 error, and within the portal the option is grayed out.</li>
<li>You cannot enable number matching on a group and also reference the all_users context. One may wish that you could target all users and then just selectively enable number matching on the group, however, if you attempt to reference all_users and a group within the policy, you’ll receive a 400 error.</li>
</ul>
<h5 id="enabling-for-all-users"><a class="toclink" href="../../../../2022/02/22/azure-ad-increasing-security-within-the-mfa-experience/#enabling-for-all-users">Enabling for all users</a></h5>
<p>The enablement for all users is even simpler. Same PATCH process, but instead we just leave the group set to <strong>all_users</strong>, and change <strong>numberMatchingRequiredState</strong> to <strong>enabled</strong>.</p>
<div class="highlight"><pre><span></span><code>PATCH https://graph.microsoft.com/beta/authenticationMethodsPolicy/authenticationMethodConfigurations/MicrosoftAuthenticator

{
    &quot;@odata.context&quot;: &quot;https://graph.microsoft.com/beta/$metadata#authenticationMethodConfigurations/$entity&quot;,
    &quot;@odata.type&quot;: &quot;#microsoft.graph.microsoftAuthenticatorAuthenticationMethodConfiguration&quot;,
    &quot;id&quot;: &quot;MicrosoftAuthenticator&quot;,
    &quot;state&quot;: &quot;enabled&quot;,
    &quot;includeTargets@odata.context&quot;: &quot;https://graph.microsoft.com/beta/$metadata#authenticationMethodsPolicy/authenticationMethodConfigurations(&#39;MicrosoftAuthenticator&#39;)/microsoft.graph.microsoftAuthenticatorAuthenticationMethodConfiguration/includeTargets&quot;,
    &quot;includeTargets&quot;: [
        {
            &quot;targetType&quot;: &quot;group&quot;,
            &quot;id&quot;: &quot;all_users&quot;,
            &quot;isRegistrationRequired&quot;: false,
            &quot;authenticationMode&quot;: &quot;any&quot;,
            &quot;outlookMobileAllowedState&quot;: &quot;default&quot;,
            &quot;displayAppInformationRequiredState&quot;: &quot;default&quot;,
            &quot;numberMatchingRequiredState&quot;: &quot;enabled&quot;
        }
    ]
}
</code></pre></div>
<p>Now when we go look in the portal:</p>
<p><img alt="Figure 8" src="/images/2022/02/22/img8.png" /></p>
<h4 id="disabling-number-matching"><a class="toclink" href="../../../../2022/02/22/azure-ad-increasing-security-within-the-mfa-experience/#disabling-number-matching">Disabling Number Matching</a></h4>
<p>Ideally you will not be in a position to need to disable number matching, but in the case that you need to, it’s just a matter of setting <strong>numberMatchingRequiredState</strong> to <strong>default</strong>. Again, if you set this to <strong>disabled</strong>, there may be a chance that you will be in a state where your tenant will miss when this rolls out across all tenants.</p>
<h3 id="additional-context"><a class="toclink" href="../../../../2022/02/22/azure-ad-increasing-security-within-the-mfa-experience/#additional-context">Additional context</a></h3>
<p>Along with number matching, we can enable additional contextual information about where the user is coming from with a map showing the rough geographic area, as well as what application is requesting the approval. Details of this process come from the <a href="https://docs.microsoft.com/en-us/azure/active-directory/authentication/how-to-mfa-additional-context">Microsoft Docs article</a>.</p>
<p><img alt="Figure 9" src="/images/2022/02/22/img9.png" /> <img alt="Figure 10" src="/images/2022/02/22/img10.png" /></p>
<p>While both mechanisms provide some additional security mechanisms to our end users, additional context alone is not going to prevent an unengaged user from selecting Approve, which is why additional context in itself should be considered a passive security mechanism. Number matching, to contrast, is active, because the user will not be able to perform MFA without interaction.</p>
<h4 id="enabling-additional-context"><a class="toclink" href="../../../../2022/02/22/azure-ad-increasing-security-within-the-mfa-experience/#enabling-additional-context">Enabling additional context</a></h4>
<p>To enable additional context, whether for all users, or for a group, follows the same processes as enabling number matching. The only difference is we are focusing on the property <strong>displayAppInformationRequiredState</strong>.</p>
<p>Out of the box, this property will be set to <strong>default</strong> when observing its value through Graph, or <strong>Microsoft managed</strong> in the portal. We can toggle this to <strong>enabled</strong> or <strong>disabled</strong>.</p>
<p>A few items to note specific to additional context:</p>
<ul>
<li>When enabling additional context and using the Authenticator App for passwordless (phone sign-in), the app only receives policy information every 7 days. Because of this, users may not see a behavioral change for up to 7 days after.</li>
<li>The NPS extension does not support providing additional context. Being that the NPS extension is simply signaling for MFA to be called, and primary authentication is happening against Active Directory, it makes sense that user location context is not available.</li>
</ul>
<h3 id="final-notes"><a class="toclink" href="../../../../2022/02/22/azure-ad-increasing-security-within-the-mfa-experience/#final-notes">Final notes</a></h3>
<p>As with all things that impact and change the way our users interact with our systems, while this may be an easier win from a security perspective, organizations will want to make sure that they communicate this change properly to end users. A rushed rollout or lack of communication is an almost certain way of creating friction with our end users, and potentially hurting the efforts to increase organizational security.</p>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <a class="md-pagination__link" href="../../">1</a> <span class="md-pagination__current">2</span>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../../../2023/" class="md-footer__link md-footer__link--prev" aria-label="Previous: 2023">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                2023
              </div>
            </div>
          </a>
        
        
          
          <a href="../../../2021/" class="md-footer__link md-footer__link--next" aria-label="Next: 2021">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                2021
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021 - 2025 Eric Woodruff
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.path", "navigation.top", "navigation.footer"], "search": "../../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": {"NFC": "nfc"}, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../../../../js/open_in_new_tab.js"></script>
      
    
  </body>
</html>