
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://new.ericonidentity.com/archive/2022/">
      
      
        <link rel="prev" href="../2023/">
      
      
        <link rel="next" href="../2021/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>2022 - Eric on Identity</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2a3383ac.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


  
  
    
      
      
        
      
      
    
  
  
  <style>:root{.md-tag.md-tag--nfc{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22M23.958%201.98C23.895%201%2023.143.256%2022.145.197c-1.102-.066-4.668-.12-5.693-.12%201.832%201.264%202.082%203.644%202.255%208.066.101%202.62.01%2011.799.002%2012.188l-.049%202.504-9.628-9.63v-3.014l7.656%207.658c.02-1.516.04-3.492.04-5.299%200-1.76-.026-3.354-.076-4.193-.288-4.819-.737-7.077-3.253-7.962-.77-.27-1.487-.335-2.683-.351C9.728.032%202.848.037%201.854.091.8.147.09.914.042%201.9c-.048.977-.064%2019.174%200%2020.165.062.98.815%201.724%201.812%201.782%201.102.067%204.668.075%205.694.075-1.832-1.264-2.083-3.643-2.255-8.066-.1-2.62-.009-11.8%200-12.188l.047-2.504%209.629%209.63v3.013L7.312%206.152c-.02%201.514-.04%203.49-.04%205.298%200%201.76.026%203.354.077%204.192.288%204.82.736%207.077%203.252%207.962.77.271%201.487.337%202.683.352.987.012%207.868.006%208.861-.047%201.056-.056%201.765-.822%201.813-1.811.048-.976.064-19.127%200-20.118%22/%3E%3C/svg%3E');}}</style>

    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2022" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Eric on Identity" class="md-header__button md-logo" aria-label="Eric on Identity" data-md-component="logo">
      
  <img src="../../images/eidlogo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Eric on Identity
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2022
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Eric on Identity" class="md-nav__button md-logo" aria-label="Eric on Identity" data-md-component="logo">
      
  <img src="../../images/eidlogo.svg" alt="logo">

    </a>
    Eric on Identity
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Archive
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2025
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2024/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2024
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2023/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2023
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
      
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    2022
    
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2021/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2021
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="2022">2022</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-12-19 00:00:00+00:00">December 19, 2022</time></li>
        
        
          
          <li class="md-meta__item">
            
              11 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations"><a class="toclink" href="../../2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/">SpAML: Spoofing Users In Azure AD With SAML Claims Transformations</a></h2>
<p>For those that believe SAML is dead, they should take a look at the Azure AD Application Gallery. While the authentication standard finished baking almost two decades ago, it‚Äôs still a staple for integration of applications with Azure AD. As of writing, the Azure AD App Gallery has 2015 applications available for SSO integration, and 1335 of them use SAML, roughly two-thirds. Beyond this, there are thousands of line-of-business (LOB) and other 3rd party applications that don‚Äôt exist in the gallery but leverage SAML. Many well-known applications and platforms are published in the gallery using SAML ‚Äì Salesforce, Google Workspace/Google Cloud, AWS, SAP, Oracle Cloud, ServiceNow, Workday‚Ä¶ the list goes on and on.</p>
<p>With the ease of federated identity, not only are we tying other cloud providers to Azure AD, but we are also bringing in business critical applications. With this, we need to keep in mind that threat actors are not always targeting critical IT resources; one can do plenty damage with access to records and data stored within SaaS applications.</p>
<p>Azure AD makes it easier than ever to spoof (impersonate) a user within a SAML response. This relatively easy technique allows us to impersonate a highly privileged user in the target application. At the same time, authentication behavior for all other users of the application, including the legitimate user being spoofed, will not change. If your organization leverages SCIM for user provisioning, which is the direction the industry is going, this lends in favor of spoofing going undetected, as optional attributes in the SAML response will go unused by the application.</p>
<p>Within Azure AD, you do not need to be a Global Administrator to configure an Enterprise Application. Anyone with Application Administrator, Cloud Application Administrator, or assigned Owner to a specific application can manage it. From a usability perspective, Microsoft pushes delegation of ownership to the business units. The users, however, that now can manage the application, likely fall under the bar of PIM or any privilege separation. Suffice to say, this opens our potential pool of targets in an organization; needing Global Administrator for movement into target applications is not necessary, just whoever has ownership. Likewise, it‚Äôs ripe for abuse by insider threats.</p>
<h3 id="azure-ad-saml-response-primer"><a class="toclink" href="../../2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#azure-ad-saml-response-primer">Azure AD SAML response primer</a></h3>
<p>For a full refresh on the SAML authentication flow, I‚Äôll refer to the IDPro Body of Knowledge Article, <a href="https://bok.idpro.org/article/id/79/">Cloud Service Authenticates Via Delegation ‚Äì SAML</a>. For an understanding of the spoofing technique, the SAML response, which is passed from the Identity Provider (IdP, Azure AD) to the application (SP, Service Provider) via the user, contains both required and optional claims. One of these required claims is the <strong>name identifier</strong>, referred to in the response as the <strong>NameID</strong>.</p>
<p>NameID is a unique attribute that represents the user within the application. It is what the application uses to lookup the user within its internal user database.</p>
<p>Azure AD defaults to, and it is a common pattern these days, to use the Email Address (urn:oasis:names<img alt="üáπüá®" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f1f9-1f1e8.svg" title=":tc:" />SAML:1.1:nameid-format:emailAddress) format. The default source attribute that is emitted in the SAML response is user.userprincipalname.</p>
<p>As an example, I authenticate to Azure AD as nestor.wilke@fabrikam.cloud, and subsequently when I connect to an Enterprise Application, say AWS, the SAML response contains the NameID below. On the identity layer, AWS uses this to match Nestor to his user account.</p>
<div class="highlight"><pre><span></span><code>&lt;NameID Format=&quot;urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress&quot;&gt;nestor.wilke@fabrikam.cloud&lt;/NameID&gt; 
</code></pre></div>
<p>Azure AD also provides the ability to create <strong>claim transformations</strong>. Claim transformations can be useful for several reasons. A simple example is if the application has case sensitivity requirements. One can apply a ToLowercase() and not have worry about needing to modify broader patterns in Azure AD to satisfy one application. Claims transformations are configured on a per-claim basis within each Enterprise Application that is using SAML.</p>
<h3 id="setting-the-stage"><a class="toclink" href="../../2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#setting-the-stage">Setting the stage</a></h3>
<p>An effective use of spoofing the SAML response is to impersonate a highly privileged user in an application. For our example, let‚Äôs look at a few different user personas, in a somewhat simplified scenario:</p>
<ul>
<li>Nestor Wilke is an account owner in AWS, and because this is considered a highly privileged role, he has privileged credentials he uses for accessing AWS, p-nestor.wilke@fabrikam.cloud.</li>
<li>Isaiah Langer is part of the Operations team that is tasked with providing support to Enterprise Applications, which provides rights over the AWS Enterprise Application. Groups are used for user assignment to AWS, and AWS role assignment happens in AWS IAM Identity Center. Isaiah can manage these applications with his normal user account, isaiah.langer@fabrikam.cloud. He has an account in AWS, but his privileges there are low.</li>
</ul>
<h3 id="configuring-our-malicious-transform"><a class="toclink" href="../../2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#configuring-our-malicious-transform">Configuring our malicious transform</a></h3>
<p>Once we gain access to an account with ownership over the application, we will want to jump into Azure AD, and browse to Enterprise Applications, and then open the target application.</p>
<p>Within here, we will select Single sign-on in the left blade, and then under Attributes &amp; Claims on the right blade, select Edit:</p>
<p><img alt="Figure 1" src="/images/2022/12/19/img1.png" /></p>
<p>In the new blade that opens, we want to select the Unique User Identifier (Name ID) claim:</p>
<p><img alt="Figure 2" src="/images/2022/12/19/img2.png" /></p>
<p>Note that in our example we will be using a transform on user.userprincipalname, but this same technique can apply to any attribute that is being used for NameID.</p>
<p>Within the <strong>Manage claim</strong> window, we want to select <strong>Transformation</strong> under <strong>Source</strong>. This will open a new <strong>Manage transformation</strong> blade on the right:</p>
<p><img alt="Figure 3" src="/images/2022/12/19/img3.png" /></p>
<p>For spoofing, we need to know just two things ‚Äì the UPN of the user we want to spoof, and the UPN of the user who will be used for performing the spoofing.</p>
<p>Under <strong>Transformation</strong>, select <strong>Contains()</strong>. For P<strong>arameter 1 (Input)</strong> select <strong>user.userprincipalname</strong>. For Value, we will enter <em>isaiah.langer@fabrikam.cloud</em>. For <strong>Parameter 2 (Output)</strong>, do <strong>not</strong> select an attribute from the dropdown menu. Instead, click into the window within the menu and enter <em>p-nestor.wilke@fabrikam.cloud</em>.</p>
<p><img alt="Figure 4" src="/images/2022/12/19/img4.png" /></p>
<p>We then check the box for <strong>Specify output if no match</strong>, and for <strong>Parameter 3 (Output if no match)</strong> select <strong>user.userprincipalname</strong>.</p>
<p>This last piece is what ensures that all other users accessing AWS will continue to have the same user experience, including Nestor. Our final transform will look like:</p>
<p><img alt="Figure 5" src="/images/2022/12/19/img5.png" /></p>
<p>And we can confirm the pattern in the claims rule:</p>
<div class="highlight"><pre><span></span><code>If &#39;user.userprincipalname&#39; contains &#39;isaiah.langer@fabrikam.cloud&#39; then output &#39;p-nestor.wilke@fabrikam.cloud&#39;. Else, output &#39;user.userprincipalname&#39;.
</code></pre></div>
<p>We select <strong>Add</strong>, and then <strong>Save</strong>.</p>
<h3 id="using-our-malicious-transform"><a class="toclink" href="../../2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#using-our-malicious-transform">Using our malicious transform</a></h3>
<p>Now that we have things configured, let‚Äôs look at this in action. Recall that Nestor is our target user, and Isaiah is the account that will be used for spoofing.</p>
<div class="video-wrapper">
  <iframe src="https://www.youtube-nocookie.com/embed/FHWV854iYDo"
          title="SpAML Abuse"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen"
          allowfullscreen>
  </iframe>
</div>

<p>This is just one example. This has been similarly tested and proofed with GCP and Salesforce and should be valid for any SAML application whether from the application gallery or a LOB application.</p>
<h3 id="detecting-malicious-transforms"><a class="toclink" href="../../2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#detecting-malicious-transforms">Detecting malicious transforms</a></h3>
<p>Unfortunately, the ability to detect a transform like this is difficult, as normal channels do not expose the data we expect and need.</p>
<h4 id="audit-logging-is-broken"><a class="toclink" href="../../2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#audit-logging-is-broken">Audit logging is broken</a></h4>
<p>The first thought is to go to our Azure AD audit logs. After all, the change should be recorded in Azure AD, so we can ingest that data for detection.</p>
<p>SAML claim policy auditing, is unfortunately, broken. If we look at our audit logs after Isaiah made the change, we will see the following:</p>
<p><img alt="Figure 6" src="/images/2022/12/19/img6.png" /></p>
<p>We can drill into the Target(s) and see that there was a change made to a ClaimIssuancePolicy:</p>
<p><img alt="Figure 7" src="/images/2022/12/19/img7.png" /></p>
<p>But when we look at the Modified Properties:</p>
<p><img alt="Figure 8" src="/images/2022/12/19/img8.png" /></p>
<p>Note that there is nothing of value. <strong>Any</strong> SAML claim issuance policy changes in Azure AD show up the same way. To ensure this was not some sort of limitation of the portal itself, I looked at the data exported to Log Analytics:</p>
<p><img alt="Figure 9" src="/images/2022/12/19/img9.png" /></p>
<p>I‚Äôve had a support case open with Microsoft through standard channels on this, but there has been no movement.</p>
<h4 id="graph-api-does-not-expose-saml-claim-policies"><a class="toclink" href="../../2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#graph-api-does-not-expose-saml-claim-policies">Graph API does not expose SAML claim policies</a></h4>
<p>Figure the next place we may turn would be the Microsoft Graph API, but again we are blocked here. The Graph API does not expose SAML claim issuance policies, something that can be traced back to 2019 with customers asking for it, yet still is not supported from my recent check with Microsoft.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Microsoft has claimed to resolve this by making claim transforms available through Graph API, however, it's a different set of transforms.</p>
</div>
<h4 id="what-are-we-left-with"><a class="toclink" href="../../2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#what-are-we-left-with">What are we left with?</a></h4>
<p>As Azure AD does not provide native means for easily tracking this, we can either go with something of relatively low fidelity, alerting on all changes to a ClaimIssuancePolicy, but this is also going to alert on all changes, good and bad. If there is little in the way of activity with SAML application onboarding in the environment, this may suffice.</p>
<p>From a retroactive analysis perspective, because these are not exposed through the Graph API, the only way to verify the policy settings is through manual inspection.</p>
<p>Using a SIEM platform for authentication log correlation may at first seem appealing but consider that authentication times are likely the only mechanism for correlation. If the platform has a high volume of user activity, that is going to create an immense level of complexity, as Azure AD and the application are highly likely going to be exposing the time the user authenticated into those systems, which may not align to the necessary precision.</p>
<h3 id="preventing-malicious-transforms"><a class="toclink" href="../../2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#preventing-malicious-transforms">Preventing malicious transforms</a></h3>
<p>Preventing malicious transforms becomes even more important when our ability to properly monitor for them is inhibited.</p>
<p>From a prevention perspective it‚Äôs back to the basics. The following should apply for all Global Administrators, as well as Application Administrator or Cloud Application Administrator roles if your organization heavily relies on them for management of Enterprise Applications:</p>
<ul>
<li>Privilege separated from daily driver accounts</li>
<li>Accounts should not be mail-enabled</li>
<li>Cloud-sourced and not synchronized from Active Directory</li>
<li>Azure AD PIM should be used with MFA requirement for elevation</li>
<li>Roles scoped with a Conditional Access policy requiring MFA for Azure management</li>
<li>Passwordless should be enabled and required for these accounts</li>
<li>Accounts should be scoped for Azure AD Identity Protection</li>
<li>Require a Privileged Access Workstation (PAW) for highly privileged operations</li>
</ul>
<p>If you heavily delegate the owner role for specific Enterprise Applications, you may want to re-evaluate how you are securing the users with delegated access. While it‚Äôs unlikely businesses will accept the model of privilege separation or a PAM implementation for the HR administrator team that owns Workday, it may be a place to reconsider if those delegations are necessary. If delegation primarily exists to assign membership to the application, the model could be changed to instead provide delegated ownership over the groups that are already assigned, or leverage entitlement management for application access lifecycle.</p>
<p>The surface area for abuse by a threat actor can be reduced by application conditional access requiring compliant devices for all users with proper endpoint management in place, but from the perspective of insider threat or certain token theft scenarios, this may not be sufficient.</p>
<p>Heavily restricted Conditional Access policies will not prevent user impersonation, as all CA policies are evaluated prior to the issuance of the SAML response. In our example, even if Nestor was restricted to using a PAW for accessing AWS, Isaiah would have been able to access AWS under whatever conditions CA was applying to his user account. If the application requires user assignment, or if a CA policy specifically blocked Isaiah from access, the risk is mitigated. For many business-critical applications, such as Workday, it‚Äôs highly likely that blocking scenarios cannot be applied as the application is used across the workforce. Using mechanisms such as role assignment may be circumvented with a combination of claim conditions and transforms.</p>
<p>If the target application provides mechanisms for privilege escalation management within, it may also stop the ability for impersonation, as the user would be presented to elevate privilege for the spoofed user within the target.</p>
<h3 id="responsible-disclosure"><a class="toclink" href="../../2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#responsible-disclosure">Responsible disclosure</a></h3>
<p>When I initially came up with my proof case, I opened a case with MSRC, indicating that claims transforms should not allow for a constant output for NameID, as it enables for spoofing. Even though it is not a security risk within Azure AD, as the identity provider, proper controls should exist within the IdP to ensure that associated applications are not overly exposed to a security risk such as NameID spoofing.</p>
<ul>
<li>August 30th, 2022: Opened case with MSRC</li>
<li>October 10th, 2022: Response from MSRC with case closed, ‚ÄúWe determined that this behavior is considered to be by design.‚Äù</li>
</ul>
<p>Likewise, a support case with Microsoft has been opened regarding deficiencies with SAML claim audit logging.</p>
<ul>
<li>October 20th, 2022: Opened support Sev C case with Microsoft</li>
<li>October 26th, 2022: First response from SE with inaccurate understanding of case</li>
<li>October 27th, 2022: Reply to SE with additional clarity</li>
<li>November 8th, 2022: SE calls at a random time, follows up with email that a session will be scheduled on November 14th, at 9:30am EST</li>
<li>November 14th, 2022: SE does not call at 9:30am EST</li>
<li>November 14th, 2022: SE calls at 12:30pm EST, I request a call back at 1:00pm EST, SE agrees to call back at 1:00pm EST</li>
<li>November 14th, 2022: SE does not call at 1:00pm EST</li>
<li>November 17th, 2022: SE emails and schedules a call for November 18th, 2022 at 10:00am EST</li>
<li>November 18th, 2022: SE does not call at 10:00am EST</li>
<li>November 21st, 2022: SE emails indicating that I did not answer my phone at indeterminate time. Check with phone carrier, no call was ever received.</li>
<li>November 28th, 2022: SE calls me outside of working hours.</li>
<li>November 28th, 2022: I reply to an email with times that the SE can reach me</li>
<li>December 9th, 2022: SE calls, able to finally have the screen sharing session. Walk the SE through the details I provided in my case showing the behavior of these changes not being properly audited. SE indicates that the case needs to be escalated.</li>
<li>December 14th, 2022: SE calls me to let me know the case is still being investigated.</li>
<li>January 9th, 2023: SE contacts me to let me know I need to reproduce the issue for fresh data for MS.</li>
<li>January 25th, 2023: SE emails me to let me know the case is still being investigated.</li>
<li>February 16th, 2023: SE emails me to let me know the case is still being investigated.</li>
<li>February 20th, 2023: SE contacts me to let me know I need to reproduce the issue for fresh data for MS.</li>
<li>March 15th, 2023: Case is re-assigned to an ‚ÄúAzure Support Ambassador‚Äù. It‚Äôs indicated that the case is still being investigated.</li>
<li>March 17th, 2023: I email the Support Ambassador asking if it would be possible to find out more details about the case directly from engineering.</li>
<li>March 27th, 2023: Support Ambassador emails me to let me know that a bug has been filed to be fixed at a later date.</li>
<li>March 29th, 2023: Support closes the case without asking if it‚Äôs alright to do so.</li>
</ul>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-12-02 00:00:00+00:00">December 2, 2022</time></li>
        
        
          
          <li class="md-meta__item">
            
              9 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="field-notes-migration-from-federation-to-cloud-authentication"><a class="toclink" href="../../2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/">Field Notes: Migration From Federation To Cloud Authentication</a></h2>
<p>During my stint at Microsoft, I spent a good deal of time with Windows Hello for Business (WHfB), and subsequently would be involved in prerequisite work to set the stage. For the enablement of WHfB, one of these items is device join, and it usually would be Hybrid Azure AD Join (HAADJ) for existing devices already within Active Directory. Device join can be a bit of a rabbit hole if the organization has federated authentication with AD FS in place, as there are different ways you can configure the device join process.</p>
<p>One customer I was working with decided that they wanted to use their WHfB prerequisite work as the same point to switch from federated to cloud authentication with PHS; they were already sending their passwords to Azure AD for use with Azure AD Identity Protection. I discussed high-level what was required to switch but figured the conversation would continue after lunch. Instead, the customer decided to implement the switch during lunch, and their thousand or so users were moved to cloud authentication, with relatively little planning.</p>
<p>Luckily their environment was relatively straightforward from an identity architecture perspective; I wouldn‚Äôt recommend going into the switch without more thorough planning. But the point being made here is that the actual period of cutover has a much lower actual risk than perceived risk.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Managed authentication and managed domain can be used interchangeably with cloud authentication. In most documentation Microsoft has started to prefer using cloud authentication for the umbrella term for Password Hash Sync (PHS) and Pass-through Authentication (PTA)</p>
</div>
<p>Note that this article should be considered a companion to some excellent documentation Microsoft already has published, which you can find here:</p>
<p><a href="https://learn.microsoft.com/en-us/azure/active-directory/hybrid/migrate-from-federation-to-cloud-authentication">Migrate from federation to cloud authentication in Azure Active Directory ‚Äì Microsoft Entra | Microsoft Learn</a></p>
<p><a href="https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-staged-rollout">Azure AD Connect: Cloud authentication via Staged Rollout ‚Äì Microsoft Entra | Microsoft Learn</a></p>
<h3 id="ensuring-risk-is-mitigated"><a class="toclink" href="../../2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#ensuring-risk-is-mitigated">Ensuring risk is mitigated</a></h3>
<p>Migration risk falls into three buckets: <em>pre-migration</em>, <em>during migration</em>, and <em>post migration</em>. As we dig into them, you‚Äôll note that during and post migration risks are mitigated by taking proper pre-migration actions.</p>
<h3 id="pre-migration-risk-mitigation"><a class="toclink" href="../../2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#pre-migration-risk-mitigation">Pre-migration risk mitigation</a></h3>
<h4 id="staged-rollout"><a class="toclink" href="../../2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#staged-rollout">Staged rollout</a></h4>
<p>While it was in public preview for over two years, staged rollout has been a pivotal piece in allowing organizations to mitigate migration risk in a few ways.</p>
<p>From the perspective of pre-migration, risk becomes mitigated by allowing organizations to do what everyone loves the most ‚Äì test in production. Staged rollout can start with as few users as desired, to dip your toes into the waters of what cloud authentication will look like.</p>
<p>When a user is authenticating to Azure AD, upon the initial sign-in screen where you enter your UPN, Home Realm Discovery (HRD) is performed to determine where and how to authenticate you. Essentially Azure AD analyzes the UPN entered and routes you accordingly. This is how staged rollout can make decisions on who to continue to federate for authentication, and who should be authenticated in the cloud.</p>
<p>The other key component is that staged rollout allows for the migration to happen in waves/phases/rings ‚Äì however you want to put it. It‚Äôs usually a business decision as to who gets to go when and how, and requires some planning, but with staged rollout, your users are essentially <strong>already</strong> migrated. I‚Äôve had some organizations move their <strong>entire</strong> user base to staged rollout so that it was a non-event when the actual switch from federated auth to cloud auth happened on the tenant level.</p>
<h4 id="password-expiration-policies-if-using-phs"><a class="toclink" href="../../2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#password-expiration-policies-if-using-phs">Password expiration policies (if using PHS)</a></h4>
<p>I‚Äôll stand on the side of the argument that for <em>most</em> personas, there is an overall usability benefit that also fosters better user behavior relative to risk of password phishing by not requiring password expiration in Azure AD.</p>
<p>When relying on federated authentication, whatever password policies exist in Active Directory will impact user authentication in the cloud.</p>
<p>Now, if you are choosing to go with PTA, Active Directory is still the final say on authentication, and so password policies in Azure AD for these hybrid users is not relevant. But if you are moving to PHS, you should weigh what your current password policy looks like and whether you want to continue to with password expiration with cloud authentication. If you do, you‚Äôll want to look here for details on how to ensure that users in the cloud continue to have their password expire, <a href="https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-password-hash-synchronization#password-expiration-policy">Implement password hash synchronization with Azure AD Connect sync ‚Äì Microsoft Entra | Microsoft Learn</a>.</p>
<h4 id="virtual-desktop-infrastructure-vdi"><a class="toclink" href="../../2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#virtual-desktop-infrastructure-vdi">Virtual Desktop Infrastructure (VDI)</a></h4>
<p>If your organization is running a VDI infrastructure, and you‚Äôre leveraging non-persistent virtual machines, it‚Äôs important to note that there are limitations for support with cloud authentication. More details can be found here, <a href="https://learn.microsoft.com/en-us/azure/active-directory/devices/howto-device-identity-virtual-desktop-infrastructure#supported-scenarios">Device identity and desktop virtualization ‚Äì Azure Active Directory ‚Äì Microsoft Entra | Microsoft Learn</a>.</p>
<h4 id="ad-fs-access-control-policies"><a class="toclink" href="../../2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#ad-fs-access-control-policies">AD FS Access Control policies</a></h4>
<p>While not as common due to the broad uptake of Conditional Access policies, it‚Äôs important to make sure that if you have any access control policies in AD FS 2016 or later, or any authorization rules in AD FS 2012 R2 (or earlier), that you translate those rules into CA policies.</p>
<h4 id="ad-fs-certificate-based-authentication"><a class="toclink" href="../../2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#ad-fs-certificate-based-authentication">AD FS certificate based authentication</a></h4>
<p>While too deep to cover within here, previously the lack of CBA was one of the reasons for organizations to continue to persist with AD FS. If you have CBA in place, you‚Äôll want to make sure you have your use cases documented and well tested in Azure AD; this is another great place for staged rollout.</p>
<h4 id="azure-ad-hybrid-join-service-connection-point"><a class="toclink" href="../../2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#azure-ad-hybrid-join-service-connection-point">Azure AD Hybrid Join service connection point</a></h4>
<p>Organizations that have been using HAADJ for a while and have had AD FS in play, may have configured their environment to use AD FS as the authentication service in the Service Connection Point (SCP) for hybrid join.</p>
<p>Note that the SCP is <strong>only</strong> used for provisioning of hybrid join. Once devices have their trust relationship with Azure AD, there is nothing facilitated by the SCP. Because of this, there is not an ongoing dependency on the SCP for devices already hybrid joined.</p>
<p>Downlevel devices (Windows 7/8/8.1) have dependencies for hybrid join in federated authentication on AD FS, but again this is for joining those devices, which hopefully the occurrences are low in spinning up new Windows 7 instances.</p>
<p>As far as timing goes, the SCP should be re-configured <strong>before</strong> the final migration from federated to managed authentication.</p>
<h4 id="windows-hello-for-business"><a class="toclink" href="../../2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#windows-hello-for-business">Windows Hello for Business</a></h4>
<p>Organizations that may have been earlier adopters of WHfB and rolled out Hybrid Certificate Trust, are going to find that they need to convert to a Hybrid Key Trust, or Cloud Kerberos Trust (the new name for Hybrid Cloud Trust).</p>
<p>If you currently are using Hybrid Key Trust, you don‚Äôt have change anything to prepare for the migration.</p>
<p>If you are using Hybrid Certificate Trust, you‚Äôll need to take a look at the work required for preparing users to re-enroll in Windows Hello for Business, which you can find here, <a href="https://learn.microsoft.com/en-us/windows/security/identity-protection/hello-for-business/hello-hybrid-cloud-kerberos-trust?tabs=intune#migrate-from-certificate-trust-deployment-model-to-cloud-kerberos-trust">Hybrid cloud Kerberos trust deployment (Windows Hello for Business) | Microsoft Learn</a>. Note that Microsoft never officially supported migration from Hybrid Certificate Trust to Hybrid Key Trust, but if you wanted to move to HKT, the same steps essentially can be taken, with the difference of targeting Hybrid Key Trust.</p>
<h4 id="sign-in-frequency-conditional-access-policies"><a class="toclink" href="../../2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#sign-in-frequency-conditional-access-policies">Sign-in frequency Conditional Access policies</a></h4>
<p>If you have heavily restrictive sign-in frequency policies in place and are <strong>not</strong> using staged rollout on the targeted users, it is an area where the risk will be slightly higher during migration. You may want to evaluate to whom and how you have these policies applied, and potentially temporarily disable your CA policies ahead of the migration window.</p>
<h4 id="continuous-access-evaluation"><a class="toclink" href="../../2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#continuous-access-evaluation">Continuous Access Evaluation</a></h4>
<p>Yet another feature that can be used to minimize any risk during migration, continuous access evaluation greatly extends access token lifetimes. Having long token lifetimes will reduce the likelihood of users needing to re-authenticate during the migration window itself. Note that CAE requires the application to support this, so the focus here primarily is on Exchange Online, SharePoint Online and Teams.</p>
<h4 id="federated-applications"><a class="toclink" href="../../2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#federated-applications">Federated applications</a></h4>
<p>It might be a surprise, but some organizations investigate migration to cloud authentication even when they still have applications federated to AD FS.</p>
<p>While the thought may be that all applications <strong>must</strong> be migrated prior to cutover, that isn‚Äôt necessarily the case, as long as the organization understands the user authentication experience and flows. As the applications have no tie to Azure AD already, they will continue to operate without issue within AD FS. And beyond the fact that the organization will have to continue to maintain AD FS, the organization needs to understand that the user experience for authentication may give a fragmented perception. Users will now have three providers for authentication ‚Äì Active Directory, Azure AD, and AD FS. In reality the user experience overall should be improved because authentication will be seamless to anything using Azure AD, but then when hitting an application tied to AD FS, the user may be prompted for forms authentication if they don‚Äôt have line-of-sight of Active Directory ‚Äì which is likely the behavior they were already used to. I bring it up because it can become a place of optics and a lot of user subjectivity, and can make troubleshooting scenarios a bit more complex.</p>
<h4 id="domain-hint-with-staged-rollout"><a class="toclink" href="../../2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#domain-hint-with-staged-rollout">Domain hint with staged rollout</a></h4>
<p>Some applications may pass a domain_hint to Azure AD, which is used to bypass the Azure AD sign-on screen. This can be popular in environments with AD FS in play so that users do not need to enter their username upon the initial sign-in screen with Azure AD.</p>
<p>Where this comes into play with staged rollout, is users could be directed to AD FS still for authentication. If your organization is already hybrid joined, and subsequently your users will have a PRT, the domain_hint piece is not even in play for authentication. If you have scenarios of users accessing Azure AD from things like personal devices with no trust relationship with Azure AD, it‚Äôs where you may want to see what the behavior for authentication looks like. You can read about domain hints here, <a href="https://learn.microsoft.com/en-us/azure/active-directory/manage-apps/home-realm-discovery-policy#domain-hints">Home Realm Discovery policy ‚Äì Microsoft Entra | Microsoft Learn</a>.</p>
<h4 id="document-your-federation-settings"><a class="toclink" href="../../2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#document-your-federation-settings">Document your federation settings</a></h4>
<p>It may go without saying, but make sure you documented your federation settings, and understand the process to reverse things in the case that an issue arises post migration. This generally would look like using Azure AD Connect to re-configure the tenant for federated authentication unless you only need to selectively roll some of the domains back to federated authentication.</p>
<h4 id="azure-ad-connect-health-and-planning-the-migration"><a class="toclink" href="../../2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#azure-ad-connect-health-and-planning-the-migration">Azure AD Connect Health and planning the migration</a></h4>
<p>Along with all the technical checks, there is the question of when to perform the migration. Whether staged rollout is in place or not, the when is a key piece of information the business is going to want to understand (well, as noted in my intro, usually).</p>
<p>For global organizations, the question can become an issue of ‚Äúthere is always someone working somewhere‚Äù. The two paths forward:</p>
<ul>
<li>A slightly less refined approach operates under the principal that the organization already has an outage window defined for IT operations. 60 minutes fits into almost any defined outage window an organization would have, and so subsequently the work is just scheduled during that time.</li>
<li>A more refined and risk-adverse approach leverages Azure AD Connect Health. Azure AD Connect Health can help organizations understand when authentication is happening within AD FS, and subsequently you can use the data from this to determine when AD FS is least utilized. Of course, if you have not already deployed Azure AD Connect Health, you‚Äôll likely want to let it run for a bit to allow it to gather a proper amount of data to make an educated decision. Rolling out Azure AD Connect Health is a relatively straightforward process, which you can read about its use here, <a href="https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-health-adfs">Using Azure AD Connect Health with AD FS ‚Äì Microsoft Entra | Microsoft Learn</a>.</li>
</ul>
<h3 id="mitigating-risk-during-migration"><a class="toclink" href="../../2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#mitigating-risk-during-migration">Mitigating risk during migration</a></h3>
<p>The level of risk used to be higher when ActiveSync was still heavily with legacy authentication, up until even a year or so ago. The reason for this is due to Exchange Online (EXO) having up to a four-hour period in which it may still attempt to authenticate to the federated identity source. Considering that Azure AD no longer has a trust relationship with AD FS, that is where things break down. Recall that with legacy authentication, the service such as EXO captures the user credentials and authentications on behalf of the user.</p>
<p>With modern authentication you don‚Äôt have the same drawn-out risk. As long as your user has a valid refresh token (RT) for Azure AD, they will not hit AD FS upon renewal of their access token (AT). To put that another way, the user only talks to AD FS for initial authentication, and subsequent renewals of the AT only require silent interaction with Azure AD. As mentioned, if you have very restrictive sign-in frequency CA policies in place, that can impact this behavior.</p>
<p>There still is a small window, Microsoft defines as up to 60 minutes, where the tenant is converting itself behind the scenes. But as long as you‚Äôve checked all the pre-migration areas, the migration should generate next to no noise.</p>
<p>If you‚Äôre curious to understand how to test the migration from the outside-in, Sander Berkouwer (<a href="https://twitter.com/SanderBerkouwer">@SanderBerkouwer</a>) has a nice way of leveraging domain_hint for that, which you can find here, <a href="https://dirteam.com/sander/2021/08/13/how-to-check-if-azure-ad-has-processed-the-hybrid-authentication-method-change/">How to check if Azure AD has processed the hybrid authentication method change ‚Äì The things that are better left unspoken (dirteam.com)</a>.</p>
<h3 id="mitigating-risk-post-migration"><a class="toclink" href="../../2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#mitigating-risk-post-migration">Mitigating risk post migration</a></h3>
<p>As noted in the pre-migration tasks, documenting how federation is currently configured is what you‚Äôll need to help rollback any changes. I have not encountered an organization that planned properly needing to roll back to federated authentication.</p>
<p>You may want to continue to keep your AD FS farm around for a bit of time. For those that managed AD FS, it will be a joyous occasion to decommission.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-10-12 00:00:00+00:00">October 12, 2022</time></li>
        
        
          
          <li class="md-meta__item">
            
              8 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="vm-contributor-to-domain-admin-in-60-seconds"><a class="toclink" href="../../2022/10/12/vm-contributor-to-domain-admin-in-60-seconds/">VM Contributor To Domain Admin In 60 Seconds</a></h2>
<p>When Microsoft revamped the privileged access model in the late fall of 2020, it was received with mixed results. To some, it felt as if it was overcomplicating the simple three-tier model that had been the gold standard for protecting Active Directory and other critical business assets for about a decade.</p>
<p>However, the shift was necessary, as it was acknowledging that business critical assets are not just the identity provider. The revamp changed how we look at things, with the proliferation of virtualization and cloud providers, and pointing out the management and control plane as critical privileged points of access.</p>
<p><img alt="Figure 1" src="/images/2022/10/12/img1.png" /></p>
<p><em>The modern Enterprise access model, courtesy Microsoft</em></p>
<p>It‚Äôs quite a common pattern to extend Active Directory to Azure as the initial standup of infrastructure out there, to support all the other ‚Äúthings‚Äù dependent on it.</p>
<p>But as it goes with the cloud, there are new vectors to be on the watch for, and in this case, it‚Äôs ensuring that your RBAC permissions over Tier 0 assets in Azure are properly defined.</p>
<p>Even with a lot of strong guidance from Microsoft on the Cloud Adoption Framework (CAF) and Landing Zones, as well as adhering to the Well Architected Framework, it‚Äôs not always clearly defined as to how the Enterprise access model ties into things.</p>
<p><img alt="Figure 2" src="/images/2022/10/12/img2.png" /></p>
<p><em>Sample landing zone model, Identity subscription highlighted, courtesy Microsoft</em></p>
<p>In the model depicted above, we see that Active Directory is living in its own subscription, but even when we drill into the details of that piece of the puzzle, there isn‚Äôt direct guidance as far as what the RBAC model should look like over that subscription, beyond a bunch of circular references to products or how to achieve certain compliance levels. And while all this stuff is good, this is an area where sometimes it needs to be clearly spelled out.</p>
<h3 id="when-permissions-go-wrong"><a class="toclink" href="../../2022/10/12/vm-contributor-to-domain-admin-in-60-seconds/#when-permissions-go-wrong">When permissions go wrong</a></h3>
<p>When we examine the roles assigned to that identity subscription, it‚Äôs important to realize that <strong>if you have certain levels of unassuming access</strong> over Domain Controller VMs it <strong>effectively provides means to gaining privileged access in Active Directory</strong>.</p>
<p>If this isn‚Äôt news to you, that‚Äôs good. If you are still unsure what this means, or want a refresher, read on.</p>
<p>Many organizations, especially those that have been in Azure a good long while before all the WAF and CAF, can range anywhere from 30 Global Administrators that are also Owners on all subscriptions (witnessed firsthand) to a NOC that has Virtual Machine Contributor to accounts separated and dedicated to the management of the Domain Controller VM‚Äôs‚Ä¶ and everything in between.</p>
<p>If you‚Äôre somewhere between too many Global Admins and to delegating out the Virtual Machine Contributor role, that is where you are leaving yourself exposed.</p>
<p>Let‚Äôs look at an example here with Isaiah Langer and the rights he has on the Domain Controller nwind-dc1:</p>
<p><img alt="Figure 3" src="/images/2022/10/12/img3.png" /></p>
<p>Virtual Machine Contributor currently has 327 actions that compose the role, and a description</p>
<p><em>Lets you manage the virtual machines, but not access to them, and not the virtual network or storage account they‚Äôre connected to</em></p>
<p>On the surface that sounds fine ‚Äì we can‚Äôt change the network configuration of the VM, and if we attempt to export the disk we are met with an error:</p>
<p><img alt="Figure 4" src="/images/2022/10/12/img4.png" /></p>
<p>However, Isaiah does have the ability to use the <strong>Run command</strong> operation.</p>
<p>Run Command leverages the VM agent installed on the machine when it‚Äôs created; this requires no additional extension deployed. The VM agent runs in the SYSTEM context. And this all makes sense, needing certain privileges on the VM to be able to manage it.</p>
<p>Before looking at what we can do with this Run command, we‚Äôll just look at a Domain Admin in AD. Note PasswordLastSet:</p>
<p><img alt="Figure 5" src="/images/2022/10/12/img5.png" /></p>
<p>Back to Isaiah in the run command portal, let‚Äôs try something simple:</p>
<div class="highlight"><pre><span></span><code>net user da-eric P0wned1234! /domain
</code></pre></div>
<p><img alt="Figure 6" src="/images/2022/10/12/img6.png" /></p>
<p>And we hit <strong>Run</strong>.</p>
<p>Twenty seconds or so later:</p>
<p><img alt="Figure 7" src="/images/2022/10/12/img7.png" /></p>
<p>Back on the Domain Controller:</p>
<p><img alt="Figure 8" src="/images/2022/10/12/img8.png" /></p>
<p>And we now successfully have changed the password for the Domain Admin da-eric. Considering how easy it is to glean this sort of knowledge from Active Directory, it‚Äôs trivial to figure out who we want to target.</p>
<p>Of course, if we would rather not disturb an existing Domain Admin, we can just create a new one:</p>
<p><div class="highlight"><pre><span></span><code>net user da-isaiah P0wned1234! /add /logonpasswordchg:no /domain
</code></pre></div>
And then add the user to the Administrator group:</p>
<div class="highlight"><pre><span></span><code>net localgroup Administrators da-isaiah /add
</code></pre></div>
<p>Back on the Domain Controller:</p>
<p><img alt="Figure 9" src="/images/2022/10/12/img9.png" /></p>
<p>These are just some examples. While a threat actor may not be so obvious, it‚Äôs also important to point out that once a VM contributor account is breached, the attack itself does not need to be overengineered or complicated. Whatever you can do within the SYSTEM context, you can pull off through Azure Run command with these rights.</p>
<h3 id="tracking-run-command"><a class="toclink" href="../../2022/10/12/vm-contributor-to-domain-admin-in-60-seconds/#tracking-run-command">Tracking run command</a></h3>
<p>If we look at the Azure activity logs, the Run command logs do not provide any insight into the command that ran. Look at the log below, from the last command Isaiah ran:</p>
<div class="highlight"><pre><span></span><code>{
    &quot;authorization&quot;: {
        &quot;action&quot;: &quot;Microsoft.Compute/virtualMachines/runCommand/action&quot;,
        &quot;scope&quot;: &quot;/subscriptions/6010f303-6259-4f47-bb99-9d461d36c1e4/resourceGroups/rg-lab/providers/Microsoft.Compute/virtualMachines/nwind-dc1&quot;
    },
    &quot;caller&quot;: &quot;isaiah.langer@fabrikam.cloud&quot;,
    &quot;channels&quot;: &quot;Operation&quot;,
    &quot;claims&quot;: {
        &quot;aud&quot;: &quot;https://management.core.windows.net/&quot;,
        &quot;iss&quot;: &quot;https://sts.windows.net/11ae06df-10e8-4b9e-bf66-2a91f4955339/&quot;,
        &quot;iat&quot;: &quot;1665576850&quot;,
        &quot;nbf&quot;: &quot;1665576850&quot;,
        &quot;exp&quot;: &quot;1665581298&quot;,
        &quot;http://schemas.microsoft.com/claims/authnclassreference&quot;: &quot;1&quot;,
        &quot;aio&quot;: &quot;ATQAy/8TAAAA2Vzb2bVgvWc1B1/qZsCPq9nblD/9RdvCXf0Y87EX8swm9HGyVQXobsMvpWY7uuBp&quot;,
        &quot;http://schemas.microsoft.com/claims/authnmethodsreferences&quot;: &quot;pwd&quot;,
        &quot;appid&quot;: &quot;c44b4083-3bb0-49c1-b47d-974e53cbdf3c&quot;,
        &quot;appidacr&quot;: &quot;2&quot;,
        &quot;http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname&quot;: &quot;Langer&quot;,
        &quot;http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname&quot;: &quot;Isaiah&quot;,
        &quot;groups&quot;: &quot;310c96cf-5606-4d8d-ae59-cb698bc9fa5b,00242a6d-86d2-4351-9303-9bcf1bfb077a,c336cee6-a292-46a8-abb2-5faeb16d66d0,b04f480e-9056-45f4-be59-0ef1e2136fac,b492badd-d952-40fc-b1e8-32279fc8635e,dc61c347-aca1-4f92-bbf4-1389af8ea099,3e56b395-18bc-4305-9f6a-ac67612c912b&quot;,
        &quot;ipaddr&quot;: &quot;&quot;,
        &quot;name&quot;: &quot;Isaiah Langer&quot;,
        &quot;http://schemas.microsoft.com/identity/claims/objectidentifier&quot;: &quot;5d2a4414-5fac-46ec-85d0-4ad537d75c77&quot;,
        &quot;onprem_sid&quot;: &quot;S-1-5-21-131657314-4052732218-1597742569-2110&quot;,
        &quot;puid&quot;: &quot;10032001710A0360&quot;,
        &quot;rh&quot;: &quot;0.AVAA3wauEegQnku_ZiqR9JVTOUZIf3kAutdPukPawfj2MBNQAA0.&quot;,
        &quot;http://schemas.microsoft.com/identity/claims/scope&quot;: &quot;user_impersonation&quot;,
        &quot;http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier&quot;: &quot;hf0X9izWHDY50kvXgOssXWjwzaMxLB9hLuSHj1aXPsA&quot;,
        &quot;http://schemas.microsoft.com/identity/claims/tenantid&quot;: &quot;11ae06df-10e8-4b9e-bf66-2a91f4955339&quot;,
        &quot;http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name&quot;: &quot;isaiah.langer@fabrikam.cloud&quot;,
        &quot;http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn&quot;: &quot;isaiah.langer@fabrikam.cloud&quot;,
        &quot;uti&quot;: &quot;gE43gRPnTU2aC5p7UGEwAA&quot;,
        &quot;ver&quot;: &quot;1.0&quot;,
        &quot;xms_tcdt&quot;: &quot;1629656520&quot;
    },
    &quot;correlationId&quot;: &quot;cdd385b0-5df8-44f1-8d63-2036772306ba&quot;,
    &quot;description&quot;: &quot;&quot;,
    &quot;eventDataId&quot;: &quot;42f9771e-342b-4278-b78a-ca77184504ee&quot;,
    &quot;eventName&quot;: {
        &quot;value&quot;: &quot;EndRequest&quot;,
        &quot;localizedValue&quot;: &quot;End request&quot;
    },
    &quot;category&quot;: {
        &quot;value&quot;: &quot;Administrative&quot;,
        &quot;localizedValue&quot;: &quot;Administrative&quot;
    },
    &quot;eventTimestamp&quot;: &quot;2022-10-12T13:00:11.66499Z&quot;,
    &quot;id&quot;: &quot;/subscriptions/6010f303-6259-4f47-bb99-9d461d36c1e4/resourceGroups/rg-lab/providers/Microsoft.Compute/virtualMachines/nwind-dc1/events/42f9771e-342b-4278-b78a-ca77184504ee/ticks/638011764116649900&quot;,
    &quot;level&quot;: &quot;Informational&quot;,
    &quot;operationId&quot;: &quot;23192952-b8ef-4671-813e-36262ee112c3&quot;,
    &quot;operationName&quot;: {
        &quot;value&quot;: &quot;Microsoft.Compute/virtualMachines/runCommand/action&quot;,
        &quot;localizedValue&quot;: &quot;Run Command on Virtual Machine&quot;
    },
    &quot;resourceGroupName&quot;: &quot;rg-lab&quot;,
    &quot;resourceProviderName&quot;: {
        &quot;value&quot;: &quot;Microsoft.Compute&quot;,
        &quot;localizedValue&quot;: &quot;Microsoft.Compute&quot;
    },
    &quot;resourceType&quot;: {
        &quot;value&quot;: &quot;Microsoft.Compute/virtualMachines&quot;,
        &quot;localizedValue&quot;: &quot;Microsoft.Compute/virtualMachines&quot;
    },
    &quot;resourceId&quot;: &quot;/subscriptions/6010f303-6259-4f47-bb99-9d461d36c1e4/resourceGroups/rg-lab/providers/Microsoft.Compute/virtualMachines/nwind-dc1&quot;,
    &quot;status&quot;: {
        &quot;value&quot;: &quot;Succeeded&quot;,
        &quot;localizedValue&quot;: &quot;Succeeded&quot;
    },
    &quot;subStatus&quot;: {
        &quot;value&quot;: &quot;&quot;,
        &quot;localizedValue&quot;: &quot;&quot;
    },
    &quot;submissionTimestamp&quot;: &quot;2022-10-12T13:01:24.1576475Z&quot;,
    &quot;subscriptionId&quot;: &quot;6010f303-6259-4f47-bb99-9d461d36c1e4&quot;,
    &quot;tenantId&quot;: &quot;11ae06df-10e8-4b9e-bf66-2a91f4955339&quot;,
    &quot;properties&quot;: {
        &quot;eventCategory&quot;: &quot;Administrative&quot;,
        &quot;entity&quot;: &quot;/subscriptions/6010f303-6259-4f47-bb99-9d461d36c1e4/resourceGroups/rg-lab/providers/Microsoft.Compute/virtualMachines/nwind-dc1&quot;,
        &quot;message&quot;: &quot;Microsoft.Compute/virtualMachines/runCommand/action&quot;,
        &quot;hierarchy&quot;: &quot;11ae06df-10e8-4b9e-bf66-2a91f4955339/6010f303-6259-4f47-bb99-9d461d36c1e4&quot;
    },
    &quot;relatedEvents&quot;: []
}
</code></pre></div>
<p>Note the absence of the command itself. Likewise, the VM agent has local logging, C:\WindowsAzure\Logs\Plugins\Microsoft.CPlat.Core.RunCommandWindows, but the logs themselves will not contain a copy of the command run.</p>
<h3 id="its-not-just-the-azure-portal"><a class="toclink" href="../../2022/10/12/vm-contributor-to-domain-admin-in-60-seconds/#its-not-just-the-azure-portal">It's not just the Azure portal</a></h3>
<p>While the examples shown here are using the Azure portal, you can perform the same commands using Azure CLI, the Azure PowerShell module <strong>Invoke-AzVMRunCommand</strong>, and the Azure Management API <strong>https://management.azure.com</strong>.</p>
<p>An example from a run using Azure CLI:</p>
<div class="highlight"><pre><span></span><code>isaiah@Azure:~$ az vm run-command invoke --command-id RuNPowerShellScript --name nwind-dc1 -g &quot;rg-lab&quot; --scripts &quot;net user da-eric P0wned1234! /domain&quot;
{
  &quot;value&quot;: [
    {
      &quot;code&quot;: &quot;ComponentStatus/StdOut/succeeded&quot;,
      &quot;displayStatus&quot;: &quot;Provisioning succeeded&quot;,
      &quot;level&quot;: &quot;Info&quot;,
      &quot;message&quot;: &quot;The command completed successfully.\n&quot;,
      &quot;time&quot;: null
    },
    {
      &quot;code&quot;: &quot;ComponentStatus/StdErr/succeeded&quot;,
      &quot;displayStatus&quot;: &quot;Provisioning succeeded&quot;,
      &quot;level&quot;: &quot;Info&quot;,
      &quot;message&quot;: &quot;&quot;,
      &quot;time&quot;: null
    }
  ]
}
isaiah@Azure:~$
</code></pre></div>
<h3 id="mitigation-monitoring-and-recommendations"><a class="toclink" href="../../2022/10/12/vm-contributor-to-domain-admin-in-60-seconds/#mitigation-monitoring-and-recommendations">Mitigation, monitoring and recommendations</a></h3>
<p>The easiest course of action is to review who has ownership and of the subscription(s) containing Domain Controllers, as well as Virtual Machine Contributor. If those assigned are different from the staff that manages identity in your organization, investigate if the permissions can be removed/reduced. And if your Domain Controllers do not reside in their own subscription, now is the time to start planning to move them.</p>
<p>Some organizations may still have standard processes to allow users who do not manage Active Directory the ability to do things like start/stop Domain Controllers, create a custom RBAC role. You can copy the Virtual Machine Contributor Role, and then use the Exclude Permissions feature to restrict the ability to use Run commands:</p>
<p><img alt="Figure 10" src="/images/2022/10/12/img10.png" /></p>
<p>Exclude permissions is a great way to restrict certain permissions within a wildcard permission, so you don‚Äôt need to manually define <strong>all</strong> the VirtualMachine permissions permitted.</p>
<p>After building the custom role, assign it to whomever currently has Virtual Machine Contributor over Domain Controllers. Once you do, what you‚Äôll find is that the user will still have the visibility of Run command in the portal, but Azure will blackhole the process if a user attempts to use it.</p>
<p>For management of critical Tier 0 VM‚Äôs like Domain Controllers, PIM should be used for role elevation, even if it‚Äôs to a role that has the Run command permissions removed. Remember, you can mix and match licenses ‚Äì go buy some AAD P2 licenses for your organization to cover management of Tier 0 assets if P2 across the organization is not something on the financial forecast.</p>
<p>Organizationally some may accept the risk here, which you shouldn‚Äôt, as Mandiant indicates they have seen this actively exploited in incident response cases.</p>
<p>Last thing, whether you mitigate or don‚Äôt, a takeaway here is why it‚Äôs critical to have robust monitoring of critical groups and users in Active Directory, and even better have an Identity Threat Detection and Response (ITDR) platform in place.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-10-05 00:00:00+00:00">October 5, 2022</time></li>
        
        
          
          <li class="md-meta__item">
            
              8 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="azure-ad-new-controls-for-authentication-strength"><a class="toclink" href="../../2022/10/05/azure-ad-new-controls-for-authentication-strength/">Azure AD: New Controls For Authentication Strength</a></h2>
<p>Microsoft has released a much asked for setting, which also aligns to the Whitehouse memorandum, M-22-09, calling for federal agencies to require phishing resistant MFA by 2024, you can read the full memorandum here, <a href="https://www.whitehouse.gov/wp-content/uploads/2022/01/M-22-09.pdf">M-22-09 Federal Zero Trust Strategy (whitehouse.gov)</a>.</p>
<p>With this, we now have granularity in Conditional Access to not just specify whether MFA is required, but also how strong the collective authentication is.</p>
<h3 id="the-prior-state-of-azure-ad-mfa"><a class="toclink" href="../../2022/10/05/azure-ad-new-controls-for-authentication-strength/#the-prior-state-of-azure-ad-mfa">The prior state of Azure AD MFA</a></h3>
<p>Within the Grant Control section of a Conditional Access policy, we‚Äôve always had the <strong>Require multifactor authentication</strong> control, which enforced MFA. But up until now, we never had the ability to specify what that level could be ‚Äì if a user in a tenant has a FIDO2 security key, but also is registered for SMS text, they could use either that security key or their password and SMS text for MFA. In many tenants it‚Äôs always practical to try and restrict users from using weaker forms of MFA, especially at times when they may need to use that to bootstrap themselves into stronger authentication methods such as passwordless. And since this is a tenant-wide setting, we have had the historical issue where we couldn‚Äôt say enforce stronger forms of authentication for privileged accounts, such as Global Admins.</p>
<h3 id="require-authentication-strength"><a class="toclink" href="../../2022/10/05/azure-ad-new-controls-for-authentication-strength/#require-authentication-strength">Require authentication strength</a></h3>
<p>Within Grant Controls, we now have a new option, <strong>Require authentication strength</strong>. When we select this dropdown, we see that we have the following options available:</p>
<ul>
<li>Multifactor authentication ‚Äì Combinations of methods that satisfy strong authentication such as Password + SMS</li>
<li>Passwordless multifactor authentication ‚Äì Passwordless methods that satisfy strong authentication, such as Microsoft Authenticator</li>
<li>Phishing-resistant multifactor authentication ‚Äì Phishing-resistant Passwordless methods for the strongest authentication, such as FIDO2 Security Key</li>
</ul>
<p><img alt="Figure 1" src="/images/2022/10/05/img1.png" /></p>
<p>We also have the ability to define custom authentications strengths in Azure AD, which we can find under Security -&gt; Authentication Methods -&gt; Authentication Strengths (Preview).</p>
<p><img alt="Figure 2" src="/images/2022/10/05/img2.png" /></p>
<p>And if we look at the details, this opens up a whole world of options for us:</p>
<p><img alt="Figure 3" src="/images/2022/10/05/img3.png" /></p>
<p>First, let us examine the out-of-the-box options.</p>
<h4 id="multifactor-authentication"><a class="toclink" href="../../2022/10/05/azure-ad-new-controls-for-authentication-strength/#multifactor-authentication">Multifactor authentication</a></h4>
<p>The lowest denominator for MFA, this setting should be parity to the <strong>Require multifactor authentication</strong> setting that we‚Äôve had available for as long as Conditional Access has existed.</p>
<p>We can examine this by changing an existing policy from Require multifactor authentication to Require authentication strength and selecting Multifactor authentication.</p>
<p>As a baseline, lets first look at what our Azure AD logs show us in the current state, with Require multifactor authentication enabled:</p>
<p><img alt="Figure 4" src="/images/2022/10/05/img4.png" /></p>
<p>And if we look at the Conditional Access Policy details:</p>
<p><img alt="Figure 5" src="/images/2022/10/05/img5.png" /></p>
<p>Now let‚Äôs change our policy to use the <strong>require authentication strength</strong> setting with <strong>multifactor authentication</strong> selected:</p>
<p><img alt="Figure 6" src="/images/2022/10/05/img6.png" /></p>
<p><em>Switching to the new MFA setting</em></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Require multifactor authentication and Require authentication strength are mutually exclusive, as they both enforce multifactor. Enabling one will disable the ability to use the other within the same Conditional Access Policy.</p>
</div>
<p>After we authenticate, the sign-in log looks the same:</p>
<p><img alt="Figure 7" src="/images/2022/10/05/img7.png" /></p>
<p>However, if we examine the Conditional Access Policy details, we will see that we are satisfying for the new authentication strength grant control:</p>
<p><img alt="Figure 8" src="/images/2022/10/05/img8.png" /></p>
<h3 id="passwordless-multifactor-authentication"><a class="toclink" href="../../2022/10/05/azure-ad-new-controls-for-authentication-strength/#passwordless-multifactor-authentication">Passwordless multifactor authentication</a></h3>
<p>Let‚Äôs kick the strength of the Conditional Access policy up:</p>
<p><img alt="Figure 9" src="/images/2022/10/05/img9.png" /></p>
<p>With things turned up, let‚Äôs first look at the behavior if we attempt to authenticate with a password anyway.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Remember that Conditional Access evaluates <strong>after</strong> primary authentication, so our policies will not prevent a user from still attempting to perform password authentication.</p>
</div>
<p><img alt="Figure 10" src="/images/2022/10/05/img10.png" /></p>
<p>We are then presented with another dialog, telling us that our organization requires additional sign in methods to access this resource:</p>
<p><img alt="Figure 11" src="/images/2022/10/05/img11.png" /></p>
<p>Now if we take a look at our Sign-in logs, we‚Äôll see that the initial username/password auth occurs, as well as passwordless to satisfy MFA requirements:</p>
<p><img alt="Figure 12" src="/images/2022/10/05/img12.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Microsoft Authenticator passwordless (phone sign-in) <strong>is not phishing-resistant</strong>. Because of this, the Passwordless MFA setting really does not have any advantage over push notifications for MFA with number matching enabled.</p>
</div>
<p>Now if we repeat this process, and instead use something like Microsoft Authenticator for passwordless (phone sign-in), we will go right into our application:</p>
<p><img alt="Figure 13" src="/images/2022/10/05/img13.png" /></p>
<p>And what happens if our user does not have a FIDO2 security key, is not on a machine with Windows Hello for Business, and does not have Microsoft Authenticator passwordless (phone sign-in) enabled?</p>
<p>If the authentication strength policy is applied to all resources, the user will get stuck in an endless loop of trying to enroll a stronger form of authentication:</p>
<p><img alt="Figure 14" src="/images/2022/10/05/img14.png" /></p>
<p>Now this behavior, from a security standpoint, is not necessarily bad. However, from an end-user perspective it‚Äôs something to watch out for.</p>
<p>If you‚Äôre using a Temporary Access Pass (TAP) and accessing https://aka.ms/mysecurityinfo to enroll in strong authentication, that does satisfy the policy.</p>
<h3 id="phishing-resistant-multifactor-authentication"><a class="toclink" href="../../2022/10/05/azure-ad-new-controls-for-authentication-strength/#phishing-resistant-multifactor-authentication">Phishing-resistant multifactor authentication</a></h3>
<p>Finally, we‚Äôll turn the dial all the way up, to phishing-resistant MFA:</p>
<p><img alt="Figure 15" src="/images/2022/10/05/img15.png" /></p>
<p>Using our FIDO2 security key, we are able to access our resources without issue:</p>
<p><img alt="Figure 16" src="/images/2022/10/05/img16.png" /></p>
<p>And if we attempt to use our password:</p>
<p><img alt="Figure 17" src="/images/2022/10/05/img17.png" /></p>
<p>We are prompted to use a security key:</p>
<p><img alt="Figure 18" src="/images/2022/10/05/img18.png" /></p>
<p>Now if our user doesn‚Äôt have a FIDO2 security key enrolled or is not accessing the resource from a device using Windows Hello for Business, they again will get stuck in an endless enrollment loop if the policy is applied to all resources.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Windows Hello for Business, FIDO2 security keys, and certificate-based authentication are the only mechanisms considered phishing-resistant within Azure AD.</p>
</div>
<h3 id="some-odd-behavior"><a class="toclink" href="../../2022/10/05/azure-ad-new-controls-for-authentication-strength/#some-odd-behavior">Some odd behavior</a></h3>
<p>In my testing, I happened upon that require authentication strength does not seem to play well with other grant controls. My test policy had been configured previously to Require one of the selected controls, effectively an OR situation, between Require multifactor authentication or Require device to be marked as compliant:</p>
<p><img alt="Figure 19" src="/images/2022/10/05/img19.png" /></p>
<p>When testing, and switching to use this new setting, I found that the policy effectively turned into a device compliance required policy ‚Äì before even being able to attempt MFA, I was presented with an error due to lack of device compliance:</p>
<p><img alt="Figure 20" src="/images/2022/10/05/img20.png" /></p>
<p>I‚Äôve reached out to Microsoft about this behavior, but it just leaves a bit of a cautionary tale to ensure that you selectively test who you are applying these policy changes to. When I find out more information, I‚Äôll update this article. While this one specific case could be worked around by excluding compliant devices as a condition instead of a control, many organizations may still be using device compliance grant controls due to the feature having existed longer.</p>
<h3 id="final-thoughts-and-notes"><a class="toclink" href="../../2022/10/05/azure-ad-new-controls-for-authentication-strength/#final-thoughts-and-notes">Final thoughts and notes</a></h3>
<p>With this new setting for granular control of authentication strength, we can finally do things in our tenant such as (only a few initial thoughts):</p>
<ul>
<li>Require privileged users to have to use a phishing-resistant form of MFA</li>
<li>In organizations such as higher-ed, restrict faculty and staff to stronger authentication while allowing students to continue to use weaker forms of MFA (as it required many times)</li>
<li>Potentially have other avenues to restrict the ability to enroll other forms of MFA only from strong forms of MFA</li>
</ul>
<p>Because this is only limiting the options used during authentication, this will not prevent a privileged user from enrolling in a weaker form of MFA, such as SMS. They‚Äôll just never necessarily be permitted to leverage that.</p>
<p>Also, as I‚Äôve found in testing, you‚Äôll want to test these new settings thoroughly, to ensure that you aren‚Äôt creating scenarios for your end users where they can‚Äôt enroll in stronger authentication, and subsequently get stuck in a proof-up loop. Applying this new grant control across all users, for all applications, is likely too broad of a policy for the majority of organizations, unless you are certain about your existing passwordless usage. There‚Äôs nothing like a few hiccups with an authentication change in an organization to completely stall any progress.</p>
<p>I still have more testing I want to do ‚Äì exploring what this looks like with external users and cross-tenant access settings. And there is the ability to create custom authentication strengths as well, which is ripe with granularity for all sorts of custom authentication strength. In all the testing of the different permutations, and a few setbacks from unexpected behavior, this article took longer than initially thought to craft.</p>
<p>End of the day, this is still a great step forward to ensuring that strong authentication is used when it matters within tenants. Can‚Äôt wait to see Global Admins voluntarily applying these policies to themselves. Just don‚Äôt forget to exclude those break-glass accounts.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-08-09 00:00:00+00:00">August 9, 2022</time></li>
        
        
          
          <li class="md-meta__item">
            
              10 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="an-agile-refresh-of-the-passwordless-strategy"><a class="toclink" href="../../2022/08/09/an-agile-refresh-of-the-passwordless-strategy/">An Agile Refresh Of The Passwordless Strategy</a></h2>
<h3 id="background"><a class="toclink" href="../../2022/08/09/an-agile-refresh-of-the-passwordless-strategy/#background">Background</a></h3>
<p>The Microsoft passwordless strategy guidance has existed since 2018, and since then it‚Äôs continued to be a solid document. You can view the full doc here, <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/hello-for-business/passwordless-strategy">Password-less strategy ‚Äì Windows security | Microsoft Docs</a>, but where the focus usually lands is on the four-step graph at the top of that page:</p>
<p><img alt="Figure 1" src="/images/2022/08/09/img1.png" /></p>
<p><em>The Microsoft passwordless strategy</em></p>
<p>When discussing the strategy with organizations, the focus is usually on Step 1 ‚Äì develop (deploy) password replacement offerings, and the technology involved, such as Windows Hello for Business, FIDO2 security keys, and MS Authenticator App passwordless sign-in. After all, the strategy is provided as a stepped approach, so you start with the first step, and then move on.</p>
<p>There are three primary issues with the approach:</p>
<ul>
<li>Organizations look at this as a reinforcement that passwordless must be deployed in a waterfall approach.</li>
<li>Application authentication modernization is not emphasized strongly enough, and subsequently organizations do not right-size the efforts required.</li>
<li>Organizations do not emphasize the pluralization on offerings, and potentially focus on the requirement of one-size-must-fit-all.</li>
</ul>
<p>While issue three is not specific to this approach as designed, many organizations will take the waterfall approach with a single solution, and then box themselves into only deploying one solution, slowing down progress.</p>
<h3 id="the-waterfall-approach-problem"><a class="toclink" href="../../2022/08/09/an-agile-refresh-of-the-passwordless-strategy/#the-waterfall-approach-problem">The waterfall approach problem</a></h3>
<p>While there have been great strides made organization wide, many still tend to suffer in that security and infrastructure teams still operate in a waterfall approach when it comes to managing identity platforms, products, and projects. A solid Identity Program or expert consultants can help rectify this, but not every organization has access to these. And sometimes, of course, organizations will simply point to the Microsoft docs and just take it all as literal guidance, with little desire to deter. From firsthand discussions with customers I‚Äôve encountered all too often the desire to look at this as a serialized, singular method to tackle passwordless.</p>
<p>For organizations that have been on other identity journeys in Azure AD, they likely will have seen similar problems in their approach to deploying things like MFA or conditional access policies ‚Äì if you wait for a collective 100% of all problems to be resolved, you will move the needle 0%.</p>
<p>In the case where a picture is worth a thousand words ‚Äì some organizations will look at this diagram and disregard all the details within the associated docs. While it‚Äôs likely they aren‚Äôt the candidate to be reading this, it‚Äôs worth noting.</p>
<h3 id="the-application-authentication-modernization-problem"><a class="toclink" href="../../2022/08/09/an-agile-refresh-of-the-passwordless-strategy/#the-application-authentication-modernization-problem">The application authentication modernization problem</a></h3>
<p>A very common issue within organizations is that they successfully reach mass deployment of passwordless with most user personas, but when the project is ‚Äúdone‚Äù they realize that there is still a lot of work to accomplish to be able to fully realize a passwordless environment.</p>
<p>For some organizations, this can result in passwordless being viewed as a failure. Focus will shift to organizations asking questions as to why LDAP or RADIUS do not support passwordless authentication, instead of asking why the organization wants to continue to depend on 20+ year old protocols that are inherently more insecure than modern counterparts.</p>
<p>Sometimes this issue is because organizations effectively look at passwordless deployments solely as that first step. The focus is just on the technology, on the identity provider, and not on the broader ecosystem. And while consensus is that users will use the path of least resistance, which usually is passwordless, if they still have to use their password at times, there is a lower ROI as passwords are still exposed and subsequently users are still susceptible to password-based attacks such as phishing or password-spray.</p>
<p>Other times, the issue is that organizations just simply don‚Äôt know where to start. Application modernization projects can be some of the most costly, complex, and time-consuming projects, that can become overwhelming at a rapid pace if not managed properly. It‚Äôs important that organizations understand the value and long-term return in application authentication modernization.</p>
<h3 id="the-single-solution-problem"><a class="toclink" href="../../2022/08/09/an-agile-refresh-of-the-passwordless-strategy/#the-single-solution-problem">The single solution problem</a></h3>
<p>The single solution problem isn‚Äôt specifically a problem with the current strategy. After all, the strategy indicates password replacement offering<strong>s</strong>. They common story for many organizations is this:</p>
<p><em>We want to deploy passwordless. Let‚Äôs deploy Windows Hello for Business, then we‚Äôll deploy FIDO2, then we‚Äôll deploy Authenticator App passwordless sign-in.</em></p>
<p>And the problem then becomes that organizations will focus solely on one method, and will not leave the opportunity to parallel thread progress. Reality is that all three mechanisms are relatively lightweight to deploy from a technical perspective, and end up consuming very little end-user cycles for initial enrollment, but organizations may take a FUD apprehensive approach, when they should instead give users options.</p>
<p>To some, this may feel strange, as we‚Äôve been wrongfully engrained by past actions in believing that users should not have choice, but be forced into a certain model ‚Äì which ultimately leads users into inventing patterns of negative behavior to circumvent doing something they would rather not. For these organizations, they need to stop viewing end users as the opposition, but instead as their customers, even in the terms of workforce identity.</p>
<p>Of course, counter to this point, there are organizations who are deterministic in saying that they require one solution to cover all solutions. While there are initiatives underway, such as passkey, and FIDO2 support is becoming broadly adopted by operating systems, the ecosystem is vastly different than 15 years ago when the single solution mindset worked. Where we only had to previously solve for a small and fixed set of criteria, with cloud sprawl and users wanting to access everything from everywhere all the time, we have to tackle this challenge with a growth mindset. And in this case that includes solving the problem with solutions that best fit the platforms.</p>
<p>Customers will ask things like <em>why doesn‚Äôt Microsoft make Windows Hello for Business for iOS</em>, even though Microsoft does not own the operating system. Focus instead should be made on the rich ecosystem on iOS and Android devices to support brokered authentication with the Authenticator App or Company Portal. When these are combined with Authenticator App passwordless sign in, users can have a simple passwordless experience on those devices with ease. For the many organizations that encounter end users wanting to access things like email from personal Windows computers, it‚Äôs counterintuitive to security to not provide users with a FIDO2 security key and the ability to use such, so that their password is not exposed on devices or in environments with a low level of assurance.</p>
<h3 id="an-agile-refresh-to-the-passwordless-strategy"><a class="toclink" href="../../2022/08/09/an-agile-refresh-of-the-passwordless-strategy/#an-agile-refresh-to-the-passwordless-strategy">An agile refresh to the passwordless strategy</a></h3>
<p>Our problems are defined. But what does the solution look like?</p>
<p><img alt="Figure 2" src="/images/2022/08/09/img2.png" /></p>
<p>Within this strategy, nothing that Microsoft already recommends is gone, but we emphasize the application side of the equation, and we shift the focus to an iterative methodology that naturally lends to a more agile approach for deployments.</p>
<p>Note that this can be considered an addendum to the existing strategy, and is not written to fully replace the existing recommendations. Therefore, it‚Äôs still worth reading the Microsoft documentation, <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/hello-for-business/passwordless-strategy">Password-less strategy ‚Äì Windows security | Microsoft Docs</a>.</p>
<h4 id="passwordless-steps-reduced-to-three"><a class="toclink" href="../../2022/08/09/an-agile-refresh-of-the-passwordless-strategy/#passwordless-steps-reduced-to-three">Passwordless steps reduced to three</a></h4>
<p>During my time at Microsoft, one of the most confusing bits to customers was Step 4, Eliminate passwords from the identity directory.</p>
<p>The confusion comes out of the mixed messaging and likely reality that passwords will continue to exist, in some form, for a long while to continue.</p>
<p>Active Directory has finished baking, and the closest mechanism to having no password is <strong>Smart Card Required for Interactive Logon</strong>, or SCRIL, where Active Directory effectively manages the users password in a way that renders the password useless and unknown to the end user. When SCRIL is enabled, users are rendered passwordless because:</p>
<ul>
<li>Their password is managed by Active Directory and they do not know it</li>
<li>The user is no longer asked by Windows to change their password</li>
<li>Domain Controllers disallow passwords for interactive authentication</li>
<li>The password is set to a 128 random bit of data and can include non-typable characters</li>
</ul>
<p>SCRIL, then, is the ultimate goal for our Active Directory based user accounts. Additional benefits of SCRIL include:</p>
<ul>
<li>Hybrid users are supported, and users become passwordless in Azure AD</li>
<li>Users, still having a password, are able to still comply with corporate password policies that may be required by cybersecurity companies or industry regulations</li>
<li>The technology is not new, SCRIL has existed in Active Directory at least since Windows Server 2003, to support organizations previously deploying traditional smartcards within their environments.</li>
</ul>
<p>For a deeper dive into SCRIL, hybrid users, and password policy enforcement, take a look at this article, <a href="https://ericonidentity.com/2021/12/13/living-in-a-passwordless-world-hybrid-identity-and-password-management/">Living in a Passwordless World: Password Management ‚Äì Eric on Identity</a>.</p>
<h4 id="circular-design-to-indicate-an-iterative-approach"><a class="toclink" href="../../2022/08/09/an-agile-refresh-of-the-passwordless-strategy/#circular-design-to-indicate-an-iterative-approach">Circular design to indicate an iterative approach</a></h4>
<p>In case it isn‚Äôt apparent at this point, I‚Äôll say it again. We want to work these efforts for passwordless in ways that allow for agile deployment, adopting in a way that best suits the organization and allows for passwordless progress.</p>
<p>Whether you call them waves, rings, phases, or something else, it‚Äôs important that organizations identify user personas to target and deploy in a way that provides the path of least resistance and builds inertia for progress. For many organizations this should look like dogfooding passwordless, with infrastructure and security teams deploying the mechanisms to themselves first, along with their Service Desk personnel. This is the reminder that organizations always find more success with technology changes when they involve their Service Desk early in the process. Organizations should also look for champions, perhaps providing opportunity for users to opt in to new passwordless experiences. Many times organizations will focus cycles on the users who won‚Äôt want to move, instead of focusing on the users who have a hunger for technology and change. Those users can be key to building that organizational inertia, for finding those non-IT voices to champion progress, and building momentum to topple down those that resist change solely for the sake of such.</p>
<p>The iterative approach can not only be used against user personas in the organization, but against the different passwordless mechanisms as well. We don‚Äôt want to lock users or the organization into a single-track mindset that only one passwordless method is suitable or feasible to use. And instances may be encountered where there is the desire to deploy multiple approaches, but one method is deployed faster than the other. An example may be deploying Windows Hello for Business first, as a means to then make bootstrapping easier for FIDO2 security keys.</p>
<h4 id="application-authentication-modernization-is-a-parallel-but-separate-effort"><a class="toclink" href="../../2022/08/09/an-agile-refresh-of-the-passwordless-strategy/#application-authentication-modernization-is-a-parallel-but-separate-effort">Application authentication modernization is a parallel but separate effort</a></h4>
<p>As most identity projects go these days, workstreams are rarely single-threaded, at least if you are looking to achieve success in a reasonable amount of time.</p>
<p>Here we have said application authentication modernization is as important as deployment of the passwordless methods themselves. This may be different for every organization, depending on a mixture of several factors, including:</p>
<ul>
<li>Age of the organization ‚Äì Older organizations are likely to have more legacy applications still persistent.</li>
<li>Types of applications ‚Äì Organizations with several line-of-business (LOB) applications may have a more varied array of authentication mechanisms existing, or if the organization has several applications running in on-premises deployments, vs organizations that primarily consume SaaS applications in a cloud, which likely already support modern forms of authentication.</li>
<li>Number of applications ‚Äì Again organizations can vary greatly in how many applications they have deployed. Efforts to modernize 10 applications likely will take less time than 100 applications.</li>
<li>Application user personas and user base ‚Äì Contradicting the number of applications, if an organization has 10 applications but 100,000 users per application, it may take longer to modernize authentication vs an organization with 100 applications but only 10 users accessing each application.</li>
</ul>
<p>Now you may read this and wonder how to prioritize applications for modernization and what the options are ‚Äì a follow-up article will eventually be linked here to dive further into that.</p>
<p>As critical as the modernization of applications, is the ability to separate out efforts to modernize those applications. Organizations may find themselves in situations where they enroll certain user personas for passwordless well before their full application catalog supports it, but organizations should also feel empowered to start modernizing applications as soon as they are identified, so that users can benefit from passwordless authentication as soon as they are enrolled.</p>
<h4 id="start-application-authentication-modernization-first"><a class="toclink" href="../../2022/08/09/an-agile-refresh-of-the-passwordless-strategy/#start-application-authentication-modernization-first">Start application authentication modernization first</a></h4>
<p>To further emphasize the importance, the arrow for application modernization actually starts a bit before passwordless deployment on purpose. While the reality is that many applications will be starting these in tandem as a passwordless initiative, it‚Äôs important to understand that support for modern authentication will benefit the application <strong>regardless</strong> of which methods of passwordless are used. There are several other benefits of application modernization, not just limited to passwordless, including:</p>
<ul>
<li>Ability to leverage Azure AD technologies for authentication, such as<ul>
<li>Conditional Access</li>
<li>Device Compliance Requirements</li>
<li>Azure AD Identity Protection</li>
<li>Microsoft Defender for Cloud Apps</li>
</ul>
</li>
<li>Decouples application from legacy identity stores, setting it up to be closer to running in a cloud-native PaaS environment</li>
<li>Support for Azure AD Application Proxy</li>
</ul>
<p>As we continue to shift towards cloud-native solutions designed to be accessed by everyone from everywhere, it is not just solving for passwordless anymore, and organizations can find themselves either ahead of or behind the ball with supporting modern forms of authentication, such as SAML or OpenID Connect (OIDC).</p>
<h3 id="final-thoughts"><a class="toclink" href="../../2022/08/09/an-agile-refresh-of-the-passwordless-strategy/#final-thoughts">Final thoughts</a></h3>
<p>Passwordless deployments, for many organizations, are a litmus test for how well the organization adopts to organizational change and technology advancements. They also are a potential pain point between the C-suite and technology staff, in both directions. Organizations can suffer from technology staff not properly articulating the business value in going passwordless, and what business assets passwordless will protect ‚Äì these days it‚Äôs more than just implementing ‚Äúall the things‚Äù without any concern for the relative value to the business. On the other hand, passwordless is a complex topic that is tough to translate and isn‚Äôt always well received by the C-suite. Considering that some organizations still suffer from executives who don‚Äôt want MFA because it‚Äôs a burden, we have a lot of organizational change that needs to happen across the board. When organizations can implement passwordless to the further extent possible, the net effect is the organization is that much more protected than implementing nothing at all.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-07-14 00:00:00+00:00">July 14, 2022</time></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="authenticator-app-ios-multiple-passwordless-account-support-is-here"><a class="toclink" href="../../2022/07/14/authenticator-app-ios-multiple-passwordless-account-support-is-here/">Authenticator App: IOS Multiple Passwordless Account Support Is Here!</a></h2>
<p>For anyone who lives in a world of multiple Azure AD accounts and the Authenticator App, you can finally rejoice over not having to make the difficult decision over which account is the one you enable for passwordless‚Ä¶ or potentially not having to carry multiple devices.</p>
<p>To date, you could enroll one Azure AD account and one personal Microsoft Account (MSA) for passwordless in the Authenticator App. Even with multiple Azure AD accounts in the same tenant, only one could go passwordless.</p>
<p>With this update, not only can you go passwordless for multiple accounts in the same Azure AD tenant, but across multiple tenants as well.</p>
<h3 id="enabling-the-preview"><a class="toclink" href="../../2022/07/14/authenticator-app-ios-multiple-passwordless-account-support-is-here/#enabling-the-preview">Enabling the preview</a></h3>
<p>First you‚Äôll want to make sure you have the latest version of the MS Authenticator App from the Apple App Store, which you can check here, <a href="https://apps.apple.com/us/app/microsoft-authenticator/id983156458">Microsoft Authenticator on the App Store (apple.com)</a>.</p>
<p>Per Microsoft, you‚Äôll also need to enable a usage data setting within the Settings of the Authenticator App. You can do this by opening the hamburger menu in the upper left, and select <strong>Settings</strong>.</p>
<p>Within settings, you‚Äôll want to enable <strong>Usage Data</strong> (the screenshot shows it disabled, but you need to enable it). The associated MS Docs article is here, <a href="https://docs.microsoft.com/en-us/azure/active-directory/authentication/howto-authentication-passwordless-phone#multiple-accounts-on-ios-preview">Passwordless sign-in with Microsoft Authenticator ‚Äì Azure Active Directory ‚Äì Microsoft Entra | Microsoft Docs</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In my testing I found you need to force quit the Authenticator App after enabling Usage Data to allow for multiple account enrollment.</p>
</div>
<p><img alt="Figure 1" src="/images/2022/07/14/img1.png" /></p>
<h3 id="multiple-passwordless-accounts-in-the-same-azure-ad-tenant"><a class="toclink" href="../../2022/07/14/authenticator-app-ios-multiple-passwordless-account-support-is-here/#multiple-passwordless-accounts-in-the-same-azure-ad-tenant">Multiple passwordless accounts in the same Azure AD tenant</a></h3>
<p>On each additional account you want to go passwordless, select the account in the Authenticator App, and choose <strong>Enable phone sign-in</strong>. This is the same as the experience to enable for the first account, with an exception that you do not need to register the device again.</p>
<p><img alt="Figure 2" src="/images/2022/07/14/img2.png" /></p>
<p>You‚Äôll see that the device indicates it is already registered, just select Continue.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>You will be prompted to perform MFA if you have not recently authenticated on the device.</p>
</div>
<h3 id="multiple-passwordless-accounts-in-different-azure-ad-tenants"><a class="toclink" href="../../2022/07/14/authenticator-app-ios-multiple-passwordless-account-support-is-here/#multiple-passwordless-accounts-in-different-azure-ad-tenants">Multiple passwordless accounts in different Azure AD tenants</a></h3>
<p>If your accounts exist across multiple Azure AD tenants, you can still initiate it through the same process as above, select the additional account, and select <strong>Enable phone sign-in</strong>. During this process, the device will just require you to register it within that second Azure AD tenant.</p>
<p>After device registration is completed, passwordless will be enabled for both accounts in both tenants.</p>
<p>We can examine this within the Authenticator App, by browsing to <strong>Settings</strong>, <strong>Device Registration</strong>, where we see the tenants the device is registered with.</p>
<p><img alt="Figure 3" src="/images/2022/07/14/img3.png" /></p>
<p>You can drill further into each tenant within the settings, see the Device ID, and optionally unregister the device from said tenant.</p>
<p>If the device is unregistered from an Azure AD tenant, the associated accounts will automatically be disabled for passwordless on it.</p>
<p>Note that the Device ID is unique per Azure AD tenant.</p>
<p><img alt="Figure 4" src="/images/2022/07/14/img4.png" /></p>
<h3 id="the-experience"><a class="toclink" href="../../2022/07/14/authenticator-app-ios-multiple-passwordless-account-support-is-here/#the-experience">The experience</a></h3>
<p>I‚Äôve been testing this experience in a private preview for a while now, and I‚Äôll say it‚Äôs been as smooth as one could want. Naturally, as the private preview recommends not using preview software for production use, I immediately installed it on my primary iPhone and enabled all of my Azure AD accounts for passwordless. I currently have multiple accounts enabled for passwordless across three Azure AD tenants, to which I‚Äôve authenticated multiple times a week, and an issue has not arisen.</p>
<h3 id="final-thoughts"><a class="toclink" href="../../2022/07/14/authenticator-app-ios-multiple-passwordless-account-support-is-here/#final-thoughts">Final thoughts</a></h3>
<p>This is a simple yet fantastic step forward in the passwordless journey by Microsoft; while not everyone out there has multiple Azure AD accounts, for those of us that do, we finally don‚Äôt have to make choices anymore.</p>
<p>For organizations out there who have not gone passwordless, because of concerns about push notification fatigue, now is the time to enable push notifications and allow for passwordless authentication for our end users. With the addition of number matching and additional context, we can protect our organizations from accidental notification approval, which I cover here, <a href="https://ericonidentity.com/2022/02/22/azure-ad-increasing-security-within-the-mfa-experience/">Azure AD: Increasing Security within the MFA Experience ‚Äì Eric on Identity</a>.</p>
<p>To provide a great user experience, we need to not lock our users into a singular means of strong authentication, and allowing users to choose the <strong>strong</strong> authentication experience that works best for them promotes better end user habits and better organizational security.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-06-16 00:00:00+00:00">June 16, 2022</time></li>
        
        
          
          <li class="md-meta__item">
            
              10 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="azure-ad-which-sso-is-the-right-sso"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/">Azure AD: Which SSO Is The Right SSO?</a></h2>
<p>It‚Äôs great having choices, except when you are not sure which choice to make.</p>
<p>For organizations that are on a hybrid journey with Azure AD, the question of single sign-on (SSO) almost always comes up. And with that, people turn to the documentation with questions. Do we need hybrid join? Do we need Azure AD Seamless SSO? Do we need both? Can we configure both? Why isn‚Äôt hybrid join listed as an SSO mechanism in the docs? If hybrid join is preferred, why does Azure AD Seamless SSO mention seamless, isn‚Äôt it better?</p>
<p>While there is one paragraph contrasting the two choices in the docs, <a href="https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso#sso-via-primary-refresh-token-vs-seamless-sso">Azure AD Connect: Seamless Single Sign-On ‚Äì Microsoft Entra | Microsoft Docs</a>, the question still comes up often. Which brings us here ‚Äì gaining clarity on the SSO choices for Azure AD. To keep the article focused, we are going to be exploring SSO for corporate owned and managed Windows devices that are joined to an Active Directory domain.</p>
<p>And for the camp out there that firmly believes everything should just go straight to Azure AD Join (AADJ), and forget hybrid‚Ä¶ this article is for those that have their reasons to stay with hybrid join for the moment. Even though you should go cloud-native with AADJ.</p>
<h3 id="sso-mechanics"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#sso-mechanics">SSO mechanics</a></h3>
<p>Before getting into the compare and contrast, it‚Äôs important to understand the fundamental reason as to why SSO works differently depending on the method implemented.</p>
<h4 id="azure-ad-hybrid-join"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#azure-ad-hybrid-join">Azure AD Hybrid Join</a></h4>
<p>When you think of Azure AD Hybrid Join (HAADJ), it helps to think of the Windows device having a duality of identity for the signed-in user.</p>
<p><img alt="Figure 1" src="/images/2022/06/16/img1.png" /></p>
<p>When a user signs in to Windows, not only does the user receive a Kerberos TGT from Active Directory, but also an Azure AD Primary Refresh Token (PRT).</p>
<p>And this PRT piece is key ‚Äì while the technology behind it is quite different, it‚Äôs logically the Azure AD version of the TGT, which allows your device to speak modern authentication natively with Azure AD.</p>
<p>For an extremely in-depth look at all the mechanics at play for authentication on a hybrid joined device, and how obtaining a PRT flows, see <a href="https://docs.microsoft.com/en-us/azure/active-directory/devices/concept-primary-refresh-token#detailed-flows">Primary Refresh Token (PRT) and Azure AD ‚Äì Azure Active Directory ‚Äì Microsoft Entra | Microsoft Docs</a>.</p>
<h4 id="azure-ad-seamless-sso"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#azure-ad-seamless-sso">Azure AD Seamless SSO</a></h4>
<p>Unlike Hybrid Join, Azure AD Seamless SSO flips things around, and essentially provides the ability for Azure AD to participate in Active Directory, not from an authentication provider perspective, but as a member computer object.</p>
<p><img alt="Figure 2" src="/images/2022/06/16/img2.png" /></p>
<p><em>Courtesy Microsoft Learn</em></p>
<p>From the diagram, we see that Azure AD has a computer account representation in Active Directory, with the computer object <strong>AZUREADSSO</strong> being the representation in AD. Azure AD holds the Kerberos decryption key for this computer object, which is what allows Azure AD to handle the TGT being passed to it.</p>
<p>The most critical piece within this model for SSO, is that line-of-sight of Active Directory is <strong>required</strong> for SSO to function.</p>
<h3 id="sso-breakdown"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#sso-breakdown">SSO Breakdown</a></h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Azure AD Hybrid Join</th>
<th>Azure AD Seamless SSO</th>
</tr>
</thead>
<tbody>
<tr>
<td>Configured with Azure AD Connect</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>Requires AD line-of-sight for configuration</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>No group policy needed for core config</td>
<td>‚úÖ</td>
<td>‚ùå</td>
</tr>
<tr>
<td>No computer object sync to Azure AD</td>
<td>‚ùå</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>No browser plugin needed for Edge</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>No browser plugin needed for Chrome</td>
<td>‚ùå</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>No browser plugin needed for Firefox</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>Deployment is non-disruptive to users</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>Supports Windows 8.1</td>
<td>‚ö†Ô∏è</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>Supports Windows 10</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>Supports Windows 11</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>Uses Active Directory for Authentication</td>
<td>‚ùå</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>Uses Azure AD for Authentication</td>
<td>‚úÖ</td>
<td>‚ùå</td>
</tr>
<tr>
<td>Works without AD line-of-sight</td>
<td>‚úÖ</td>
<td>‚ùå</td>
</tr>
<tr>
<td>No Kerberos decryption key to rollover</td>
<td>‚úÖ</td>
<td>‚ùå</td>
</tr>
<tr>
<td>Is completely Seamless SSO</td>
<td>‚úÖ</td>
<td>‚ö†Ô∏è</td>
</tr>
</tbody>
</table>
<h4 id="configuration"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#configuration">Configuration</a></h4>
<p>Whether it‚Äôs Hybrid Azure AD Join, or Azure AD Seamless SSO, both are first enabled primarily using Azure AD Connect.</p>
<p>For details on enablement of Hybrid Azure AD Join, see <a href="https://docs.microsoft.com/en-us/azure/active-directory/devices/howto-hybrid-azure-ad-join">Configure hybrid Azure Active Directory join ‚Äì Microsoft Entra | Microsoft Docs</a>.</p>
<p>For details on enablement of Azure AD Seamless SSO, see <a href="https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso-quick-start">Azure AD Connect: Seamless Single Sign-On ‚Äì quickstart ‚Äì Microsoft Entra | Microsoft Docs</a>.</p>
<h4 id="active-directory-line-of-sight-for-client-enablement"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#active-directory-line-of-sight-for-client-enablement">Active Directory line-of-sight for client enablement</a></h4>
<p>When deploying Azure AD Hybrid Join, it is required that computers have line-of-sight of Active Directory in a PHS or PTA scenario (and usually for ease in a federated scenario). The reason is that Azure AD Connect is the means for Windows to bootstrap its trust relationship with Azure AD ‚Äì when you enable hybrid join, you‚Äôll note that the computer object in scope has the <strong>userCertificate</strong> attribute in Active Directory populated. This is the public half of a key-pair generated by the Windows device, which makes it way up to Azure AD, via Azure AD Connect, and is tied to the created device object in Azure AD. When you see a device with a Registered date/time of <strong>Pending</strong>, it means the device has been created in Azure AD, but the Windows client itself hasn‚Äôt finished the hybrid join process. Now that we have the means for a trust relationship to be established, the Windows client uses this key-pair to connect to Azure Active Directory Device Registration Service (AAD DRS); the key-pair used is replaced with a permanent key-pair, and hybrid join is complete. <strong>Afterward</strong>, line-of-sight of Active Directory is not required for authentication to Azure AD, even though you still will want to keep your hybrid joined devices in scope for Azure AD Connect, so that device disable and device delete actions will flow up to Azure AD.</p>
<p>For Azure AD Seamless SSO, you‚Äôll always need AD line-of-sight for this to function, and many orgs tend to use group policy to roll out the configuration, which also would need that same line-of-sight.</p>
<h4 id="group-policy-for-client-configuration"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#group-policy-for-client-configuration">Group policy for client configuration</a></h4>
<p>For rollout of Azure AD Hybrid Join across an organization, there is no need to configure anything additional through group policy. This is because, by default, configuration of HAADJ leverages a Service Connection Point (SCP) in Active Directory. Because the SCP is stored in the Configuration partition in AD, this is the reason configuration of Hybrid Join requires Enterprise Administrator. And while your Azure AD Connect server <strong>should</strong> be treated as Tier 0, if you have concern using an Enterprise Admin account on the Azure AD Connect server, a script can be downloaded to configure and run this from another system. The exception to no group policy is for organizations which are performing a targeted rollout of HAADJ, even though you can also control rollout by excluding devices from synchronization in Azure AD Connect.</p>
<p>For Azure AD Seamless SSO, there are group policy settings that are inevitably needed regardless of the rollout plan. By default, browsers will not send Kerberos tickets to an internet endpoint, so configuration on the client is required to set an Azure AD URL to Intranet zone. And yes, you may be able to use alternatives such as Intune to push these settings to clients, but it still comes down to needing to push a configuration change to clients.</p>
<h4 id="azure-ad-computer-object-sync"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#azure-ad-computer-object-sync">Azure AD computer object sync</a></h4>
<p>Now, some may consider this an advantage, not having to synchronize their computer objects to Azure AD for Azure AD Seamless SSO.</p>
<p>Many organizations, however, going down the modern device management route, or wanting to strengthen their security posture in conditional access with policies based on compliance or hybrid join, will need to sync their computer objects, as part of the requirement for hybrid join (excluding organizations with AD FS in place). And if you‚Äôre looking to go passwordless with Windows Hello for Business on these devices, hybrid join is also a prerequisite.</p>
<p>And considering what a non-event it is to enable hybrid join, it‚Äôs hard to argue against it.</p>
<h4 id="browser-support"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#browser-support">Browser Support</a></h4>
<h5 id="edge"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#edge">Edge</a></h5>
<p>Neither method of SSO requires anything additional in Edge.</p>
<h5 id="chrome"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#chrome">Chrome</a></h5>
<p>For Chrome to be able to take advantage of the PRT with hybrid join (or Azure AD Join), and subsequently perform SSO using the PRT, you‚Äôll want to install the Windows Accounts extension in Chrome, <a href="https://chrome.google.com/webstore/detail/windows-accounts/ppnbnpeolgkicgegkbkbjmhlideopiji/related?hl=en-US">Windows Accounts ‚Äì Chrome Web Store (google.com)</a>.</p>
<p>Azure AD Seamless SSO does not require this browser extension, as Chrome has long supported integrated authentication.</p>
<h5 id="firefox"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#firefox">Firefox</a></h5>
<p>Mozilla, likely in a move to keep Firefox competitive, released an update starting with version 91 to support PRT authentication natively within the browser, <a href="https://support.mozilla.org/en-US/kb/windows-sso">Windows SSO | Firefox Help (mozilla.org)</a>.</p>
<p>Like Chrome, Firefox has long had support for integrated authentication, so it‚Äôs able to handle Azure AD Seamless SSO without a plugin.</p>
<h4 id="os-support"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#os-support">OS Support</a></h4>
<h5 id="windows-1011"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#windows-1011">Windows 10/11</a></h5>
<p>As noted in the article highlighted earlier, <a href="https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso#sso-via-primary-refresh-token-vs-seamless-sso">Azure AD Connect: Seamless Single Sign-On ‚Äì Microsoft Entra | Microsoft Docs</a>, recommendation for these modern versions of Windows is to use hybrid join and subsequently a PRT for SSO.</p>
<h5 id="windows-81"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#windows-81">Windows 8.1</a></h5>
<p>If, for some unfortunate reason, you still have Windows 8.1 (or no longer supported Windows 7 or 8) in your environment, and still want all the snazziness of letting decrepit operating systems enjoy the cloud, Azure AD Seamless SSO is going to be the easier bet. Hybrid Join for downlevel devices requires installation of the Workplace Join agent and some additional configuration to support hybrid join.</p>
<h4 id="end-user-experience"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#end-user-experience">End-user experience</a></h4>
<p>From the end user experience, hybrid join is going to give our users what is Azure AD native SSO. The user signs in to Windows, and they receive or refresh their Azure AD PRT, and off they go. When browsing, the user won‚Äôt be prompted to enter their username or password, and will just be right into their applications.</p>
<p>Azure AD Seamless SSO, on the other hand, has a few specifics about what SSO looks like. When a user goes to access an application the first time, they will be prompted to enter their username, but shouldn‚Äôt be asked for their password. There are ways to work around this with altering the URL to contain a login hint, but it generally would not be intuitive for a user. Also, if a user chooses to sign out from an application tied to Azure AD, upon sign-in, they are required to enter their password ‚Äì this is considered by design. But even if we look past these, when our user is away from the corporate network, they will be asked to enter their password. And asking our users to have to enter their password when we can provide the means not to, isn‚Äôt the best for our user experience, and isn‚Äôt the best for security.</p>
<h4 id="maintenance"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#maintenance">Maintenance</a></h4>
<p>For hybrid join, there is potential maintenance in needing to restructure how OU‚Äôs are synchronized with Azure AD Connect, though generally many organizations find ways to make this a bit of a one and done scenario.</p>
<p>For Azure AD Seamless SSO, it is recommended that organizations rollover the Kerberos decryption key stored in Azure AD for the <strong>AZUREADSSO</strong> computer object every 30 days. This has to be performed manually, or automated through a process that though subsequently requires providing some task Domain Administrator credentials. Less than ideal, but because Azure AD isn‚Äôt able to directly perform this process against AD, we are left with no other choice.</p>
<h3 id="so-which-sso-is-the-right-sso"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#so-which-sso-is-the-right-sso">So which SSO is the right SSO?</a></h3>
<p>If your organization is primarily Windows 10/11 devices that are AD domain joined, <strong>Azure AD Hybrid Join</strong> is the route to go. To be clear, <strong>you do not</strong> need to deploy Azure AD Seamless SSO along with hybrid join; your clients <strong>will not</strong> use Azure AD Seamless SSO if the device has a PRT.</p>
<p>If you have to support downlevel installs of Windows 8.1, Seamless SSO may be an easier route than hybrid join, and you can enable seamless SSO and just target those devices for configuration.</p>
<p>Likewise, if you are supporting MacOS in your environment, enabling Azure AD Seamless SSO can provide a better authentication experience if those Macs are Active Directory domain joined. Even though at this point you may want to look at the Enterprise SSO plugin for MacOS, <a href="https://docs.microsoft.com/en-us/mem/intune/configuration/use-enterprise-sso-plug-in-ios-ipados-macos">Microsoft Enterprise SSO plug-in in Microsoft Intune | Microsoft Docs</a>.</p>
<p>There‚Äôs no harm in having both methods configured, but if the mechanism for Seamless SSO isn‚Äôt actually being leveraged in your environment, and if you have hybrid joined Windows 10/11 devices <strong>it‚Äôs not</strong>, it‚Äôs just an extra bit of configuration to manage and maintain with no benefit.</p>
<h4 id="what-about-federated-identity"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#what-about-federated-identity">What about federated identity?</a></h4>
<p>If an organization has AD FS or a supported 3rd party IdP in the mix, such as PingFederate or Okta, the proper route to go, from an Azure AD perspective, is still hybrid join.</p>
<p>Hybrid join is still going to provide you SSO with your PRT for applications leveraging Azure AD as their identity provider ‚Äì when you authenticate interactively with the Windows client at sign-on, WS-Trust is the means to authenticate you to your federated identity provider behind the scenes, and in return allowing Azure AD to give you a fresh PRT.</p>
<p>The MS Docs articles indicate that Seamless SSO is not supported with federated identity, and I‚Äôve never tried to see what happens if you force it via PowerShell module ‚Äì but would presume you run into conflicts with overlap in how Azure AD handles hints for bypassing username entry for Seamless SSO and how Azure AD handles hints for bypassing username entry for federated auth.</p>
<h4 id="what-about-azure-ad-join"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#what-about-azure-ad-join">What about Azure AD join?</a></h4>
<p>Azure AD Join (AADJ) should be the long-term goal for organizations, going cloud native and removing their clients dependency on Active Directory. Under the hood, the mechanics of authentication for AADJ are <strong>just</strong> the bits that give you that Azure AD PRT, and Azure AD is now the authoritative identity provider for those clients. For many organizations, it tends to be client management and group policies that lend the most complexity in going cloud native, even though it is the future, so now is as good as ever to start a pilot down that road while you continue to support existing clients with Hybrid Azure AD Join.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-05-04 00:00:00+00:00">May 4, 2022</time></li>
        
        
          
          <li class="md-meta__item">
            
              7 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="world-password-day"><a class="toclink" href="../../2022/05/04/world-password-day/">World Password Day</a></h2>
<p>Forget passwords. Passwords are garbage. To celebrate World Password Day, I‚Äôm curating blog articles that can help organizations on their passwordless journey.</p>
<p>While much of the Microsoft documentation on passwordless is quite good, it can tend to be overwhelming at times; the hope is to give you some great leads on some clear, step-by-step instructions on how to get you from a password-filled to a passwordless world in Active Directory and Azure AD.</p>
<p>With each link, I‚Äôve provided a rough time estimate for how long the process should take, given a dedicated effort. There may always be the fringe case or two where passwordless is more complex ‚Äì if your existing environment has things such as AD FS and using smartcards, or has DC‚Äôs older than 2016, you have a bunch of Macs in your environment, as examples. It always helps to review the documentation, which I also link to.</p>
<p>If you want to dive further into why this is so important, I‚Äôll refer you to these two blog articles from Alex Weinert [<a href="https://twitter.com/Alex_T_Weinert">@Alex_T_Weinert</a>], the Director of Identity Security at Microsoft.</p>
<p><a href="https://techcommunity.microsoft.com/t5/azure-active-directory-identity/your-pa-word-doesn-t-matter/ba-p/731984">Your Pa$$word doesn‚Äôt matter ‚Äì Microsoft Tech Community</a> ‚Äì Alex discusses why MFA is so important.</p>
<p><a href="https://techcommunity.microsoft.com/t5/azure-active-directory-identity/all-your-creds-are-belong-to-us/ba-p/855124">All your creds are belong to us! ‚Äì Microsoft Tech Community</a> ‚Äì Alex discusses why passwordless strong authentication is important and shows why more common forms of MFA are still phishable.</p>
<p>See something missing? Still have questions? Not sure how the underlying technology works? Reach out to me.</p>
<p>And if you are a fellow Microsoft blogger who thinks their article would be a good fit, but it‚Äôs not on here? Reach out and I‚Äôll update accordingly.</p>
<h3 id="but-i-havent-started-the-passwordless-journey-yet"><a class="toclink" href="../../2022/05/04/world-password-day/#but-i-havent-started-the-passwordless-journey-yet">But I haven't started the passwordless journey yet</a></h3>
<p>You aren‚Äôt alone. Many organizations find it difficult to fit yet another new project onto the docket.</p>
<p>The thing about passwordless ‚Äì while it may be a journey, it‚Äôs also one of the easiest journeys to start. All major mechanisms of passwordless ‚Äì Windows Hello for Business (WHfB), FIDO2 security keys, Authenticator App for primary authentication, and smartcards ‚Äì they all can be implemented in a wave/phase/ring (pick your favorite descriptor) approach. And the underlying directory &amp; infrastructure changes (if any) can be implemented in a non-disruptive manner.</p>
<p>Can‚Äôt get the whole organization onboard? That‚Äôs ok, x% is better than 0%.</p>
<p>Don‚Äôt have biometrics on all your devices? WHfB has PIN support.</p>
<p>End-users not wanting to MDM enroll their devices? Authenticator App only requires Device Registration.</p>
<p>FIDO2 feel odd or uncomfortable? It‚Äôs essentially modern smartcards.</p>
<p>Have some applications that still use legacy means of authentication? Most organizations do, but we can minimize the need to use passwords beyond them.</p>
<p>Concerned users may still use their password because you can‚Äôt fully get rid of it? When we give users an easier passwordless experience, they will not opt for something more complex. Users love easy things.</p>
<p>When talking about the security of identity, the <strong>most important thing</strong> we can all do is <strong>change our mindset</strong>. Instead of focusing on the possibility that a single solution may not cover 100% of user personas, we need to focus on whatever percentage we <strong>can</strong> cover, which will <strong>reduce</strong> the <strong>password attack surface</strong> immensely for those users, and our organization.</p>
<h3 id="authenticator-app-for-primary-authentication"><a class="toclink" href="../../2022/05/04/world-password-day/#authenticator-app-for-primary-authentication">Authenticator App for primary authentication</a></h3>
<p><strong>Infrastructure effort: 5-10 minutes</strong>
<strong>End user enrollment effort: 5-10 minutes</strong>
<strong>Can be rolled out selectively: Yes</strong>
<strong>Can be enabled on an end user without forcing them to enroll: Yes</strong></p>
<p>Lots of folks might be familiar with the Microsoft Authenticator App, but did you know you can use it for passwordless authentication? You can. It‚Äôs great for when users need to be passwordless when accessing company resources from a mobile device, or when they are on the go and need to auth through a web browser.</p>
<p>Jason Samuel [<a href="https://twitter.com/_JasonSamuel">@_JasonSamuel</a>] has a good write-up here covering enablement. He also gets into Citrix Workspace stuff, but even if you don‚Äôt have Citrix in your environment, the other parts are written straightforward:</p>
<p><a href="https://www.jasonsamuel.com/2019/03/04/how-to-setup-password-less-phone-sign-in-authentication-with-microsoft-authenticator-azure-ad-and-citrix-workspace/">How to setup password-less phone sign-in authentication with Microsoft Authenticator, Azure AD, and Citrix Workspace ‚Äì JasonSamuel.com</a></p>
<p>Microsoft Docs article for reference can be found here:</p>
<p><a href="https://docs.microsoft.com/en-us/azure/active-directory/authentication/howto-authentication-passwordless-phone">Passwordless sign-in with the Microsoft Authenticator app ‚Äì Azure Active Directory | Microsoft Docs</a></p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>If you are also using the number matching preview for Authenticator App push notifications, the passwordless configuration is covered under the same settings in Azure AD. If you are using groups to selectively roll out these settings, I cover targeting groups here:</p>
<p><a href="https://ericonidentity.com/2022/02/22/azure-ad-increasing-security-within-the-mfa-experience/">Azure AD: Increasing Security within the MFA Experience ‚Äì Eric on Identity</a></p>
</div>
<h3 id="fido2-security-keys"><a class="toclink" href="../../2022/05/04/world-password-day/#fido2-security-keys">FIDO2 Security Keys</a></h3>
<p><strong>Infrastructure effort: 20 minutes for AADJ devices. 40 minutes for HAADJ devices.</strong>
<strong>End user enrollment effort: 5-10 minutes</strong>
<strong>Can be rolled out selectively: Yes</strong>
<strong>Can be enabled on an end user without forcing them to enroll: Yes</strong></p>
<p>FIDO2 security keys are the latest and greatest thing ‚Äì it‚Äôs based on asymmetric cryptography ‚Äì what we generally refer to as certificates (even though a key is a piece within a certificate).</p>
<p>Many organizations that have never operated in a highly secure environment where smartcards are prevalent may find the idea of a device containing a certificate for authentication seeming a bit odd. But we should look at FIDO2 security keys as smartcard 2.0 ‚Äì it‚Äôs all the great security features of smartcards, but packed and managed in a way that makes it easier to manage from both the IT and end-user side.</p>
<p>For a great deep dive on how FIDO2 works, look at this article by Dominik Hoefling [<a href="https://twitter.com/DominikHoefling">@DominikHoefling</a>]:</p>
<p><a href="https://practical365.com/understanding-how-fido-makes-passwordless-authentication-possible/">Understanding How FIDO Makes Passwordless Authentication Possible (practical365.com)</a></p>
<p>To see how to configure your environment to support FIDO2 for Azure AD Joined devices, Peter Klapwijk [<a href="https://twitter.com/inthecloud_247">@inthecloud_247</a>] has us covered. He uses Feitian keys but any supported FIDO2 key will work:</p>
<p><a href="https://www.inthecloud247.com/enable-passwordless-authentication-to-windows-10-with-feitian-security-keys/">Enable passwordless authentication to Windows 10 with Feitian security keys | (inthecloud247.com)</a></p>
<p>Peter also has a great article covering the same, but for Hybrid Azure AD Join:</p>
<p><a href="https://www.inthecloud247.com/enable-passwordless-security-key-sign-in-in-hybrid-azure-active-directory-environments/">Enable passwordless security key sign-in in Hybrid Azure Active Directory environments | (inthecloud247.com)</a></p>
<p>Microsoft Docs articles for reference can be found here:</p>
<p><a href="https://docs.microsoft.com/en-us/azure/active-directory/authentication/howto-authentication-passwordless-security-key">Passwordless security key sign-in ‚Äì Azure Active Directory | Microsoft Docs</a></p>
<p><a href="https://docs.microsoft.com/en-us/azure/active-directory/authentication/howto-authentication-passwordless-security-key-windows">Passwordless security key sign-in Windows ‚Äì Azure Active Directory | Microsoft Docs</a></p>
<p><a href="https://docs.microsoft.com/en-us/azure/active-directory/authentication/howto-authentication-passwordless-security-key-on-premises">Passwordless security key sign-in to on-premises resources ‚Äì Azure Active Directory | Microsoft Docs</a></p>
<h3 id="windows-hello-for-business"><a class="toclink" href="../../2022/05/04/world-password-day/#windows-hello-for-business">Windows Hello for Business</a></h3>
<p><strong>Infrastructure effort: 20 minutes [Azure AD Join Cloud Trust], 1-2 hours [Hybrid Cloud Trust], 2 hours-3 days [Hybrid Key Trust]</strong>
<strong>End user enrollment effort: 2-5 minutes (plus 30-60 usability delay for Hybrid Key Trust)</strong>
<strong>Can be rolled out selectively: Yes</strong>
<strong>Can be enabled on an end user without forcing them to enroll: No</strong>
<em>There are mechanisms that can delay end-user enrollment, but the complexity usually is not worth the effort</em></p>
<p>Windows Hello for Business. It‚Äôs like Face ID, for Windows. Or is Face ID like Windows Hello for Business, but for iOS??</p>
<p>If you don‚Äôt have a fancy camera, it also works with your fingerprint. And if you have no fancy biometric thingies, you can use it with just a PIN. But wait, isn‚Äôt a PIN the same as a password? <strong>NO</strong>. The PIN is entropy to unlock the key/certificate that is stored on the TPM chipset on your device. It‚Äôs never emitted beyond the device. And yes, you always must create a PIN ‚Äì the same way you always must create a PIN for mobile devices as backup for biometric‚Ä¶ just in case.</p>
<p>Also ‚Äì if you are rolling out Hybrid Key Trust, you <strong>do not, I repeat, do not, need any premium licenses</strong>. The issue many organizations have theoretically faced is that to enroll in WHfB, you hit the part where you need to perform MFA, and organizations that do not have P1+/EMS E3+/M365 E3+ (and the variants) believe that they cannot use MFA. That is not the case. You need premium licensing when certain things are calling for MFA ‚Äì such as per-user enablement (which is an O365 license thing), or more commonly thought of, conditional access. When Azure AD calls for MFA for WHfB enrollment, that MFA call is <strong>free</strong>. Considering that security defaults, which are also free, call for MFA potentially, this should be less of a concern. But it‚Äôs always been a huge point of confusion. I learned about this in excruciating detail when I worked at Microsoft, rolling out WHfB with customers. Based on what I can gather regarding Hybrid Cloud Trust, I would say the case is the same. /endrant</p>
<p>If you have Azure AD Joined devices and are looking to go cloud-only, Janusz Gal [<a href="https://twitter.com/JanuszGal">@JanuszGal</a>] has you covered with his article here:</p>
<p><a href="https://deviceadvice.io/2020/06/22/how-to-set-up-windows-hello-for-business-for-cloud-only-devices/">How to set up Windows Hello for Business for cloud-only devices ‚Äì Device Advice</a></p>
<p>If you want to ensure that those devices can still reach Active Directory based resources, look no further than this article by Ben Whitmore [<a href="https://twitter.com/byteben">@byteben</a>] and Michael Mardahl [<a href="https://twitter.com/michael_mardahl?lang=en">@michael_mardahl</a>]:</p>
<p><a href="https://msendpointmgr.com/2021/08/15/sso-to-domain-resources-from-azure-ad-joined-devices-the-mega-series/">SSO to domain resources from Azure AD Joined Devices ‚Äì The MEGA Series ‚Äì Part 1 ‚Äì Overview ‚Äì MSEndpointMgr</a></p>
<p>For rolling out what previously was (and technically still is, because Cloud Trust is in Public Preview) the recommended path for hybrid devices, Hybrid Key Trust, check out this article by Brooks Peppin [<a href="https://twitter.com/brookspeppin">@brookspeppin</a>]:</p>
<p><a href="https://www.brookspeppin.com/2021/08/13/how-to-setup-windows-hello-for-business-key-trust-method/">How to Setup Windows Hello for Business (Key-Trust Method!) ‚Äì Brooks Peppin‚Äôs Blog</a></p>
<p>For what will eventually become the recommended path for hybrid devices, Hybrid Cloud Trust, see this article by Pim Jacobs [<a href="https://twitter.com/pimjacobs89">@pimjacobs89</a>]:</p>
<p><a href="https://identity-man.eu/2022/02/17/improving-your-windows-hello-for-business-hybrid-password-less-setup-by-using-cloud-trust/">Improving your Windows Hello for Business Hybrid Password less setup by using Cloud Trust ‚Äì Identity Man (identity-man.eu)</a></p>
<p>If you are curious what it looks like to convert from Hybrid Key Trust to Hybrid Cloud Trust, check out my article:</p>
<p><a href="https://ericonidentity.com/2022/03/23/windows-hello-for-business-hybrid-cloud-trust/">Windows Hello for Business: Hybrid Cloud Trust ‚Äì Eric on Identity</a></p>
<p>And if you are far enough down the passwordless road that you want to take them away from end users, then check out this article I wrote:</p>
<p><a href="https://ericonidentity.com/2021/12/13/living-in-a-passwordless-world-hybrid-identity-and-password-management/">Living in a Passwordless World: Password Management ‚Äì Eric on Identity</a></p>
<p>Microsoft Docs articles for reference can be found here:</p>
<p><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/hello-for-business/hello-aad-join-cloud-only-deploy">Azure Active Directory join cloud only deployment ‚Äì Windows security | Microsoft Docs</a></p>
<p><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/hello-for-business/hello-hybrid-cloud-trust">Hybrid Cloud Trust Deployment (Windows Hello for Business) ‚Äì Windows security | Microsoft Docs</a></p>
<p><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/hello-for-business/hello-hybrid-key-trust">Hybrid Key Trust Deployment (Windows Hello for Business) ‚Äì Windows security | Microsoft Docs</a></p>
<p><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/hello-for-business/hello-hybrid-cert-trust">Hybrid Certificate Trust Deployment (Windows Hello for Business) ‚Äì Windows security | Microsoft Docs</a></p>
<p><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/hello-for-business/hello-hybrid-aadj-sso">Azure AD Join Single Sign-on Deployment ‚Äì Windows security | Microsoft Docs</a></p>
<h3 id="some-great-additional-resources"><a class="toclink" href="../../2022/05/04/world-password-day/#some-great-additional-resources">Some great additional resources</a></h3>
<p>Fabian Bader [<a href="https://twitter.com/fabian_bader">@fabian_bader</a>] has a long series on passwordless:</p>
<p><a href="https://cloudbrothers.info/en/categories/passwordless/">Passwordless ‚Äì Category ‚Äì Cloudbrothers</a></p>
<p>Jan Bakker [<a href="https://twitter.com/janbakker_">@janbakker_</a>] has some quality articles covering FIDO2:</p>
<p><a href="https://janbakker.tech/?s=fido">FIDO ‚Äì JanBakker.tech</a></p>
<p>Harri Jaakkonen[<a href="https://twitter.com/HarriJaakkonen">@HarriJaakkonen</a>] is constantly putting out new articles, and lots that cover passwordless:</p>
<p><a href="https://www.cloudpartner.fi/?s=passwordless">Set-AzWebApp -name ‚ÄúAnything Microsoft and other stuff on the side‚Äù (cloudpartner.fi)</a></p>
<h3 id="final-notes"><a class="toclink" href="../../2022/05/04/world-password-day/#final-notes">Final notes</a></h3>
<p>Passwords will eventually have an expiration date. It‚Äôs better to start the journey away from them now, than get caught behind the ball down the road.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-04-26 00:00:00+00:00">April 26, 2022</time></li>
        
        
          
          <li class="md-meta__item">
            
              6 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="azure-ad-you-should-disable-this-legacy-mfa-setting"><a class="toclink" href="../../2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/">Azure AD: You Should Disable This Legacy MFA Setting</a></h2>
<p>When talking with organizations about securing their Azure AD tenants, there is always a focus on the latest and greatest, and all the ways it brings everyone forward on the Zero Trust journey. Advancements in Conditional Access, Windows Hello for Business, FIDO2 ‚Äì the focus is on what‚Äôs new and where to go. Occasionally there is the reminder to block legacy authentication (speaking of ‚Äì have you?), but the focus tends to be on what‚Äôs new, and not reviewing what‚Äôs old.</p>
<p>There is one setting, however, that tends to lurk deep within Azure AD tenants, especially for organizations that have had their tenant for a long while, that goes unnoticed, and when left enabled, allows users to potentially interfere with what we believe to be their authentication pattern.</p>
<h3 id="whats-the-setting"><a class="toclink" href="../../2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#whats-the-setting">What's the setting?</a></h3>
<p>If we dig into the legacy multi-factor authentication service settings portal, which can be found by browsing to <strong>Azure AD -&gt; Security -&gt; MFA</strong>, and then on the <strong>right</strong>, under <strong>Configure</strong>, select <strong>Additional cloud-based MFA settings</strong>. It will bring you to the following:</p>
<p><img alt="Figure 1" src="/images/2022/04/26/img1.png" /></p>
<p>The setting we are focused on is at the bottom. Under <em>remember multi-factor authentication on trusted device, Allow users to remember multi-factor authentication on devices they trust.</em></p>
<h3 id="whats-the-problem"><a class="toclink" href="../../2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#whats-the-problem">What's the problem?</a></h3>
<p>The name of the setting doesn‚Äôt really explain it well. The Microsoft Docs article that explains the details of this setting can be found here, <a href="https://docs.microsoft.com/en-us/azure/active-directory/authentication/howto-mfa-mfasettings#remember-multi-factor-authentication">Configure Azure AD Multi-Factor Authentication ‚Äì Azure Active Directory | Microsoft Docs</a>.</p>
<p>Even though there is an additional note provided, a lot of organizations don‚Äôt even recall this setting exists ‚Äì either they have never had to come to this set of options to begin with, or it was enabled several years ago and never reviewed again. Unfortunately, this setting is not well exposed in Azure AD.</p>
<p>When enabled in an Azure AD tenant, it allows end-users to make the decision on what a ‚Äútrusted device‚Äù is. The heading for the setting, when glanced over, may make you believe it relates to trusted devices, as in compliant devices. But as we see within the details, the user is making that trust decision.</p>
<p>And the issue with that trust decision, is that it allows the user to choose to drop an MFA persistence cookie, <strong>completely separate</strong> from the refresh token, in the browser.</p>
<p>So even if our user chooses to <strong>sign-out</strong>, and even if they choose in the browser the option to <strong>forget</strong> their username from the sign-in menu, this cookie persists.</p>
<p>The user experience, with this setting enabled, will show the following during sign-in:</p>
<p><img alt="Figure 2" src="/images/2022/04/26/img2.png" /></p>
<p>When enabled, the <strong>Don‚Äôt ask again for 90 days</strong> (or whatever interval is set in your organization) shows up and is checked by default.</p>
<p>On subsequent user sign-in, the user <strong>will not be prompted for MFA</strong>, unless the time specified in the setting has lapsed, or the browser cookies have been cleared.</p>
<p>You will see the following in the Sign-in details:</p>
<p><img alt="Figure 3" src="/images/2022/04/26/img3.png" /></p>
<p>This setting is <strong>not the same</strong> as the <strong>Keep Me Signed In (KMSI)</strong> settings in Azure AD, which allow the user to retain their refresh token in their browser when they close it. The KMSI experience invalidates the token during user sign-out, and upon sign-in provides the expected behavior of calling for both primary authentication and MFA (if there is an MFA requirement).</p>
<h3 id="why-exactly-is-this-a-problem"><a class="toclink" href="../../2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#why-exactly-is-this-a-problem">Why exactly is this a problem</a></h3>
<p>While it may be alluded to above, this setting weakens the security posture regarding MFA. It allows users to subvert when we may be requiring Conditional Access to call for MFA. Now we are not saying our user is doing anything malicious ‚Äì this is a setting we enable and it‚Äôs logical that a user would select this. Users will pick whatever options make getting the job done with the least amount of friction.</p>
<p>If the device is or becomes compromised, the user account will become an easier target to malicious actors. Just think of any device you have the least amount of trust in, which usually is some sort of shared device outside the corporate boundaries, and then allow the user to make the trust decision. It‚Äôs not a great recipe.</p>
<h3 id="determining-the-usage"><a class="toclink" href="../../2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#determining-the-usage">Determining the usage</a></h3>
<p>If you‚Äôve looked at your settings, and you see that this setting is disabled, then you can just stop here.</p>
<p>If you‚Äôve found that this setting is enabled, you want to understand how widespread the usage is before disabling it. The fewer users leveraging it, the swifter the change process.</p>
<p>We want to explore our Azure AD Sign-in logs, however, we cannot filter granularly within the portal.</p>
<p>Using Log Analytics, the following query will help show who, where they are coming from, and the device information. The query is written to highlight distinct devices:</p>
<div class="highlight"><pre><span></span><code>SigninLogs
| where TimeGenerated &gt; ago(30d) //Set time period to within the last 30 days
| where Status.additionalDetails == &quot;MFA requirement skipped due to remembered device&quot; //String to search for
| project UserPrincipalName,IPAddress,OS = tostring(DeviceDetail.operatingSystem),Browser = tostring(DeviceDetail.browser),City = tostring(LocationDetails.city),State = tostring(LocationDetails.state),Country = tostring(LocationDetails.countryOrRegion) //Pull JSON data into strings
| distinct UserPrincipalName,IPAddress,OS,Browser,City,State,Country //Filter for distinct instances
</code></pre></div>
<p>If you do not have access to Log Analytics, you can export your Azure AD Sign-in logs in either CSV or JSON format and parse the data out accordingly, the string you will want to search for is <strong>MFA requirement skipped due to remembered device</strong>.</p>
<h3 id="remediation"><a class="toclink" href="../../2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#remediation">Remediation</a></h3>
<p>I‚Äôll preface that I‚Äôve had dozens of organizations disable this setting with little notice to end-users, and with little disruption to their lives. Many of those organizations did not even search their logs prior to disabling it.</p>
<p>This only impacts browser sessions. Client applications will never present this prompt, regardless of whether the client application is on a mobile device or Windows.</p>
<p>If we are using Windows Hello for Business, FIDO2 security keys, or Authenticator App for Primary Auth, all those mechanisms provide for strong-authentication within them, and are not impacted by this setting.</p>
<p>For Azure AD Joined (AADJ) or Hybrid Azure AD Joined (HAADJ) devices, even if our users are using passwords and are requested to perform MFA, their PRT will obtain an MFA claim within it during the first run, and users will not be frequently prompted for MFA subsequently.</p>
<p>That‚Äôs a long way of saying the impact is usually limited to web browsers on personal devices that have no relationship to the Azure AD tenant. The devices we trust the least.</p>
<p>Once comfortable turning off this setting, it‚Äôs simply a matter of unchecking the box in the MFA service settings portal we examined above.</p>
<h3 id="if-you-want-to-limit-mfa-lifetime"><a class="toclink" href="../../2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#if-you-want-to-limit-mfa-lifetime">If you want to limit MFA lifetime</a></h3>
<p>I‚Äôve encountered some organizations who have this setting enabled, and the number dialed way down. When talking about corporate devices or devices we have insight into, through either MDM, MAM, hybrid trust, or such, it‚Äôs not recommended to limit MFA lifetime. We already have a level of trust established and prompting users frequently for MFA will not only create friction in the user experience, as well as sets our users up to be both more susceptible to MFA phishing (you get trained to just perform MFA without thought) and devise ways around security.</p>
<p>If you have business scenarios that call for the desire to prompt more frequently for MFA, Conditional access offers Sign-in frequency session controls as well as Persistent browser session controls, which can be targeted to non-corporate managed devices. Authentication context also allows for scenarios where we want to call for strong authentication scenarios when users are accessing sensitive information. These settings offer a higher level of precision to target certain scenarios while not negatively impacting the broader user experience.</p>
<h3 id="final-notes"><a class="toclink" href="../../2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#final-notes">Final notes</a></h3>
<p>This setting really has been a carry-over from when we didn‚Äôt have the power available from Conditional Access, and unfortunately, it‚Äôs well hidden in that dusty MFA settings portal almost nobody ever treks into. Lucky for us, it‚Äôs a quick win in the name of security to disable.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-04-21 00:00:00+00:00">April 21, 2022</time></li>
        
        
          
          <li class="md-meta__item">
            
              6 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="azure-ad-cross-tenant-access-settings-clarity"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/">Azure AD: Cross-tenant Access Settings Clarity</a></h2>
<p>With the release of Azure AD cross-tenant access settings, I‚Äôve noted some confusion among folks as to what it <strong>is</strong>, and as importantly, what it <strong>isn‚Äôt</strong>.</p>
<p>I‚Äôll also be covering B2B Direct Connect, because even though it‚Äôs a separate feature, with release coinciding at the same time as cross-tenant access settings, I see it all being lumped ‚Äúinto the same‚Äù set of preview features.</p>
<p>The Microsoft Docs article on this is an excellent source of information, which can be found here, <a href="https://docs.microsoft.com/en-us/azure/active-directory/external-identities/cross-tenant-access-overview">Cross-tenant access overview ‚Äì Azure AD | Microsoft Docs</a>. Along with that, we‚Äôll dive into the background and use cases for this new suite of knobs and dials for our external identities.</p>
<h3 id="terminology"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#terminology">Terminology</a></h3>
<p><strong>Guest</strong> ‚Äì For clarity, when speaking about guest users for the context of this post, we are talking about users invited into your Azure AD tenant.</p>
<p><strong>Resource Azure AD Tenant [Resource Tenant]</strong> ‚Äì If you are inviting guests <strong>into</strong> your Azure AD tenant, <strong>your</strong> tenant is the resource tenant. It represents your organization. If you are a <strong>guest</strong>, then the resource tenant is the tenant you have been invited into.</p>
<p><strong>Home Azure AD Tenant [Home Tenant]</strong> ‚Äì This is the tenant where the user objects live. If your user object exists in your organizations Azure AD tenant, your tenant is <strong>both</strong> the home tenant and resource tenant ‚Äì your users and applications all ‚Äúlive‚Äù in the same place. Guests into your tenant will have a <strong>different</strong> home tenant.</p>
<h3 id="what-it-is-not"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#what-it-is-not">What it is not</a></h3>
<p>Before getting into what we can do with cross-tenant access settings, let‚Äôs cover what this is not (at least at the time of this writing).</p>
<h4 id="parity-to-an-active-directory-trust"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#parity-to-an-active-directory-trust">Parity to an Active Directory trust</a></h4>
<p>Cross-tenant access settings may invoke a feeling of configuring a trust in Active Directory, which many Microsoft identity practitioners may be familiar with.</p>
<p>It is closer to the <strong>opposite</strong> of a trust, in the sense that by default Active Directory has no implicit trusts, and you must explicitly configure trusts. Azure AD historically is opposite, any organization, unless settings are adjusted, can invite users from any Azure AD tenant into the organization. These settings allow us to be more granular in how we <strong>restrict</strong> guest access inbound and outbound to our Azure AD tenant.</p>
<p>Further, when we examine B2B Direct Connect, we realize that the only use case, currently, is Teams shared channels.</p>
<p>When we think of an Active Directory trust, we think of the fact that user objects only exist in the source user forest. With cross-tenant access settings, and the limitations with B2B Direct Connect, we still must invite user objects into our resource tenant ‚Äì all the other ‚Äúthings‚Äù tied to our Azure AD tenant need the objectID within our resource tenant to reference.</p>
<h3 id="what-it-is"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#what-it-is">What it is</a></h3>
<h4 id="a-mechanism-to-provide-granular-b2b-guest-control"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#a-mechanism-to-provide-granular-b2b-guest-control">A mechanism to provide granular B2B guest control</a></h4>
<p>When speaking about B2B guests and external identities, many organizations tend to focus on the aspect of guests being invited <strong>into</strong> their tenant. There is the other side to that B2B coin, which is restricting what organizations you may want your users to have access to.</p>
<p>Certain organizations, especially those in the regulated industries, have concern over which external tenants their users can connect to. Up until now, organizations would need to apply tenant restrictions, <a href="https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/tenant-restrictions">Use tenant restrictions to manage access to SaaS apps ‚Äì Azure AD | Microsoft Docs</a>, which has a higher level of complexity to it ‚Äì the implementation requires a proxy to perform traffic inspection and HTTP header insertion.</p>
<p>Now, organizations that have strict requirements regarding outbound guest access can, by default, restrict outbound access, and then create a more granular allow list.</p>
<p>We also now can be granular down to user/group level of who can access certain organizations. Say you want to only allow employees from payroll to be able to access the tenant the vendor uses and restrict outbound access to everyone else ‚Äì now you can do that.</p>
<p>Likewise, there is granularity on the inbound side. Say you are that vendor that processes an organizations payroll and want to ensure that only the known users for the company you serve can come into your organization. You can restrict inbound as well, limiting what guests are allowed in.</p>
<h4 id="a-way-to-trust-external-mfa-and-device-compliance"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#a-way-to-trust-external-mfa-and-device-compliance">A way to trust external MFA and Device Compliance</a></h4>
<p>Many organizations that are familiar with conditional access and guest policies have encountered the need to enroll in Azure AD MFA twice or more ‚Äì once for their home tenant and once in every other resource tenant they access. This experience, from a user perspective, is less than ideal.</p>
<p>With cross-tenant access settings, we can now choose to trust MFA from the guest users home tenant. We also can be granular ‚Äì if we want to trust MFA from certain tenants, but require MFA enrollment from others, we can do that.</p>
<p>More interestingly, we can now trust device compliance and hybrid join status, from the guest home tenant. While I still have certain reservations about the quality of relying on hybrid join alone, focusing on device compliance, it really opens a lot of cross-tenant collaboration, and brings an innovative approach to leveraging Zero Trust modeling when working with guests. While this still has the requirement that the guest home tenant must be leveraging Intune or a 3rd party MDM that can report in device compliance, it makes this a possibility.</p>
<p>In my own testing, I was able to leverage device compliance in conditional access for a device in a guest tenant, and it worked with ease.</p>
<h3 id="a-few-lingering-questions"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#a-few-lingering-questions">A few lingering questions</a></h3>
<h4 id="where-is-conditional-access-processed"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#where-is-conditional-access-processed">Where is Conditional Access processed?</a></h4>
<p>This hasn‚Äôt changed with the new cross-tenant access settings, but it‚Äôs a good time to review.</p>
<p>Conditional access is <strong>always</strong> evaluated in the <strong>resource</strong> tenant.</p>
<p>The resource tenant needs to ensure that their Conditional Access policies meet the needs of protecting their applications.</p>
<p>Likewise, the home tenant <strong>cannot</strong> restrict outbound access to another tenant with Conditional Access. Because the guest is not accessing resources in their tenant, even an all applications block CA policy will not prevent the user from accessing a resource tenant as a guest ‚Äì which really brings us back to what these new settings solve.</p>
<h4 id="where-is-identity-protection-processed"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#where-is-identity-protection-processed">Where is Identity Protection processed?</a></h4>
<p>User risk is evaluated in the <strong>home</strong> tenant, and sign-in risk is evaluated in the <strong>resource</strong> tenant for B2B users. When firing up Tor, and accessing O365 with a guest, my test user was blocked by Identity Protection in the home tenant because it was flagged as a high user risk. So depending on the sort of threat detected by Identity Protection, you may find users being restricted by both the home and resource tenant when Identity Protection is in play.</p>
<p>The details on this are further elaborated on in the Microsoft Docs article, <a href="https://docs.microsoft.com/en-us/azure/active-directory/identity-protection/concept-identity-protection-b2b#how-does-identity-protection-work-for-b2b-users">Identity Protection and B2B users ‚Äì Azure Active Directory | Microsoft Docs</a>.</p>
<h3 id="one-new-trick-out-of-a-possible-many"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#one-new-trick-out-of-a-possible-many">One new trick - out of a possible many</a></h3>
<h4 id="pim-in-the-home-tenant-for-outbound-guest-access"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#pim-in-the-home-tenant-for-outbound-guest-access">PIM in the home tenant for outbound guest access</a></h4>
<p>The ability to apply PIM to guest user accounts is not new. But if we combine the preview feature of PIM for group membership, and apply outbound restrictions to a certain group, the <strong>home</strong> tenant can build a request process for outbound access.</p>
<p>In that this is quite restrictive, I would see a narrow range of use cases, as it really hampers collaboration between tenants. For those organizations who previously completely turned off the ability to collaborate with other organizations due to things like data sensitivity, the door might now be opened a bit.</p>
<h3 id="final-notes"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#final-notes">Final notes</a></h3>
<p>External Identities and B2B are continually evolving. While there is still a large gap to bridge for many situations, this definitely is bringing us one step closer. B2B Direct Access in particular will be interesting to see how Microsoft evolves it ‚Äì will it come closer to how an AD trust operates, or will there be improvements on how guests are invited into tenants.</p>
<p>As usual, any questions/concerns/comments please reach out to me, and if you find any new unique use cases for cross-tenant access settings, would love to hear them.</p>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <span class="md-pagination__current">1</span> <a class="md-pagination__link" href="page/2/">2</a>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.path", "navigation.top"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": {"NFC": "nfc"}, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../../js/open_in_new_tab.js"></script>
      
    
  </body>
</html>