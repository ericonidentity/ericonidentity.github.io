
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://new.ericonidentity.com/2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/">
      
      
        <link rel="prev" href="../../02/field-notes-migration-from-federation-to-cloud-authentication/">
      
      
        <link rel="next" href="../../../../2023/01/16/cloud-identity-is-still-the-future/">
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>SpAML: Spoofing Users In Azure AD With SAML Claims Transformations - Eric on Identity</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.2a3383ac.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


  
  
    
      
      
        
      
      
    
  
  
  <style>:root{.md-tag.md-tag--nfc{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22M23.958%201.98C23.895%201%2023.143.256%2022.145.197c-1.102-.066-4.668-.12-5.693-.12%201.832%201.264%202.082%203.644%202.255%208.066.101%202.62.01%2011.799.002%2012.188l-.049%202.504-9.628-9.63v-3.014l7.656%207.658c.02-1.516.04-3.492.04-5.299%200-1.76-.026-3.354-.076-4.193-.288-4.819-.737-7.077-3.253-7.962-.77-.27-1.487-.335-2.683-.351C9.728.032%202.848.037%201.854.091.8.147.09.914.042%201.9c-.048.977-.064%2019.174%200%2020.165.062.98.815%201.724%201.812%201.782%201.102.067%204.668.075%205.694.075-1.832-1.264-2.083-3.643-2.255-8.066-.1-2.62-.009-11.8%200-12.188l.047-2.504%209.629%209.63v3.013L7.312%206.152c-.02%201.514-.04%203.49-.04%205.298%200%201.76.026%203.354.077%204.192.288%204.82.736%207.077%203.252%207.962.77.271%201.487.337%202.683.352.987.012%207.868.006%208.861-.047%201.056-.056%201.765-.822%201.813-1.811.048-.976.064-19.127%200-20.118%22/%3E%3C/svg%3E');}}</style>

    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Eric on Identity" class="md-header__button md-logo" aria-label="Eric on Identity" data-md-component="logo">
      
  <img src="../../../../images/eidlogo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Eric on Identity
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              SpAML: Spoofing Users In Azure AD With SAML Claims Transformations
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Eric on Identity" class="md-nav__button md-logo" aria-label="Eric on Identity" data-md-component="logo">
      
  <img src="../../../../images/eidlogo.svg" alt="logo">

    </a>
    Eric on Identity
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href="../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Archive
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2025
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2024/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2024
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2023/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2023
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2022/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2022
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2021/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2021
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#azure-ad-saml-response-primer" class="md-nav__link">
    <span class="md-ellipsis">
      Azure AD SAML response primer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-the-stage" class="md-nav__link">
    <span class="md-ellipsis">
      Setting the stage
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuring-our-malicious-transform" class="md-nav__link">
    <span class="md-ellipsis">
      Configuring our malicious transform
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-our-malicious-transform" class="md-nav__link">
    <span class="md-ellipsis">
      Using our malicious transform
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#detecting-malicious-transforms" class="md-nav__link">
    <span class="md-ellipsis">
      Detecting malicious transforms
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Detecting malicious transforms">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#audit-logging-is-broken" class="md-nav__link">
    <span class="md-ellipsis">
      Audit logging is broken
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graph-api-does-not-expose-saml-claim-policies" class="md-nav__link">
    <span class="md-ellipsis">
      Graph API does not expose SAML claim policies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-are-we-left-with" class="md-nav__link">
    <span class="md-ellipsis">
      What are we left with?
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#preventing-malicious-transforms" class="md-nav__link">
    <span class="md-ellipsis">
      Preventing malicious transforms
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#responsible-disclosure" class="md-nav__link">
    <span class="md-ellipsis">
      Responsible disclosure
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../.." class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
              <div class="md-post__authors md-typeset">
                
                  <div class="md-profile md-post__profile">
                    <span class="md-author md-author--long">
                      <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
                    </span>
                    <span class="md-profile__description">
                      <strong>
                        
                          <a href="https://www.ericonidentity.com">Eric Woodruff</a>
                        
                      </strong>
                      <br>
                      Identity Nerd
                    </span>
                  </div>
                
              </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                        <time datetime="2022-12-19 00:00:00+00:00" class="md-ellipsis">December 19, 2022</time>
                      </div>
                    </li>
                    
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg>
                          <span class="md-ellipsis">
                            
                              11 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  




<h1 id="spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations">SpAML: Spoofing Users In Azure AD With SAML Claims Transformations</h1>
<p>For those that believe SAML is dead, they should take a look at the Azure AD Application Gallery. While the authentication standard finished baking almost two decades ago, it‚Äôs still a staple for integration of applications with Azure AD. As of writing, the Azure AD App Gallery has 2015 applications available for SSO integration, and 1335 of them use SAML, roughly two-thirds. Beyond this, there are thousands of line-of-business (LOB) and other 3rd party applications that don‚Äôt exist in the gallery but leverage SAML. Many well-known applications and platforms are published in the gallery using SAML ‚Äì Salesforce, Google Workspace/Google Cloud, AWS, SAP, Oracle Cloud, ServiceNow, Workday‚Ä¶ the list goes on and on.</p>
<p>With the ease of federated identity, not only are we tying other cloud providers to Azure AD, but we are also bringing in business critical applications. With this, we need to keep in mind that threat actors are not always targeting critical IT resources; one can do plenty damage with access to records and data stored within SaaS applications.</p>
<p>Azure AD makes it easier than ever to spoof (impersonate) a user within a SAML response. This relatively easy technique allows us to impersonate a highly privileged user in the target application. At the same time, authentication behavior for all other users of the application, including the legitimate user being spoofed, will not change. If your organization leverages SCIM for user provisioning, which is the direction the industry is going, this lends in favor of spoofing going undetected, as optional attributes in the SAML response will go unused by the application.</p>
<p>Within Azure AD, you do not need to be a Global Administrator to configure an Enterprise Application. Anyone with Application Administrator, Cloud Application Administrator, or assigned Owner to a specific application can manage it. From a usability perspective, Microsoft pushes delegation of ownership to the business units. The users, however, that now can manage the application, likely fall under the bar of PIM or any privilege separation. Suffice to say, this opens our potential pool of targets in an organization; needing Global Administrator for movement into target applications is not necessary, just whoever has ownership. Likewise, it‚Äôs ripe for abuse by insider threats.</p>
<h2 id="azure-ad-saml-response-primer">Azure AD SAML response primer</h2>
<p>For a full refresh on the SAML authentication flow, I‚Äôll refer to the IDPro Body of Knowledge Article, <a href="https://bok.idpro.org/article/id/79/">Cloud Service Authenticates Via Delegation ‚Äì SAML</a>. For an understanding of the spoofing technique, the SAML response, which is passed from the Identity Provider (IdP, Azure AD) to the application (SP, Service Provider) via the user, contains both required and optional claims. One of these required claims is the <strong>name identifier</strong>, referred to in the response as the <strong>NameID</strong>.</p>
<p>NameID is a unique attribute that represents the user within the application. It is what the application uses to lookup the user within its internal user database.</p>
<p>Azure AD defaults to, and it is a common pattern these days, to use the Email Address (urn:oasis:names<img alt="üáπüá®" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f1f9-1f1e8.svg" title=":tc:" />SAML:1.1:nameid-format:emailAddress) format. The default source attribute that is emitted in the SAML response is user.userprincipalname.</p>
<p>As an example, I authenticate to Azure AD as nestor.wilke@fabrikam.cloud, and subsequently when I connect to an Enterprise Application, say AWS, the SAML response contains the NameID below. On the identity layer, AWS uses this to match Nestor to his user account.</p>
<div class="highlight"><pre><span></span><code>&lt;NameID Format=&quot;urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress&quot;&gt;nestor.wilke@fabrikam.cloud&lt;/NameID&gt; 
</code></pre></div>
<p>Azure AD also provides the ability to create <strong>claim transformations</strong>. Claim transformations can be useful for several reasons. A simple example is if the application has case sensitivity requirements. One can apply a ToLowercase() and not have worry about needing to modify broader patterns in Azure AD to satisfy one application. Claims transformations are configured on a per-claim basis within each Enterprise Application that is using SAML.</p>
<h2 id="setting-the-stage">Setting the stage</h2>
<p>An effective use of spoofing the SAML response is to impersonate a highly privileged user in an application. For our example, let‚Äôs look at a few different user personas, in a somewhat simplified scenario:</p>
<ul>
<li>Nestor Wilke is an account owner in AWS, and because this is considered a highly privileged role, he has privileged credentials he uses for accessing AWS, p-nestor.wilke@fabrikam.cloud.</li>
<li>Isaiah Langer is part of the Operations team that is tasked with providing support to Enterprise Applications, which provides rights over the AWS Enterprise Application. Groups are used for user assignment to AWS, and AWS role assignment happens in AWS IAM Identity Center. Isaiah can manage these applications with his normal user account, isaiah.langer@fabrikam.cloud. He has an account in AWS, but his privileges there are low.</li>
</ul>
<h2 id="configuring-our-malicious-transform">Configuring our malicious transform</h2>
<p>Once we gain access to an account with ownership over the application, we will want to jump into Azure AD, and browse to Enterprise Applications, and then open the target application.</p>
<p>Within here, we will select Single sign-on in the left blade, and then under Attributes &amp; Claims on the right blade, select Edit:</p>
<p><img alt="Figure 1" src="/images/2022/12/19/img1.png" /></p>
<p>In the new blade that opens, we want to select the Unique User Identifier (Name ID) claim:</p>
<p><img alt="Figure 2" src="/images/2022/12/19/img2.png" /></p>
<p>Note that in our example we will be using a transform on user.userprincipalname, but this same technique can apply to any attribute that is being used for NameID.</p>
<p>Within the <strong>Manage claim</strong> window, we want to select <strong>Transformation</strong> under <strong>Source</strong>. This will open a new <strong>Manage transformation</strong> blade on the right:</p>
<p><img alt="Figure 3" src="/images/2022/12/19/img3.png" /></p>
<p>For spoofing, we need to know just two things ‚Äì the UPN of the user we want to spoof, and the UPN of the user who will be used for performing the spoofing.</p>
<p>Under <strong>Transformation</strong>, select <strong>Contains()</strong>. For P<strong>arameter 1 (Input)</strong> select <strong>user.userprincipalname</strong>. For Value, we will enter <em>isaiah.langer@fabrikam.cloud</em>. For <strong>Parameter 2 (Output)</strong>, do <strong>not</strong> select an attribute from the dropdown menu. Instead, click into the window within the menu and enter <em>p-nestor.wilke@fabrikam.cloud</em>.</p>
<p><img alt="Figure 4" src="/images/2022/12/19/img4.png" /></p>
<p>We then check the box for <strong>Specify output if no match</strong>, and for <strong>Parameter 3 (Output if no match)</strong> select <strong>user.userprincipalname</strong>.</p>
<p>This last piece is what ensures that all other users accessing AWS will continue to have the same user experience, including Nestor. Our final transform will look like:</p>
<p><img alt="Figure 5" src="/images/2022/12/19/img5.png" /></p>
<p>And we can confirm the pattern in the claims rule:</p>
<div class="highlight"><pre><span></span><code>If &#39;user.userprincipalname&#39; contains &#39;isaiah.langer@fabrikam.cloud&#39; then output &#39;p-nestor.wilke@fabrikam.cloud&#39;. Else, output &#39;user.userprincipalname&#39;.
</code></pre></div>
<p>We select <strong>Add</strong>, and then <strong>Save</strong>.</p>
<h2 id="using-our-malicious-transform">Using our malicious transform</h2>
<p>Now that we have things configured, let‚Äôs look at this in action. Recall that Nestor is our target user, and Isaiah is the account that will be used for spoofing.</p>
<div class="video-wrapper">
  <iframe src="https://www.youtube-nocookie.com/embed/FHWV854iYDo"
          title="SpAML Abuse"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen"
          allowfullscreen>
  </iframe>
</div>

<p>This is just one example. This has been similarly tested and proofed with GCP and Salesforce and should be valid for any SAML application whether from the application gallery or a LOB application.</p>
<h2 id="detecting-malicious-transforms">Detecting malicious transforms</h2>
<p>Unfortunately, the ability to detect a transform like this is difficult, as normal channels do not expose the data we expect and need.</p>
<h3 id="audit-logging-is-broken">Audit logging is broken</h3>
<p>The first thought is to go to our Azure AD audit logs. After all, the change should be recorded in Azure AD, so we can ingest that data for detection.</p>
<p>SAML claim policy auditing, is unfortunately, broken. If we look at our audit logs after Isaiah made the change, we will see the following:</p>
<p><img alt="Figure 6" src="/images/2022/12/19/img6.png" /></p>
<p>We can drill into the Target(s) and see that there was a change made to a ClaimIssuancePolicy:</p>
<p><img alt="Figure 7" src="/images/2022/12/19/img7.png" /></p>
<p>But when we look at the Modified Properties:</p>
<p><img alt="Figure 8" src="/images/2022/12/19/img8.png" /></p>
<p>Note that there is nothing of value. <strong>Any</strong> SAML claim issuance policy changes in Azure AD show up the same way. To ensure this was not some sort of limitation of the portal itself, I looked at the data exported to Log Analytics:</p>
<p><img alt="Figure 9" src="/images/2022/12/19/img9.png" /></p>
<p>I‚Äôve had a support case open with Microsoft through standard channels on this, but there has been no movement.</p>
<h3 id="graph-api-does-not-expose-saml-claim-policies">Graph API does not expose SAML claim policies</h3>
<p>Figure the next place we may turn would be the Microsoft Graph API, but again we are blocked here. The Graph API does not expose SAML claim issuance policies, something that can be traced back to 2019 with customers asking for it, yet still is not supported from my recent check with Microsoft.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Microsoft has claimed to resolve this by making claim transforms available through Graph API, however, it's a different set of transforms.</p>
</div>
<h3 id="what-are-we-left-with">What are we left with?</h3>
<p>As Azure AD does not provide native means for easily tracking this, we can either go with something of relatively low fidelity, alerting on all changes to a ClaimIssuancePolicy, but this is also going to alert on all changes, good and bad. If there is little in the way of activity with SAML application onboarding in the environment, this may suffice.</p>
<p>From a retroactive analysis perspective, because these are not exposed through the Graph API, the only way to verify the policy settings is through manual inspection.</p>
<p>Using a SIEM platform for authentication log correlation may at first seem appealing but consider that authentication times are likely the only mechanism for correlation. If the platform has a high volume of user activity, that is going to create an immense level of complexity, as Azure AD and the application are highly likely going to be exposing the time the user authenticated into those systems, which may not align to the necessary precision.</p>
<h2 id="preventing-malicious-transforms">Preventing malicious transforms</h2>
<p>Preventing malicious transforms becomes even more important when our ability to properly monitor for them is inhibited.</p>
<p>From a prevention perspective it‚Äôs back to the basics. The following should apply for all Global Administrators, as well as Application Administrator or Cloud Application Administrator roles if your organization heavily relies on them for management of Enterprise Applications:</p>
<ul>
<li>Privilege separated from daily driver accounts</li>
<li>Accounts should not be mail-enabled</li>
<li>Cloud-sourced and not synchronized from Active Directory</li>
<li>Azure AD PIM should be used with MFA requirement for elevation</li>
<li>Roles scoped with a Conditional Access policy requiring MFA for Azure management</li>
<li>Passwordless should be enabled and required for these accounts</li>
<li>Accounts should be scoped for Azure AD Identity Protection</li>
<li>Require a Privileged Access Workstation (PAW) for highly privileged operations</li>
</ul>
<p>If you heavily delegate the owner role for specific Enterprise Applications, you may want to re-evaluate how you are securing the users with delegated access. While it‚Äôs unlikely businesses will accept the model of privilege separation or a PAM implementation for the HR administrator team that owns Workday, it may be a place to reconsider if those delegations are necessary. If delegation primarily exists to assign membership to the application, the model could be changed to instead provide delegated ownership over the groups that are already assigned, or leverage entitlement management for application access lifecycle.</p>
<p>The surface area for abuse by a threat actor can be reduced by application conditional access requiring compliant devices for all users with proper endpoint management in place, but from the perspective of insider threat or certain token theft scenarios, this may not be sufficient.</p>
<p>Heavily restricted Conditional Access policies will not prevent user impersonation, as all CA policies are evaluated prior to the issuance of the SAML response. In our example, even if Nestor was restricted to using a PAW for accessing AWS, Isaiah would have been able to access AWS under whatever conditions CA was applying to his user account. If the application requires user assignment, or if a CA policy specifically blocked Isaiah from access, the risk is mitigated. For many business-critical applications, such as Workday, it‚Äôs highly likely that blocking scenarios cannot be applied as the application is used across the workforce. Using mechanisms such as role assignment may be circumvented with a combination of claim conditions and transforms.</p>
<p>If the target application provides mechanisms for privilege escalation management within, it may also stop the ability for impersonation, as the user would be presented to elevate privilege for the spoofed user within the target.</p>
<h2 id="responsible-disclosure">Responsible disclosure</h2>
<p>When I initially came up with my proof case, I opened a case with MSRC, indicating that claims transforms should not allow for a constant output for NameID, as it enables for spoofing. Even though it is not a security risk within Azure AD, as the identity provider, proper controls should exist within the IdP to ensure that associated applications are not overly exposed to a security risk such as NameID spoofing.</p>
<ul>
<li>August 30th, 2022: Opened case with MSRC</li>
<li>October 10th, 2022: Response from MSRC with case closed, ‚ÄúWe determined that this behavior is considered to be by design.‚Äù</li>
</ul>
<p>Likewise, a support case with Microsoft has been opened regarding deficiencies with SAML claim audit logging.</p>
<ul>
<li>October 20th, 2022: Opened support Sev C case with Microsoft</li>
<li>October 26th, 2022: First response from SE with inaccurate understanding of case</li>
<li>October 27th, 2022: Reply to SE with additional clarity</li>
<li>November 8th, 2022: SE calls at a random time, follows up with email that a session will be scheduled on November 14th, at 9:30am EST</li>
<li>November 14th, 2022: SE does not call at 9:30am EST</li>
<li>November 14th, 2022: SE calls at 12:30pm EST, I request a call back at 1:00pm EST, SE agrees to call back at 1:00pm EST</li>
<li>November 14th, 2022: SE does not call at 1:00pm EST</li>
<li>November 17th, 2022: SE emails and schedules a call for November 18th, 2022 at 10:00am EST</li>
<li>November 18th, 2022: SE does not call at 10:00am EST</li>
<li>November 21st, 2022: SE emails indicating that I did not answer my phone at indeterminate time. Check with phone carrier, no call was ever received.</li>
<li>November 28th, 2022: SE calls me outside of working hours.</li>
<li>November 28th, 2022: I reply to an email with times that the SE can reach me</li>
<li>December 9th, 2022: SE calls, able to finally have the screen sharing session. Walk the SE through the details I provided in my case showing the behavior of these changes not being properly audited. SE indicates that the case needs to be escalated.</li>
<li>December 14th, 2022: SE calls me to let me know the case is still being investigated.</li>
<li>January 9th, 2023: SE contacts me to let me know I need to reproduce the issue for fresh data for MS.</li>
<li>January 25th, 2023: SE emails me to let me know the case is still being investigated.</li>
<li>February 16th, 2023: SE emails me to let me know the case is still being investigated.</li>
<li>February 20th, 2023: SE contacts me to let me know I need to reproduce the issue for fresh data for MS.</li>
<li>March 15th, 2023: Case is re-assigned to an ‚ÄúAzure Support Ambassador‚Äù. It‚Äôs indicated that the case is still being investigated.</li>
<li>March 17th, 2023: I email the Support Ambassador asking if it would be possible to find out more details about the case directly from engineering.</li>
<li>March 27th, 2023: Support Ambassador emails me to let me know that a bug has been filed to be fixed at a later date.</li>
<li>March 29th, 2023: Support closes the case without asking if it‚Äôs alright to do so.</li>
</ul>







  
  




  



      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
        
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../../02/field-notes-migration-from-federation-to-cloud-authentication/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Field Notes: Migration From Federation To Cloud Authentication">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Field Notes: Migration From Federation To Cloud Authentication
              </div>
            </div>
          </a>
        
        
          
          <a href="../../../../2023/01/16/cloud-identity-is-still-the-future/" class="md-footer__link md-footer__link--next" aria-label="Next: Cloud Identity Is Still The Future">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Cloud Identity Is Still The Future
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021 - 2025 Eric Woodruff
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/ericonidentity" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M357.2 48h70.6L273.6 224.2 455 464H313L201.7 318.6 74.5 464H3.8l164.9-188.5L-5.2 48h145.6l100.5 132.9zm-24.8 373.8h39.1L119.1 88h-42z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.path", "navigation.top", "navigation.footer"], "search": "../../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": {"NFC": "nfc"}, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../../../../js/open_in_new_tab.js"></script>
      
    
  </body>
</html>