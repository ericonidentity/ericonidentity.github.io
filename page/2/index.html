
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://new.ericonidentity.com/page/2/">
      
      
      
        <link rel="next" href="../../archive/2025/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>Home - Eric on Identity</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2a3383ac.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


  
  
    
      
      
        
      
      
    
  
  
  <style>:root{.md-tag.md-tag--nfc{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22M23.958%201.98C23.895%201%2023.143.256%2022.145.197c-1.102-.066-4.668-.12-5.693-.12%201.832%201.264%202.082%203.644%202.255%208.066.101%202.62.01%2011.799.002%2012.188l-.049%202.504-9.628-9.63v-3.014l7.656%207.658c.02-1.516.04-3.492.04-5.299%200-1.76-.026-3.354-.076-4.193-.288-4.819-.737-7.077-3.253-7.962-.77-.27-1.487-.335-2.683-.351C9.728.032%202.848.037%201.854.091.8.147.09.914.042%201.9c-.048.977-.064%2019.174%200%2020.165.062.98.815%201.724%201.812%201.782%201.102.067%204.668.075%205.694.075-1.832-1.264-2.083-3.643-2.255-8.066-.1-2.62-.009-11.8%200-12.188l.047-2.504%209.629%209.63v3.013L7.312%206.152c-.02%201.514-.04%203.49-.04%205.298%200%201.76.026%203.354.077%204.192.288%204.82.736%207.077%203.252%207.962.77.271%201.487.337%202.683.352.987.012%207.868.006%208.861-.047%201.056-.056%201.765-.822%201.813-1.811.048-.976.064-19.127%200-20.118%22/%3E%3C/svg%3E');}}</style>

    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#home" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Eric on Identity" class="md-header__button md-logo" aria-label="Eric on Identity" data-md-component="logo">
      
  <img src="../../images/eidlogo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Eric on Identity
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Home
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Eric on Identity" class="md-nav__button md-logo" aria-label="Eric on Identity" data-md-component="logo">
      
  <img src="../../images/eidlogo.svg" alt="logo">

    </a>
    Eric on Identity
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    
      
    
  
  
    <li class="md-nav__item">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="../.." class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Archive
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2025
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2024/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2024
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2023/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2023
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2022/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2022
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2021/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2021
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="home">Home</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-02-06 00:00:00+00:00">February 6, 2023</time></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="dont-let-dns-be-your-azure-ad-recovery-downfall"><a class="toclink" href="../../2023/02/06/dont-let-dns-be-your-azure-ad-recovery-downfall/">Don't Let DNS Be Your Azure AD Recovery Downfall</a></h2>
<p>In September of 2022, Joey Verlinden (<a href="https://twitter.com/jvldn1">@jvldn1</a>) published an excellent article on his experience with recovering access to an Azure AD tenant that he was completely locked out of. You can, and should, read the full article here, <a href="https://www.joeyverlinden.com/what-happens-if-you-lock-out-your-azure-tenant/">What happens if you lock-out your Azure Tenant? ‚Äì Joey Verlinden</a>.</p>
<p>In this, Joey details the process for recovering access to an Azure AD tenant, which includes a detailed verification process, which is rightfully put in place to ensure that someone isn‚Äôt capable of a tenant takeover through social engineer. As part of the process, the request is verified by means of either:</p>
<ul>
<li>Calling the phone number associated with a Tenant</li>
<li>Emailing a Global Administrator</li>
<li>Requesting that the organization creates a DNS TXT record associated with one of the verified domains</li>
</ul>
<p>Now, under normal ‚Äúoops‚Äù scenarios, you likely could use a phone call or email to a Global Administrator. Of course, if a GA is mail-enabled, the email should be forwarded, as your Global Admins should not actually be receiving or checking email directly in that inbox (which is a different story).</p>
<p>But say my tenant has come under some sort of cyberattack. Or more mundane You can‚Äôt guarantee that a phone call or email will still go to where you expect. And while these changes should be audited, when you‚Äôre in a state of needing to authenticate yourself from a support perspective, it‚Äôs likely you‚Äôll still have to try and complete one of these steps, if you don‚Äôt want further delay.</p>
<p>This leaves us with DNS. But what if that DNS is hosted in a subscription associated with the same Azure AD tenant? Things could potentially not turn out so well.</p>
<p>Even if you have DNS management delegated out to accounts that are not a GA (which in a large-scale enterprise, GA should not own resources in subscriptions)‚Ä¶ can you guarantee that their access would not be tampered with if a threat actor is involved?</p>
<p>From a resilience perspective, it seems like it‚Äôs one of the times to not host DNS in Azure, or at least not in a subscription that is tied to the same tenant that uses those domains for services.</p>
<p>You may already have a DNS architecture with secondary zones hosted outside of Azure, but those read-only copies won‚Äôt save you when you need to edit a zone.</p>
<p>And if you host DNS with something like Amazon Route 53‚Ä¶ do you federate authentication for your account owners and resources back to Azure AD? If your Azure tenant is breached, it‚Äôs certain a threat actor will try to follow your multi-cloud sprawl.</p>
<h3 id="so-whats-the-resilient-path"><a class="toclink" href="../../2023/02/06/dont-let-dns-be-your-azure-ad-recovery-downfall/#so-whats-the-resilient-path">So what's the resilient path?</a></h3>
<p>Your mind may go to contacting your domain name registrar, and updating your NS records. But, you now are adding another external dependency.</p>
<p>This past summer I was trying to update NS records for a domain with Directnic, and ticket response time was 12-24 hours, let alone actually having the records updated. Why did I open a ticket? Updates in the portal were not reflecting days after the change.</p>
<p>While it may seem suboptimal, the most resilient path would be hosting DNS either in another small subscription and tenant that has no association to your primary production tenant, or using another large-scale cloud provider for DNS, but not associating authentication back to Azure AD.</p>
<p>Considering the reality that most organizations struggle to keep as many nines as cloud providers (even with their occasional outages), this wouldn‚Äôt be time for a knee-jerk reaction to bring DNS back to an on-premise data center, unless your organization is still robust enough to handle those high SLA‚Äôs.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-01-29 00:00:00+00:00">January 29, 2023</time></li>
        
        
          
          <li class="md-meta__item">
            
              6 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="azure-ad-101-azure-subscription-relationship"><a class="toclink" href="../../2023/01/29/azure-ad-101-azure-subscription-relationship/">Azure AD 101: Azure Subscription Relationship</a></h2>
<p>Whether you are dipping your toe or diving headfirst into Azure, one of the points of confusion is the relationship between Azure Active Directory and Azure subscriptions. Azure subscriptions may be referred to as subscriptions, or sometimes even just Azure. An Azure Active Directory tenant, which is the cloud identity provider, is usually referred to as Azure AD or AAD, or sometimes just tenant.</p>
<p>While Microsoft has decent documentation on the relationship, I tend to find that drawing analogies along with additional visuals can help really drive the relationship home for folks. For the MS Docs article, see <a href="https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-how-subscriptions-associated-directory?WT.mc_id=SEC-MVP-5005105">Add an existing Azure subscription to your tenant ‚Äì Azure AD ‚Äì Microsoft Entra | Microsoft Learn</a>.</p>
<h3 id="a-look-at-pre-cloud-infrastructures"><a class="toclink" href="../../2023/01/29/azure-ad-101-azure-subscription-relationship/#a-look-at-pre-cloud-infrastructures">A look at pre-cloud infrastructures</a></h3>
<p>When we take a look at very classic on-premises infrastructure, if it‚Äôs a Microsoft shop we‚Äôll almost always have Active Directory, an identity provider, usually running on physical or virtualized servers in a high availability architecture. For purposes here, we‚Äôll abstract it from the underlying server infrastructure:</p>
<p><img alt="Figure 1" src="/images/2023/01/29/img1.png" /></p>
<p><em>Our Active Directory domain</em></p>
<p>Likewise, we have all sorts of servers running, again possibly a mix of physical servers, as well as virtualized servers (even though the hypervisor itself is running on some form of physical server). Below we have a simple example of a Windows Server that is running Hyper-V, and has four virtual machines running:</p>
<p><img alt="Figure 2" src="/images/2023/01/29/img2.png" /></p>
<p><em>A Hyper-V environment running on a Windows server</em></p>
<p>When we connect these two systems, Active Directory and the Windows Server, we form a trust relationship between the two. The trust relationship is represented in Active Directory by the computer object that represents that Hyper-V server.</p>
<p><img alt="Figure 3" src="/images/2023/01/29/img3.png" /></p>
<p><em>The AD and Windows Server trust relationship</em></p>
<p>To expand this out a bit further, we likely have several different servers running several different types of workloads in our environment:</p>
<p><img alt="Figure 4" src="/images/2023/01/29/img4.png" /></p>
<p><em>Our simple multi-server environment</em></p>
<p>The one commonality is that regardless of the type of workload running on the server, we have that trust relationship between Active Directory and each server.</p>
<h3 id="translating-to-the-cloud-trust-model"><a class="toclink" href="../../2023/01/29/azure-ad-101-azure-subscription-relationship/#translating-to-the-cloud-trust-model">Translating to the cloud trust model</a></h3>
<p>With our understanding of having that trust relationship between Active Directory and each Windows Server, we can translate this to a <strong>similar</strong> trust relationship between our <strong>Azure Active Directory tenant</strong> and <strong>Azure Subscriptions</strong>.</p>
<p>In our example below, we see that a subscription can be mostly analogous to a Windows Server. They both contain virtual machines, and both the subscription and the server have their own type of trust relationship to their relative identity provider:</p>
<p><img alt="Figure 5" src="/images/2023/01/29/img5.png" /></p>
<p><em>A tenant-subscription trust</em></p>
<p>Similar to how we may run several different workloads on several different servers, we can have several different subscriptions that are managing several different workloads:</p>
<p><img alt="Figure 6" src="/images/2023/01/29/img6.png" /></p>
<p><em>A multi-subscription trust model</em></p>
<p>Similar to Active Directory, where you can only join a Windows server to <strong>one</strong> domain, an Azure subscription can only have <strong>one</strong> trust relationship to an Azure AD tenant.</p>
<p>Unlike Active Directory, where the trust relationship is observable as a computer object, the subscription won‚Äôt be something that you‚Äôll see represented in Azure AD itself, but with the right permissions you‚Äôll be able to observe all subscriptions associated with that tenant when you sign into the Azure portal.</p>
<p>With Windows servers, we occasionally may run into instances where we wanted to migrate a Windows server from one Active Directory Forest to another. Similarly, we <strong>can</strong> migrate an Azure subscription relationship from one Azure AD tenant to another:</p>
<p><img alt="Figure 7" src="/images/2023/01/29/img7.png" /></p>
<p><em>Changing the trust relationship</em></p>
<p>In both models, the trust relationship is changed, because we can still only have <strong>one</strong> trust relationship between a subscription and a tenant.</p>
<p>Similar to Active Directory and changing the associated forest, depending on the types of workloads in the subscription, there may be post migration work that needs to happen. At the very least, we will need to re-assign the appropriate permissions to the subscription.</p>
<h3 id="the-permission-confusion"><a class="toclink" href="../../2023/01/29/azure-ad-101-azure-subscription-relationship/#the-permission-confusion">The permission confusion</a></h3>
<p>Not only is the relationship between a tenant and subscription confusing, but so is the permission model, and where things should, or should not, crossover.</p>
<p>With Active Directory, in a properly tiered permission model, Domain Administrator should primarily be used for management of Active Directory, and nothing more. All of those servers joined to Active Directory should use a separate set of permissions, many times referred to as a Server Administrator. Domain Administrators have no business logging onto the member servers, and Server Administrators have no business managing Active Directory. This all becomes <strong>really important</strong> when you start talking about least privilege and privilege separation.</p>
<p>You can think of the fact that each Windows server has its own set of local permissions you can delegate and control on the server. And those permissions are managed <strong>local</strong> to that server. While you may create groups of objects in Active Directory, say, Hyper-V Server Administrators, you then assign that group local on each Hyper-V server to have the necessary rights.</p>
<p>The same goes in Azure subscriptions. Subscription Owners are effectively the Local Administrators, and the permissions themselves are assigned <strong>on the subscription</strong>. While the permissions may be abstracted in the sense that you use a single portal or command across multiple subscriptions, the permissions are still encompassed around that subscription.</p>
<p>And just like Active Directory, you generally <strong>do not need</strong> to assign a Global Administrator any permissions into or over a subscription. While some organizations may accept the risk with a limited number of Global Administrators, the problem becomes pervasive in organizations that believe they need to continue to hand out Global Administrator roles just so that subscription ownership can happen.</p>
<p><img alt="Figure 8" src="/images/2023/01/29/img8.png" /></p>
<p>While it is a shift in how organizations work and operate, overly permissive models with a lack of privilege separation are a great way to help threat actors into your environment.</p>
<h3 id="digging-deeper"><a class="toclink" href="../../2023/01/29/azure-ad-101-azure-subscription-relationship/#digging-deeper">Digging deeper</a></h3>
<p>Our examples are simple, to help build an understanding of the relationship model. And just like we may divide server workloads up by application groups or regions, and how we likely architect web farms and Hyper-V clusters, elaborate subscription models require thoughtful architecture behind them. This is where the Microsoft Cloud Adoption Framework and Azure Landing Zones come into play.</p>
<p>You can find more information on these here, <a href="https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/?WT.mc_id=SEC-MVP-5005105">Microsoft Cloud Adoption Framework for Azure ‚Äì Cloud Adoption Framework | Microsoft Learn</a>, and here, <a href="https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/landing-zone/?WT.mc_id=SEC-MVP-5005105">What is an Azure landing zone? ‚Äì Cloud Adoption Framework | Microsoft Learn</a>.</p>
<p>It‚Äôs especially important from an identity and security perspective properly design the security of your subscriptions ‚Äì many organizations have overly permissive architectural designs around their subscription permissions, including on items of critical infrastructure, such as Active Directory Domain Controllers running as virtual machines in Azure.</p>
<p>For further information on securing privileges access, take a look at <a href="https://learn.microsoft.com/en-us/security/compass/overview?WT.mc_id=SEC-MVP-5005105">Securing privileged access overview | Microsoft Learn</a>.</p>
<h3 id="one-last-point-language-matters"><a class="toclink" href="../../2023/01/29/azure-ad-101-azure-subscription-relationship/#one-last-point-language-matters">One last point - language matters</a></h3>
<p>This is one of those areas where language matters, especially if you are an identity practitioner or working in a role where you help manage and service your customers Azure subscriptions and Azure AD tenant(s).</p>
<p>It is not:</p>
<ul>
<li>Azure tenant</li>
<li>Azure AD subscription</li>
<li>AAD subscription</li>
<li>Azure directory</li>
</ul>
<p>It is:</p>
<ul>
<li>Azure AD tenant</li>
<li>Azure subscription</li>
</ul>
<p>While for some organizations you may be able to get away with interchanging terminology, if you were to have a project assigned to you, or scope a project for a customer, and the details were similar to ‚Äú<em>perform an audit of the AAD subscription and make recommendations on a privilege model</em>‚Äù, would you be talking about auditing the permissions in Azure Active Directory? In an Azure subscription? Which Azure subscription if the organization has multiple? You can see where this is going.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-01-16 00:00:00+00:00">January 16, 2023</time></li>
        
        
          
          <li class="md-meta__item">
            
              6 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="cloud-identity-is-still-the-future"><a class="toclink" href="../../2023/01/16/cloud-identity-is-still-the-future/">Cloud Identity Is Still The Future</a></h2>
<p>In October 2022, the CTO of 37signals, David Heinemeier Hansson, published a piece on why hey.com was leaving the cloud. You can read the full article here, <a href="https://world.hey.com/dhh/why-we-re-leaving-the-cloud-654b47e0">Why we‚Äôre leaving the cloud (hey.com)</a>; the gist of the post is that cloud is not cost-effective. More recently, InfoWorld published a piece by David Linthicum, <a href="https://www.infoworld.com/article/3684369/2023-could-be-the-year-of-public-cloud-repatriation.html">2023 could be the year of public cloud repatriation | InfoWorld</a>, hitting on why it may be more cost-effective to move back to private data centers. You see the trend ‚Äì cloud may not be providing the ROI that is expected, especially if your organization has just performed a bunch of lift-and-shift without application refactoring.</p>
<p>While the titles are attention grabbing, and the articles have valid points, they don‚Äôt really tell the full story. Folks in the industry may scan the headlines and believe that a mass cloud exodus is on the verge of happening, but we really need to look at what part of the cloud we are speaking to. We need to distinguish between IaaS, PaaS and SaaS, as well as related services and systems, such as IDaaS (identity as a service, aka Azure AD, Okta, and so on).</p>
<h3 id="saas-is-king-for-business-productivity"><a class="toclink" href="../../2023/01/16/cloud-identity-is-still-the-future/#saas-is-king-for-business-productivity">SaaS is king for business productivity</a></h3>
<p>37signals is a SaaS application company ‚Äì with basecamp.com, a project management platform, and hey.com, a cloud email service. Neither product offers a private hosted version, so while 37signals is leaving the cloud, the services they offer you, well, are still cloud services. Sure, they may not be hosted in AWS or GCP, but the organizations that consume these platforms will be accessing and using them as cloud services.</p>
<p>These days, nobody wants to manage a SharePoint farm, and certainly not Exchange Server. But it‚Äôs not just office suites such as Office 365 and Google Workspace (and hey.com). In recent years we have seen an explosion of growth with SaaS applications and platforms, and this is something that is continuing to trend upward.</p>
<h3 id="vpn-is-an-antiquated-means-of-access"><a class="toclink" href="../../2023/01/16/cloud-identity-is-still-the-future/#vpn-is-an-antiquated-means-of-access">VPN is an antiquated means of access</a></h3>
<p>Whether it‚Äôs IaaS or PaaS, hosted in private data centers or in some form of cloud, needing to access applications from everywhere and anywhere is as important as ever. With COVID-19 and the remote workforce, it strained organizations trying to find ways to allow access to applications for the workforce. While VPN may have been the path of least resistance to allowing remote access, it‚Äôs certainly not well aligned to Zero Trust. Cloud platforms provide means for modern access, and modern authentication, to applications, regardless of where they exist. Products such as Azure AD Application Proxy can be that conduit, are easy to deploy, and can be used to supplant VPN access. Sure, there may be the edge cases where VPN still provides the necessary means of access, but organizations should realize that success is much easier when we are not picking one-size-fits-all solutions.</p>
<h3 id="cloud-native-devices-ease-administrative-burden"><a class="toclink" href="../../2023/01/16/cloud-identity-is-still-the-future/#cloud-native-devices-ease-administrative-burden">Cloud-native devices ease administrative burden</a></h3>
<p>Closely tied to VPN access was the struggle of organizations trying to manage Windows devices that were Active Directory joined, or Hybrid Azure AD Joined. Concerns included patch management, group policy changes, and expired user passwords. The question of machine account password age and the relationship it has with Active Directory became a huge point and topic of confusion.</p>
<p>Microsoft has used the past few years to really push Azure AD Joined devices, making device identity cloud-native. Yes, we still have the issue of remote troubleshooting, which is regardless of how they device identity exists. Yes, we still need to use something like Intune to manage the devices, and the road has been bumpy in replacing group policy. And yes the ROI is not worth it for most organizations to redeploy Windows on existing Hybrid Azure AD Joined devices until those devices are due for a hardware refresh. But we should continue to build the path towards the cloud, away from Active Directory, for client devices.</p>
<p>For those in the Microsoft ecosystem with Active Directory and Azure AD, cloud-native devices can still access on-prem resources tied to Active Directory, either when on a corporate network or coming across the VPN (unfortunately).</p>
<h3 id="cloud-applications-need-cloud-identity"><a class="toclink" href="../../2023/01/16/cloud-identity-is-still-the-future/#cloud-applications-need-cloud-identity">Cloud applications need cloud identity</a></h3>
<p>The benefits should be clear for cloud identity systems. While there have been a few major outages in the past three or so years with Azure AD, the level of complexity required to maintain a 99.99% SLA for a publicly connected directory services system just cannot compare.</p>
<p>If we look at what it takes to manage an AD FS farm with a high level of redundancy ‚Äì at least three sites with Active Directory replicated across, at least one AD FS server (but likely two) in each respective location. If more than one AD FS farm server is in each location, you need location-specific load balancing. For the public edge, you need at least three disparate DMZ networks, with a minimum of one WAP server (but likely two), and then to route the traffic between locations a global traffic management solution, which usually looks like a DNS-based load balancing solution, such as Azure Traffic Manager.</p>
<p><img alt="Figure 1" src="/images/2023/01/16/img1.png" /></p>
<p><em>A highly redundant AD FS farm reference architecture</em></p>
<p>Organizations still need to harden and secure this environment, patch it monthly with orchestrated patch management to ensure availability, and monitor from a security and availability perspective. At the end of it all, this still pales in comparison to Azure AD. AD FS access control policies come nowhere near conditional access. Management and writing of claims policies are still harder for the average person to understand, and Solorigate has shown us what happens when AD FS is compromised.</p>
<p>A pretty surmised way of looking at it ‚Äì cloud-native directory services are designed with identity security practitioners in mind. On-prem directory services are designed with infrastructure practitioners in mind. AD FS is still an ‚Äúinfrastructure‚Äù identity system.</p>
<p>While one can argue some pros of owning your own systems, that argument falls flat when you look at the realization that any of the major identity providers platform developers are investing in cloud-native identity first.</p>
<h3 id="what-about-those-on-prem-servers"><a class="toclink" href="../../2023/01/16/cloud-identity-is-still-the-future/#what-about-those-on-prem-servers">What about those on-prem servers</a></h3>
<p>For as long as Windows server remains in your organization, it‚Äôs likely that Active Directory is not going anywhere. While we have had huge advancements with Windows clients and the cloud, server is another story. Sure, we have things like Azure Arc and Desired State Config (DSC), but many argue that DSC is too complex and not a replacement for group policy. It still makes sense to keep identity close to the servers, so even if you could Azure AD Join a Windows server, the majority of use cases would not be well-served.</p>
<p>Until applications are refactored, the Windows servers they run on aren‚Äôt going anywhere. And the associated service accounts that run these services will likely still need to exist in Active Directory.</p>
<p>But what we may continue to see is a wide array of patterns emerge. Organizations that primarily need Active Directory for compute workloads may drive end-user identity into the cloud, and AD remains as the glue for server administration only. Others that are further behind on their application modernization journey may need to persist user identities in AD.</p>
<h3 id="the-way-forward"><a class="toclink" href="../../2023/01/16/cloud-identity-is-still-the-future/#the-way-forward">The way forward</a></h3>
<p>One of the most important investments organizations can make with cloud identity is not just selecting the platform, but skilling the people. From experiences in performing security assessments of Azure AD, a lack of strong skilling leads to the majority of insecure and inefficient implementations of various components of cloud identity.</p>
<p>We also need to continue to push to transform identity from an infrastructure system to a security system. And this is much more than just transferring ownership and landing a complex identity system in the laps of folks completely unfamiliar with it all. Organizations will need to take a look at what it will take to properly staff identity under the security ecosystem within. This is its own ball of yarn, which I‚Äôll save for another time.</p>
<p>One thing is for sure ‚Äì cloud identity is here to stay.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-12-19 00:00:00+00:00">December 19, 2022</time></li>
        
        
          
          <li class="md-meta__item">
            
              11 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations"><a class="toclink" href="../../2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/">SpAML: Spoofing Users In Azure AD With SAML Claims Transformations</a></h2>
<p>For those that believe SAML is dead, they should take a look at the Azure AD Application Gallery. While the authentication standard finished baking almost two decades ago, it‚Äôs still a staple for integration of applications with Azure AD. As of writing, the Azure AD App Gallery has 2015 applications available for SSO integration, and 1335 of them use SAML, roughly two-thirds. Beyond this, there are thousands of line-of-business (LOB) and other 3rd party applications that don‚Äôt exist in the gallery but leverage SAML. Many well-known applications and platforms are published in the gallery using SAML ‚Äì Salesforce, Google Workspace/Google Cloud, AWS, SAP, Oracle Cloud, ServiceNow, Workday‚Ä¶ the list goes on and on.</p>
<p>With the ease of federated identity, not only are we tying other cloud providers to Azure AD, but we are also bringing in business critical applications. With this, we need to keep in mind that threat actors are not always targeting critical IT resources; one can do plenty damage with access to records and data stored within SaaS applications.</p>
<p>Azure AD makes it easier than ever to spoof (impersonate) a user within a SAML response. This relatively easy technique allows us to impersonate a highly privileged user in the target application. At the same time, authentication behavior for all other users of the application, including the legitimate user being spoofed, will not change. If your organization leverages SCIM for user provisioning, which is the direction the industry is going, this lends in favor of spoofing going undetected, as optional attributes in the SAML response will go unused by the application.</p>
<p>Within Azure AD, you do not need to be a Global Administrator to configure an Enterprise Application. Anyone with Application Administrator, Cloud Application Administrator, or assigned Owner to a specific application can manage it. From a usability perspective, Microsoft pushes delegation of ownership to the business units. The users, however, that now can manage the application, likely fall under the bar of PIM or any privilege separation. Suffice to say, this opens our potential pool of targets in an organization; needing Global Administrator for movement into target applications is not necessary, just whoever has ownership. Likewise, it‚Äôs ripe for abuse by insider threats.</p>
<h3 id="azure-ad-saml-response-primer"><a class="toclink" href="../../2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#azure-ad-saml-response-primer">Azure AD SAML response primer</a></h3>
<p>For a full refresh on the SAML authentication flow, I‚Äôll refer to the IDPro Body of Knowledge Article, <a href="https://bok.idpro.org/article/id/79/">Cloud Service Authenticates Via Delegation ‚Äì SAML</a>. For an understanding of the spoofing technique, the SAML response, which is passed from the Identity Provider (IdP, Azure AD) to the application (SP, Service Provider) via the user, contains both required and optional claims. One of these required claims is the <strong>name identifier</strong>, referred to in the response as the <strong>NameID</strong>.</p>
<p>NameID is a unique attribute that represents the user within the application. It is what the application uses to lookup the user within its internal user database.</p>
<p>Azure AD defaults to, and it is a common pattern these days, to use the Email Address (urn:oasis:names<img alt="üáπüá®" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f1f9-1f1e8.svg" title=":tc:" />SAML:1.1:nameid-format:emailAddress) format. The default source attribute that is emitted in the SAML response is user.userprincipalname.</p>
<p>As an example, I authenticate to Azure AD as nestor.wilke@fabrikam.cloud, and subsequently when I connect to an Enterprise Application, say AWS, the SAML response contains the NameID below. On the identity layer, AWS uses this to match Nestor to his user account.</p>
<div class="highlight"><pre><span></span><code>&lt;NameID Format=&quot;urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress&quot;&gt;nestor.wilke@fabrikam.cloud&lt;/NameID&gt; 
</code></pre></div>
<p>Azure AD also provides the ability to create <strong>claim transformations</strong>. Claim transformations can be useful for several reasons. A simple example is if the application has case sensitivity requirements. One can apply a ToLowercase() and not have worry about needing to modify broader patterns in Azure AD to satisfy one application. Claims transformations are configured on a per-claim basis within each Enterprise Application that is using SAML.</p>
<h3 id="setting-the-stage"><a class="toclink" href="../../2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#setting-the-stage">Setting the stage</a></h3>
<p>An effective use of spoofing the SAML response is to impersonate a highly privileged user in an application. For our example, let‚Äôs look at a few different user personas, in a somewhat simplified scenario:</p>
<ul>
<li>Nestor Wilke is an account owner in AWS, and because this is considered a highly privileged role, he has privileged credentials he uses for accessing AWS, p-nestor.wilke@fabrikam.cloud.</li>
<li>Isaiah Langer is part of the Operations team that is tasked with providing support to Enterprise Applications, which provides rights over the AWS Enterprise Application. Groups are used for user assignment to AWS, and AWS role assignment happens in AWS IAM Identity Center. Isaiah can manage these applications with his normal user account, isaiah.langer@fabrikam.cloud. He has an account in AWS, but his privileges there are low.</li>
</ul>
<h3 id="configuring-our-malicious-transform"><a class="toclink" href="../../2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#configuring-our-malicious-transform">Configuring our malicious transform</a></h3>
<p>Once we gain access to an account with ownership over the application, we will want to jump into Azure AD, and browse to Enterprise Applications, and then open the target application.</p>
<p>Within here, we will select Single sign-on in the left blade, and then under Attributes &amp; Claims on the right blade, select Edit:</p>
<p><img alt="Figure 1" src="/images/2022/12/19/img1.png" /></p>
<p>In the new blade that opens, we want to select the Unique User Identifier (Name ID) claim:</p>
<p><img alt="Figure 2" src="/images/2022/12/19/img2.png" /></p>
<p>Note that in our example we will be using a transform on user.userprincipalname, but this same technique can apply to any attribute that is being used for NameID.</p>
<p>Within the <strong>Manage claim</strong> window, we want to select <strong>Transformation</strong> under <strong>Source</strong>. This will open a new <strong>Manage transformation</strong> blade on the right:</p>
<p><img alt="Figure 3" src="/images/2022/12/19/img3.png" /></p>
<p>For spoofing, we need to know just two things ‚Äì the UPN of the user we want to spoof, and the UPN of the user who will be used for performing the spoofing.</p>
<p>Under <strong>Transformation</strong>, select <strong>Contains()</strong>. For P<strong>arameter 1 (Input)</strong> select <strong>user.userprincipalname</strong>. For Value, we will enter <em>isaiah.langer@fabrikam.cloud</em>. For <strong>Parameter 2 (Output)</strong>, do <strong>not</strong> select an attribute from the dropdown menu. Instead, click into the window within the menu and enter <em>p-nestor.wilke@fabrikam.cloud</em>.</p>
<p><img alt="Figure 4" src="/images/2022/12/19/img4.png" /></p>
<p>We then check the box for <strong>Specify output if no match</strong>, and for <strong>Parameter 3 (Output if no match)</strong> select <strong>user.userprincipalname</strong>.</p>
<p>This last piece is what ensures that all other users accessing AWS will continue to have the same user experience, including Nestor. Our final transform will look like:</p>
<p><img alt="Figure 5" src="/images/2022/12/19/img5.png" /></p>
<p>And we can confirm the pattern in the claims rule:</p>
<div class="highlight"><pre><span></span><code>If &#39;user.userprincipalname&#39; contains &#39;isaiah.langer@fabrikam.cloud&#39; then output &#39;p-nestor.wilke@fabrikam.cloud&#39;. Else, output &#39;user.userprincipalname&#39;.
</code></pre></div>
<p>We select <strong>Add</strong>, and then <strong>Save</strong>.</p>
<h3 id="using-our-malicious-transform"><a class="toclink" href="../../2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#using-our-malicious-transform">Using our malicious transform</a></h3>
<p>Now that we have things configured, let‚Äôs look at this in action. Recall that Nestor is our target user, and Isaiah is the account that will be used for spoofing.</p>
<div class="video-wrapper">
  <iframe src="https://www.youtube-nocookie.com/embed/FHWV854iYDo"
          title="SpAML Abuse"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen"
          allowfullscreen>
  </iframe>
</div>

<p>This is just one example. This has been similarly tested and proofed with GCP and Salesforce and should be valid for any SAML application whether from the application gallery or a LOB application.</p>
<h3 id="detecting-malicious-transforms"><a class="toclink" href="../../2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#detecting-malicious-transforms">Detecting malicious transforms</a></h3>
<p>Unfortunately, the ability to detect a transform like this is difficult, as normal channels do not expose the data we expect and need.</p>
<h4 id="audit-logging-is-broken"><a class="toclink" href="../../2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#audit-logging-is-broken">Audit logging is broken</a></h4>
<p>The first thought is to go to our Azure AD audit logs. After all, the change should be recorded in Azure AD, so we can ingest that data for detection.</p>
<p>SAML claim policy auditing, is unfortunately, broken. If we look at our audit logs after Isaiah made the change, we will see the following:</p>
<p><img alt="Figure 6" src="/images/2022/12/19/img6.png" /></p>
<p>We can drill into the Target(s) and see that there was a change made to a ClaimIssuancePolicy:</p>
<p><img alt="Figure 7" src="/images/2022/12/19/img7.png" /></p>
<p>But when we look at the Modified Properties:</p>
<p><img alt="Figure 8" src="/images/2022/12/19/img8.png" /></p>
<p>Note that there is nothing of value. <strong>Any</strong> SAML claim issuance policy changes in Azure AD show up the same way. To ensure this was not some sort of limitation of the portal itself, I looked at the data exported to Log Analytics:</p>
<p><img alt="Figure 9" src="/images/2022/12/19/img9.png" /></p>
<p>I‚Äôve had a support case open with Microsoft through standard channels on this, but there has been no movement.</p>
<h4 id="graph-api-does-not-expose-saml-claim-policies"><a class="toclink" href="../../2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#graph-api-does-not-expose-saml-claim-policies">Graph API does not expose SAML claim policies</a></h4>
<p>Figure the next place we may turn would be the Microsoft Graph API, but again we are blocked here. The Graph API does not expose SAML claim issuance policies, something that can be traced back to 2019 with customers asking for it, yet still is not supported from my recent check with Microsoft.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Microsoft has claimed to resolve this by making claim transforms available through Graph API, however, it's a different set of transforms.</p>
</div>
<h4 id="what-are-we-left-with"><a class="toclink" href="../../2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#what-are-we-left-with">What are we left with?</a></h4>
<p>As Azure AD does not provide native means for easily tracking this, we can either go with something of relatively low fidelity, alerting on all changes to a ClaimIssuancePolicy, but this is also going to alert on all changes, good and bad. If there is little in the way of activity with SAML application onboarding in the environment, this may suffice.</p>
<p>From a retroactive analysis perspective, because these are not exposed through the Graph API, the only way to verify the policy settings is through manual inspection.</p>
<p>Using a SIEM platform for authentication log correlation may at first seem appealing but consider that authentication times are likely the only mechanism for correlation. If the platform has a high volume of user activity, that is going to create an immense level of complexity, as Azure AD and the application are highly likely going to be exposing the time the user authenticated into those systems, which may not align to the necessary precision.</p>
<h3 id="preventing-malicious-transforms"><a class="toclink" href="../../2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#preventing-malicious-transforms">Preventing malicious transforms</a></h3>
<p>Preventing malicious transforms becomes even more important when our ability to properly monitor for them is inhibited.</p>
<p>From a prevention perspective it‚Äôs back to the basics. The following should apply for all Global Administrators, as well as Application Administrator or Cloud Application Administrator roles if your organization heavily relies on them for management of Enterprise Applications:</p>
<ul>
<li>Privilege separated from daily driver accounts</li>
<li>Accounts should not be mail-enabled</li>
<li>Cloud-sourced and not synchronized from Active Directory</li>
<li>Azure AD PIM should be used with MFA requirement for elevation</li>
<li>Roles scoped with a Conditional Access policy requiring MFA for Azure management</li>
<li>Passwordless should be enabled and required for these accounts</li>
<li>Accounts should be scoped for Azure AD Identity Protection</li>
<li>Require a Privileged Access Workstation (PAW) for highly privileged operations</li>
</ul>
<p>If you heavily delegate the owner role for specific Enterprise Applications, you may want to re-evaluate how you are securing the users with delegated access. While it‚Äôs unlikely businesses will accept the model of privilege separation or a PAM implementation for the HR administrator team that owns Workday, it may be a place to reconsider if those delegations are necessary. If delegation primarily exists to assign membership to the application, the model could be changed to instead provide delegated ownership over the groups that are already assigned, or leverage entitlement management for application access lifecycle.</p>
<p>The surface area for abuse by a threat actor can be reduced by application conditional access requiring compliant devices for all users with proper endpoint management in place, but from the perspective of insider threat or certain token theft scenarios, this may not be sufficient.</p>
<p>Heavily restricted Conditional Access policies will not prevent user impersonation, as all CA policies are evaluated prior to the issuance of the SAML response. In our example, even if Nestor was restricted to using a PAW for accessing AWS, Isaiah would have been able to access AWS under whatever conditions CA was applying to his user account. If the application requires user assignment, or if a CA policy specifically blocked Isaiah from access, the risk is mitigated. For many business-critical applications, such as Workday, it‚Äôs highly likely that blocking scenarios cannot be applied as the application is used across the workforce. Using mechanisms such as role assignment may be circumvented with a combination of claim conditions and transforms.</p>
<p>If the target application provides mechanisms for privilege escalation management within, it may also stop the ability for impersonation, as the user would be presented to elevate privilege for the spoofed user within the target.</p>
<h3 id="responsible-disclosure"><a class="toclink" href="../../2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#responsible-disclosure">Responsible disclosure</a></h3>
<p>When I initially came up with my proof case, I opened a case with MSRC, indicating that claims transforms should not allow for a constant output for NameID, as it enables for spoofing. Even though it is not a security risk within Azure AD, as the identity provider, proper controls should exist within the IdP to ensure that associated applications are not overly exposed to a security risk such as NameID spoofing.</p>
<ul>
<li>August 30th, 2022: Opened case with MSRC</li>
<li>October 10th, 2022: Response from MSRC with case closed, ‚ÄúWe determined that this behavior is considered to be by design.‚Äù</li>
</ul>
<p>Likewise, a support case with Microsoft has been opened regarding deficiencies with SAML claim audit logging.</p>
<ul>
<li>October 20th, 2022: Opened support Sev C case with Microsoft</li>
<li>October 26th, 2022: First response from SE with inaccurate understanding of case</li>
<li>October 27th, 2022: Reply to SE with additional clarity</li>
<li>November 8th, 2022: SE calls at a random time, follows up with email that a session will be scheduled on November 14th, at 9:30am EST</li>
<li>November 14th, 2022: SE does not call at 9:30am EST</li>
<li>November 14th, 2022: SE calls at 12:30pm EST, I request a call back at 1:00pm EST, SE agrees to call back at 1:00pm EST</li>
<li>November 14th, 2022: SE does not call at 1:00pm EST</li>
<li>November 17th, 2022: SE emails and schedules a call for November 18th, 2022 at 10:00am EST</li>
<li>November 18th, 2022: SE does not call at 10:00am EST</li>
<li>November 21st, 2022: SE emails indicating that I did not answer my phone at indeterminate time. Check with phone carrier, no call was ever received.</li>
<li>November 28th, 2022: SE calls me outside of working hours.</li>
<li>November 28th, 2022: I reply to an email with times that the SE can reach me</li>
<li>December 9th, 2022: SE calls, able to finally have the screen sharing session. Walk the SE through the details I provided in my case showing the behavior of these changes not being properly audited. SE indicates that the case needs to be escalated.</li>
<li>December 14th, 2022: SE calls me to let me know the case is still being investigated.</li>
<li>January 9th, 2023: SE contacts me to let me know I need to reproduce the issue for fresh data for MS.</li>
<li>January 25th, 2023: SE emails me to let me know the case is still being investigated.</li>
<li>February 16th, 2023: SE emails me to let me know the case is still being investigated.</li>
<li>February 20th, 2023: SE contacts me to let me know I need to reproduce the issue for fresh data for MS.</li>
<li>March 15th, 2023: Case is re-assigned to an ‚ÄúAzure Support Ambassador‚Äù. It‚Äôs indicated that the case is still being investigated.</li>
<li>March 17th, 2023: I email the Support Ambassador asking if it would be possible to find out more details about the case directly from engineering.</li>
<li>March 27th, 2023: Support Ambassador emails me to let me know that a bug has been filed to be fixed at a later date.</li>
<li>March 29th, 2023: Support closes the case without asking if it‚Äôs alright to do so.</li>
</ul>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-06-16 00:00:00+00:00">June 16, 2022</time></li>
        
        
          
          <li class="md-meta__item">
            
              10 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="azure-ad-which-sso-is-the-right-sso"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/">Azure AD: Which SSO Is The Right SSO?</a></h2>
<p>It‚Äôs great having choices, except when you are not sure which choice to make.</p>
<p>For organizations that are on a hybrid journey with Azure AD, the question of single sign-on (SSO) almost always comes up. And with that, people turn to the documentation with questions. Do we need hybrid join? Do we need Azure AD Seamless SSO? Do we need both? Can we configure both? Why isn‚Äôt hybrid join listed as an SSO mechanism in the docs? If hybrid join is preferred, why does Azure AD Seamless SSO mention seamless, isn‚Äôt it better?</p>
<p>While there is one paragraph contrasting the two choices in the docs, <a href="https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso#sso-via-primary-refresh-token-vs-seamless-sso">Azure AD Connect: Seamless Single Sign-On ‚Äì Microsoft Entra | Microsoft Docs</a>, the question still comes up often. Which brings us here ‚Äì gaining clarity on the SSO choices for Azure AD. To keep the article focused, we are going to be exploring SSO for corporate owned and managed Windows devices that are joined to an Active Directory domain.</p>
<p>And for the camp out there that firmly believes everything should just go straight to Azure AD Join (AADJ), and forget hybrid‚Ä¶ this article is for those that have their reasons to stay with hybrid join for the moment. Even though you should go cloud-native with AADJ.</p>
<h3 id="sso-mechanics"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#sso-mechanics">SSO mechanics</a></h3>
<p>Before getting into the compare and contrast, it‚Äôs important to understand the fundamental reason as to why SSO works differently depending on the method implemented.</p>
<h4 id="azure-ad-hybrid-join"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#azure-ad-hybrid-join">Azure AD Hybrid Join</a></h4>
<p>When you think of Azure AD Hybrid Join (HAADJ), it helps to think of the Windows device having a duality of identity for the signed-in user.</p>
<p><img alt="Figure 1" src="/images/2022/06/16/img1.png" /></p>
<p>When a user signs in to Windows, not only does the user receive a Kerberos TGT from Active Directory, but also an Azure AD Primary Refresh Token (PRT).</p>
<p>And this PRT piece is key ‚Äì while the technology behind it is quite different, it‚Äôs logically the Azure AD version of the TGT, which allows your device to speak modern authentication natively with Azure AD.</p>
<p>For an extremely in-depth look at all the mechanics at play for authentication on a hybrid joined device, and how obtaining a PRT flows, see <a href="https://docs.microsoft.com/en-us/azure/active-directory/devices/concept-primary-refresh-token#detailed-flows">Primary Refresh Token (PRT) and Azure AD ‚Äì Azure Active Directory ‚Äì Microsoft Entra | Microsoft Docs</a>.</p>
<h4 id="azure-ad-seamless-sso"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#azure-ad-seamless-sso">Azure AD Seamless SSO</a></h4>
<p>Unlike Hybrid Join, Azure AD Seamless SSO flips things around, and essentially provides the ability for Azure AD to participate in Active Directory, not from an authentication provider perspective, but as a member computer object.</p>
<p><img alt="Figure 2" src="/images/2022/06/16/img2.png" /></p>
<p><em>Courtesy Microsoft Learn</em></p>
<p>From the diagram, we see that Azure AD has a computer account representation in Active Directory, with the computer object <strong>AZUREADSSO</strong> being the representation in AD. Azure AD holds the Kerberos decryption key for this computer object, which is what allows Azure AD to handle the TGT being passed to it.</p>
<p>The most critical piece within this model for SSO, is that line-of-sight of Active Directory is <strong>required</strong> for SSO to function.</p>
<h3 id="sso-breakdown"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#sso-breakdown">SSO Breakdown</a></h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Azure AD Hybrid Join</th>
<th>Azure AD Seamless SSO</th>
</tr>
</thead>
<tbody>
<tr>
<td>Configured with Azure AD Connect</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>Requires AD line-of-sight for configuration</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>No group policy needed for core config</td>
<td>‚úÖ</td>
<td>‚ùå</td>
</tr>
<tr>
<td>No computer object sync to Azure AD</td>
<td>‚ùå</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>No browser plugin needed for Edge</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>No browser plugin needed for Chrome</td>
<td>‚ùå</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>No browser plugin needed for Firefox</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>Deployment is non-disruptive to users</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>Supports Windows 8.1</td>
<td>‚ö†Ô∏è</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>Supports Windows 10</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>Supports Windows 11</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>Uses Active Directory for Authentication</td>
<td>‚ùå</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>Uses Azure AD for Authentication</td>
<td>‚úÖ</td>
<td>‚ùå</td>
</tr>
<tr>
<td>Works without AD line-of-sight</td>
<td>‚úÖ</td>
<td>‚ùå</td>
</tr>
<tr>
<td>No Kerberos decryption key to rollover</td>
<td>‚úÖ</td>
<td>‚ùå</td>
</tr>
<tr>
<td>Is completely Seamless SSO</td>
<td>‚úÖ</td>
<td>‚ö†Ô∏è</td>
</tr>
</tbody>
</table>
<h4 id="configuration"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#configuration">Configuration</a></h4>
<p>Whether it‚Äôs Hybrid Azure AD Join, or Azure AD Seamless SSO, both are first enabled primarily using Azure AD Connect.</p>
<p>For details on enablement of Hybrid Azure AD Join, see <a href="https://docs.microsoft.com/en-us/azure/active-directory/devices/howto-hybrid-azure-ad-join">Configure hybrid Azure Active Directory join ‚Äì Microsoft Entra | Microsoft Docs</a>.</p>
<p>For details on enablement of Azure AD Seamless SSO, see <a href="https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso-quick-start">Azure AD Connect: Seamless Single Sign-On ‚Äì quickstart ‚Äì Microsoft Entra | Microsoft Docs</a>.</p>
<h4 id="active-directory-line-of-sight-for-client-enablement"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#active-directory-line-of-sight-for-client-enablement">Active Directory line-of-sight for client enablement</a></h4>
<p>When deploying Azure AD Hybrid Join, it is required that computers have line-of-sight of Active Directory in a PHS or PTA scenario (and usually for ease in a federated scenario). The reason is that Azure AD Connect is the means for Windows to bootstrap its trust relationship with Azure AD ‚Äì when you enable hybrid join, you‚Äôll note that the computer object in scope has the <strong>userCertificate</strong> attribute in Active Directory populated. This is the public half of a key-pair generated by the Windows device, which makes it way up to Azure AD, via Azure AD Connect, and is tied to the created device object in Azure AD. When you see a device with a Registered date/time of <strong>Pending</strong>, it means the device has been created in Azure AD, but the Windows client itself hasn‚Äôt finished the hybrid join process. Now that we have the means for a trust relationship to be established, the Windows client uses this key-pair to connect to Azure Active Directory Device Registration Service (AAD DRS); the key-pair used is replaced with a permanent key-pair, and hybrid join is complete. <strong>Afterward</strong>, line-of-sight of Active Directory is not required for authentication to Azure AD, even though you still will want to keep your hybrid joined devices in scope for Azure AD Connect, so that device disable and device delete actions will flow up to Azure AD.</p>
<p>For Azure AD Seamless SSO, you‚Äôll always need AD line-of-sight for this to function, and many orgs tend to use group policy to roll out the configuration, which also would need that same line-of-sight.</p>
<h4 id="group-policy-for-client-configuration"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#group-policy-for-client-configuration">Group policy for client configuration</a></h4>
<p>For rollout of Azure AD Hybrid Join across an organization, there is no need to configure anything additional through group policy. This is because, by default, configuration of HAADJ leverages a Service Connection Point (SCP) in Active Directory. Because the SCP is stored in the Configuration partition in AD, this is the reason configuration of Hybrid Join requires Enterprise Administrator. And while your Azure AD Connect server <strong>should</strong> be treated as Tier 0, if you have concern using an Enterprise Admin account on the Azure AD Connect server, a script can be downloaded to configure and run this from another system. The exception to no group policy is for organizations which are performing a targeted rollout of HAADJ, even though you can also control rollout by excluding devices from synchronization in Azure AD Connect.</p>
<p>For Azure AD Seamless SSO, there are group policy settings that are inevitably needed regardless of the rollout plan. By default, browsers will not send Kerberos tickets to an internet endpoint, so configuration on the client is required to set an Azure AD URL to Intranet zone. And yes, you may be able to use alternatives such as Intune to push these settings to clients, but it still comes down to needing to push a configuration change to clients.</p>
<h4 id="azure-ad-computer-object-sync"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#azure-ad-computer-object-sync">Azure AD computer object sync</a></h4>
<p>Now, some may consider this an advantage, not having to synchronize their computer objects to Azure AD for Azure AD Seamless SSO.</p>
<p>Many organizations, however, going down the modern device management route, or wanting to strengthen their security posture in conditional access with policies based on compliance or hybrid join, will need to sync their computer objects, as part of the requirement for hybrid join (excluding organizations with AD FS in place). And if you‚Äôre looking to go passwordless with Windows Hello for Business on these devices, hybrid join is also a prerequisite.</p>
<p>And considering what a non-event it is to enable hybrid join, it‚Äôs hard to argue against it.</p>
<h4 id="browser-support"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#browser-support">Browser Support</a></h4>
<h5 id="edge"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#edge">Edge</a></h5>
<p>Neither method of SSO requires anything additional in Edge.</p>
<h5 id="chrome"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#chrome">Chrome</a></h5>
<p>For Chrome to be able to take advantage of the PRT with hybrid join (or Azure AD Join), and subsequently perform SSO using the PRT, you‚Äôll want to install the Windows Accounts extension in Chrome, <a href="https://chrome.google.com/webstore/detail/windows-accounts/ppnbnpeolgkicgegkbkbjmhlideopiji/related?hl=en-US">Windows Accounts ‚Äì Chrome Web Store (google.com)</a>.</p>
<p>Azure AD Seamless SSO does not require this browser extension, as Chrome has long supported integrated authentication.</p>
<h5 id="firefox"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#firefox">Firefox</a></h5>
<p>Mozilla, likely in a move to keep Firefox competitive, released an update starting with version 91 to support PRT authentication natively within the browser, <a href="https://support.mozilla.org/en-US/kb/windows-sso">Windows SSO | Firefox Help (mozilla.org)</a>.</p>
<p>Like Chrome, Firefox has long had support for integrated authentication, so it‚Äôs able to handle Azure AD Seamless SSO without a plugin.</p>
<h4 id="os-support"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#os-support">OS Support</a></h4>
<h5 id="windows-1011"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#windows-1011">Windows 10/11</a></h5>
<p>As noted in the article highlighted earlier, <a href="https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso#sso-via-primary-refresh-token-vs-seamless-sso">Azure AD Connect: Seamless Single Sign-On ‚Äì Microsoft Entra | Microsoft Docs</a>, recommendation for these modern versions of Windows is to use hybrid join and subsequently a PRT for SSO.</p>
<h5 id="windows-81"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#windows-81">Windows 8.1</a></h5>
<p>If, for some unfortunate reason, you still have Windows 8.1 (or no longer supported Windows 7 or 8) in your environment, and still want all the snazziness of letting decrepit operating systems enjoy the cloud, Azure AD Seamless SSO is going to be the easier bet. Hybrid Join for downlevel devices requires installation of the Workplace Join agent and some additional configuration to support hybrid join.</p>
<h4 id="end-user-experience"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#end-user-experience">End-user experience</a></h4>
<p>From the end user experience, hybrid join is going to give our users what is Azure AD native SSO. The user signs in to Windows, and they receive or refresh their Azure AD PRT, and off they go. When browsing, the user won‚Äôt be prompted to enter their username or password, and will just be right into their applications.</p>
<p>Azure AD Seamless SSO, on the other hand, has a few specifics about what SSO looks like. When a user goes to access an application the first time, they will be prompted to enter their username, but shouldn‚Äôt be asked for their password. There are ways to work around this with altering the URL to contain a login hint, but it generally would not be intuitive for a user. Also, if a user chooses to sign out from an application tied to Azure AD, upon sign-in, they are required to enter their password ‚Äì this is considered by design. But even if we look past these, when our user is away from the corporate network, they will be asked to enter their password. And asking our users to have to enter their password when we can provide the means not to, isn‚Äôt the best for our user experience, and isn‚Äôt the best for security.</p>
<h4 id="maintenance"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#maintenance">Maintenance</a></h4>
<p>For hybrid join, there is potential maintenance in needing to restructure how OU‚Äôs are synchronized with Azure AD Connect, though generally many organizations find ways to make this a bit of a one and done scenario.</p>
<p>For Azure AD Seamless SSO, it is recommended that organizations rollover the Kerberos decryption key stored in Azure AD for the <strong>AZUREADSSO</strong> computer object every 30 days. This has to be performed manually, or automated through a process that though subsequently requires providing some task Domain Administrator credentials. Less than ideal, but because Azure AD isn‚Äôt able to directly perform this process against AD, we are left with no other choice.</p>
<h3 id="so-which-sso-is-the-right-sso"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#so-which-sso-is-the-right-sso">So which SSO is the right SSO?</a></h3>
<p>If your organization is primarily Windows 10/11 devices that are AD domain joined, <strong>Azure AD Hybrid Join</strong> is the route to go. To be clear, <strong>you do not</strong> need to deploy Azure AD Seamless SSO along with hybrid join; your clients <strong>will not</strong> use Azure AD Seamless SSO if the device has a PRT.</p>
<p>If you have to support downlevel installs of Windows 8.1, Seamless SSO may be an easier route than hybrid join, and you can enable seamless SSO and just target those devices for configuration.</p>
<p>Likewise, if you are supporting MacOS in your environment, enabling Azure AD Seamless SSO can provide a better authentication experience if those Macs are Active Directory domain joined. Even though at this point you may want to look at the Enterprise SSO plugin for MacOS, <a href="https://docs.microsoft.com/en-us/mem/intune/configuration/use-enterprise-sso-plug-in-ios-ipados-macos">Microsoft Enterprise SSO plug-in in Microsoft Intune | Microsoft Docs</a>.</p>
<p>There‚Äôs no harm in having both methods configured, but if the mechanism for Seamless SSO isn‚Äôt actually being leveraged in your environment, and if you have hybrid joined Windows 10/11 devices <strong>it‚Äôs not</strong>, it‚Äôs just an extra bit of configuration to manage and maintain with no benefit.</p>
<h4 id="what-about-federated-identity"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#what-about-federated-identity">What about federated identity?</a></h4>
<p>If an organization has AD FS or a supported 3rd party IdP in the mix, such as PingFederate or Okta, the proper route to go, from an Azure AD perspective, is still hybrid join.</p>
<p>Hybrid join is still going to provide you SSO with your PRT for applications leveraging Azure AD as their identity provider ‚Äì when you authenticate interactively with the Windows client at sign-on, WS-Trust is the means to authenticate you to your federated identity provider behind the scenes, and in return allowing Azure AD to give you a fresh PRT.</p>
<p>The MS Docs articles indicate that Seamless SSO is not supported with federated identity, and I‚Äôve never tried to see what happens if you force it via PowerShell module ‚Äì but would presume you run into conflicts with overlap in how Azure AD handles hints for bypassing username entry for Seamless SSO and how Azure AD handles hints for bypassing username entry for federated auth.</p>
<h4 id="what-about-azure-ad-join"><a class="toclink" href="../../2022/06/16/azure-ad-which-sso-is-the-right-sso/#what-about-azure-ad-join">What about Azure AD join?</a></h4>
<p>Azure AD Join (AADJ) should be the long-term goal for organizations, going cloud native and removing their clients dependency on Active Directory. Under the hood, the mechanics of authentication for AADJ are <strong>just</strong> the bits that give you that Azure AD PRT, and Azure AD is now the authoritative identity provider for those clients. For many organizations, it tends to be client management and group policies that lend the most complexity in going cloud native, even though it is the future, so now is as good as ever to start a pilot down that road while you continue to support existing clients with Hybrid Azure AD Join.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-05-04 00:00:00+00:00">May 4, 2022</time></li>
        
        
          
          <li class="md-meta__item">
            
              7 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="world-password-day"><a class="toclink" href="../../2022/05/04/world-password-day/">World Password Day</a></h2>
<p>Forget passwords. Passwords are garbage. To celebrate World Password Day, I‚Äôm curating blog articles that can help organizations on their passwordless journey.</p>
<p>While much of the Microsoft documentation on passwordless is quite good, it can tend to be overwhelming at times; the hope is to give you some great leads on some clear, step-by-step instructions on how to get you from a password-filled to a passwordless world in Active Directory and Azure AD.</p>
<p>With each link, I‚Äôve provided a rough time estimate for how long the process should take, given a dedicated effort. There may always be the fringe case or two where passwordless is more complex ‚Äì if your existing environment has things such as AD FS and using smartcards, or has DC‚Äôs older than 2016, you have a bunch of Macs in your environment, as examples. It always helps to review the documentation, which I also link to.</p>
<p>If you want to dive further into why this is so important, I‚Äôll refer you to these two blog articles from Alex Weinert [<a href="https://twitter.com/Alex_T_Weinert">@Alex_T_Weinert</a>], the Director of Identity Security at Microsoft.</p>
<p><a href="https://techcommunity.microsoft.com/t5/azure-active-directory-identity/your-pa-word-doesn-t-matter/ba-p/731984">Your Pa$$word doesn‚Äôt matter ‚Äì Microsoft Tech Community</a> ‚Äì Alex discusses why MFA is so important.</p>
<p><a href="https://techcommunity.microsoft.com/t5/azure-active-directory-identity/all-your-creds-are-belong-to-us/ba-p/855124">All your creds are belong to us! ‚Äì Microsoft Tech Community</a> ‚Äì Alex discusses why passwordless strong authentication is important and shows why more common forms of MFA are still phishable.</p>
<p>See something missing? Still have questions? Not sure how the underlying technology works? Reach out to me.</p>
<p>And if you are a fellow Microsoft blogger who thinks their article would be a good fit, but it‚Äôs not on here? Reach out and I‚Äôll update accordingly.</p>
<h3 id="but-i-havent-started-the-passwordless-journey-yet"><a class="toclink" href="../../2022/05/04/world-password-day/#but-i-havent-started-the-passwordless-journey-yet">But I haven't started the passwordless journey yet</a></h3>
<p>You aren‚Äôt alone. Many organizations find it difficult to fit yet another new project onto the docket.</p>
<p>The thing about passwordless ‚Äì while it may be a journey, it‚Äôs also one of the easiest journeys to start. All major mechanisms of passwordless ‚Äì Windows Hello for Business (WHfB), FIDO2 security keys, Authenticator App for primary authentication, and smartcards ‚Äì they all can be implemented in a wave/phase/ring (pick your favorite descriptor) approach. And the underlying directory &amp; infrastructure changes (if any) can be implemented in a non-disruptive manner.</p>
<p>Can‚Äôt get the whole organization onboard? That‚Äôs ok, x% is better than 0%.</p>
<p>Don‚Äôt have biometrics on all your devices? WHfB has PIN support.</p>
<p>End-users not wanting to MDM enroll their devices? Authenticator App only requires Device Registration.</p>
<p>FIDO2 feel odd or uncomfortable? It‚Äôs essentially modern smartcards.</p>
<p>Have some applications that still use legacy means of authentication? Most organizations do, but we can minimize the need to use passwords beyond them.</p>
<p>Concerned users may still use their password because you can‚Äôt fully get rid of it? When we give users an easier passwordless experience, they will not opt for something more complex. Users love easy things.</p>
<p>When talking about the security of identity, the <strong>most important thing</strong> we can all do is <strong>change our mindset</strong>. Instead of focusing on the possibility that a single solution may not cover 100% of user personas, we need to focus on whatever percentage we <strong>can</strong> cover, which will <strong>reduce</strong> the <strong>password attack surface</strong> immensely for those users, and our organization.</p>
<h3 id="authenticator-app-for-primary-authentication"><a class="toclink" href="../../2022/05/04/world-password-day/#authenticator-app-for-primary-authentication">Authenticator App for primary authentication</a></h3>
<p><strong>Infrastructure effort: 5-10 minutes</strong>
<strong>End user enrollment effort: 5-10 minutes</strong>
<strong>Can be rolled out selectively: Yes</strong>
<strong>Can be enabled on an end user without forcing them to enroll: Yes</strong></p>
<p>Lots of folks might be familiar with the Microsoft Authenticator App, but did you know you can use it for passwordless authentication? You can. It‚Äôs great for when users need to be passwordless when accessing company resources from a mobile device, or when they are on the go and need to auth through a web browser.</p>
<p>Jason Samuel [<a href="https://twitter.com/_JasonSamuel">@_JasonSamuel</a>] has a good write-up here covering enablement. He also gets into Citrix Workspace stuff, but even if you don‚Äôt have Citrix in your environment, the other parts are written straightforward:</p>
<p><a href="https://www.jasonsamuel.com/2019/03/04/how-to-setup-password-less-phone-sign-in-authentication-with-microsoft-authenticator-azure-ad-and-citrix-workspace/">How to setup password-less phone sign-in authentication with Microsoft Authenticator, Azure AD, and Citrix Workspace ‚Äì JasonSamuel.com</a></p>
<p>Microsoft Docs article for reference can be found here:</p>
<p><a href="https://docs.microsoft.com/en-us/azure/active-directory/authentication/howto-authentication-passwordless-phone">Passwordless sign-in with the Microsoft Authenticator app ‚Äì Azure Active Directory | Microsoft Docs</a></p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>If you are also using the number matching preview for Authenticator App push notifications, the passwordless configuration is covered under the same settings in Azure AD. If you are using groups to selectively roll out these settings, I cover targeting groups here:</p>
<p><a href="https://ericonidentity.com/2022/02/22/azure-ad-increasing-security-within-the-mfa-experience/">Azure AD: Increasing Security within the MFA Experience ‚Äì Eric on Identity</a></p>
</div>
<h3 id="fido2-security-keys"><a class="toclink" href="../../2022/05/04/world-password-day/#fido2-security-keys">FIDO2 Security Keys</a></h3>
<p><strong>Infrastructure effort: 20 minutes for AADJ devices. 40 minutes for HAADJ devices.</strong>
<strong>End user enrollment effort: 5-10 minutes</strong>
<strong>Can be rolled out selectively: Yes</strong>
<strong>Can be enabled on an end user without forcing them to enroll: Yes</strong></p>
<p>FIDO2 security keys are the latest and greatest thing ‚Äì it‚Äôs based on asymmetric cryptography ‚Äì what we generally refer to as certificates (even though a key is a piece within a certificate).</p>
<p>Many organizations that have never operated in a highly secure environment where smartcards are prevalent may find the idea of a device containing a certificate for authentication seeming a bit odd. But we should look at FIDO2 security keys as smartcard 2.0 ‚Äì it‚Äôs all the great security features of smartcards, but packed and managed in a way that makes it easier to manage from both the IT and end-user side.</p>
<p>For a great deep dive on how FIDO2 works, look at this article by Dominik Hoefling [<a href="https://twitter.com/DominikHoefling">@DominikHoefling</a>]:</p>
<p><a href="https://practical365.com/understanding-how-fido-makes-passwordless-authentication-possible/">Understanding How FIDO Makes Passwordless Authentication Possible (practical365.com)</a></p>
<p>To see how to configure your environment to support FIDO2 for Azure AD Joined devices, Peter Klapwijk [<a href="https://twitter.com/inthecloud_247">@inthecloud_247</a>] has us covered. He uses Feitian keys but any supported FIDO2 key will work:</p>
<p><a href="https://www.inthecloud247.com/enable-passwordless-authentication-to-windows-10-with-feitian-security-keys/">Enable passwordless authentication to Windows 10 with Feitian security keys | (inthecloud247.com)</a></p>
<p>Peter also has a great article covering the same, but for Hybrid Azure AD Join:</p>
<p><a href="https://www.inthecloud247.com/enable-passwordless-security-key-sign-in-in-hybrid-azure-active-directory-environments/">Enable passwordless security key sign-in in Hybrid Azure Active Directory environments | (inthecloud247.com)</a></p>
<p>Microsoft Docs articles for reference can be found here:</p>
<p><a href="https://docs.microsoft.com/en-us/azure/active-directory/authentication/howto-authentication-passwordless-security-key">Passwordless security key sign-in ‚Äì Azure Active Directory | Microsoft Docs</a></p>
<p><a href="https://docs.microsoft.com/en-us/azure/active-directory/authentication/howto-authentication-passwordless-security-key-windows">Passwordless security key sign-in Windows ‚Äì Azure Active Directory | Microsoft Docs</a></p>
<p><a href="https://docs.microsoft.com/en-us/azure/active-directory/authentication/howto-authentication-passwordless-security-key-on-premises">Passwordless security key sign-in to on-premises resources ‚Äì Azure Active Directory | Microsoft Docs</a></p>
<h3 id="windows-hello-for-business"><a class="toclink" href="../../2022/05/04/world-password-day/#windows-hello-for-business">Windows Hello for Business</a></h3>
<p><strong>Infrastructure effort: 20 minutes [Azure AD Join Cloud Trust], 1-2 hours [Hybrid Cloud Trust], 2 hours-3 days [Hybrid Key Trust]</strong>
<strong>End user enrollment effort: 2-5 minutes (plus 30-60 usability delay for Hybrid Key Trust)</strong>
<strong>Can be rolled out selectively: Yes</strong>
<strong>Can be enabled on an end user without forcing them to enroll: No</strong>
<em>There are mechanisms that can delay end-user enrollment, but the complexity usually is not worth the effort</em></p>
<p>Windows Hello for Business. It‚Äôs like Face ID, for Windows. Or is Face ID like Windows Hello for Business, but for iOS??</p>
<p>If you don‚Äôt have a fancy camera, it also works with your fingerprint. And if you have no fancy biometric thingies, you can use it with just a PIN. But wait, isn‚Äôt a PIN the same as a password? <strong>NO</strong>. The PIN is entropy to unlock the key/certificate that is stored on the TPM chipset on your device. It‚Äôs never emitted beyond the device. And yes, you always must create a PIN ‚Äì the same way you always must create a PIN for mobile devices as backup for biometric‚Ä¶ just in case.</p>
<p>Also ‚Äì if you are rolling out Hybrid Key Trust, you <strong>do not, I repeat, do not, need any premium licenses</strong>. The issue many organizations have theoretically faced is that to enroll in WHfB, you hit the part where you need to perform MFA, and organizations that do not have P1+/EMS E3+/M365 E3+ (and the variants) believe that they cannot use MFA. That is not the case. You need premium licensing when certain things are calling for MFA ‚Äì such as per-user enablement (which is an O365 license thing), or more commonly thought of, conditional access. When Azure AD calls for MFA for WHfB enrollment, that MFA call is <strong>free</strong>. Considering that security defaults, which are also free, call for MFA potentially, this should be less of a concern. But it‚Äôs always been a huge point of confusion. I learned about this in excruciating detail when I worked at Microsoft, rolling out WHfB with customers. Based on what I can gather regarding Hybrid Cloud Trust, I would say the case is the same. /endrant</p>
<p>If you have Azure AD Joined devices and are looking to go cloud-only, Janusz Gal [<a href="https://twitter.com/JanuszGal">@JanuszGal</a>] has you covered with his article here:</p>
<p><a href="https://deviceadvice.io/2020/06/22/how-to-set-up-windows-hello-for-business-for-cloud-only-devices/">How to set up Windows Hello for Business for cloud-only devices ‚Äì Device Advice</a></p>
<p>If you want to ensure that those devices can still reach Active Directory based resources, look no further than this article by Ben Whitmore [<a href="https://twitter.com/byteben">@byteben</a>] and Michael Mardahl [<a href="https://twitter.com/michael_mardahl?lang=en">@michael_mardahl</a>]:</p>
<p><a href="https://msendpointmgr.com/2021/08/15/sso-to-domain-resources-from-azure-ad-joined-devices-the-mega-series/">SSO to domain resources from Azure AD Joined Devices ‚Äì The MEGA Series ‚Äì Part 1 ‚Äì Overview ‚Äì MSEndpointMgr</a></p>
<p>For rolling out what previously was (and technically still is, because Cloud Trust is in Public Preview) the recommended path for hybrid devices, Hybrid Key Trust, check out this article by Brooks Peppin [<a href="https://twitter.com/brookspeppin">@brookspeppin</a>]:</p>
<p><a href="https://www.brookspeppin.com/2021/08/13/how-to-setup-windows-hello-for-business-key-trust-method/">How to Setup Windows Hello for Business (Key-Trust Method!) ‚Äì Brooks Peppin‚Äôs Blog</a></p>
<p>For what will eventually become the recommended path for hybrid devices, Hybrid Cloud Trust, see this article by Pim Jacobs [<a href="https://twitter.com/pimjacobs89">@pimjacobs89</a>]:</p>
<p><a href="https://identity-man.eu/2022/02/17/improving-your-windows-hello-for-business-hybrid-password-less-setup-by-using-cloud-trust/">Improving your Windows Hello for Business Hybrid Password less setup by using Cloud Trust ‚Äì Identity Man (identity-man.eu)</a></p>
<p>If you are curious what it looks like to convert from Hybrid Key Trust to Hybrid Cloud Trust, check out my article:</p>
<p><a href="https://ericonidentity.com/2022/03/23/windows-hello-for-business-hybrid-cloud-trust/">Windows Hello for Business: Hybrid Cloud Trust ‚Äì Eric on Identity</a></p>
<p>And if you are far enough down the passwordless road that you want to take them away from end users, then check out this article I wrote:</p>
<p><a href="https://ericonidentity.com/2021/12/13/living-in-a-passwordless-world-hybrid-identity-and-password-management/">Living in a Passwordless World: Password Management ‚Äì Eric on Identity</a></p>
<p>Microsoft Docs articles for reference can be found here:</p>
<p><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/hello-for-business/hello-aad-join-cloud-only-deploy">Azure Active Directory join cloud only deployment ‚Äì Windows security | Microsoft Docs</a></p>
<p><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/hello-for-business/hello-hybrid-cloud-trust">Hybrid Cloud Trust Deployment (Windows Hello for Business) ‚Äì Windows security | Microsoft Docs</a></p>
<p><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/hello-for-business/hello-hybrid-key-trust">Hybrid Key Trust Deployment (Windows Hello for Business) ‚Äì Windows security | Microsoft Docs</a></p>
<p><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/hello-for-business/hello-hybrid-cert-trust">Hybrid Certificate Trust Deployment (Windows Hello for Business) ‚Äì Windows security | Microsoft Docs</a></p>
<p><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/hello-for-business/hello-hybrid-aadj-sso">Azure AD Join Single Sign-on Deployment ‚Äì Windows security | Microsoft Docs</a></p>
<h3 id="some-great-additional-resources"><a class="toclink" href="../../2022/05/04/world-password-day/#some-great-additional-resources">Some great additional resources</a></h3>
<p>Fabian Bader [<a href="https://twitter.com/fabian_bader">@fabian_bader</a>] has a long series on passwordless:</p>
<p><a href="https://cloudbrothers.info/en/categories/passwordless/">Passwordless ‚Äì Category ‚Äì Cloudbrothers</a></p>
<p>Jan Bakker [<a href="https://twitter.com/janbakker_">@janbakker_</a>] has some quality articles covering FIDO2:</p>
<p><a href="https://janbakker.tech/?s=fido">FIDO ‚Äì JanBakker.tech</a></p>
<p>Harri Jaakkonen[<a href="https://twitter.com/HarriJaakkonen">@HarriJaakkonen</a>] is constantly putting out new articles, and lots that cover passwordless:</p>
<p><a href="https://www.cloudpartner.fi/?s=passwordless">Set-AzWebApp -name ‚ÄúAnything Microsoft and other stuff on the side‚Äù (cloudpartner.fi)</a></p>
<h3 id="final-notes"><a class="toclink" href="../../2022/05/04/world-password-day/#final-notes">Final notes</a></h3>
<p>Passwords will eventually have an expiration date. It‚Äôs better to start the journey away from them now, than get caught behind the ball down the road.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-04-26 00:00:00+00:00">April 26, 2022</time></li>
        
        
          
          <li class="md-meta__item">
            
              6 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="azure-ad-you-should-disable-this-legacy-mfa-setting"><a class="toclink" href="../../2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/">Azure AD: You Should Disable This Legacy MFA Setting</a></h2>
<p>When talking with organizations about securing their Azure AD tenants, there is always a focus on the latest and greatest, and all the ways it brings everyone forward on the Zero Trust journey. Advancements in Conditional Access, Windows Hello for Business, FIDO2 ‚Äì the focus is on what‚Äôs new and where to go. Occasionally there is the reminder to block legacy authentication (speaking of ‚Äì have you?), but the focus tends to be on what‚Äôs new, and not reviewing what‚Äôs old.</p>
<p>There is one setting, however, that tends to lurk deep within Azure AD tenants, especially for organizations that have had their tenant for a long while, that goes unnoticed, and when left enabled, allows users to potentially interfere with what we believe to be their authentication pattern.</p>
<h3 id="whats-the-setting"><a class="toclink" href="../../2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#whats-the-setting">What's the setting?</a></h3>
<p>If we dig into the legacy multi-factor authentication service settings portal, which can be found by browsing to <strong>Azure AD -&gt; Security -&gt; MFA</strong>, and then on the <strong>right</strong>, under <strong>Configure</strong>, select <strong>Additional cloud-based MFA settings</strong>. It will bring you to the following:</p>
<p><img alt="Figure 1" src="/images/2022/04/26/img1.png" /></p>
<p>The setting we are focused on is at the bottom. Under <em>remember multi-factor authentication on trusted device, Allow users to remember multi-factor authentication on devices they trust.</em></p>
<h3 id="whats-the-problem"><a class="toclink" href="../../2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#whats-the-problem">What's the problem?</a></h3>
<p>The name of the setting doesn‚Äôt really explain it well. The Microsoft Docs article that explains the details of this setting can be found here, <a href="https://docs.microsoft.com/en-us/azure/active-directory/authentication/howto-mfa-mfasettings#remember-multi-factor-authentication">Configure Azure AD Multi-Factor Authentication ‚Äì Azure Active Directory | Microsoft Docs</a>.</p>
<p>Even though there is an additional note provided, a lot of organizations don‚Äôt even recall this setting exists ‚Äì either they have never had to come to this set of options to begin with, or it was enabled several years ago and never reviewed again. Unfortunately, this setting is not well exposed in Azure AD.</p>
<p>When enabled in an Azure AD tenant, it allows end-users to make the decision on what a ‚Äútrusted device‚Äù is. The heading for the setting, when glanced over, may make you believe it relates to trusted devices, as in compliant devices. But as we see within the details, the user is making that trust decision.</p>
<p>And the issue with that trust decision, is that it allows the user to choose to drop an MFA persistence cookie, <strong>completely separate</strong> from the refresh token, in the browser.</p>
<p>So even if our user chooses to <strong>sign-out</strong>, and even if they choose in the browser the option to <strong>forget</strong> their username from the sign-in menu, this cookie persists.</p>
<p>The user experience, with this setting enabled, will show the following during sign-in:</p>
<p><img alt="Figure 2" src="/images/2022/04/26/img2.png" /></p>
<p>When enabled, the <strong>Don‚Äôt ask again for 90 days</strong> (or whatever interval is set in your organization) shows up and is checked by default.</p>
<p>On subsequent user sign-in, the user <strong>will not be prompted for MFA</strong>, unless the time specified in the setting has lapsed, or the browser cookies have been cleared.</p>
<p>You will see the following in the Sign-in details:</p>
<p><img alt="Figure 3" src="/images/2022/04/26/img3.png" /></p>
<p>This setting is <strong>not the same</strong> as the <strong>Keep Me Signed In (KMSI)</strong> settings in Azure AD, which allow the user to retain their refresh token in their browser when they close it. The KMSI experience invalidates the token during user sign-out, and upon sign-in provides the expected behavior of calling for both primary authentication and MFA (if there is an MFA requirement).</p>
<h3 id="why-exactly-is-this-a-problem"><a class="toclink" href="../../2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#why-exactly-is-this-a-problem">Why exactly is this a problem</a></h3>
<p>While it may be alluded to above, this setting weakens the security posture regarding MFA. It allows users to subvert when we may be requiring Conditional Access to call for MFA. Now we are not saying our user is doing anything malicious ‚Äì this is a setting we enable and it‚Äôs logical that a user would select this. Users will pick whatever options make getting the job done with the least amount of friction.</p>
<p>If the device is or becomes compromised, the user account will become an easier target to malicious actors. Just think of any device you have the least amount of trust in, which usually is some sort of shared device outside the corporate boundaries, and then allow the user to make the trust decision. It‚Äôs not a great recipe.</p>
<h3 id="determining-the-usage"><a class="toclink" href="../../2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#determining-the-usage">Determining the usage</a></h3>
<p>If you‚Äôve looked at your settings, and you see that this setting is disabled, then you can just stop here.</p>
<p>If you‚Äôve found that this setting is enabled, you want to understand how widespread the usage is before disabling it. The fewer users leveraging it, the swifter the change process.</p>
<p>We want to explore our Azure AD Sign-in logs, however, we cannot filter granularly within the portal.</p>
<p>Using Log Analytics, the following query will help show who, where they are coming from, and the device information. The query is written to highlight distinct devices:</p>
<div class="highlight"><pre><span></span><code>SigninLogs
| where TimeGenerated &gt; ago(30d) //Set time period to within the last 30 days
| where Status.additionalDetails == &quot;MFA requirement skipped due to remembered device&quot; //String to search for
| project UserPrincipalName,IPAddress,OS = tostring(DeviceDetail.operatingSystem),Browser = tostring(DeviceDetail.browser),City = tostring(LocationDetails.city),State = tostring(LocationDetails.state),Country = tostring(LocationDetails.countryOrRegion) //Pull JSON data into strings
| distinct UserPrincipalName,IPAddress,OS,Browser,City,State,Country //Filter for distinct instances
</code></pre></div>
<p>If you do not have access to Log Analytics, you can export your Azure AD Sign-in logs in either CSV or JSON format and parse the data out accordingly, the string you will want to search for is <strong>MFA requirement skipped due to remembered device</strong>.</p>
<h3 id="remediation"><a class="toclink" href="../../2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#remediation">Remediation</a></h3>
<p>I‚Äôll preface that I‚Äôve had dozens of organizations disable this setting with little notice to end-users, and with little disruption to their lives. Many of those organizations did not even search their logs prior to disabling it.</p>
<p>This only impacts browser sessions. Client applications will never present this prompt, regardless of whether the client application is on a mobile device or Windows.</p>
<p>If we are using Windows Hello for Business, FIDO2 security keys, or Authenticator App for Primary Auth, all those mechanisms provide for strong-authentication within them, and are not impacted by this setting.</p>
<p>For Azure AD Joined (AADJ) or Hybrid Azure AD Joined (HAADJ) devices, even if our users are using passwords and are requested to perform MFA, their PRT will obtain an MFA claim within it during the first run, and users will not be frequently prompted for MFA subsequently.</p>
<p>That‚Äôs a long way of saying the impact is usually limited to web browsers on personal devices that have no relationship to the Azure AD tenant. The devices we trust the least.</p>
<p>Once comfortable turning off this setting, it‚Äôs simply a matter of unchecking the box in the MFA service settings portal we examined above.</p>
<h3 id="if-you-want-to-limit-mfa-lifetime"><a class="toclink" href="../../2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#if-you-want-to-limit-mfa-lifetime">If you want to limit MFA lifetime</a></h3>
<p>I‚Äôve encountered some organizations who have this setting enabled, and the number dialed way down. When talking about corporate devices or devices we have insight into, through either MDM, MAM, hybrid trust, or such, it‚Äôs not recommended to limit MFA lifetime. We already have a level of trust established and prompting users frequently for MFA will not only create friction in the user experience, as well as sets our users up to be both more susceptible to MFA phishing (you get trained to just perform MFA without thought) and devise ways around security.</p>
<p>If you have business scenarios that call for the desire to prompt more frequently for MFA, Conditional access offers Sign-in frequency session controls as well as Persistent browser session controls, which can be targeted to non-corporate managed devices. Authentication context also allows for scenarios where we want to call for strong authentication scenarios when users are accessing sensitive information. These settings offer a higher level of precision to target certain scenarios while not negatively impacting the broader user experience.</p>
<h3 id="final-notes"><a class="toclink" href="../../2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#final-notes">Final notes</a></h3>
<p>This setting really has been a carry-over from when we didn‚Äôt have the power available from Conditional Access, and unfortunately, it‚Äôs well hidden in that dusty MFA settings portal almost nobody ever treks into. Lucky for us, it‚Äôs a quick win in the name of security to disable.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-04-21 00:00:00+00:00">April 21, 2022</time></li>
        
        
          
          <li class="md-meta__item">
            
              6 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="azure-ad-cross-tenant-access-settings-clarity"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/">Azure AD: Cross-tenant Access Settings Clarity</a></h2>
<p>With the release of Azure AD cross-tenant access settings, I‚Äôve noted some confusion among folks as to what it <strong>is</strong>, and as importantly, what it <strong>isn‚Äôt</strong>.</p>
<p>I‚Äôll also be covering B2B Direct Connect, because even though it‚Äôs a separate feature, with release coinciding at the same time as cross-tenant access settings, I see it all being lumped ‚Äúinto the same‚Äù set of preview features.</p>
<p>The Microsoft Docs article on this is an excellent source of information, which can be found here, <a href="https://docs.microsoft.com/en-us/azure/active-directory/external-identities/cross-tenant-access-overview">Cross-tenant access overview ‚Äì Azure AD | Microsoft Docs</a>. Along with that, we‚Äôll dive into the background and use cases for this new suite of knobs and dials for our external identities.</p>
<h3 id="terminology"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#terminology">Terminology</a></h3>
<p><strong>Guest</strong> ‚Äì For clarity, when speaking about guest users for the context of this post, we are talking about users invited into your Azure AD tenant.</p>
<p><strong>Resource Azure AD Tenant [Resource Tenant]</strong> ‚Äì If you are inviting guests <strong>into</strong> your Azure AD tenant, <strong>your</strong> tenant is the resource tenant. It represents your organization. If you are a <strong>guest</strong>, then the resource tenant is the tenant you have been invited into.</p>
<p><strong>Home Azure AD Tenant [Home Tenant]</strong> ‚Äì This is the tenant where the user objects live. If your user object exists in your organizations Azure AD tenant, your tenant is <strong>both</strong> the home tenant and resource tenant ‚Äì your users and applications all ‚Äúlive‚Äù in the same place. Guests into your tenant will have a <strong>different</strong> home tenant.</p>
<h3 id="what-it-is-not"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#what-it-is-not">What it is not</a></h3>
<p>Before getting into what we can do with cross-tenant access settings, let‚Äôs cover what this is not (at least at the time of this writing).</p>
<h4 id="parity-to-an-active-directory-trust"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#parity-to-an-active-directory-trust">Parity to an Active Directory trust</a></h4>
<p>Cross-tenant access settings may invoke a feeling of configuring a trust in Active Directory, which many Microsoft identity practitioners may be familiar with.</p>
<p>It is closer to the <strong>opposite</strong> of a trust, in the sense that by default Active Directory has no implicit trusts, and you must explicitly configure trusts. Azure AD historically is opposite, any organization, unless settings are adjusted, can invite users from any Azure AD tenant into the organization. These settings allow us to be more granular in how we <strong>restrict</strong> guest access inbound and outbound to our Azure AD tenant.</p>
<p>Further, when we examine B2B Direct Connect, we realize that the only use case, currently, is Teams shared channels.</p>
<p>When we think of an Active Directory trust, we think of the fact that user objects only exist in the source user forest. With cross-tenant access settings, and the limitations with B2B Direct Connect, we still must invite user objects into our resource tenant ‚Äì all the other ‚Äúthings‚Äù tied to our Azure AD tenant need the objectID within our resource tenant to reference.</p>
<h3 id="what-it-is"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#what-it-is">What it is</a></h3>
<h4 id="a-mechanism-to-provide-granular-b2b-guest-control"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#a-mechanism-to-provide-granular-b2b-guest-control">A mechanism to provide granular B2B guest control</a></h4>
<p>When speaking about B2B guests and external identities, many organizations tend to focus on the aspect of guests being invited <strong>into</strong> their tenant. There is the other side to that B2B coin, which is restricting what organizations you may want your users to have access to.</p>
<p>Certain organizations, especially those in the regulated industries, have concern over which external tenants their users can connect to. Up until now, organizations would need to apply tenant restrictions, <a href="https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/tenant-restrictions">Use tenant restrictions to manage access to SaaS apps ‚Äì Azure AD | Microsoft Docs</a>, which has a higher level of complexity to it ‚Äì the implementation requires a proxy to perform traffic inspection and HTTP header insertion.</p>
<p>Now, organizations that have strict requirements regarding outbound guest access can, by default, restrict outbound access, and then create a more granular allow list.</p>
<p>We also now can be granular down to user/group level of who can access certain organizations. Say you want to only allow employees from payroll to be able to access the tenant the vendor uses and restrict outbound access to everyone else ‚Äì now you can do that.</p>
<p>Likewise, there is granularity on the inbound side. Say you are that vendor that processes an organizations payroll and want to ensure that only the known users for the company you serve can come into your organization. You can restrict inbound as well, limiting what guests are allowed in.</p>
<h4 id="a-way-to-trust-external-mfa-and-device-compliance"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#a-way-to-trust-external-mfa-and-device-compliance">A way to trust external MFA and Device Compliance</a></h4>
<p>Many organizations that are familiar with conditional access and guest policies have encountered the need to enroll in Azure AD MFA twice or more ‚Äì once for their home tenant and once in every other resource tenant they access. This experience, from a user perspective, is less than ideal.</p>
<p>With cross-tenant access settings, we can now choose to trust MFA from the guest users home tenant. We also can be granular ‚Äì if we want to trust MFA from certain tenants, but require MFA enrollment from others, we can do that.</p>
<p>More interestingly, we can now trust device compliance and hybrid join status, from the guest home tenant. While I still have certain reservations about the quality of relying on hybrid join alone, focusing on device compliance, it really opens a lot of cross-tenant collaboration, and brings an innovative approach to leveraging Zero Trust modeling when working with guests. While this still has the requirement that the guest home tenant must be leveraging Intune or a 3rd party MDM that can report in device compliance, it makes this a possibility.</p>
<p>In my own testing, I was able to leverage device compliance in conditional access for a device in a guest tenant, and it worked with ease.</p>
<h3 id="a-few-lingering-questions"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#a-few-lingering-questions">A few lingering questions</a></h3>
<h4 id="where-is-conditional-access-processed"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#where-is-conditional-access-processed">Where is Conditional Access processed?</a></h4>
<p>This hasn‚Äôt changed with the new cross-tenant access settings, but it‚Äôs a good time to review.</p>
<p>Conditional access is <strong>always</strong> evaluated in the <strong>resource</strong> tenant.</p>
<p>The resource tenant needs to ensure that their Conditional Access policies meet the needs of protecting their applications.</p>
<p>Likewise, the home tenant <strong>cannot</strong> restrict outbound access to another tenant with Conditional Access. Because the guest is not accessing resources in their tenant, even an all applications block CA policy will not prevent the user from accessing a resource tenant as a guest ‚Äì which really brings us back to what these new settings solve.</p>
<h4 id="where-is-identity-protection-processed"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#where-is-identity-protection-processed">Where is Identity Protection processed?</a></h4>
<p>User risk is evaluated in the <strong>home</strong> tenant, and sign-in risk is evaluated in the <strong>resource</strong> tenant for B2B users. When firing up Tor, and accessing O365 with a guest, my test user was blocked by Identity Protection in the home tenant because it was flagged as a high user risk. So depending on the sort of threat detected by Identity Protection, you may find users being restricted by both the home and resource tenant when Identity Protection is in play.</p>
<p>The details on this are further elaborated on in the Microsoft Docs article, <a href="https://docs.microsoft.com/en-us/azure/active-directory/identity-protection/concept-identity-protection-b2b#how-does-identity-protection-work-for-b2b-users">Identity Protection and B2B users ‚Äì Azure Active Directory | Microsoft Docs</a>.</p>
<h3 id="one-new-trick-out-of-a-possible-many"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#one-new-trick-out-of-a-possible-many">One new trick - out of a possible many</a></h3>
<h4 id="pim-in-the-home-tenant-for-outbound-guest-access"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#pim-in-the-home-tenant-for-outbound-guest-access">PIM in the home tenant for outbound guest access</a></h4>
<p>The ability to apply PIM to guest user accounts is not new. But if we combine the preview feature of PIM for group membership, and apply outbound restrictions to a certain group, the <strong>home</strong> tenant can build a request process for outbound access.</p>
<p>In that this is quite restrictive, I would see a narrow range of use cases, as it really hampers collaboration between tenants. For those organizations who previously completely turned off the ability to collaborate with other organizations due to things like data sensitivity, the door might now be opened a bit.</p>
<h3 id="final-notes"><a class="toclink" href="../../2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#final-notes">Final notes</a></h3>
<p>External Identities and B2B are continually evolving. While there is still a large gap to bridge for many situations, this definitely is bringing us one step closer. B2B Direct Access in particular will be interesting to see how Microsoft evolves it ‚Äì will it come closer to how an AD trust operates, or will there be improvements on how guests are invited into tenants.</p>
<p>As usual, any questions/concerns/comments please reach out to me, and if you find any new unique use cases for cross-tenant access settings, would love to hear them.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-03-29 00:00:00+00:00">March 29, 2022</time></li>
        
        
          
          <li class="md-meta__item">
            
              9 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="azure-ad-the-arrival-of-dynamic-administrative-units"><a class="toclink" href="../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/">Azure AD: The Arrival of Dynamic Administrative Units</a></h2>
<p>Administrative units. The Azure AD sort-of equivalent of organizational units (OU‚Äôs). For those less familiar, administrative units (AU‚Äôs) allow for granular assignment of RBAC roles in Azure AD.</p>
<p>Organizations initially struggled with the limited ability to delegate granular RBAC roles in Azure AD, with the directories flat structure; especially for all of us coming from an Active Directory background. When administrative units were introduced, they started to open up the door for organizations that needed to delegate access to a subset of users in an Azure AD tenant.</p>
<p>The one catch with AU‚Äôs that <strong>was</strong> a non-starter for many organizations ‚Äì they weren‚Äôt dynamic. And while OU‚Äôs are not dynamic in Active Directory, it‚Äôs a different take when the tenant is usually secondary to AD being authoritative. Move a user in AD, one would hope that the location in Azure AD would follow. While there are some PowerShell scripts out there that feel very akin to those used for AD shadow groups, overall maintenance of AU‚Äôs could prove cumbersome in dynamic organizations.</p>
<p>The struggle, however, is no more ‚Äì administrative units now support <strong>dynamic</strong> user and device membership!</p>
<h3 id="administrative-unite-use-cases"><a class="toclink" href="../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#administrative-unite-use-cases">Administrative Unite use cases</a></h3>
<p>Before exploring dynamic membership, I just wanted to touch on some of the use cases that have already existed, and many that can greatly improve with dynamic membership. This is just a mere tip of the iceberg for use cases ‚Äì if you see ones that I‚Äôve missed let me know, and I‚Äôll gladly add it.</p>
<p>While they feel similar to OU‚Äôs, the fact that AU‚Äôs are virtual units of structure, they provide much greater flexibility than OU‚Äôs. A user can belong to several AUs, and you don‚Äôt have to worry about users being linked as child objects that are deleted if an AU is removed ‚Äì everyone remembers that time that their AD backups were tested with an accidental OU deletion.</p>
<h4 id="regional-it-delegation"><a class="toclink" href="../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#regional-it-delegation">Regional IT delegation</a></h4>
<p>Many global organizations that operate out of a single Azure AD tenant still have localized and regional support desks. With AU‚Äôs, you can create multiple layers of support structure to provide for things like password reset and user object management, without needing to deal with the complications of trying to fit complex delegations of ACL‚Äôs onto objects the same way we would have to with Active Directory.</p>
<h4 id="state-and-local-government-agency-delegation"><a class="toclink" href="../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#state-and-local-government-agency-delegation">State and local government agency delegation</a></h4>
<p>Many organizations in the public sector operate out of the same Azure AD tenant to support a single O365 environment. However, many agencies still want to retain levels of autonomy over managing their user objects. Administrative units can provide for that granular level of RBAC control.</p>
<h4 id="my-staff-management"><a class="toclink" href="../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#my-staff-management">My Staff management</a></h4>
<p>My Staff came out to primarily help assist with managers performing basic tasks for front line workers. The goal is to bring the power to non-IT employees the ability to do things like reset passwords or manage phone numbers for MFA. My Staff is driven by administrative units, with AU‚Äôs that are built to replicate an organizational staffing structure. For more information on My Staff, take a look at the Microsoft documentation, <a href="https://docs.microsoft.com/en-us/azure/active-directory/roles/my-staff-configure">Use My Staff to delegate user management ‚Äì Azure AD | Microsoft Docs</a>.</p>
<p>It takes a bit of work in Azure AD Connect, because the manager attribute is a reference attribute in Active Directory, to synchronize the manager UPN as a custom attribute (even though manager is synchronized by Azure AD Connect, it is not exposed as a dynamic attribute option). But one could configure a system where managers have control over their employees objects, and with dynamic membership, their manager changes in AD can easily follow them in My Staff.</p>
<h3 id="exploring-administrative-unit-dynamic-membership"><a class="toclink" href="../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#exploring-administrative-unit-dynamic-membership">Exploring Administrative Unit dynamic membership</a></h3>
<p>If you‚Äôve used dynamic membership for groups, the logic and expressions for dynamic administrative units is the same. I won‚Äôt deep dive into all the rules available, but the options for evaluation are both flexible and immensely powerful. For more details on the rules, take a look at this Microsoft documentation, <a href="https://docs.microsoft.com/en-us/azure/active-directory/enterprise-users/groups-dynamic-membership">Rules for dynamically populated groups membership ‚Äì Azure AD | Microsoft Docs</a>.</p>
<h4 id="licensing"><a class="toclink" href="../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#licensing">Licensing</a></h4>
<p>As with dynamic group membership, current documentation indicates that any user who is a member of an AU that is dynamically populates requires an Azure AD P1 or P2 license assigned to them. This contrasts static membership, where only those managing the AU‚Äôs require a P1 or P2 license; users can be members of the AU‚Äôs with an Azure AD free license. Dynamic device membership does not require any special license for AU‚Äôs. For more information, see the Microsoft documentation, <a href="https://docs.microsoft.com/en-us/azure/active-directory/roles/admin-units-members-dynamic#prerequisites">Manage users or devices for an administrative unit with dynamic membership rules (Preview) ‚Äì Azure Active Directory | Microsoft Docs</a>.</p>
<h4 id="configuring-administrative-unit-dynamic-membership"><a class="toclink" href="../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#configuring-administrative-unit-dynamic-membership">Configuring Administrative Unit dynamic membership</a></h4>
<p>While the expression set is the same as dynamic groups, currently you have to adjust the administrative unit to be dynamic post-creation. Also, as we go through this, I‚Äôll be referencing the current Microsoft documentation on dynamic membership for administrative units, which can be found here, <a href="https://docs.microsoft.com/en-us/azure/active-directory/roles/admin-units-members-dynamic">Manage users or devices for an administrative unit with dynamic membership rules (Preview) ‚Äì Azure Active Directory | Microsoft Docs</a>.</p>
<p>First we create a new administrative unit:</p>
<p><img alt="Figure 1" src="/images/2022/03/29/img1.png" /></p>
<p>And after creation of the AU, we can go look at the Properties for it. Within here we will find <strong>Membership type</strong>, which we can drop down and select <strong>Dynamic User</strong>:</p>
<p><img alt="Figure 2" src="/images/2022/03/29/img2.png" /></p>
<p>After setting the <strong>Membership type</strong> to <strong>Dynamic User</strong>, we will need to <strong>Add dynamic query</strong> before we can save the changes. The dynamic query is the secret sauce to what makes the dynamic AU, dynamic. Note that until we set this query, we cannot save these changes; the save is grayed out.</p>
<p><img alt="Figure 3" src="/images/2022/03/29/img3.png" /></p>
<p>In our example here, we are going to use a rule for physicalDeliveryOfficeName equals Schenectady:</p>
<p><img alt="Figure 4" src="/images/2022/03/29/img4.png" /></p>
<p>We save the rule, and now the Save button will be available on the administrative unit properties. Before saving, we will be presented with a warning:</p>
<p><em>After changing the administrative unit type, the existing membership may change based on the dynamic membership rules you provide. Click Yes to continue.</em></p>
<p><img alt="Figure 5" src="/images/2022/03/29/img5.png" /></p>
<p>The warning here will show up, regardless of whether it‚Äôs a new, unpopulated AU, or if it‚Äôs an existing AU with thousands of users within it.</p>
<p>After a few minutes of churning, the AU will be populated:</p>
<p><img alt="Figure 6" src="/images/2022/03/29/img6.png" /></p>
<h4 id="converting-an-administrative-unit-to-dynamic"><a class="toclink" href="../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#converting-an-administrative-unit-to-dynamic">Converting an Administrative Unit to dynamic</a></h4>
<p>During testing of conversion of an assigned AU to dynamic, I was curious to see how it operated. Does it wipe out all membership and start from scratch, or does Azure AD evaluate the users within the AU to determine who still belongs? Luckily, it appears to be the latter.</p>
<p>Checking my Azure AD Audit logs, we can see users who no longer belong in a specific administrative unit being removed:</p>
<p><img alt="Figure 7" src="/images/2022/03/29/img7.png" /></p>
<p>Note that if you are going the other direction, from dynamic membership to assigned, Azure AD will indicate that the existing users in the AU will be retained, but will not be dynamically processed anymore.</p>
<h4 id="exploring-with-powershell"><a class="toclink" href="../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#exploring-with-powershell">Exploring with PowerShell</a></h4>
<p>As with most things Azure AD, anything that can be done in the portal can be done with PowerShell (which really is just indirect Graph) and Graph.</p>
<p>I‚Äôve been making a concerted effort to use the Microsoft Graph PowerShell SDK, <a href="https://docs.microsoft.com/en-us/graph/powershell/installation">Install the Microsoft Graph PowerShell SDK ‚Äì Microsoft Graph | Microsoft Docs</a>, over the Azure Active Directory PowerShell for Graph modules. Why? The PowerShell SDK supports PowerShell 7, is cross-platform, and provides access to all of Graph, not just Azure AD.</p>
<p>That being said, I‚Äôve found the PowerShell SDK modules for dynamic administrative units to be, well, rather lacking. While there are indirect parameters to provide dynamic information, I haven‚Äôt spent the cycles yet figuring things out. The docs/get-help provide almost no information on commands like <strong>New-MGAdministrativeUnit</strong></p>
<p><img alt="Figure 8" src="/images/2022/03/29/img8.png" /></p>
<p><em>The (lacking) documentation</em></p>
<p>As such, for the purpose of getting this post published, I‚Äôll be using the Azure AD PowerShell modules.</p>
<p>First, let‚Äôs take a look at the administrative unit named ATZ:</p>
<div class="highlight"><pre><span></span><code>Get-AzureADMSAdministrativeUnit -Filter &quot;DisplayName eq &#39;ATZ&#39;&quot; | fl
</code></pre></div>
<p><img alt="Figure 9" src="/images/2022/03/29/img9.png" /></p>
<p>We can see that the membership type is dynamic, and also see the membership rule. In this case, we are using the in rule to allow for matching the country attribute against a defined list.</p>
<p>And if we then enumerate the membership of the AU, we can see that the logic works:</p>
<div class="highlight"><pre><span></span><code>Get-AzureADAdministrativeUnitMember -ObjectId a5175ada-f6f1-4c72-a986-65c65f662bde `
| Get-AzureADUser | ft ObjectId,UserPrincipalName,Country
</code></pre></div>
<p><img alt="Figure 10" src="/images/2022/03/29/img10.png" /></p>
<p>We can also create an administrative unit rather easily with PowerShell, which has an advantage, at least currently over the portal, in that we can define the dynamic rules upon creation.</p>
<div class="highlight"><pre><span></span><code>New-AzureADMSAdministrativeUnit -DisplayName &quot;US&quot; -Description &quot;US Employees&quot; `
-MembershipType &quot;Dynamic&quot; -MembershipRuleProcessingState &quot;On&quot; -MembershipRule `
&#39;(user.country -eq &quot;United States&quot;)&#39;
</code></pre></div>
<p><img alt="Figure 11" src="/images/2022/03/29/img11.png" /></p>
<h3 id="faq"><a class="toclink" href="../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#faq">FAQ</a></h3>
<h4 id="limitations"><a class="toclink" href="../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#limitations">Limitations</a></h4>
<p>Microsoft does not publish a size limitation for administrative units, but the standard limitations for administrative units still exist with resources being members of no more than 30 administrative units, and an organization can have a maximum of 5,000 dynamic groups and dynamic administrative units combined. The latter bit is an interesting item to note, as it would seem the evaluation engine is then shared in a tenant between dynamic groups and administrative units (which makes sense really).</p>
<p>I would also then speculate, while I cannot find it published yet, that administrative units may fall into the same rule evaluation service level, which is up to 24 hours, per this document, <a href="https://docs.microsoft.com/en-us/azure/active-directory/enterprise-users/groups-troubleshooting#troubleshooting-dynamic-memberships-for-groups">Fix problems with dynamic group memberships ‚Äì Azure AD | Microsoft Docs</a>.</p>
<h4 id="how-can-i-test-preview-a-dynamic-membership-rule"><a class="toclink" href="../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#how-can-i-test-preview-a-dynamic-membership-rule">How can I test / preview a dynamic membership rule?</a></h4>
<p>Currently, the dynamic membership rule settings in an administrative unit does not have a rule validation option available. However, we can simply create a test dynamic group in Azure AD for evaluating the rule, and can also use the Validate Rules option to get a more instant verification of whether our rule works.</p>
<p><img alt="Figure 12" src="/images/2022/03/29/img12.png" /></p>
<p><em>An example of rule validation in dynamic groups</em></p>
<h4 id="can-i-combine-different-object-types-in-a-dynamic-administrative-unit"><a class="toclink" href="../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#can-i-combine-different-object-types-in-a-dynamic-administrative-unit">Can I combine different object types in a dynamic Administrative Unit?</a></h4>
<p>Unfortunately this is one trade-off between statically assigned groups and dynamic ones. Whereas in static groups we can assign users, groups and devices to the same AU, for dynamic membership you are limited to the type of dynamic object assignment you are looking to use ‚Äì either user or device. Also, groups are not an option for dynamic administrative unit rules, and can belong to neither dynamic user or dynamic device AU‚Äôs.</p>
<h3 id="final-notes"><a class="toclink" href="../../2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#final-notes">Final notes</a></h3>
<p>Dynamic groups are already such a powerful option for organizations, it‚Äôs great to see that same logic added into administrative units, an area where it fits so well. If I had the time I would reach out to all those customers who had the ‚Äúthis is great, but it‚Äôs too inflexible‚Äù mindset upon seeing administrative units. I‚Äôm curious to see what new doors this opens for organizations; if you have some interesting use cases, give me a shout.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-03-23 00:00:00+00:00">March 23, 2022</time></li>
        
        
          
          <li class="md-meta__item">
            
              8 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="windows-hello-for-business-hybrid-cloud-trust"><a class="toclink" href="../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/">Windows Hello for Business: Hybrid Cloud Trust</a></h2>
<p>When we talk about Windows Hello for Business (WHfB) rollout scenarios, the one that has consistently been the preferred path is Hybrid Key Trust. It is the lowest weight scenario for deployment requirements, and if you already had Active Directory Certificate Services (AD CS), it was only a matter of a few hours to configure your directory to be ready to start a rollout.</p>
<p>While there are some smaller niche limitations, the most common limitation that <strong>every</strong> organization will encounter with Hybrid Key Trust, is that initial Windows of needing to wait for Azure AD Connect to synchronize the <strong>msDS-KeyCredentialLink</strong> attribute from Azure AD to the user object in Active Directory.</p>
<p>This process is what informs Active Directory of the public side of the users WHfB key pair, and is what enables the user for certificate-based authentication, through WHfB, to AD. Historically this leaves many organizations needing to communicate to users that it will ‚Äútake some time‚Äù between when they enroll and when they can first start using WHfB ‚Äì not the greatest way to introduce users into a passwordless experience.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>I‚Äôve received feedback from readers who have gone through this post, and following up with me that for their users who were already enrolled in Windows Hello for Business with Hybrid Key Trust are having issues with authentication when switching to Hybrid Cloud Trust.</p>
<p>From my own conversations with folks at Microsoft, the path explained in this document is how an organization would go about switching existing Hybrid Key Trust users to Hybrid Cloud Trust.</p>
</div>
<h3 id="enter-hybrid-cloud-trust"><a class="toclink" href="../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#enter-hybrid-cloud-trust">Enter Hybrid Cloud Trust</a></h3>
<p>The technology behind WHfB Hybrid Cloud Trust has existed for a while; it‚Äôs the same mechanism that has been used to support hybrid FIDO2 Security Key authentication.</p>
<p>Microsoft already has some very good documentation, <a href="https://docs.microsoft.com/en-us/azure/active-directory/authentication/howto-authentication-passwordless-security-key-on-premises#use-sso-to-sign-in-to-on-premises-resources-by-using-fido2-keys">Passwordless security key sign-in to on-premises resources ‚Äì Azure Active Directory | Microsoft Docs</a>, that explains how the whole process works, so I won‚Äôt dive deep into paraphrasing things. But essentially we now are able to obtain a partial TGT from Azure AD, and subsequently exchange that for a full TGT in AD. Because of this key piece, we <strong>no longer</strong> need to wait for Azure AD Connect to inform AD of our users public key.</p>
<h3 id="why-should-i-convert"><a class="toclink" href="../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#why-should-i-convert">Why should I convert?</a></h3>
<p>If you‚Äôre asking yourself why you would want to convert from a Hybrid Key Trust to a Hybrid Cloud Trust, there are several benefits:</p>
<h4 id="goodbye-pki"><a class="toclink" href="../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#goodbye-pki">Goodbye PKI</a></h4>
<p>In reality, if you have a PKI in your environment, you likely are using it for several things. However, you will no longer need to maintain certificates on your Domain Controllers to be used for certificate-based authentication. That partial TGT is all you‚Äôll need to obtain a full Kerberos TGT from Active Directory.</p>
<h4 id="no-more-enrollment-delays"><a class="toclink" href="../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#no-more-enrollment-delays">No more enrollment delays</a></h4>
<p>Not having to wait for the sync back to AD of msDS-KeyCredentialLink, users will be able to use their WHfB credentials <strong>immediately</strong> after enrollment.</p>
<h4 id="sets-the-stage-for-fido2-security-keys"><a class="toclink" href="../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#sets-the-stage-for-fido2-security-keys">Sets the stage for FIDO2 security keys</a></h4>
<p>The mechanisms to configure Hybrid Cloud Trust is the same leveraged for FIDO2 Security Key authentication in a hybrid scenario. This puts your environment in a great position to start exploring FIDO2 if you have not already.</p>
<h3 id="convert-to-hybrid-cloud-trust"><a class="toclink" href="../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#convert-to-hybrid-cloud-trust">Convert to Hybrid Cloud Trust</a></h3>
<h4 id="prerequisites"><a class="toclink" href="../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#prerequisites">Prerequisites</a></h4>
<p>You‚Äôll need to first configure your tenant to support the ability for Azure AD to issue a Kerberos TGT for your Active Directory domain. I won‚Äôt run through the process here, but it‚Äôs straightforward, and the instructions can be found here, <a href="https://docs.microsoft.com/en-us/azure/active-directory/authentication/howto-authentication-passwordless-security-key-on-premises#install-the-azure-ad-kerberos-powershell-module">Passwordless security key sign-in to on-premises resources ‚Äì Azure Active Directory | Microsoft Docs</a>.</p>
<h4 id="method-for-conversion"><a class="toclink" href="../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#method-for-conversion">Method for conversion</a></h4>
<p>Microsoft has documented both the mechanisms for enabling Hybrid Cloud Trust through both Intune and Group Policy; here we will be examining the GPO route. The Microsoft documentation regarding the enablement of <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/hello-for-business/hello-hybrid-cloud-trust#configure-windows-hello-for-business-policy">Hybrid Cloud Trust can be found here, Hybrid Cloud Trust Deployment (Windows Hello for Business) ‚Äì Windows security | Microsoft Docs</a>.</p>
<p>Let‚Äôs take a look at our existing GPO settings, which can be found under <strong>Computer Configuration, Windows Components, Windows Hello for Business</strong>:</p>
<p><img alt="Figure 1" src="/images/2022/03/23/img1.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>While we can enable WHfB either as a Computer or User Configuration, the ability to modify the trust model only exists under the Computer Group Policy.</p>
</div>
<p>The setting we want to toggle is <strong>Use cloud trust for on-premises authentication</strong>:</p>
<p><img alt="Figure 2" src="/images/2022/03/23/img2.png" /></p>
<p>We just need to select OK to save our policy change, and let (or force) our clients pick up the changed GPO.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you do not find the option for Use cloud trust for on-premises authentication within your GPO, you likely need to update your ADMX templates to a newer version.</p>
</div>
<p>And <strong>that's it</strong>. The devices scoped to this group policy will be configured for Hybrid Cloud Trust.</p>
<h3 id="verification-transition-and-cleanup"><a class="toclink" href="../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#verification-transition-and-cleanup">Verification, transition, and cleanup</a></h3>
<h4 id="verification"><a class="toclink" href="../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#verification">Verification</a></h4>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Please note that the process explained below for verification is not a required process. This verification piece is provided to explain the steps that would invalidate any local certificates in Active Directory, to ultimately prove that Hybrid Cloud Trust is working. For migration purposes, you only need to perform the group policy change indicated above.</p>
</div>
<p>So we have our GPO updated and refreshed on our client. How can we tell that the device is in fact using Hybrid Cloud Trust and not Hybrid Key Trust?</p>
<p>After the configuration change, we can look at some Event Viewer logs. If we expand Applications and Services Logs, Microsoft, Windows, Hello for Business, Operational, we can see the following Event that shows the device configured and having obtained a Cloud TGT:</p>
<p><img alt="Figure 3" src="/images/2022/03/23/img3.png" /></p>
<p>We can further test things by deleting the msDS-KeyCredentialLink contents on the user object within Active Directory.</p>
<p>If we look at Lee Gu, we can see there is a public key on his account in AD:</p>
<p><img alt="Figure 4" src="/images/2022/03/23/img4.png" /></p>
<p>We can easily clear this, and then verify the attribute is empty:</p>
<p><img alt="Figure 5" src="/images/2022/03/23/img5.png" /></p>
<p>After another sign-on with WHfB, we can go look at our Security logs in Active Directory, and find a successful 4624:</p>
<p><img alt="Figure 6" src="/images/2022/03/23/img6.png" /></p>
<h4 id="transition"><a class="toclink" href="../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#transition">Transition</a></h4>
<p>Even though the transition has no visible impact on our end users, many organizations may still want to take a staged approach to transition to a Hybrid Cloud Trust. To that point, because we are altering the mechanism for authentication on a per-device level, there is <strong>nothing</strong> stopping an organization from moving to a Hybrid Cloud Trust in a staged approach.</p>
<p>Long-term, from a troubleshooting perspective, it would behoove most organizations to not draw out the transition. Conversely, if an organization has edge use cases that are only supported by a Hybrid Key Trust, those users and their devices should still be able to continue to use Hybrid Key Trust while the rest of the organization operates with Hybrid Cloud Trust.</p>
<h4 id="cleanup"><a class="toclink" href="../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#cleanup">Cleanup</a></h4>
<p>While in the demonstration above, we see that authentication happens without the need for the msDS-KeyCredentialLink to be populated in Active Directory, the behavior of Azure AD Connect is to still synchronize that value back ton AD, even for a Hybrid Cloud Trust. Remember ‚Äì we are still performing asymmetric key-based authentication to Azure AD, so there is still a keypair that exists. The behavior change is on the client; the public key in the way it is written to Azure AD appears to have no mechanism to differentiate the type of authentication the client intends with it. Due to this, downstream, Azure AD Connect is still going to synchronize back to Active Directory the public key. I would be curious if Microsoft has intentions to modify this behavior down the road, but for the meantime, we can just ignore those attributes in AD.</p>
<p>At this point, we can also evaluate whether to roll back the certificate policies issuing certs to our DC‚Äôs for certificate-based authentication. If configured properly, this process should be no-maintenance, so it‚Äôs not a critical item, but likely should be removed to clear up any confusion down the road. Would also caution though to ensure that you do not negatively impact anything else that might be leveraging AD for certificate-based auth before backing that out of Active Directory.</p>
<h3 id="faq"><a class="toclink" href="../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#faq">FAQ</a></h3>
<h4 id="do-i-still-need-line-of-sight-of-active-directory-for-enrollment"><a class="toclink" href="../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#do-i-still-need-line-of-sight-of-active-directory-for-enrollment">Do I still need line-of-sight of Active Directory for enrollment?</a></h4>
<p>Yes. For the underlying mechanisms that configure Windows for a cached sign-on experience, line-of-sight is required for Active Directory during the first use of the WHfB credentials that were configured.</p>
<h4 id="what-identity-provider-is-authoritative-for-the-client"><a class="toclink" href="../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#what-identity-provider-is-authoritative-for-the-client">What Identity Provider is Authoritative for the client?</a></h4>
<p>One of the topics that almost always comes up when talking about a Hybrid device, is what Identity Provider (IdP) is authoritative for user authentication ‚Äì Azure AD or Active Directory. This question arises because there is this <strong>duality</strong> of identity on the device; our user object is tied to two different identity providers. However, one of the identity providers is still considered the <strong>authoritative</strong> identity provider. The authoritative identity provider is the one that would handle things like providing account lockout for a disabled user account.</p>
<p>For Hybrid Key Trust, Active Directory was authoritative, and Azure AD was secondary ‚Äì you would receive/refresh your PRT after successful authentication to AD.</p>
<p><img alt="Figure 7" src="/images/2022/03/23/img7.png" /></p>
<p>With Hybrid Cloud Trust, the model is now flipped, and Azure AD is authoritative, with AD as secondary.</p>
<p><img alt="Figure 8" src="/images/2022/03/23/img8.png" /></p>
<p>We can observe this behavior in the security events on the device. When you first sign in to the device, you will receive a 4624 user logon event with a logon type of 11, which is cached interactive. This is observed even with line-of-sight of Active Directory. Very soon after, if you have line-of-sight of Active Directory, you will see another 4624 user logon event with a type of 7, which normally indicates workstation unlock.</p>
<p>Now, during testing, you will notice that even if the user account is disabled in Azure AD and Active Directory, even with line-of-sight of both AAD and AD, local logon will still occur. However, when the user attempts to access cloud-based resources, they will receive an error in thick-client applications like Teams indicating they need to sign in (which will fail), and through the web, they will be informed their account is locked out. For AD resources, access will also be denied, and in the security event log, we will find a failed sign-on event, with a failure indicating the account is currently disabled.</p>
<h3 id="final-notes"><a class="toclink" href="../../2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#final-notes">Final notes</a></h3>
<p>If you‚Äôve happened to read this whole post and your organization is not using WHfB yet, now is a great time to strengthen the security posture of your organization, and to start examining what it takes to go passwordless.</p>
<p>If you‚Äôve rolled out Windows Hello for Business, and want to take a look at what the next steps are to eliminating the use of passwords for those passwordless people, take a look at my post on SCRIL, <a href="https://ericonidentity.com/2021/12/13/living-in-a-passwordless-world-hybrid-identity-and-password-management/">Living in a Passwordless World: Password Management ‚Äì Eric on Identity</a>.</p>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <a class="md-pagination__link" href="../..">1</a> <span class="md-pagination__current">2</span> <a class="md-pagination__link" href="../3/">3</a>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.path", "navigation.top"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": {"NFC": "nfc"}, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../../js/open_in_new_tab.js"></script>
      
    
  </body>
</html>