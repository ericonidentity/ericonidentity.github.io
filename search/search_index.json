{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"2023/03/11/entra-app-registrations-and-enterprise-applications-the-definitive-guide/","title":"Entra App Registrations and Enterprise Applications: The Definitive Guide","text":"<p>For those that must manage application integrations in Entra ID, it\u2019s an inevitable question: What is the difference between an App Registration and an Enterprise Application? Why are there two different management blades? Why do I see some applications in both places?</p> <p>I\u2019ll admit that this is not the first take at answering this question, and there are already some good answers out there. Microsoft breaks things down here, Apps &amp; service principals in Azure AD \u2013 Microsoft Entra | Microsoft Learn, with a decent visual at the end.</p> <p>Marilee Turscak also has an excellent breakdown here, The Differences Between App Registrations, Enterprise Applications, and Service Principals in Azure AD | Marilee Turscak.</p> <p>And John Savill has fantastic video published covering this as well, Azure AD App Registrations, Enterprise Apps and Service Principals \u2013 YouTube.</p> <p>As John points out in his video, the understanding of App Registrations and Enterprise Apps can further be enhanced by understanding OpenID Connect and OAuth 2.0 flows. This is especially important for identity professionals and ITPros who may come from a sysadmin background. Modern authentication flows and concepts may feel foreign to folks who built their career on identity platforms such as Active Directory.</p> <p>For those that find it easiest to learn by doing, if you want to play around with App Registrations, Enterprise Apps and Service Principals, but don\u2019t want to mess with your prod environment, sign up for an M365 Developer account, to have your own free tenant to work with here, Developer Program | Microsoft 365 Dev Center</p> <p>We\u2019ll start with some definitions, and then try to walk through various scenarios that you may encounter. If you don\u2019t see your question answered within the definitions, keep reading\u2026 we\u2019ll try to hit on all the areas here.</p>"},{"location":"2022/08/09/an-agile-refresh-of-the-passwordless-strategy/","title":"An Agile Refresh Of The Passwordless Strategy","text":""},{"location":"2022/08/09/an-agile-refresh-of-the-passwordless-strategy/#background","title":"Background","text":"<p>The Microsoft passwordless strategy guidance has existed since 2018, and since then it\u2019s continued to be a solid document. You can view the full doc here, Password-less strategy \u2013 Windows security | Microsoft Docs, but where the focus usually lands is on the four-step graph at the top of that page:</p> <p></p> <p>The Microsoft passwordless strategy</p> <p>When discussing the strategy with organizations, the focus is usually on Step 1 \u2013 develop (deploy) password replacement offerings, and the technology involved, such as Windows Hello for Business, FIDO2 security keys, and MS Authenticator App passwordless sign-in. After all, the strategy is provided as a stepped approach, so you start with the first step, and then move on.</p> <p>There are three primary issues with the approach:</p> <ul> <li>Organizations look at this as a reinforcement that passwordless must be deployed in a waterfall approach.</li> <li>Application authentication modernization is not emphasized strongly enough, and subsequently organizations do not right-size the efforts required.</li> <li>Organizations do not emphasize the pluralization on offerings, and potentially focus on the requirement of one-size-must-fit-all.</li> </ul> <p>While issue three is not specific to this approach as designed, many organizations will take the waterfall approach with a single solution, and then box themselves into only deploying one solution, slowing down progress.</p>"},{"location":"2022/08/09/an-agile-refresh-of-the-passwordless-strategy/#the-waterfall-approach-problem","title":"The waterfall approach problem","text":"<p>While there have been great strides made organization wide, many still tend to suffer in that security and infrastructure teams still operate in a waterfall approach when it comes to managing identity platforms, products, and projects. A solid Identity Program or expert consultants can help rectify this, but not every organization has access to these. And sometimes, of course, organizations will simply point to the Microsoft docs and just take it all as literal guidance, with little desire to deter. From firsthand discussions with customers I\u2019ve encountered all too often the desire to look at this as a serialized, singular method to tackle passwordless.</p> <p>For organizations that have been on other identity journeys in Azure AD, they likely will have seen similar problems in their approach to deploying things like MFA or conditional access policies \u2013 if you wait for a collective 100% of all problems to be resolved, you will move the needle 0%.</p> <p>In the case where a picture is worth a thousand words \u2013 some organizations will look at this diagram and disregard all the details within the associated docs. While it\u2019s likely they aren\u2019t the candidate to be reading this, it\u2019s worth noting.</p>"},{"location":"2022/08/09/an-agile-refresh-of-the-passwordless-strategy/#the-application-authentication-modernization-problem","title":"The application authentication modernization problem","text":"<p>A very common issue within organizations is that they successfully reach mass deployment of passwordless with most user personas, but when the project is \u201cdone\u201d they realize that there is still a lot of work to accomplish to be able to fully realize a passwordless environment.</p> <p>For some organizations, this can result in passwordless being viewed as a failure. Focus will shift to organizations asking questions as to why LDAP or RADIUS do not support passwordless authentication, instead of asking why the organization wants to continue to depend on 20+ year old protocols that are inherently more insecure than modern counterparts.</p> <p>Sometimes this issue is because organizations effectively look at passwordless deployments solely as that first step. The focus is just on the technology, on the identity provider, and not on the broader ecosystem. And while consensus is that users will use the path of least resistance, which usually is passwordless, if they still have to use their password at times, there is a lower ROI as passwords are still exposed and subsequently users are still susceptible to password-based attacks such as phishing or password-spray.</p> <p>Other times, the issue is that organizations just simply don\u2019t know where to start. Application modernization projects can be some of the most costly, complex, and time-consuming projects, that can become overwhelming at a rapid pace if not managed properly. It\u2019s important that organizations understand the value and long-term return in application authentication modernization.</p>"},{"location":"2022/08/09/an-agile-refresh-of-the-passwordless-strategy/#the-single-solution-problem","title":"The single solution problem","text":"<p>The single solution problem isn\u2019t specifically a problem with the current strategy. After all, the strategy indicates password replacement offerings. They common story for many organizations is this:</p> <p>We want to deploy passwordless. Let\u2019s deploy Windows Hello for Business, then we\u2019ll deploy FIDO2, then we\u2019ll deploy Authenticator App passwordless sign-in.</p> <p>And the problem then becomes that organizations will focus solely on one method, and will not leave the opportunity to parallel thread progress. Reality is that all three mechanisms are relatively lightweight to deploy from a technical perspective, and end up consuming very little end-user cycles for initial enrollment, but organizations may take a FUD apprehensive approach, when they should instead give users options.</p> <p>To some, this may feel strange, as we\u2019ve been wrongfully engrained by past actions in believing that users should not have choice, but be forced into a certain model \u2013 which ultimately leads users into inventing patterns of negative behavior to circumvent doing something they would rather not. For these organizations, they need to stop viewing end users as the opposition, but instead as their customers, even in the terms of workforce identity.</p> <p>Of course, counter to this point, there are organizations who are deterministic in saying that they require one solution to cover all solutions. While there are initiatives underway, such as passkey, and FIDO2 support is becoming broadly adopted by operating systems, the ecosystem is vastly different than 15 years ago when the single solution mindset worked. Where we only had to previously solve for a small and fixed set of criteria, with cloud sprawl and users wanting to access everything from everywhere all the time, we have to tackle this challenge with a growth mindset. And in this case that includes solving the problem with solutions that best fit the platforms.</p> <p>Customers will ask things like why doesn\u2019t Microsoft make Windows Hello for Business for iOS, even though Microsoft does not own the operating system. Focus instead should be made on the rich ecosystem on iOS and Android devices to support brokered authentication with the Authenticator App or Company Portal. When these are combined with Authenticator App passwordless sign in, users can have a simple passwordless experience on those devices with ease. For the many organizations that encounter end users wanting to access things like email from personal Windows computers, it\u2019s counterintuitive to security to not provide users with a FIDO2 security key and the ability to use such, so that their password is not exposed on devices or in environments with a low level of assurance.</p>"},{"location":"2022/08/09/an-agile-refresh-of-the-passwordless-strategy/#an-agile-refresh-to-the-passwordless-strategy","title":"An agile refresh to the passwordless strategy","text":"<p>Our problems are defined. But what does the solution look like?</p> <p></p> <p>Within this strategy, nothing that Microsoft already recommends is gone, but we emphasize the application side of the equation, and we shift the focus to an iterative methodology that naturally lends to a more agile approach for deployments.</p> <p>Note that this can be considered an addendum to the existing strategy, and is not written to fully replace the existing recommendations. Therefore, it\u2019s still worth reading the Microsoft documentation, Password-less strategy \u2013 Windows security | Microsoft Docs.</p>"},{"location":"2022/08/09/an-agile-refresh-of-the-passwordless-strategy/#passwordless-steps-reduced-to-three","title":"Passwordless steps reduced to three","text":"<p>During my time at Microsoft, one of the most confusing bits to customers was Step 4, Eliminate passwords from the identity directory.</p> <p>The confusion comes out of the mixed messaging and likely reality that passwords will continue to exist, in some form, for a long while to continue.</p> <p>Active Directory has finished baking, and the closest mechanism to having no password is Smart Card Required for Interactive Logon, or SCRIL, where Active Directory effectively manages the users password in a way that renders the password useless and unknown to the end user. When SCRIL is enabled, users are rendered passwordless because:</p> <ul> <li>Their password is managed by Active Directory and they do not know it</li> <li>The user is no longer asked by Windows to change their password</li> <li>Domain Controllers disallow passwords for interactive authentication</li> <li>The password is set to a 128 random bit of data and can include non-typable characters</li> </ul> <p>SCRIL, then, is the ultimate goal for our Active Directory based user accounts. Additional benefits of SCRIL include:</p> <ul> <li>Hybrid users are supported, and users become passwordless in Azure AD</li> <li>Users, still having a password, are able to still comply with corporate password policies that may be required by cybersecurity companies or industry regulations</li> <li>The technology is not new, SCRIL has existed in Active Directory at least since Windows Server 2003, to support organizations previously deploying traditional smartcards within their environments.</li> </ul> <p>For a deeper dive into SCRIL, hybrid users, and password policy enforcement, take a look at this article, Living in a Passwordless World: Password Management \u2013 Eric on Identity.</p>"},{"location":"2022/08/09/an-agile-refresh-of-the-passwordless-strategy/#circular-design-to-indicate-an-iterative-approach","title":"Circular design to indicate an iterative approach","text":"<p>In case it isn\u2019t apparent at this point, I\u2019ll say it again. We want to work these efforts for passwordless in ways that allow for agile deployment, adopting in a way that best suits the organization and allows for passwordless progress.</p> <p>Whether you call them waves, rings, phases, or something else, it\u2019s important that organizations identify user personas to target and deploy in a way that provides the path of least resistance and builds inertia for progress. For many organizations this should look like dogfooding passwordless, with infrastructure and security teams deploying the mechanisms to themselves first, along with their Service Desk personnel. This is the reminder that organizations always find more success with technology changes when they involve their Service Desk early in the process. Organizations should also look for champions, perhaps providing opportunity for users to opt in to new passwordless experiences. Many times organizations will focus cycles on the users who won\u2019t want to move, instead of focusing on the users who have a hunger for technology and change. Those users can be key to building that organizational inertia, for finding those non-IT voices to champion progress, and building momentum to topple down those that resist change solely for the sake of such.</p> <p>The iterative approach can not only be used against user personas in the organization, but against the different passwordless mechanisms as well. We don\u2019t want to lock users or the organization into a single-track mindset that only one passwordless method is suitable or feasible to use. And instances may be encountered where there is the desire to deploy multiple approaches, but one method is deployed faster than the other. An example may be deploying Windows Hello for Business first, as a means to then make bootstrapping easier for FIDO2 security keys.</p>"},{"location":"2022/08/09/an-agile-refresh-of-the-passwordless-strategy/#application-authentication-modernization-is-a-parallel-but-separate-effort","title":"Application authentication modernization is a parallel but separate effort","text":"<p>As most identity projects go these days, workstreams are rarely single-threaded, at least if you are looking to achieve success in a reasonable amount of time.</p> <p>Here we have said application authentication modernization is as important as deployment of the passwordless methods themselves. This may be different for every organization, depending on a mixture of several factors, including:</p> <ul> <li>Age of the organization \u2013 Older organizations are likely to have more legacy applications still persistent.</li> <li>Types of applications \u2013 Organizations with several line-of-business (LOB) applications may have a more varied array of authentication mechanisms existing, or if the organization has several applications running in on-premises deployments, vs organizations that primarily consume SaaS applications in a cloud, which likely already support modern forms of authentication.</li> <li>Number of applications \u2013 Again organizations can vary greatly in how many applications they have deployed. Efforts to modernize 10 applications likely will take less time than 100 applications.</li> <li>Application user personas and user base \u2013 Contradicting the number of applications, if an organization has 10 applications but 100,000 users per application, it may take longer to modernize authentication vs an organization with 100 applications but only 10 users accessing each application.</li> </ul> <p>Now you may read this and wonder how to prioritize applications for modernization and what the options are \u2013 a follow-up article will eventually be linked here to dive further into that.</p> <p>As critical as the modernization of applications, is the ability to separate out efforts to modernize those applications. Organizations may find themselves in situations where they enroll certain user personas for passwordless well before their full application catalog supports it, but organizations should also feel empowered to start modernizing applications as soon as they are identified, so that users can benefit from passwordless authentication as soon as they are enrolled.</p>"},{"location":"2022/08/09/an-agile-refresh-of-the-passwordless-strategy/#start-application-authentication-modernization-first","title":"Start application authentication modernization first","text":"<p>To further emphasize the importance, the arrow for application modernization actually starts a bit before passwordless deployment on purpose. While the reality is that many applications will be starting these in tandem as a passwordless initiative, it\u2019s important to understand that support for modern authentication will benefit the application regardless of which methods of passwordless are used. There are several other benefits of application modernization, not just limited to passwordless, including:</p> <ul> <li>Ability to leverage Azure AD technologies for authentication, such as<ul> <li>Conditional Access</li> <li>Device Compliance Requirements</li> <li>Azure AD Identity Protection</li> <li>Microsoft Defender for Cloud Apps</li> </ul> </li> <li>Decouples application from legacy identity stores, setting it up to be closer to running in a cloud-native PaaS environment</li> <li>Support for Azure AD Application Proxy</li> </ul> <p>As we continue to shift towards cloud-native solutions designed to be accessed by everyone from everywhere, it is not just solving for passwordless anymore, and organizations can find themselves either ahead of or behind the ball with supporting modern forms of authentication, such as SAML or OpenID Connect (OIDC).</p>"},{"location":"2022/08/09/an-agile-refresh-of-the-passwordless-strategy/#final-thoughts","title":"Final thoughts","text":"<p>Passwordless deployments, for many organizations, are a litmus test for how well the organization adopts to organizational change and technology advancements. They also are a potential pain point between the C-suite and technology staff, in both directions. Organizations can suffer from technology staff not properly articulating the business value in going passwordless, and what business assets passwordless will protect \u2013 these days it\u2019s more than just implementing \u201call the things\u201d without any concern for the relative value to the business. On the other hand, passwordless is a complex topic that is tough to translate and isn\u2019t always well received by the C-suite. Considering that some organizations still suffer from executives who don\u2019t want MFA because it\u2019s a burden, we have a lot of organizational change that needs to happen across the board. When organizations can implement passwordless to the further extent possible, the net effect is the organization is that much more protected than implementing nothing at all.</p>"},{"location":"2025/02/20/an-interesting-m365-billing-scam/","title":"An Interesting M365 Billing Scam","text":""},{"location":"2025/02/20/an-interesting-m365-billing-scam/#update","title":"Update","text":"<p>I called the 888 number this morning and it does indeed go to a scam call center. I played along with the person on the other end, who ultimately wanted my first and last name, email address, the order number, and most importantly, my credit card number, so they \u201ccould reverse the charge\u201d \ud83e\udd23</p>"},{"location":"2025/02/20/an-interesting-m365-billing-scam/#the-scam","title":"The Scam","text":"<p>This is a case where I\u2019d actually love to see how this plays out \u2013 when you see the way that scammers try to string things together. I\u2019ve been receiving a rash of unpaid toll bill texts, which give themselves away pretty easily based on the source number. But I\u2019m not here to talk about that scam.</p> <p>Instead, I\u2019m here to dig into this email I received last week:</p> <p></p> <p>Last time I checked, I\u2019m not Molly Wagner</p> <p>It looked authentic, and when I checked the headers, it is indeed from Microsoft. I do subscribe to various Microsoft services and receiving emails like this are not abnormal, but I was certainly confused by the service, as well as who it was to.</p> <p>I scroll down a bit more into the rest of the email:</p> <p></p> <p>Notice anything unusual? At first, I didn\u2019t. To give myself props, even though it all seemed legitimate, I didn\u2019t click on the link.</p> <p>But when I saw the domain JacksonLyons.onmicrosoft.com I decided to go look it up over at https://aadinternals.com/osint/. The results:</p> Property Value Default domain JacksonLyons.onmicrosoft.com Tenant name null Tenant brand Microsoft We appreciate your purchase and have finished your recent order for 592.99 USD. Please contact us at (888) 929-1904 for help or cancelation. Tenant id 6cc54dbc-77fb-44e7-9c6f-ca766a8e26b1 Tenant region NA Seamless single sign-on (SSSO) disabled Uses Azure AD Connect cloud sync N/A Certificate-based authentication (CBA) N/A <p>The results make me wonder if the tenant is turned off on the Microsoft side, as there are no verified domains, but there is a Tenant ID, and the interesting Tenant brand.</p> <p>Of course, it appears that smithkrause.onmicrosoft.com is the vehicle behind this, and in particular mollywagner@smithkrause.onmicrsoft.com.</p> <p>Back to another lookup courtesy of @drazuread.bksy.social:</p> Property Value Default domain SmithKrause.onmicrosoft.com Tenant name SmithKrause.onmicrosoft.com Tenant brand SmithKrause Tenant id eecfe604-36e5-4e7c-86ee-2313e05112aa Tenant region NA Seamless single sign-on (SSSO) disabled Uses Azure AD Connect cloud sync N/A Certificate-based authentication (CBA) N/A Verified domains 2 Domain Type STS addiamaryellen.gigasphere.site Managed SmithKrause.onmicrosoft.com Managed <p>Pulling a whois of gigasphere.site, the domain is relatively fresh:</p> <pre><code>Domain Name: GIGASPHERE.SITE\nRegistry Domain ID: D524536986-CNIC\nRegistrar WHOIS Server: whois.namecheap.com\nRegistrar URL: https://namecheap.com\nUpdated Date: 2025-02-05T10:49:53.0Z\nCreation Date: 2025-02-05T10:49:48.0Z\nRegistry Expiry Date: 2026-02-05T23:59:59.0Z\nRegistrar: Namecheap\nRegistrar IANA ID: 1068\n</code></pre> <p>When digging into DNS, both gigasphere.site and addiamaryellen.gigasphere.site only have MX and SPF records for EXO (gigasphere.site DNS is hosted by Cloudflare).</p> <p>Of course, the email originated from a smithkrause.onmicrosoft.com domain, which I can\u2019t tell the age of, or at least not through AAD Internals OSINIT. Another interesting thing to note is that the people behind the scam are populating a distribution list with the target email addresses; when looking at the headers the To: is indeed mollywagner@smithkrause.onmicrosoft.com.</p> <p>In due diligence I submitted the email review in M365 Defender, which came back with a no threats found</p> <p></p> <p>Apparently, the body of the email containing \"Microsoft We appreciate your purchase and have finished your recent order for 592.99 USD. Please contact us at (888) 929-1904 for help or cancelation.\" isn\u2019t sufficient enough to be considered suspicious \ud83d\ude44.</p> <p>For fun, I did call the number, but right now the scammers number just forwards to a voicemail box; if I\u2019m able to get ahold of them and resolve my billing issues I\u2019ll follow up \ud83d\ude09.</p> <p>And the link? The link is benign, it just goes to the M365 admin billing portal, because the email as far as I can tell is legit from Microsoft.</p> <p>The first few hops on the headers appear to be coming from some MS backend service and it hits the DL on hop 5, based on looking at the headers on https://mxtoolbox.com/EmailHeaders.aspx:</p> Hop Delay From By With Time (UTC) Blacklist 1 * outlook.office365.com 2603:10b6:303:18d::16 MW4PR20MB4527.namprd20.prod.outlook.com HTTP 2/13/2025 2:40:06 PM \u2705 2 2 seconds NAM10-DM6-obe.outbound.protection.outlook.com 2a01:111:f403:2413::720 SJ1PEPF00002313.mail.protection.outlook.com 2603:10b6:a0f:fc02::1a7 Microsoft SMTP Server (version=TLS1_3, cipher=TLS_AES_256_GCM_SHA384) 2/13/2025 2:40:08 PM \u2705 3 0 seconds SJ1PEPF00002313.namprd03.prod.outlook.com 2603:10b6:a03:54:cafe::b3 BYAPR02CA0055.outlook.office365.com 2603:10b6:a03:54::32 Microsoft SMTP Server (version=TLS1_3, cipher=TLS_AES_256_GCM_SHA384) 2/13/2025 2:40:08 PM \u2705 4 0 seconds BYAPR02CA0055.namprd02.prod.outlook.com 2603:10b6:a03:54::32 SJ2PR17MB6565.namprd17.prod.outlook.com 2603:10b6:a03:4f6::19 Microsoft SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) 2/13/2025 2:40:08 PM \u2705 5 47 seconds BY5PR17MB3063.namprd17.prod.outlook.com fe80::bf8c:c1de:31b1:4af5 BY5PR17MB3063.namprd17.prod.outlook.com fe80::bf8c:c1de:31b1:4af5 mapi 2/13/2025 2:40:55 PM \u274c <p>Additionally, I would think if the email was fake, they wouldn\u2019t include a legit link to the M365 Admin billing site.</p> <p>Here is what I believe is going on:</p> <ol> <li>Scammer sets up junk tenant with the scam text tenant brand info</li> <li>Distribution list is created with target email addresses</li> <li>DL is used as the billing contact email</li> <li>Scammer signs up for trial and/or service (not sure of this part in that when I looked up Dynamics 365 Sales Enterprise Edition, it\u2019s $120 USD /month)</li> <li>Email is blasted to all the targets via the DL</li> </ol> <p>Anyway, I thought it was worth a share as this seems like a new twist on using Microsoft tools to try and scam people.</p> <p>In the meantime, I\u2019ll be trying to poke at Microsoft people to take down the smithkrause domain.</p>"},{"location":"2022/07/14/authenticator-app-ios-multiple-passwordless-account-support-is-here/","title":"Authenticator App: IOS Multiple Passwordless Account Support Is Here!","text":"<p>For anyone who lives in a world of multiple Azure AD accounts and the Authenticator App, you can finally rejoice over not having to make the difficult decision over which account is the one you enable for passwordless\u2026 or potentially not having to carry multiple devices.</p> <p>To date, you could enroll one Azure AD account and one personal Microsoft Account (MSA) for passwordless in the Authenticator App. Even with multiple Azure AD accounts in the same tenant, only one could go passwordless.</p> <p>With this update, not only can you go passwordless for multiple accounts in the same Azure AD tenant, but across multiple tenants as well.</p>"},{"location":"2022/07/14/authenticator-app-ios-multiple-passwordless-account-support-is-here/#enabling-the-preview","title":"Enabling the preview","text":"<p>First you\u2019ll want to make sure you have the latest version of the MS Authenticator App from the Apple App Store, which you can check here, Microsoft Authenticator on the App Store (apple.com).</p> <p>Per Microsoft, you\u2019ll also need to enable a usage data setting within the Settings of the Authenticator App. You can do this by opening the hamburger menu in the upper left, and select Settings.</p> <p>Within settings, you\u2019ll want to enable Usage Data (the screenshot shows it disabled, but you need to enable it). The associated MS Docs article is here, Passwordless sign-in with Microsoft Authenticator \u2013 Azure Active Directory \u2013 Microsoft Entra | Microsoft Docs.</p> <p>Note</p> <p>In my testing I found you need to force quit the Authenticator App after enabling Usage Data to allow for multiple account enrollment.</p> <p></p>"},{"location":"2022/07/14/authenticator-app-ios-multiple-passwordless-account-support-is-here/#multiple-passwordless-accounts-in-the-same-azure-ad-tenant","title":"Multiple passwordless accounts in the same Azure AD tenant","text":"<p>On each additional account you want to go passwordless, select the account in the Authenticator App, and choose Enable phone sign-in. This is the same as the experience to enable for the first account, with an exception that you do not need to register the device again.</p> <p></p> <p>You\u2019ll see that the device indicates it is already registered, just select Continue.</p> <p>Info</p> <p>You will be prompted to perform MFA if you have not recently authenticated on the device.</p>"},{"location":"2022/07/14/authenticator-app-ios-multiple-passwordless-account-support-is-here/#multiple-passwordless-accounts-in-different-azure-ad-tenants","title":"Multiple passwordless accounts in different Azure AD tenants","text":"<p>If your accounts exist across multiple Azure AD tenants, you can still initiate it through the same process as above, select the additional account, and select Enable phone sign-in. During this process, the device will just require you to register it within that second Azure AD tenant.</p> <p>After device registration is completed, passwordless will be enabled for both accounts in both tenants.</p> <p>We can examine this within the Authenticator App, by browsing to Settings, Device Registration, where we see the tenants the device is registered with.</p> <p></p> <p>You can drill further into each tenant within the settings, see the Device ID, and optionally unregister the device from said tenant.</p> <p>If the device is unregistered from an Azure AD tenant, the associated accounts will automatically be disabled for passwordless on it.</p> <p>Note that the Device ID is unique per Azure AD tenant.</p> <p></p>"},{"location":"2022/07/14/authenticator-app-ios-multiple-passwordless-account-support-is-here/#the-experience","title":"The experience","text":"<p>I\u2019ve been testing this experience in a private preview for a while now, and I\u2019ll say it\u2019s been as smooth as one could want. Naturally, as the private preview recommends not using preview software for production use, I immediately installed it on my primary iPhone and enabled all of my Azure AD accounts for passwordless. I currently have multiple accounts enabled for passwordless across three Azure AD tenants, to which I\u2019ve authenticated multiple times a week, and an issue has not arisen.</p>"},{"location":"2022/07/14/authenticator-app-ios-multiple-passwordless-account-support-is-here/#final-thoughts","title":"Final thoughts","text":"<p>This is a simple yet fantastic step forward in the passwordless journey by Microsoft; while not everyone out there has multiple Azure AD accounts, for those of us that do, we finally don\u2019t have to make choices anymore.</p> <p>For organizations out there who have not gone passwordless, because of concerns about push notification fatigue, now is the time to enable push notifications and allow for passwordless authentication for our end users. With the addition of number matching and additional context, we can protect our organizations from accidental notification approval, which I cover here, Azure AD: Increasing Security within the MFA Experience \u2013 Eric on Identity.</p> <p>To provide a great user experience, we need to not lock our users into a singular means of strong authentication, and allowing users to choose the strong authentication experience that works best for them promotes better end user habits and better organizational security.</p>"},{"location":"2023/01/29/azure-ad-101-azure-subscription-relationship/","title":"Azure AD 101: Azure Subscription Relationship","text":"<p>Whether you are dipping your toe or diving headfirst into Azure, one of the points of confusion is the relationship between Azure Active Directory and Azure subscriptions. Azure subscriptions may be referred to as subscriptions, or sometimes even just Azure. An Azure Active Directory tenant, which is the cloud identity provider, is usually referred to as Azure AD or AAD, or sometimes just tenant.</p> <p>While Microsoft has decent documentation on the relationship, I tend to find that drawing analogies along with additional visuals can help really drive the relationship home for folks. For the MS Docs article, see Add an existing Azure subscription to your tenant \u2013 Azure AD \u2013 Microsoft Entra | Microsoft Learn.</p>"},{"location":"2023/01/29/azure-ad-101-azure-subscription-relationship/#a-look-at-pre-cloud-infrastructures","title":"A look at pre-cloud infrastructures","text":"<p>When we take a look at very classic on-premises infrastructure, if it\u2019s a Microsoft shop we\u2019ll almost always have Active Directory, an identity provider, usually running on physical or virtualized servers in a high availability architecture. For purposes here, we\u2019ll abstract it from the underlying server infrastructure:</p> <p></p> <p>Our Active Directory domain</p> <p>Likewise, we have all sorts of servers running, again possibly a mix of physical servers, as well as virtualized servers (even though the hypervisor itself is running on some form of physical server). Below we have a simple example of a Windows Server that is running Hyper-V, and has four virtual machines running:</p> <p></p> <p>A Hyper-V environment running on a Windows server</p> <p>When we connect these two systems, Active Directory and the Windows Server, we form a trust relationship between the two. The trust relationship is represented in Active Directory by the computer object that represents that Hyper-V server.</p> <p></p> <p>The AD and Windows Server trust relationship</p> <p>To expand this out a bit further, we likely have several different servers running several different types of workloads in our environment:</p> <p></p> <p>Our simple multi-server environment</p> <p>The one commonality is that regardless of the type of workload running on the server, we have that trust relationship between Active Directory and each server.</p>"},{"location":"2023/01/29/azure-ad-101-azure-subscription-relationship/#translating-to-the-cloud-trust-model","title":"Translating to the cloud trust model","text":"<p>With our understanding of having that trust relationship between Active Directory and each Windows Server, we can translate this to a similar trust relationship between our Azure Active Directory tenant and Azure Subscriptions.</p> <p>In our example below, we see that a subscription can be mostly analogous to a Windows Server. They both contain virtual machines, and both the subscription and the server have their own type of trust relationship to their relative identity provider:</p> <p></p> <p>A tenant-subscription trust</p> <p>Similar to how we may run several different workloads on several different servers, we can have several different subscriptions that are managing several different workloads:</p> <p></p> <p>A multi-subscription trust model</p> <p>Similar to Active Directory, where you can only join a Windows server to one domain, an Azure subscription can only have one trust relationship to an Azure AD tenant.</p> <p>Unlike Active Directory, where the trust relationship is observable as a computer object, the subscription won\u2019t be something that you\u2019ll see represented in Azure AD itself, but with the right permissions you\u2019ll be able to observe all subscriptions associated with that tenant when you sign into the Azure portal.</p> <p>With Windows servers, we occasionally may run into instances where we wanted to migrate a Windows server from one Active Directory Forest to another. Similarly, we can migrate an Azure subscription relationship from one Azure AD tenant to another:</p> <p></p> <p>Changing the trust relationship</p> <p>In both models, the trust relationship is changed, because we can still only have one trust relationship between a subscription and a tenant.</p> <p>Similar to Active Directory and changing the associated forest, depending on the types of workloads in the subscription, there may be post migration work that needs to happen. At the very least, we will need to re-assign the appropriate permissions to the subscription.</p>"},{"location":"2023/01/29/azure-ad-101-azure-subscription-relationship/#the-permission-confusion","title":"The permission confusion","text":"<p>Not only is the relationship between a tenant and subscription confusing, but so is the permission model, and where things should, or should not, crossover.</p> <p>With Active Directory, in a properly tiered permission model, Domain Administrator should primarily be used for management of Active Directory, and nothing more. All of those servers joined to Active Directory should use a separate set of permissions, many times referred to as a Server Administrator. Domain Administrators have no business logging onto the member servers, and Server Administrators have no business managing Active Directory. This all becomes really important when you start talking about least privilege and privilege separation.</p> <p>You can think of the fact that each Windows server has its own set of local permissions you can delegate and control on the server. And those permissions are managed local to that server. While you may create groups of objects in Active Directory, say, Hyper-V Server Administrators, you then assign that group local on each Hyper-V server to have the necessary rights.</p> <p>The same goes in Azure subscriptions. Subscription Owners are effectively the Local Administrators, and the permissions themselves are assigned on the subscription. While the permissions may be abstracted in the sense that you use a single portal or command across multiple subscriptions, the permissions are still encompassed around that subscription.</p> <p>And just like Active Directory, you generally do not need to assign a Global Administrator any permissions into or over a subscription. While some organizations may accept the risk with a limited number of Global Administrators, the problem becomes pervasive in organizations that believe they need to continue to hand out Global Administrator roles just so that subscription ownership can happen.</p> <p></p> <p>While it is a shift in how organizations work and operate, overly permissive models with a lack of privilege separation are a great way to help threat actors into your environment.</p>"},{"location":"2023/01/29/azure-ad-101-azure-subscription-relationship/#digging-deeper","title":"Digging deeper","text":"<p>Our examples are simple, to help build an understanding of the relationship model. And just like we may divide server workloads up by application groups or regions, and how we likely architect web farms and Hyper-V clusters, elaborate subscription models require thoughtful architecture behind them. This is where the Microsoft Cloud Adoption Framework and Azure Landing Zones come into play.</p> <p>You can find more information on these here, Microsoft Cloud Adoption Framework for Azure \u2013 Cloud Adoption Framework | Microsoft Learn, and here, What is an Azure landing zone? \u2013 Cloud Adoption Framework | Microsoft Learn.</p> <p>It\u2019s especially important from an identity and security perspective properly design the security of your subscriptions \u2013 many organizations have overly permissive architectural designs around their subscription permissions, including on items of critical infrastructure, such as Active Directory Domain Controllers running as virtual machines in Azure.</p> <p>For further information on securing privileges access, take a look at Securing privileged access overview | Microsoft Learn.</p>"},{"location":"2023/01/29/azure-ad-101-azure-subscription-relationship/#one-last-point-language-matters","title":"One last point - language matters","text":"<p>This is one of those areas where language matters, especially if you are an identity practitioner or working in a role where you help manage and service your customers Azure subscriptions and Azure AD tenant(s).</p> <p>It is not:</p> <ul> <li>Azure tenant</li> <li>Azure AD subscription</li> <li>AAD subscription</li> <li>Azure directory</li> </ul> <p>It is:</p> <ul> <li>Azure AD tenant</li> <li>Azure subscription</li> </ul> <p>While for some organizations you may be able to get away with interchanging terminology, if you were to have a project assigned to you, or scope a project for a customer, and the details were similar to \u201cperform an audit of the AAD subscription and make recommendations on a privilege model\u201d, would you be talking about auditing the permissions in Azure Active Directory? In an Azure subscription? Which Azure subscription if the organization has multiple? You can see where this is going.</p>"},{"location":"2022/04/21/azure-ad-cross-tenant-access-settings-clarity/","title":"Azure AD: Cross-tenant Access Settings Clarity","text":"<p>With the release of Azure AD cross-tenant access settings, I\u2019ve noted some confusion among folks as to what it is, and as importantly, what it isn\u2019t.</p> <p>I\u2019ll also be covering B2B Direct Connect, because even though it\u2019s a separate feature, with release coinciding at the same time as cross-tenant access settings, I see it all being lumped \u201cinto the same\u201d set of preview features.</p> <p>The Microsoft Docs article on this is an excellent source of information, which can be found here, Cross-tenant access overview \u2013 Azure AD | Microsoft Docs. Along with that, we\u2019ll dive into the background and use cases for this new suite of knobs and dials for our external identities.</p>"},{"location":"2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#terminology","title":"Terminology","text":"<p>Guest \u2013 For clarity, when speaking about guest users for the context of this post, we are talking about users invited into your Azure AD tenant.</p> <p>Resource Azure AD Tenant [Resource Tenant] \u2013 If you are inviting guests into your Azure AD tenant, your tenant is the resource tenant. It represents your organization. If you are a guest, then the resource tenant is the tenant you have been invited into.</p> <p>Home Azure AD Tenant [Home Tenant] \u2013 This is the tenant where the user objects live. If your user object exists in your organizations Azure AD tenant, your tenant is both the home tenant and resource tenant \u2013 your users and applications all \u201clive\u201d in the same place. Guests into your tenant will have a different home tenant.</p>"},{"location":"2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#what-it-is-not","title":"What it is not","text":"<p>Before getting into what we can do with cross-tenant access settings, let\u2019s cover what this is not (at least at the time of this writing).</p>"},{"location":"2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#parity-to-an-active-directory-trust","title":"Parity to an Active Directory trust","text":"<p>Cross-tenant access settings may invoke a feeling of configuring a trust in Active Directory, which many Microsoft identity practitioners may be familiar with.</p> <p>It is closer to the opposite of a trust, in the sense that by default Active Directory has no implicit trusts, and you must explicitly configure trusts. Azure AD historically is opposite, any organization, unless settings are adjusted, can invite users from any Azure AD tenant into the organization. These settings allow us to be more granular in how we restrict guest access inbound and outbound to our Azure AD tenant.</p> <p>Further, when we examine B2B Direct Connect, we realize that the only use case, currently, is Teams shared channels.</p> <p>When we think of an Active Directory trust, we think of the fact that user objects only exist in the source user forest. With cross-tenant access settings, and the limitations with B2B Direct Connect, we still must invite user objects into our resource tenant \u2013 all the other \u201cthings\u201d tied to our Azure AD tenant need the objectID within our resource tenant to reference.</p>"},{"location":"2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#what-it-is","title":"What it is","text":""},{"location":"2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#a-mechanism-to-provide-granular-b2b-guest-control","title":"A mechanism to provide granular B2B guest control","text":"<p>When speaking about B2B guests and external identities, many organizations tend to focus on the aspect of guests being invited into their tenant. There is the other side to that B2B coin, which is restricting what organizations you may want your users to have access to.</p> <p>Certain organizations, especially those in the regulated industries, have concern over which external tenants their users can connect to. Up until now, organizations would need to apply tenant restrictions, Use tenant restrictions to manage access to SaaS apps \u2013 Azure AD | Microsoft Docs, which has a higher level of complexity to it \u2013 the implementation requires a proxy to perform traffic inspection and HTTP header insertion.</p> <p>Now, organizations that have strict requirements regarding outbound guest access can, by default, restrict outbound access, and then create a more granular allow list.</p> <p>We also now can be granular down to user/group level of who can access certain organizations. Say you want to only allow employees from payroll to be able to access the tenant the vendor uses and restrict outbound access to everyone else \u2013 now you can do that.</p> <p>Likewise, there is granularity on the inbound side. Say you are that vendor that processes an organizations payroll and want to ensure that only the known users for the company you serve can come into your organization. You can restrict inbound as well, limiting what guests are allowed in.</p>"},{"location":"2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#a-way-to-trust-external-mfa-and-device-compliance","title":"A way to trust external MFA and Device Compliance","text":"<p>Many organizations that are familiar with conditional access and guest policies have encountered the need to enroll in Azure AD MFA twice or more \u2013 once for their home tenant and once in every other resource tenant they access. This experience, from a user perspective, is less than ideal.</p> <p>With cross-tenant access settings, we can now choose to trust MFA from the guest users home tenant. We also can be granular \u2013 if we want to trust MFA from certain tenants, but require MFA enrollment from others, we can do that.</p> <p>More interestingly, we can now trust device compliance and hybrid join status, from the guest home tenant. While I still have certain reservations about the quality of relying on hybrid join alone, focusing on device compliance, it really opens a lot of cross-tenant collaboration, and brings an innovative approach to leveraging Zero Trust modeling when working with guests. While this still has the requirement that the guest home tenant must be leveraging Intune or a 3rd party MDM that can report in device compliance, it makes this a possibility.</p> <p>In my own testing, I was able to leverage device compliance in conditional access for a device in a guest tenant, and it worked with ease.</p>"},{"location":"2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#a-few-lingering-questions","title":"A few lingering questions","text":""},{"location":"2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#where-is-conditional-access-processed","title":"Where is Conditional Access processed?","text":"<p>This hasn\u2019t changed with the new cross-tenant access settings, but it\u2019s a good time to review.</p> <p>Conditional access is always evaluated in the resource tenant.</p> <p>The resource tenant needs to ensure that their Conditional Access policies meet the needs of protecting their applications.</p> <p>Likewise, the home tenant cannot restrict outbound access to another tenant with Conditional Access. Because the guest is not accessing resources in their tenant, even an all applications block CA policy will not prevent the user from accessing a resource tenant as a guest \u2013 which really brings us back to what these new settings solve.</p>"},{"location":"2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#where-is-identity-protection-processed","title":"Where is Identity Protection processed?","text":"<p>User risk is evaluated in the home tenant, and sign-in risk is evaluated in the resource tenant for B2B users. When firing up Tor, and accessing O365 with a guest, my test user was blocked by Identity Protection in the home tenant because it was flagged as a high user risk. So depending on the sort of threat detected by Identity Protection, you may find users being restricted by both the home and resource tenant when Identity Protection is in play.</p> <p>The details on this are further elaborated on in the Microsoft Docs article, Identity Protection and B2B users \u2013 Azure Active Directory | Microsoft Docs.</p>"},{"location":"2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#one-new-trick-out-of-a-possible-many","title":"One new trick - out of a possible many","text":""},{"location":"2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#pim-in-the-home-tenant-for-outbound-guest-access","title":"PIM in the home tenant for outbound guest access","text":"<p>The ability to apply PIM to guest user accounts is not new. But if we combine the preview feature of PIM for group membership, and apply outbound restrictions to a certain group, the home tenant can build a request process for outbound access.</p> <p>In that this is quite restrictive, I would see a narrow range of use cases, as it really hampers collaboration between tenants. For those organizations who previously completely turned off the ability to collaborate with other organizations due to things like data sensitivity, the door might now be opened a bit.</p>"},{"location":"2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#final-notes","title":"Final notes","text":"<p>External Identities and B2B are continually evolving. While there is still a large gap to bridge for many situations, this definitely is bringing us one step closer. B2B Direct Access in particular will be interesting to see how Microsoft evolves it \u2013 will it come closer to how an AD trust operates, or will there be improvements on how guests are invited into tenants.</p> <p>As usual, any questions/concerns/comments please reach out to me, and if you find any new unique use cases for cross-tenant access settings, would love to hear them.</p>"},{"location":"2022/02/22/azure-ad-increasing-security-within-the-mfa-experience/","title":"Azure AD: Increasing Security Within The MFA Experience","text":"<p>MFA push notifications \u2013 one of the more polarizing MFA options available within Azure AD. From a usability perspective, the perception is that it\u2019s less interruptive and less complex for end users. From a security perspective, it\u2019s a low barrier of entry for a malicious actor; especially when targeting a user who may approve push notifications for MFA without much thought.</p> <p>We have seen Microsoft implement various methods of interaction into push notifications to try and combat users just hitting Approve without a second thought. The Authenticator App for passwordless, sometimes referred to as phone sign-in, already has number matching implemented. But this never made it into our more common corporate MFA scenarios \u2013 until recently when additional options for the Authenticator App showed up in Public Preview.</p> <p>After reviewing the details within enabling of number matching and additional context, the effort is a handful of minutes of work \u2013 organizations can categorize this one under the \u2018low effort/high return\u2019 security bucket.</p> <p> </p> <p>Before and after</p>"},{"location":"2022/02/22/azure-ad-increasing-security-within-the-mfa-experience/#number-matching","title":"Number matching","text":"<p>Number matching is the component that creates a stronger second factor for our end users, because they will no longer be able to just hit Approve to that push notification. According to the Microsoft Docs article, once number matching goes GA, it will be enabled within all tenants a few months after. It\u2019s tough to tell at this point whether customers will then have the option to retroactively disable number matching, but the interface makes it seem like it could be possible \u2013 not that it would be recommended.</p> <p></p> <p>Number matching dialogue after primary authentication</p> <p>Per Microsoft number matching will support the following scenarios:</p> <ul> <li>Multi-factor</li> <li>Self-service password reset</li> <li>Combined SSPR and MFA registration</li> <li>AD FS adapter</li> <li>NPS extension</li> </ul> <p>Probably should place an asterisk on the NPS extension, because unless you are using PAP as your RADIUS protocol, push notifications will \u201cdowngrade\u201d to an Approve/Deny without number matching (there is no ability to interact with EAP/MS-CHAPv2).</p>"},{"location":"2022/02/22/azure-ad-increasing-security-within-the-mfa-experience/#enabling-number-matching","title":"Enabling number matching","text":"<p>Again, will speculate that the long term goal is that number matching will be enabled by default in all tenants, and it\u2019s going to become the new normal for our end users. But with this in Public Preview at the moment, it\u2019s something we have to opt into.</p> <p>Also, we have the choice of either enabling number matching for the entire organization or for a group of users; the latter allowing for more finesse in testing, piloting, staged rollouts, and the such.</p> <p>Referencing the docs article linked above, it\u2019s a relatively straightforward process. The article itself actually comes across at first as if you have to use Graph for updating/creating the policy; when you scroll down within it, you\u2019ll see that it can also be performed through the portal. We\u2019ll run through here looking at the options through Graph and seeing how they impact what the portal looks like.</p> <p>Before jumping into things, I will note that the changes were relatively quick to notice within my test tenant \u2013 within a few minutes the changes were apparent to my test users. Likewise with testing of disabling the settings.</p>"},{"location":"2022/02/22/azure-ad-increasing-security-within-the-mfa-experience/#gathering-the-current-state","title":"Gathering the current state","text":"<p>Before making any changes, let\u2019s check out the current state of our policy.</p> <p>Note</p> <p>In order to perform the actions within Graph Explorer, you will want to sign-in, and make sure that you consent to Policy.Read.All and Policy.ReadWrite.AuthenticationMethod permissions.</p> <p>We can do this by running the following query in Graph Explorer:</p> <pre><code>GET https://graph.microsoft.com/beta/authenticationMethodsPolicy/authenticationMethodConfigurations/MicrosoftAuthenticator\n</code></pre> <p>Which in our current tenant returns the following:</p> <pre><code>{\n    \"@odata.context\": \"https://graph.microsoft.com/beta/$metadata#authenticationMethodConfigurations/$entity\",\n    \"@odata.type\": \"#microsoft.graph.microsoftAuthenticatorAuthenticationMethodConfiguration\",\n    \"id\": \"MicrosoftAuthenticator\",\n    \"state\": \"enabled\",\n    \"includeTargets@odata.context\": \"https://graph.microsoft.com/beta/$metadata#authenticationMethodsPolicy/authenticationMethodConfigurations('MicrosoftAuthenticator')/microsoft.graph.microsoftAuthenticatorAuthenticationMethodConfiguration/includeTargets\",\n    \"includeTargets\": [\n        {\n            \"targetType\": \"group\",\n            \"id\": \"all_users\",\n            \"isRegistrationRequired\": false,\n            \"authenticationMode\": \"any\",\n            \"outlookMobileAllowedState\": \"default\",\n            \"displayAppInformationRequiredState\": \"default\",\n            \"numberMatchingRequiredState\": \"default\"\n        }\n    ]\n}\n</code></pre> <p>When we look in the portal we see the following:</p> <p></p> <p>It\u2019s important to note that default = Microsoft managed. And you may be asking what exactly is Microsoft managed? Microsoft managed effectively is the setting that allows Microsoft to make a decision whether these settings should be enabled in your tenant. Back to the thought earlier, eventually Microsoft managed will likely be the way in which Microsoft makes the decision to enable things in your tenant once it\u2019s GA.</p>"},{"location":"2022/02/22/azure-ad-increasing-security-within-the-mfa-experience/#enabling-for-a-group","title":"Enabling for a group","text":"<p>If you are looking to enable this for a single group, it\u2019s just a matter of updating the returned content from our Graph query, and running a PATCH. We simply will replace the all_users portion of the policy with the Azure AD groups ObjectID, and update numberMatchingRequiredState with enabled.</p> <pre><code>PATCH https://graph.microsoft.com/beta/authenticationMethodsPolicy/authenticationMethodConfigurations/MicrosoftAuthenticator\n\n{\n    \"@odata.context\": \"https://graph.microsoft.com/beta/$metadata#authenticationMethodConfigurations/$entity\",\n    \"@odata.type\": \"#microsoft.graph.microsoftAuthenticatorAuthenticationMethodConfiguration\",\n    \"id\": \"MicrosoftAuthenticator\",\n    \"state\": \"enabled\",\n    \"includeTargets@odata.context\": \"https://graph.microsoft.com/beta/$metadata#authenticationMethodsPolicy/authenticationMethodConfigurations('MicrosoftAuthenticator')/microsoft.graph.microsoftAuthenticatorAuthenticationMethodConfiguration/includeTargets\",\n    \"includeTargets\": [\n        {\n            \"targetType\": \"group\",\n            \"id\": \"e39dfee7-4551-4836-adbb-859953e2cba6\",\n            \"isRegistrationRequired\": false,\n            \"authenticationMode\": \"any\",\n            \"outlookMobileAllowedState\": \"default\",\n            \"displayAppInformationRequiredState\": \"default\",\n            \"numberMatchingRequiredState\": \"enabled\"\n        }\n    ]\n}\n</code></pre> <p>As long as we get a 204 response, everything was successful. Looking in the portal again, after a refresh we will see:</p> <p></p> <p>If you\u2019re using the Authenticator App for passwordless (phone sign-in), this is where it can become confusing. If you had previously targeted all users for allowing passwordless through the Authenticator App, and now you\u2019ve added this group, you\u2019ll notice the targeting has changed. Subsequently, if you have users go to enroll for passwordless through the Authenticator App, they will see:</p> <p></p> <p>We will want to make sure that we are now targeting two groups \u2013 a group that will allow for passwordless through Authenticator App, and the second being used for number matching. In our tenant this looks like:</p> <pre><code>PATCH https://graph.microsoft.com/beta/authenticationMethodsPolicy/authenticationMethodConfigurations/MicrosoftAuthenticator\n\n{\n    \"@odata.context\": \"https://graph.microsoft.com/beta/$metadata#authenticationMethodConfigurations/$entity\",\n    \"@odata.type\": \"#microsoft.graph.microsoftAuthenticatorAuthenticationMethodConfiguration\",\n    \"id\": \"MicrosoftAuthenticator\",\n    \"state\": \"enabled\",\n    \"includeTargets@odata.context\": \"https://graph.microsoft.com/beta/$metadata#authenticationMethodsPolicy/authenticationMethodConfigurations('MicrosoftAuthenticator')/microsoft.graph.microsoftAuthenticatorAuthenticationMethodConfiguration/includeTargets\",\n    \"includeTargets\": [\n        {\n            \"targetType\": \"group\",\n            \"id\": \"e39dfee7-4551-4836-adbb-859953e2cba6\",\n            \"isRegistrationRequired\": false,\n            \"authenticationMode\": \"any\",\n            \"outlookMobileAllowedState\": \"default\",\n            \"displayAppInformationRequiredState\": \"default\",\n            \"numberMatchingRequiredState\": \"enabled\"\n        },\n        {\n            \"targetType\": \"group\",\n            \"id\": \"44a9449d-ae6e-4d0b-bd40-c599dcb07441\",\n            \"isRegistrationRequired\": false,\n            \"authenticationMode\": \"any\",\n            \"outlookMobileAllowedState\": \"default\",\n            \"displayAppInformationRequiredState\": \"default\",\n            \"numberMatchingRequiredState\": \"default\"\n        }\n    ]\n}\n</code></pre> <p>And if we look in the portal we will see:</p> <p></p> <p>In this instance, Security Ring 0 is the group with number matching enabled, and Security Ring 1 is the group with number matching left to default (Microsoft managed).</p> <p>A few items to note:</p> <ul> <li>You cannot enable number matching on more than one group, if you attempt to do so through Graph you\u2019ll receive a 400 error, and within the portal the option is grayed out.</li> <li>You cannot enable number matching on a group and also reference the all_users context. One may wish that you could target all users and then just selectively enable number matching on the group, however, if you attempt to reference all_users and a group within the policy, you\u2019ll receive a 400 error.</li> </ul>"},{"location":"2022/02/22/azure-ad-increasing-security-within-the-mfa-experience/#enabling-for-all-users","title":"Enabling for all users","text":"<p>The enablement for all users is even simpler. Same PATCH process, but instead we just leave the group set to all_users, and change numberMatchingRequiredState to enabled.</p> <pre><code>PATCH https://graph.microsoft.com/beta/authenticationMethodsPolicy/authenticationMethodConfigurations/MicrosoftAuthenticator\n\n{\n    \"@odata.context\": \"https://graph.microsoft.com/beta/$metadata#authenticationMethodConfigurations/$entity\",\n    \"@odata.type\": \"#microsoft.graph.microsoftAuthenticatorAuthenticationMethodConfiguration\",\n    \"id\": \"MicrosoftAuthenticator\",\n    \"state\": \"enabled\",\n    \"includeTargets@odata.context\": \"https://graph.microsoft.com/beta/$metadata#authenticationMethodsPolicy/authenticationMethodConfigurations('MicrosoftAuthenticator')/microsoft.graph.microsoftAuthenticatorAuthenticationMethodConfiguration/includeTargets\",\n    \"includeTargets\": [\n        {\n            \"targetType\": \"group\",\n            \"id\": \"all_users\",\n            \"isRegistrationRequired\": false,\n            \"authenticationMode\": \"any\",\n            \"outlookMobileAllowedState\": \"default\",\n            \"displayAppInformationRequiredState\": \"default\",\n            \"numberMatchingRequiredState\": \"enabled\"\n        }\n    ]\n}\n</code></pre> <p>Now when we go look in the portal:</p> <p></p>"},{"location":"2022/02/22/azure-ad-increasing-security-within-the-mfa-experience/#disabling-number-matching","title":"Disabling Number Matching","text":"<p>Ideally you will not be in a position to need to disable number matching, but in the case that you need to, it\u2019s just a matter of setting numberMatchingRequiredState to default. Again, if you set this to disabled, there may be a chance that you will be in a state where your tenant will miss when this rolls out across all tenants.</p>"},{"location":"2022/02/22/azure-ad-increasing-security-within-the-mfa-experience/#additional-context","title":"Additional context","text":"<p>Along with number matching, we can enable additional contextual information about where the user is coming from with a map showing the rough geographic area, as well as what application is requesting the approval. Details of this process come from the Microsoft Docs article.</p> <p> </p> <p>While both mechanisms provide some additional security mechanisms to our end users, additional context alone is not going to prevent an unengaged user from selecting Approve, which is why additional context in itself should be considered a passive security mechanism. Number matching, to contrast, is active, because the user will not be able to perform MFA without interaction.</p>"},{"location":"2022/02/22/azure-ad-increasing-security-within-the-mfa-experience/#enabling-additional-context","title":"Enabling additional context","text":"<p>To enable additional context, whether for all users, or for a group, follows the same processes as enabling number matching. The only difference is we are focusing on the property displayAppInformationRequiredState.</p> <p>Out of the box, this property will be set to default when observing its value through Graph, or Microsoft managed in the portal. We can toggle this to enabled or disabled.</p> <p>A few items to note specific to additional context:</p> <ul> <li>When enabling additional context and using the Authenticator App for passwordless (phone sign-in), the app only receives policy information every 7 days. Because of this, users may not see a behavioral change for up to 7 days after.</li> <li>The NPS extension does not support providing additional context. Being that the NPS extension is simply signaling for MFA to be called, and primary authentication is happening against Active Directory, it makes sense that user location context is not available.</li> </ul>"},{"location":"2022/02/22/azure-ad-increasing-security-within-the-mfa-experience/#final-notes","title":"Final notes","text":"<p>As with all things that impact and change the way our users interact with our systems, while this may be an easier win from a security perspective, organizations will want to make sure that they communicate this change properly to end users. A rushed rollout or lack of communication is an almost certain way of creating friction with our end users, and potentially hurting the efforts to increase organizational security.</p>"},{"location":"2022/10/05/azure-ad-new-controls-for-authentication-strength/","title":"Azure AD: New Controls For Authentication Strength","text":"<p>Microsoft has released a much asked for setting, which also aligns to the Whitehouse memorandum, M-22-09, calling for federal agencies to require phishing resistant MFA by 2024, you can read the full memorandum here, M-22-09 Federal Zero Trust Strategy (whitehouse.gov).</p> <p>With this, we now have granularity in Conditional Access to not just specify whether MFA is required, but also how strong the collective authentication is.</p>"},{"location":"2022/10/05/azure-ad-new-controls-for-authentication-strength/#the-prior-state-of-azure-ad-mfa","title":"The prior state of Azure AD MFA","text":"<p>Within the Grant Control section of a Conditional Access policy, we\u2019ve always had the Require multifactor authentication control, which enforced MFA. But up until now, we never had the ability to specify what that level could be \u2013 if a user in a tenant has a FIDO2 security key, but also is registered for SMS text, they could use either that security key or their password and SMS text for MFA. In many tenants it\u2019s always practical to try and restrict users from using weaker forms of MFA, especially at times when they may need to use that to bootstrap themselves into stronger authentication methods such as passwordless. And since this is a tenant-wide setting, we have had the historical issue where we couldn\u2019t say enforce stronger forms of authentication for privileged accounts, such as Global Admins.</p>"},{"location":"2022/10/05/azure-ad-new-controls-for-authentication-strength/#require-authentication-strength","title":"Require authentication strength","text":"<p>Within Grant Controls, we now have a new option, Require authentication strength. When we select this dropdown, we see that we have the following options available:</p> <ul> <li>Multifactor authentication \u2013 Combinations of methods that satisfy strong authentication such as Password + SMS</li> <li>Passwordless multifactor authentication \u2013 Passwordless methods that satisfy strong authentication, such as Microsoft Authenticator</li> <li>Phishing-resistant multifactor authentication \u2013 Phishing-resistant Passwordless methods for the strongest authentication, such as FIDO2 Security Key</li> </ul> <p></p> <p>We also have the ability to define custom authentications strengths in Azure AD, which we can find under Security -&gt; Authentication Methods -&gt; Authentication Strengths (Preview).</p> <p></p> <p>And if we look at the details, this opens up a whole world of options for us:</p> <p></p> <p>First, let us examine the out-of-the-box options.</p>"},{"location":"2022/10/05/azure-ad-new-controls-for-authentication-strength/#multifactor-authentication","title":"Multifactor authentication","text":"<p>The lowest denominator for MFA, this setting should be parity to the Require multifactor authentication setting that we\u2019ve had available for as long as Conditional Access has existed.</p> <p>We can examine this by changing an existing policy from Require multifactor authentication to Require authentication strength and selecting Multifactor authentication.</p> <p>As a baseline, lets first look at what our Azure AD logs show us in the current state, with Require multifactor authentication enabled:</p> <p></p> <p>And if we look at the Conditional Access Policy details:</p> <p></p> <p>Now let\u2019s change our policy to use the require authentication strength setting with multifactor authentication selected:</p> <p></p> <p>Switching to the new MFA setting</p> <p>Note</p> <p>Require multifactor authentication and Require authentication strength are mutually exclusive, as they both enforce multifactor. Enabling one will disable the ability to use the other within the same Conditional Access Policy.</p> <p>After we authenticate, the sign-in log looks the same:</p> <p></p> <p>However, if we examine the Conditional Access Policy details, we will see that we are satisfying for the new authentication strength grant control:</p> <p></p>"},{"location":"2022/10/05/azure-ad-new-controls-for-authentication-strength/#passwordless-multifactor-authentication","title":"Passwordless multifactor authentication","text":"<p>Let\u2019s kick the strength of the Conditional Access policy up:</p> <p></p> <p>With things turned up, let\u2019s first look at the behavior if we attempt to authenticate with a password anyway.</p> <p>Note</p> <p>Remember that Conditional Access evaluates after primary authentication, so our policies will not prevent a user from still attempting to perform password authentication.</p> <p></p> <p>We are then presented with another dialog, telling us that our organization requires additional sign in methods to access this resource:</p> <p></p> <p>Now if we take a look at our Sign-in logs, we\u2019ll see that the initial username/password auth occurs, as well as passwordless to satisfy MFA requirements:</p> <p></p> <p>Note</p> <p>Microsoft Authenticator passwordless (phone sign-in) is not phishing-resistant. Because of this, the Passwordless MFA setting really does not have any advantage over push notifications for MFA with number matching enabled.</p> <p>Now if we repeat this process, and instead use something like Microsoft Authenticator for passwordless (phone sign-in), we will go right into our application:</p> <p></p> <p>And what happens if our user does not have a FIDO2 security key, is not on a machine with Windows Hello for Business, and does not have Microsoft Authenticator passwordless (phone sign-in) enabled?</p> <p>If the authentication strength policy is applied to all resources, the user will get stuck in an endless loop of trying to enroll a stronger form of authentication:</p> <p></p> <p>Now this behavior, from a security standpoint, is not necessarily bad. However, from an end-user perspective it\u2019s something to watch out for.</p> <p>If you\u2019re using a Temporary Access Pass (TAP) and accessing https://aka.ms/mysecurityinfo to enroll in strong authentication, that does satisfy the policy.</p>"},{"location":"2022/10/05/azure-ad-new-controls-for-authentication-strength/#phishing-resistant-multifactor-authentication","title":"Phishing-resistant multifactor authentication","text":"<p>Finally, we\u2019ll turn the dial all the way up, to phishing-resistant MFA:</p> <p></p> <p>Using our FIDO2 security key, we are able to access our resources without issue:</p> <p></p> <p>And if we attempt to use our password:</p> <p></p> <p>We are prompted to use a security key:</p> <p></p> <p>Now if our user doesn\u2019t have a FIDO2 security key enrolled or is not accessing the resource from a device using Windows Hello for Business, they again will get stuck in an endless enrollment loop if the policy is applied to all resources.</p> <p>Note</p> <p>Windows Hello for Business, FIDO2 security keys, and certificate-based authentication are the only mechanisms considered phishing-resistant within Azure AD.</p>"},{"location":"2022/10/05/azure-ad-new-controls-for-authentication-strength/#some-odd-behavior","title":"Some odd behavior","text":"<p>In my testing, I happened upon that require authentication strength does not seem to play well with other grant controls. My test policy had been configured previously to Require one of the selected controls, effectively an OR situation, between Require multifactor authentication or Require device to be marked as compliant:</p> <p></p> <p>When testing, and switching to use this new setting, I found that the policy effectively turned into a device compliance required policy \u2013 before even being able to attempt MFA, I was presented with an error due to lack of device compliance:</p> <p></p> <p>I\u2019ve reached out to Microsoft about this behavior, but it just leaves a bit of a cautionary tale to ensure that you selectively test who you are applying these policy changes to. When I find out more information, I\u2019ll update this article. While this one specific case could be worked around by excluding compliant devices as a condition instead of a control, many organizations may still be using device compliance grant controls due to the feature having existed longer.</p>"},{"location":"2022/10/05/azure-ad-new-controls-for-authentication-strength/#final-thoughts-and-notes","title":"Final thoughts and notes","text":"<p>With this new setting for granular control of authentication strength, we can finally do things in our tenant such as (only a few initial thoughts):</p> <ul> <li>Require privileged users to have to use a phishing-resistant form of MFA</li> <li>In organizations such as higher-ed, restrict faculty and staff to stronger authentication while allowing students to continue to use weaker forms of MFA (as it required many times)</li> <li>Potentially have other avenues to restrict the ability to enroll other forms of MFA only from strong forms of MFA</li> </ul> <p>Because this is only limiting the options used during authentication, this will not prevent a privileged user from enrolling in a weaker form of MFA, such as SMS. They\u2019ll just never necessarily be permitted to leverage that.</p> <p>Also, as I\u2019ve found in testing, you\u2019ll want to test these new settings thoroughly, to ensure that you aren\u2019t creating scenarios for your end users where they can\u2019t enroll in stronger authentication, and subsequently get stuck in a proof-up loop. Applying this new grant control across all users, for all applications, is likely too broad of a policy for the majority of organizations, unless you are certain about your existing passwordless usage. There\u2019s nothing like a few hiccups with an authentication change in an organization to completely stall any progress.</p> <p>I still have more testing I want to do \u2013 exploring what this looks like with external users and cross-tenant access settings. And there is the ability to create custom authentication strengths as well, which is ripe with granularity for all sorts of custom authentication strength. In all the testing of the different permutations, and a few setbacks from unexpected behavior, this article took longer than initially thought to craft.</p> <p>End of the day, this is still a great step forward to ensuring that strong authentication is used when it matters within tenants. Can\u2019t wait to see Global Admins voluntarily applying these policies to themselves. Just don\u2019t forget to exclude those break-glass accounts.</p>"},{"location":"2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/","title":"Azure AD: The Arrival of Dynamic Administrative Units","text":"<p>Administrative units. The Azure AD sort-of equivalent of organizational units (OU\u2019s). For those less familiar, administrative units (AU\u2019s) allow for granular assignment of RBAC roles in Azure AD.</p> <p>Organizations initially struggled with the limited ability to delegate granular RBAC roles in Azure AD, with the directories flat structure; especially for all of us coming from an Active Directory background. When administrative units were introduced, they started to open up the door for organizations that needed to delegate access to a subset of users in an Azure AD tenant.</p> <p>The one catch with AU\u2019s that was a non-starter for many organizations \u2013 they weren\u2019t dynamic. And while OU\u2019s are not dynamic in Active Directory, it\u2019s a different take when the tenant is usually secondary to AD being authoritative. Move a user in AD, one would hope that the location in Azure AD would follow. While there are some PowerShell scripts out there that feel very akin to those used for AD shadow groups, overall maintenance of AU\u2019s could prove cumbersome in dynamic organizations.</p> <p>The struggle, however, is no more \u2013 administrative units now support dynamic user and device membership!</p>"},{"location":"2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#administrative-unite-use-cases","title":"Administrative Unite use cases","text":"<p>Before exploring dynamic membership, I just wanted to touch on some of the use cases that have already existed, and many that can greatly improve with dynamic membership. This is just a mere tip of the iceberg for use cases \u2013 if you see ones that I\u2019ve missed let me know, and I\u2019ll gladly add it.</p> <p>While they feel similar to OU\u2019s, the fact that AU\u2019s are virtual units of structure, they provide much greater flexibility than OU\u2019s. A user can belong to several AUs, and you don\u2019t have to worry about users being linked as child objects that are deleted if an AU is removed \u2013 everyone remembers that time that their AD backups were tested with an accidental OU deletion.</p>"},{"location":"2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#regional-it-delegation","title":"Regional IT delegation","text":"<p>Many global organizations that operate out of a single Azure AD tenant still have localized and regional support desks. With AU\u2019s, you can create multiple layers of support structure to provide for things like password reset and user object management, without needing to deal with the complications of trying to fit complex delegations of ACL\u2019s onto objects the same way we would have to with Active Directory.</p>"},{"location":"2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#state-and-local-government-agency-delegation","title":"State and local government agency delegation","text":"<p>Many organizations in the public sector operate out of the same Azure AD tenant to support a single O365 environment. However, many agencies still want to retain levels of autonomy over managing their user objects. Administrative units can provide for that granular level of RBAC control.</p>"},{"location":"2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#my-staff-management","title":"My Staff management","text":"<p>My Staff came out to primarily help assist with managers performing basic tasks for front line workers. The goal is to bring the power to non-IT employees the ability to do things like reset passwords or manage phone numbers for MFA. My Staff is driven by administrative units, with AU\u2019s that are built to replicate an organizational staffing structure. For more information on My Staff, take a look at the Microsoft documentation, Use My Staff to delegate user management \u2013 Azure AD | Microsoft Docs.</p> <p>It takes a bit of work in Azure AD Connect, because the manager attribute is a reference attribute in Active Directory, to synchronize the manager UPN as a custom attribute (even though manager is synchronized by Azure AD Connect, it is not exposed as a dynamic attribute option). But one could configure a system where managers have control over their employees objects, and with dynamic membership, their manager changes in AD can easily follow them in My Staff.</p>"},{"location":"2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#exploring-administrative-unit-dynamic-membership","title":"Exploring Administrative Unit dynamic membership","text":"<p>If you\u2019ve used dynamic membership for groups, the logic and expressions for dynamic administrative units is the same. I won\u2019t deep dive into all the rules available, but the options for evaluation are both flexible and immensely powerful. For more details on the rules, take a look at this Microsoft documentation, Rules for dynamically populated groups membership \u2013 Azure AD | Microsoft Docs.</p>"},{"location":"2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#licensing","title":"Licensing","text":"<p>As with dynamic group membership, current documentation indicates that any user who is a member of an AU that is dynamically populates requires an Azure AD P1 or P2 license assigned to them. This contrasts static membership, where only those managing the AU\u2019s require a P1 or P2 license; users can be members of the AU\u2019s with an Azure AD free license. Dynamic device membership does not require any special license for AU\u2019s. For more information, see the Microsoft documentation, Manage users or devices for an administrative unit with dynamic membership rules (Preview) \u2013 Azure Active Directory | Microsoft Docs.</p>"},{"location":"2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#configuring-administrative-unit-dynamic-membership","title":"Configuring Administrative Unit dynamic membership","text":"<p>While the expression set is the same as dynamic groups, currently you have to adjust the administrative unit to be dynamic post-creation. Also, as we go through this, I\u2019ll be referencing the current Microsoft documentation on dynamic membership for administrative units, which can be found here, Manage users or devices for an administrative unit with dynamic membership rules (Preview) \u2013 Azure Active Directory | Microsoft Docs.</p> <p>First we create a new administrative unit:</p> <p></p> <p>And after creation of the AU, we can go look at the Properties for it. Within here we will find Membership type, which we can drop down and select Dynamic User:</p> <p></p> <p>After setting the Membership type to Dynamic User, we will need to Add dynamic query before we can save the changes. The dynamic query is the secret sauce to what makes the dynamic AU, dynamic. Note that until we set this query, we cannot save these changes; the save is grayed out.</p> <p></p> <p>In our example here, we are going to use a rule for physicalDeliveryOfficeName equals Schenectady:</p> <p></p> <p>We save the rule, and now the Save button will be available on the administrative unit properties. Before saving, we will be presented with a warning:</p> <p>After changing the administrative unit type, the existing membership may change based on the dynamic membership rules you provide. Click Yes to continue.</p> <p></p> <p>The warning here will show up, regardless of whether it\u2019s a new, unpopulated AU, or if it\u2019s an existing AU with thousands of users within it.</p> <p>After a few minutes of churning, the AU will be populated:</p> <p></p>"},{"location":"2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#converting-an-administrative-unit-to-dynamic","title":"Converting an Administrative Unit to dynamic","text":"<p>During testing of conversion of an assigned AU to dynamic, I was curious to see how it operated. Does it wipe out all membership and start from scratch, or does Azure AD evaluate the users within the AU to determine who still belongs? Luckily, it appears to be the latter.</p> <p>Checking my Azure AD Audit logs, we can see users who no longer belong in a specific administrative unit being removed:</p> <p></p> <p>Note that if you are going the other direction, from dynamic membership to assigned, Azure AD will indicate that the existing users in the AU will be retained, but will not be dynamically processed anymore.</p>"},{"location":"2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#exploring-with-powershell","title":"Exploring with PowerShell","text":"<p>As with most things Azure AD, anything that can be done in the portal can be done with PowerShell (which really is just indirect Graph) and Graph.</p> <p>I\u2019ve been making a concerted effort to use the Microsoft Graph PowerShell SDK, Install the Microsoft Graph PowerShell SDK \u2013 Microsoft Graph | Microsoft Docs, over the Azure Active Directory PowerShell for Graph modules. Why? The PowerShell SDK supports PowerShell 7, is cross-platform, and provides access to all of Graph, not just Azure AD.</p> <p>That being said, I\u2019ve found the PowerShell SDK modules for dynamic administrative units to be, well, rather lacking. While there are indirect parameters to provide dynamic information, I haven\u2019t spent the cycles yet figuring things out. The docs/get-help provide almost no information on commands like New-MGAdministrativeUnit</p> <p></p> <p>The (lacking) documentation</p> <p>As such, for the purpose of getting this post published, I\u2019ll be using the Azure AD PowerShell modules.</p> <p>First, let\u2019s take a look at the administrative unit named ATZ:</p> <pre><code>Get-AzureADMSAdministrativeUnit -Filter \"DisplayName eq 'ATZ'\" | fl\n</code></pre> <p></p> <p>We can see that the membership type is dynamic, and also see the membership rule. In this case, we are using the in rule to allow for matching the country attribute against a defined list.</p> <p>And if we then enumerate the membership of the AU, we can see that the logic works:</p> <pre><code>Get-AzureADAdministrativeUnitMember -ObjectId a5175ada-f6f1-4c72-a986-65c65f662bde `\n| Get-AzureADUser | ft ObjectId,UserPrincipalName,Country\n</code></pre> <p></p> <p>We can also create an administrative unit rather easily with PowerShell, which has an advantage, at least currently over the portal, in that we can define the dynamic rules upon creation.</p> <pre><code>New-AzureADMSAdministrativeUnit -DisplayName \"US\" -Description \"US Employees\" `\n-MembershipType \"Dynamic\" -MembershipRuleProcessingState \"On\" -MembershipRule `\n'(user.country -eq \"United States\")'\n</code></pre> <p></p>"},{"location":"2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#faq","title":"FAQ","text":""},{"location":"2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#limitations","title":"Limitations","text":"<p>Microsoft does not publish a size limitation for administrative units, but the standard limitations for administrative units still exist with resources being members of no more than 30 administrative units, and an organization can have a maximum of 5,000 dynamic groups and dynamic administrative units combined. The latter bit is an interesting item to note, as it would seem the evaluation engine is then shared in a tenant between dynamic groups and administrative units (which makes sense really).</p> <p>I would also then speculate, while I cannot find it published yet, that administrative units may fall into the same rule evaluation service level, which is up to 24 hours, per this document, Fix problems with dynamic group memberships \u2013 Azure AD | Microsoft Docs.</p>"},{"location":"2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#how-can-i-test-preview-a-dynamic-membership-rule","title":"How can I test / preview a dynamic membership rule?","text":"<p>Currently, the dynamic membership rule settings in an administrative unit does not have a rule validation option available. However, we can simply create a test dynamic group in Azure AD for evaluating the rule, and can also use the Validate Rules option to get a more instant verification of whether our rule works.</p> <p></p> <p>An example of rule validation in dynamic groups</p>"},{"location":"2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#can-i-combine-different-object-types-in-a-dynamic-administrative-unit","title":"Can I combine different object types in a dynamic Administrative Unit?","text":"<p>Unfortunately this is one trade-off between statically assigned groups and dynamic ones. Whereas in static groups we can assign users, groups and devices to the same AU, for dynamic membership you are limited to the type of dynamic object assignment you are looking to use \u2013 either user or device. Also, groups are not an option for dynamic administrative unit rules, and can belong to neither dynamic user or dynamic device AU\u2019s.</p>"},{"location":"2022/03/29/azure-ad-the-arrival-of-dynamic-administrative-units/#final-notes","title":"Final notes","text":"<p>Dynamic groups are already such a powerful option for organizations, it\u2019s great to see that same logic added into administrative units, an area where it fits so well. If I had the time I would reach out to all those customers who had the \u201cthis is great, but it\u2019s too inflexible\u201d mindset upon seeing administrative units. I\u2019m curious to see what new doors this opens for organizations; if you have some interesting use cases, give me a shout.</p>"},{"location":"2022/06/16/azure-ad-which-sso-is-the-right-sso/","title":"Azure AD: Which SSO Is The Right SSO?","text":"<p>It\u2019s great having choices, except when you are not sure which choice to make.</p> <p>For organizations that are on a hybrid journey with Azure AD, the question of single sign-on (SSO) almost always comes up. And with that, people turn to the documentation with questions. Do we need hybrid join? Do we need Azure AD Seamless SSO? Do we need both? Can we configure both? Why isn\u2019t hybrid join listed as an SSO mechanism in the docs? If hybrid join is preferred, why does Azure AD Seamless SSO mention seamless, isn\u2019t it better?</p> <p>While there is one paragraph contrasting the two choices in the docs, Azure AD Connect: Seamless Single Sign-On \u2013 Microsoft Entra | Microsoft Docs, the question still comes up often. Which brings us here \u2013 gaining clarity on the SSO choices for Azure AD. To keep the article focused, we are going to be exploring SSO for corporate owned and managed Windows devices that are joined to an Active Directory domain.</p> <p>And for the camp out there that firmly believes everything should just go straight to Azure AD Join (AADJ), and forget hybrid\u2026 this article is for those that have their reasons to stay with hybrid join for the moment. Even though you should go cloud-native with AADJ.</p>"},{"location":"2022/06/16/azure-ad-which-sso-is-the-right-sso/#sso-mechanics","title":"SSO mechanics","text":"<p>Before getting into the compare and contrast, it\u2019s important to understand the fundamental reason as to why SSO works differently depending on the method implemented.</p>"},{"location":"2022/06/16/azure-ad-which-sso-is-the-right-sso/#azure-ad-hybrid-join","title":"Azure AD Hybrid Join","text":"<p>When you think of Azure AD Hybrid Join (HAADJ), it helps to think of the Windows device having a duality of identity for the signed-in user.</p> <p></p> <p>When a user signs in to Windows, not only does the user receive a Kerberos TGT from Active Directory, but also an Azure AD Primary Refresh Token (PRT).</p> <p>And this PRT piece is key \u2013 while the technology behind it is quite different, it\u2019s logically the Azure AD version of the TGT, which allows your device to speak modern authentication natively with Azure AD.</p> <p>For an extremely in-depth look at all the mechanics at play for authentication on a hybrid joined device, and how obtaining a PRT flows, see Primary Refresh Token (PRT) and Azure AD \u2013 Azure Active Directory \u2013 Microsoft Entra | Microsoft Docs.</p>"},{"location":"2022/06/16/azure-ad-which-sso-is-the-right-sso/#azure-ad-seamless-sso","title":"Azure AD Seamless SSO","text":"<p>Unlike Hybrid Join, Azure AD Seamless SSO flips things around, and essentially provides the ability for Azure AD to participate in Active Directory, not from an authentication provider perspective, but as a member computer object.</p> <p></p> <p>Courtesy Microsoft Learn</p> <p>From the diagram, we see that Azure AD has a computer account representation in Active Directory, with the computer object AZUREADSSO being the representation in AD. Azure AD holds the Kerberos decryption key for this computer object, which is what allows Azure AD to handle the TGT being passed to it.</p> <p>The most critical piece within this model for SSO, is that line-of-sight of Active Directory is required for SSO to function.</p>"},{"location":"2022/06/16/azure-ad-which-sso-is-the-right-sso/#sso-breakdown","title":"SSO Breakdown","text":"Component Azure AD Hybrid Join Azure AD Seamless SSO Configured with Azure AD Connect \u2705 \u2705 Requires AD line-of-sight for configuration \u2705 \u2705 No group policy needed for core config \u2705 \u274c No computer object sync to Azure AD \u274c \u2705 No browser plugin needed for Edge \u2705 \u2705 No browser plugin needed for Chrome \u274c \u2705 No browser plugin needed for Firefox \u2705 \u2705 Deployment is non-disruptive to users \u2705 \u2705 Supports Windows 8.1 \u26a0\ufe0f \u2705 Supports Windows 10 \u2705 \u2705 Supports Windows 11 \u2705 \u2705 Uses Active Directory for Authentication \u274c \u2705 Uses Azure AD for Authentication \u2705 \u274c Works without AD line-of-sight \u2705 \u274c No Kerberos decryption key to rollover \u2705 \u274c Is completely Seamless SSO \u2705 \u26a0\ufe0f"},{"location":"2022/06/16/azure-ad-which-sso-is-the-right-sso/#configuration","title":"Configuration","text":"<p>Whether it\u2019s Hybrid Azure AD Join, or Azure AD Seamless SSO, both are first enabled primarily using Azure AD Connect.</p> <p>For details on enablement of Hybrid Azure AD Join, see Configure hybrid Azure Active Directory join \u2013 Microsoft Entra | Microsoft Docs.</p> <p>For details on enablement of Azure AD Seamless SSO, see Azure AD Connect: Seamless Single Sign-On \u2013 quickstart \u2013 Microsoft Entra | Microsoft Docs.</p>"},{"location":"2022/06/16/azure-ad-which-sso-is-the-right-sso/#active-directory-line-of-sight-for-client-enablement","title":"Active Directory line-of-sight for client enablement","text":"<p>When deploying Azure AD Hybrid Join, it is required that computers have line-of-sight of Active Directory in a PHS or PTA scenario (and usually for ease in a federated scenario). The reason is that Azure AD Connect is the means for Windows to bootstrap its trust relationship with Azure AD \u2013 when you enable hybrid join, you\u2019ll note that the computer object in scope has the userCertificate attribute in Active Directory populated. This is the public half of a key-pair generated by the Windows device, which makes it way up to Azure AD, via Azure AD Connect, and is tied to the created device object in Azure AD. When you see a device with a Registered date/time of Pending, it means the device has been created in Azure AD, but the Windows client itself hasn\u2019t finished the hybrid join process. Now that we have the means for a trust relationship to be established, the Windows client uses this key-pair to connect to Azure Active Directory Device Registration Service (AAD DRS); the key-pair used is replaced with a permanent key-pair, and hybrid join is complete. Afterward, line-of-sight of Active Directory is not required for authentication to Azure AD, even though you still will want to keep your hybrid joined devices in scope for Azure AD Connect, so that device disable and device delete actions will flow up to Azure AD.</p> <p>For Azure AD Seamless SSO, you\u2019ll always need AD line-of-sight for this to function, and many orgs tend to use group policy to roll out the configuration, which also would need that same line-of-sight.</p>"},{"location":"2022/06/16/azure-ad-which-sso-is-the-right-sso/#group-policy-for-client-configuration","title":"Group policy for client configuration","text":"<p>For rollout of Azure AD Hybrid Join across an organization, there is no need to configure anything additional through group policy. This is because, by default, configuration of HAADJ leverages a Service Connection Point (SCP) in Active Directory. Because the SCP is stored in the Configuration partition in AD, this is the reason configuration of Hybrid Join requires Enterprise Administrator. And while your Azure AD Connect server should be treated as Tier 0, if you have concern using an Enterprise Admin account on the Azure AD Connect server, a script can be downloaded to configure and run this from another system. The exception to no group policy is for organizations which are performing a targeted rollout of HAADJ, even though you can also control rollout by excluding devices from synchronization in Azure AD Connect.</p> <p>For Azure AD Seamless SSO, there are group policy settings that are inevitably needed regardless of the rollout plan. By default, browsers will not send Kerberos tickets to an internet endpoint, so configuration on the client is required to set an Azure AD URL to Intranet zone. And yes, you may be able to use alternatives such as Intune to push these settings to clients, but it still comes down to needing to push a configuration change to clients.</p>"},{"location":"2022/06/16/azure-ad-which-sso-is-the-right-sso/#azure-ad-computer-object-sync","title":"Azure AD computer object sync","text":"<p>Now, some may consider this an advantage, not having to synchronize their computer objects to Azure AD for Azure AD Seamless SSO.</p> <p>Many organizations, however, going down the modern device management route, or wanting to strengthen their security posture in conditional access with policies based on compliance or hybrid join, will need to sync their computer objects, as part of the requirement for hybrid join (excluding organizations with AD FS in place). And if you\u2019re looking to go passwordless with Windows Hello for Business on these devices, hybrid join is also a prerequisite.</p> <p>And considering what a non-event it is to enable hybrid join, it\u2019s hard to argue against it.</p>"},{"location":"2022/06/16/azure-ad-which-sso-is-the-right-sso/#browser-support","title":"Browser Support","text":""},{"location":"2022/06/16/azure-ad-which-sso-is-the-right-sso/#edge","title":"Edge","text":"<p>Neither method of SSO requires anything additional in Edge.</p>"},{"location":"2022/06/16/azure-ad-which-sso-is-the-right-sso/#chrome","title":"Chrome","text":"<p>For Chrome to be able to take advantage of the PRT with hybrid join (or Azure AD Join), and subsequently perform SSO using the PRT, you\u2019ll want to install the Windows Accounts extension in Chrome, Windows Accounts \u2013 Chrome Web Store (google.com).</p> <p>Azure AD Seamless SSO does not require this browser extension, as Chrome has long supported integrated authentication.</p>"},{"location":"2022/06/16/azure-ad-which-sso-is-the-right-sso/#firefox","title":"Firefox","text":"<p>Mozilla, likely in a move to keep Firefox competitive, released an update starting with version 91 to support PRT authentication natively within the browser, Windows SSO | Firefox Help (mozilla.org).</p> <p>Like Chrome, Firefox has long had support for integrated authentication, so it\u2019s able to handle Azure AD Seamless SSO without a plugin.</p>"},{"location":"2022/06/16/azure-ad-which-sso-is-the-right-sso/#os-support","title":"OS Support","text":""},{"location":"2022/06/16/azure-ad-which-sso-is-the-right-sso/#windows-1011","title":"Windows 10/11","text":"<p>As noted in the article highlighted earlier, Azure AD Connect: Seamless Single Sign-On \u2013 Microsoft Entra | Microsoft Docs, recommendation for these modern versions of Windows is to use hybrid join and subsequently a PRT for SSO.</p>"},{"location":"2022/06/16/azure-ad-which-sso-is-the-right-sso/#windows-81","title":"Windows 8.1","text":"<p>If, for some unfortunate reason, you still have Windows 8.1 (or no longer supported Windows 7 or 8) in your environment, and still want all the snazziness of letting decrepit operating systems enjoy the cloud, Azure AD Seamless SSO is going to be the easier bet. Hybrid Join for downlevel devices requires installation of the Workplace Join agent and some additional configuration to support hybrid join.</p>"},{"location":"2022/06/16/azure-ad-which-sso-is-the-right-sso/#end-user-experience","title":"End-user experience","text":"<p>From the end user experience, hybrid join is going to give our users what is Azure AD native SSO. The user signs in to Windows, and they receive or refresh their Azure AD PRT, and off they go. When browsing, the user won\u2019t be prompted to enter their username or password, and will just be right into their applications.</p> <p>Azure AD Seamless SSO, on the other hand, has a few specifics about what SSO looks like. When a user goes to access an application the first time, they will be prompted to enter their username, but shouldn\u2019t be asked for their password. There are ways to work around this with altering the URL to contain a login hint, but it generally would not be intuitive for a user. Also, if a user chooses to sign out from an application tied to Azure AD, upon sign-in, they are required to enter their password \u2013 this is considered by design. But even if we look past these, when our user is away from the corporate network, they will be asked to enter their password. And asking our users to have to enter their password when we can provide the means not to, isn\u2019t the best for our user experience, and isn\u2019t the best for security.</p>"},{"location":"2022/06/16/azure-ad-which-sso-is-the-right-sso/#maintenance","title":"Maintenance","text":"<p>For hybrid join, there is potential maintenance in needing to restructure how OU\u2019s are synchronized with Azure AD Connect, though generally many organizations find ways to make this a bit of a one and done scenario.</p> <p>For Azure AD Seamless SSO, it is recommended that organizations rollover the Kerberos decryption key stored in Azure AD for the AZUREADSSO computer object every 30 days. This has to be performed manually, or automated through a process that though subsequently requires providing some task Domain Administrator credentials. Less than ideal, but because Azure AD isn\u2019t able to directly perform this process against AD, we are left with no other choice.</p>"},{"location":"2022/06/16/azure-ad-which-sso-is-the-right-sso/#so-which-sso-is-the-right-sso","title":"So which SSO is the right SSO?","text":"<p>If your organization is primarily Windows 10/11 devices that are AD domain joined, Azure AD Hybrid Join is the route to go. To be clear, you do not need to deploy Azure AD Seamless SSO along with hybrid join; your clients will not use Azure AD Seamless SSO if the device has a PRT.</p> <p>If you have to support downlevel installs of Windows 8.1, Seamless SSO may be an easier route than hybrid join, and you can enable seamless SSO and just target those devices for configuration.</p> <p>Likewise, if you are supporting MacOS in your environment, enabling Azure AD Seamless SSO can provide a better authentication experience if those Macs are Active Directory domain joined. Even though at this point you may want to look at the Enterprise SSO plugin for MacOS, Microsoft Enterprise SSO plug-in in Microsoft Intune | Microsoft Docs.</p> <p>There\u2019s no harm in having both methods configured, but if the mechanism for Seamless SSO isn\u2019t actually being leveraged in your environment, and if you have hybrid joined Windows 10/11 devices it\u2019s not, it\u2019s just an extra bit of configuration to manage and maintain with no benefit.</p>"},{"location":"2022/06/16/azure-ad-which-sso-is-the-right-sso/#what-about-federated-identity","title":"What about federated identity?","text":"<p>If an organization has AD FS or a supported 3rd party IdP in the mix, such as PingFederate or Okta, the proper route to go, from an Azure AD perspective, is still hybrid join.</p> <p>Hybrid join is still going to provide you SSO with your PRT for applications leveraging Azure AD as their identity provider \u2013 when you authenticate interactively with the Windows client at sign-on, WS-Trust is the means to authenticate you to your federated identity provider behind the scenes, and in return allowing Azure AD to give you a fresh PRT.</p> <p>The MS Docs articles indicate that Seamless SSO is not supported with federated identity, and I\u2019ve never tried to see what happens if you force it via PowerShell module \u2013 but would presume you run into conflicts with overlap in how Azure AD handles hints for bypassing username entry for Seamless SSO and how Azure AD handles hints for bypassing username entry for federated auth.</p>"},{"location":"2022/06/16/azure-ad-which-sso-is-the-right-sso/#what-about-azure-ad-join","title":"What about Azure AD join?","text":"<p>Azure AD Join (AADJ) should be the long-term goal for organizations, going cloud native and removing their clients dependency on Active Directory. Under the hood, the mechanics of authentication for AADJ are just the bits that give you that Azure AD PRT, and Azure AD is now the authoritative identity provider for those clients. For many organizations, it tends to be client management and group policies that lend the most complexity in going cloud native, even though it is the future, so now is as good as ever to start a pilot down that road while you continue to support existing clients with Hybrid Azure AD Join.</p>"},{"location":"2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/","title":"Azure AD: You Should Disable This Legacy MFA Setting","text":"<p>When talking with organizations about securing their Azure AD tenants, there is always a focus on the latest and greatest, and all the ways it brings everyone forward on the Zero Trust journey. Advancements in Conditional Access, Windows Hello for Business, FIDO2 \u2013 the focus is on what\u2019s new and where to go. Occasionally there is the reminder to block legacy authentication (speaking of \u2013 have you?), but the focus tends to be on what\u2019s new, and not reviewing what\u2019s old.</p> <p>There is one setting, however, that tends to lurk deep within Azure AD tenants, especially for organizations that have had their tenant for a long while, that goes unnoticed, and when left enabled, allows users to potentially interfere with what we believe to be their authentication pattern.</p>"},{"location":"2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#whats-the-setting","title":"What's the setting?","text":"<p>If we dig into the legacy multi-factor authentication service settings portal, which can be found by browsing to Azure AD -&gt; Security -&gt; MFA, and then on the right, under Configure, select Additional cloud-based MFA settings. It will bring you to the following:</p> <p></p> <p>The setting we are focused on is at the bottom. Under remember multi-factor authentication on trusted device, Allow users to remember multi-factor authentication on devices they trust.</p>"},{"location":"2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#whats-the-problem","title":"What's the problem?","text":"<p>The name of the setting doesn\u2019t really explain it well. The Microsoft Docs article that explains the details of this setting can be found here, Configure Azure AD Multi-Factor Authentication \u2013 Azure Active Directory | Microsoft Docs.</p> <p>Even though there is an additional note provided, a lot of organizations don\u2019t even recall this setting exists \u2013 either they have never had to come to this set of options to begin with, or it was enabled several years ago and never reviewed again. Unfortunately, this setting is not well exposed in Azure AD.</p> <p>When enabled in an Azure AD tenant, it allows end-users to make the decision on what a \u201ctrusted device\u201d is. The heading for the setting, when glanced over, may make you believe it relates to trusted devices, as in compliant devices. But as we see within the details, the user is making that trust decision.</p> <p>And the issue with that trust decision, is that it allows the user to choose to drop an MFA persistence cookie, completely separate from the refresh token, in the browser.</p> <p>So even if our user chooses to sign-out, and even if they choose in the browser the option to forget their username from the sign-in menu, this cookie persists.</p> <p>The user experience, with this setting enabled, will show the following during sign-in:</p> <p></p> <p>When enabled, the Don\u2019t ask again for 90 days (or whatever interval is set in your organization) shows up and is checked by default.</p> <p>On subsequent user sign-in, the user will not be prompted for MFA, unless the time specified in the setting has lapsed, or the browser cookies have been cleared.</p> <p>You will see the following in the Sign-in details:</p> <p></p> <p>This setting is not the same as the Keep Me Signed In (KMSI) settings in Azure AD, which allow the user to retain their refresh token in their browser when they close it. The KMSI experience invalidates the token during user sign-out, and upon sign-in provides the expected behavior of calling for both primary authentication and MFA (if there is an MFA requirement).</p>"},{"location":"2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#why-exactly-is-this-a-problem","title":"Why exactly is this a problem","text":"<p>While it may be alluded to above, this setting weakens the security posture regarding MFA. It allows users to subvert when we may be requiring Conditional Access to call for MFA. Now we are not saying our user is doing anything malicious \u2013 this is a setting we enable and it\u2019s logical that a user would select this. Users will pick whatever options make getting the job done with the least amount of friction.</p> <p>If the device is or becomes compromised, the user account will become an easier target to malicious actors. Just think of any device you have the least amount of trust in, which usually is some sort of shared device outside the corporate boundaries, and then allow the user to make the trust decision. It\u2019s not a great recipe.</p>"},{"location":"2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#determining-the-usage","title":"Determining the usage","text":"<p>If you\u2019ve looked at your settings, and you see that this setting is disabled, then you can just stop here.</p> <p>If you\u2019ve found that this setting is enabled, you want to understand how widespread the usage is before disabling it. The fewer users leveraging it, the swifter the change process.</p> <p>We want to explore our Azure AD Sign-in logs, however, we cannot filter granularly within the portal.</p> <p>Using Log Analytics, the following query will help show who, where they are coming from, and the device information. The query is written to highlight distinct devices:</p> <pre><code>SigninLogs\n| where TimeGenerated &gt; ago(30d) //Set time period to within the last 30 days\n| where Status.additionalDetails == \"MFA requirement skipped due to remembered device\" //String to search for\n| project UserPrincipalName,IPAddress,OS = tostring(DeviceDetail.operatingSystem),Browser = tostring(DeviceDetail.browser),City = tostring(LocationDetails.city),State = tostring(LocationDetails.state),Country = tostring(LocationDetails.countryOrRegion) //Pull JSON data into strings\n| distinct UserPrincipalName,IPAddress,OS,Browser,City,State,Country //Filter for distinct instances\n</code></pre> <p>If you do not have access to Log Analytics, you can export your Azure AD Sign-in logs in either CSV or JSON format and parse the data out accordingly, the string you will want to search for is MFA requirement skipped due to remembered device.</p>"},{"location":"2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#remediation","title":"Remediation","text":"<p>I\u2019ll preface that I\u2019ve had dozens of organizations disable this setting with little notice to end-users, and with little disruption to their lives. Many of those organizations did not even search their logs prior to disabling it.</p> <p>This only impacts browser sessions. Client applications will never present this prompt, regardless of whether the client application is on a mobile device or Windows.</p> <p>If we are using Windows Hello for Business, FIDO2 security keys, or Authenticator App for Primary Auth, all those mechanisms provide for strong-authentication within them, and are not impacted by this setting.</p> <p>For Azure AD Joined (AADJ) or Hybrid Azure AD Joined (HAADJ) devices, even if our users are using passwords and are requested to perform MFA, their PRT will obtain an MFA claim within it during the first run, and users will not be frequently prompted for MFA subsequently.</p> <p>That\u2019s a long way of saying the impact is usually limited to web browsers on personal devices that have no relationship to the Azure AD tenant. The devices we trust the least.</p> <p>Once comfortable turning off this setting, it\u2019s simply a matter of unchecking the box in the MFA service settings portal we examined above.</p>"},{"location":"2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#if-you-want-to-limit-mfa-lifetime","title":"If you want to limit MFA lifetime","text":"<p>I\u2019ve encountered some organizations who have this setting enabled, and the number dialed way down. When talking about corporate devices or devices we have insight into, through either MDM, MAM, hybrid trust, or such, it\u2019s not recommended to limit MFA lifetime. We already have a level of trust established and prompting users frequently for MFA will not only create friction in the user experience, as well as sets our users up to be both more susceptible to MFA phishing (you get trained to just perform MFA without thought) and devise ways around security.</p> <p>If you have business scenarios that call for the desire to prompt more frequently for MFA, Conditional access offers Sign-in frequency session controls as well as Persistent browser session controls, which can be targeted to non-corporate managed devices. Authentication context also allows for scenarios where we want to call for strong authentication scenarios when users are accessing sensitive information. These settings offer a higher level of precision to target certain scenarios while not negatively impacting the broader user experience.</p>"},{"location":"2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#final-notes","title":"Final notes","text":"<p>This setting really has been a carry-over from when we didn\u2019t have the power available from Conditional Access, and unfortunately, it\u2019s well hidden in that dusty MFA settings portal almost nobody ever treks into. Lucky for us, it\u2019s a quick win in the name of security to disable.</p>"},{"location":"2023/01/16/cloud-identity-is-still-the-future/","title":"Cloud Identity Is Still The Future","text":"<p>In October 2022, the CTO of 37signals, David Heinemeier Hansson, published a piece on why hey.com was leaving the cloud. You can read the full article here, Why we\u2019re leaving the cloud (hey.com); the gist of the post is that cloud is not cost-effective. More recently, InfoWorld published a piece by David Linthicum, 2023 could be the year of public cloud repatriation | InfoWorld, hitting on why it may be more cost-effective to move back to private data centers. You see the trend \u2013 cloud may not be providing the ROI that is expected, especially if your organization has just performed a bunch of lift-and-shift without application refactoring.</p> <p>While the titles are attention grabbing, and the articles have valid points, they don\u2019t really tell the full story. Folks in the industry may scan the headlines and believe that a mass cloud exodus is on the verge of happening, but we really need to look at what part of the cloud we are speaking to. We need to distinguish between IaaS, PaaS and SaaS, as well as related services and systems, such as IDaaS (identity as a service, aka Azure AD, Okta, and so on).</p>"},{"location":"2023/01/16/cloud-identity-is-still-the-future/#saas-is-king-for-business-productivity","title":"SaaS is king for business productivity","text":"<p>37signals is a SaaS application company \u2013 with basecamp.com, a project management platform, and hey.com, a cloud email service. Neither product offers a private hosted version, so while 37signals is leaving the cloud, the services they offer you, well, are still cloud services. Sure, they may not be hosted in AWS or GCP, but the organizations that consume these platforms will be accessing and using them as cloud services.</p> <p>These days, nobody wants to manage a SharePoint farm, and certainly not Exchange Server. But it\u2019s not just office suites such as Office 365 and Google Workspace (and hey.com). In recent years we have seen an explosion of growth with SaaS applications and platforms, and this is something that is continuing to trend upward.</p>"},{"location":"2023/01/16/cloud-identity-is-still-the-future/#vpn-is-an-antiquated-means-of-access","title":"VPN is an antiquated means of access","text":"<p>Whether it\u2019s IaaS or PaaS, hosted in private data centers or in some form of cloud, needing to access applications from everywhere and anywhere is as important as ever. With COVID-19 and the remote workforce, it strained organizations trying to find ways to allow access to applications for the workforce. While VPN may have been the path of least resistance to allowing remote access, it\u2019s certainly not well aligned to Zero Trust. Cloud platforms provide means for modern access, and modern authentication, to applications, regardless of where they exist. Products such as Azure AD Application Proxy can be that conduit, are easy to deploy, and can be used to supplant VPN access. Sure, there may be the edge cases where VPN still provides the necessary means of access, but organizations should realize that success is much easier when we are not picking one-size-fits-all solutions.</p>"},{"location":"2023/01/16/cloud-identity-is-still-the-future/#cloud-native-devices-ease-administrative-burden","title":"Cloud-native devices ease administrative burden","text":"<p>Closely tied to VPN access was the struggle of organizations trying to manage Windows devices that were Active Directory joined, or Hybrid Azure AD Joined. Concerns included patch management, group policy changes, and expired user passwords. The question of machine account password age and the relationship it has with Active Directory became a huge point and topic of confusion.</p> <p>Microsoft has used the past few years to really push Azure AD Joined devices, making device identity cloud-native. Yes, we still have the issue of remote troubleshooting, which is regardless of how they device identity exists. Yes, we still need to use something like Intune to manage the devices, and the road has been bumpy in replacing group policy. And yes the ROI is not worth it for most organizations to redeploy Windows on existing Hybrid Azure AD Joined devices until those devices are due for a hardware refresh. But we should continue to build the path towards the cloud, away from Active Directory, for client devices.</p> <p>For those in the Microsoft ecosystem with Active Directory and Azure AD, cloud-native devices can still access on-prem resources tied to Active Directory, either when on a corporate network or coming across the VPN (unfortunately).</p>"},{"location":"2023/01/16/cloud-identity-is-still-the-future/#cloud-applications-need-cloud-identity","title":"Cloud applications need cloud identity","text":"<p>The benefits should be clear for cloud identity systems. While there have been a few major outages in the past three or so years with Azure AD, the level of complexity required to maintain a 99.99% SLA for a publicly connected directory services system just cannot compare.</p> <p>If we look at what it takes to manage an AD FS farm with a high level of redundancy \u2013 at least three sites with Active Directory replicated across, at least one AD FS server (but likely two) in each respective location. If more than one AD FS farm server is in each location, you need location-specific load balancing. For the public edge, you need at least three disparate DMZ networks, with a minimum of one WAP server (but likely two), and then to route the traffic between locations a global traffic management solution, which usually looks like a DNS-based load balancing solution, such as Azure Traffic Manager.</p> <p></p> <p>A highly redundant AD FS farm reference architecture</p> <p>Organizations still need to harden and secure this environment, patch it monthly with orchestrated patch management to ensure availability, and monitor from a security and availability perspective. At the end of it all, this still pales in comparison to Azure AD. AD FS access control policies come nowhere near conditional access. Management and writing of claims policies are still harder for the average person to understand, and Solorigate has shown us what happens when AD FS is compromised.</p> <p>A pretty surmised way of looking at it \u2013 cloud-native directory services are designed with identity security practitioners in mind. On-prem directory services are designed with infrastructure practitioners in mind. AD FS is still an \u201cinfrastructure\u201d identity system.</p> <p>While one can argue some pros of owning your own systems, that argument falls flat when you look at the realization that any of the major identity providers platform developers are investing in cloud-native identity first.</p>"},{"location":"2023/01/16/cloud-identity-is-still-the-future/#what-about-those-on-prem-servers","title":"What about those on-prem servers","text":"<p>For as long as Windows server remains in your organization, it\u2019s likely that Active Directory is not going anywhere. While we have had huge advancements with Windows clients and the cloud, server is another story. Sure, we have things like Azure Arc and Desired State Config (DSC), but many argue that DSC is too complex and not a replacement for group policy. It still makes sense to keep identity close to the servers, so even if you could Azure AD Join a Windows server, the majority of use cases would not be well-served.</p> <p>Until applications are refactored, the Windows servers they run on aren\u2019t going anywhere. And the associated service accounts that run these services will likely still need to exist in Active Directory.</p> <p>But what we may continue to see is a wide array of patterns emerge. Organizations that primarily need Active Directory for compute workloads may drive end-user identity into the cloud, and AD remains as the glue for server administration only. Others that are further behind on their application modernization journey may need to persist user identities in AD.</p>"},{"location":"2023/01/16/cloud-identity-is-still-the-future/#the-way-forward","title":"The way forward","text":"<p>One of the most important investments organizations can make with cloud identity is not just selecting the platform, but skilling the people. From experiences in performing security assessments of Azure AD, a lack of strong skilling leads to the majority of insecure and inefficient implementations of various components of cloud identity.</p> <p>We also need to continue to push to transform identity from an infrastructure system to a security system. And this is much more than just transferring ownership and landing a complex identity system in the laps of folks completely unfamiliar with it all. Organizations will need to take a look at what it will take to properly staff identity under the security ecosystem within. This is its own ball of yarn, which I\u2019ll save for another time.</p> <p>One thing is for sure \u2013 cloud identity is here to stay.</p>"},{"location":"2023/02/06/dont-let-dns-be-your-azure-ad-recovery-downfall/","title":"Don't Let DNS Be Your Azure AD Recovery Downfall","text":"<p>In September of 2022, Joey Verlinden (@jvldn1) published an excellent article on his experience with recovering access to an Azure AD tenant that he was completely locked out of. You can, and should, read the full article here, What happens if you lock-out your Azure Tenant? \u2013 Joey Verlinden.</p> <p>In this, Joey details the process for recovering access to an Azure AD tenant, which includes a detailed verification process, which is rightfully put in place to ensure that someone isn\u2019t capable of a tenant takeover through social engineer. As part of the process, the request is verified by means of either:</p> <ul> <li>Calling the phone number associated with a Tenant</li> <li>Emailing a Global Administrator</li> <li>Requesting that the organization creates a DNS TXT record associated with one of the verified domains</li> </ul> <p>Now, under normal \u201coops\u201d scenarios, you likely could use a phone call or email to a Global Administrator. Of course, if a GA is mail-enabled, the email should be forwarded, as your Global Admins should not actually be receiving or checking email directly in that inbox (which is a different story).</p> <p>But say my tenant has come under some sort of cyberattack. Or more mundane You can\u2019t guarantee that a phone call or email will still go to where you expect. And while these changes should be audited, when you\u2019re in a state of needing to authenticate yourself from a support perspective, it\u2019s likely you\u2019ll still have to try and complete one of these steps, if you don\u2019t want further delay.</p> <p>This leaves us with DNS. But what if that DNS is hosted in a subscription associated with the same Azure AD tenant? Things could potentially not turn out so well.</p> <p>Even if you have DNS management delegated out to accounts that are not a GA (which in a large-scale enterprise, GA should not own resources in subscriptions)\u2026 can you guarantee that their access would not be tampered with if a threat actor is involved?</p> <p>From a resilience perspective, it seems like it\u2019s one of the times to not host DNS in Azure, or at least not in a subscription that is tied to the same tenant that uses those domains for services.</p> <p>You may already have a DNS architecture with secondary zones hosted outside of Azure, but those read-only copies won\u2019t save you when you need to edit a zone.</p> <p>And if you host DNS with something like Amazon Route 53\u2026 do you federate authentication for your account owners and resources back to Azure AD? If your Azure tenant is breached, it\u2019s certain a threat actor will try to follow your multi-cloud sprawl.</p>"},{"location":"2023/02/06/dont-let-dns-be-your-azure-ad-recovery-downfall/#so-whats-the-resilient-path","title":"So what's the resilient path?","text":"<p>Your mind may go to contacting your domain name registrar, and updating your NS records. But, you now are adding another external dependency.</p> <p>This past summer I was trying to update NS records for a domain with Directnic, and ticket response time was 12-24 hours, let alone actually having the records updated. Why did I open a ticket? Updates in the portal were not reflecting days after the change.</p> <p>While it may seem suboptimal, the most resilient path would be hosting DNS either in another small subscription and tenant that has no association to your primary production tenant, or using another large-scale cloud provider for DNS, but not associating authentication back to Azure AD.</p> <p>Considering the reality that most organizations struggle to keep as many nines as cloud providers (even with their occasional outages), this wouldn\u2019t be time for a knee-jerk reaction to bring DNS back to an on-premise data center, unless your organization is still robust enough to handle those high SLA\u2019s.</p>"},{"location":"2023/08/29/dude-wheres-my-audit-logs/","title":"Dude, Where's My Audit Logs?","text":"<p>Audit logs can provide all sorts of wonderful points of data. In the interest of identity security, we have historically seen that we can glean rich sets of information around what\u2019s happening in a directory service with some properly functioning audit logging. For many identity practitioners, there is the expectation that while we may not always look at the audit logs or their details, if or when we need them, they\u2019ll be there to help us understand whatever it is we are investigating. Same goes for compliance and auditing as well.</p> <p>Considering that customers have no ability to impact what or how auditing happens in Entra ID, in the shared responsibility model, it\u2019s on Microsoft to ensure all events are audited.</p> <p></p> <p>Shared responsibility model, courtesy Microsoft, with identity and directory infrastructure highlighted.</p> <p>Microsoft documents what is audited in Entra ID, which you can find here, Azure Active Directory (Azure AD) audit activity reference \u2013 Microsoft Entra | Microsoft Learn.</p>"},{"location":"2023/08/29/dude-wheres-my-audit-logs/#the-problem","title":"The problem","text":"<p>I\u2019ve recently been down the rabbit hole part time picking apart Entra ID audit logs, and in my analysis of the audit log data for Entra ID, some audit logs slot into one of two buckets:</p> <ul> <li>Data is missing</li> <li>Data is inconsistent/poor quality</li> </ul> <p></p> <p>Or perhaps in our case, what has been unseen cannot be seen.</p> <p>To be fair, a broad set of changes are audited in Entra ID, but at the same time I found it rather surprising that most SSPR configuration changes are not properly audited, which, if you look at the document above, Microsoft does not seem to argue. Considering recent events that surface what is logged in Entra ID and the M365 ecosystem, in this persons opinion Microsoft should be continually striving to audit 100% of all configuration changes in Entra ID.</p>"},{"location":"2023/08/29/dude-wheres-my-audit-logs/#missing-log-data","title":"Missing log data","text":"<p>These are instances where Entra ID log data is incomplete, usually in that the modified properties data is null.</p>"},{"location":"2023/08/29/dude-wheres-my-audit-logs/#self-service-group-management","title":"Self-service group management","text":"<p>Neither of these settings are exposed via the Graph API, so the reference point for their control is under Entra ID -&gt; Groups -&gt; Group settings</p> <p></p>"},{"location":"2023/08/29/dude-wheres-my-audit-logs/#the-audit-data","title":"The audit data","text":"<p>Note an absence of the actual change data, as highlighted in the audit event:</p> <pre><code>{\n        \"activityDateTime\": \"2023-08-07T20:04:39.1390262+00:00\",\n        \"activityDisplayName\": \"Update authorization policy\",\n        \"additionalDetails\": [\n            {\n                \"key\": \"User-Agent\",\n                \"value\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/116.0\"\n            }\n        ],\n        \"category\": \"AuthorizationPolicy\",\n        \"correlationId\": \"1349713e-116b-4246-9c64-60b394884488\",\n        \"id\": \"Directory_1349713e-116b-4246-9c64-60b394884488_NANEA_29121908\",\n        \"initiatedBy\": {\n            \"user\": {\n                \"displayName\": null,\n                \"homeTenantId\": null,\n                \"homeTenantName\": null,\n                \"id\": \"d7148226-7444-4884-aef7-b5fe693a6798\",\n                \"ipAddress\": \"X.X.X.X\",\n                \"userPrincipalName\": \"ga-x@x.onmicrosoft.com\"\n            }\n        },\n        \"loggedByService\": \"Core Directory\",\n        \"result\": \"success\",\n        \"resultReason\": \"\",\n        \"targetResources\": [\n            {\n                \"displayName\": \"Authorization Policy\",\n                \"groupType\": null,\n                \"id\": \"4bb7b039-71e4-474e-a7fc-5fe0bbf86fcc\",\n                \"modifiedProperties\": [\n                    {\n                        \"displayName\": \"Included Updated Properties\",\n                        \"newValue\": \"\\\"\\\"\",\n                        \"oldValue\": null\n                    }\n                ],\n                \"type\": \"Other\",\n                \"userPrincipalName\": null\n            }\n        ],\n        \"userAgent\": null\n    },\n</code></pre>"},{"location":"2023/08/29/dude-wheres-my-audit-logs/#group-lifecycle-policy-changes","title":"Group lifecycle policy changes","text":"<p>More commonly known as the group expiration settings, the controls for these in the portal can be found under Groups -&gt; Group settings -&gt; Expiration.</p> <p></p> <p>These are also exposed through Graph, https://graph.microsoft.com/beta/groupLifecyclePolicies/.</p>"},{"location":"2023/08/29/dude-wheres-my-audit-logs/#the-audit-data_1","title":"The audit data","text":"<p>Note the absence of any change data, as highlighted in the audit event:</p> <pre><code>    {\n        \"activityDateTime\": \"2023-08-07T20:09:38.6970558+00:00\",\n        \"activityDisplayName\": \"Update lifecycle management policy\",\n        \"additionalDetails\": [\n        ],\n        \"category\": \"GroupManagement\",\n        \"correlationId\": \"8883b045-774b-4107-b85a-04df5252b5ad\",\n        \"id\": \"SSGM_8883b045-774b-4107-b85a-04df5252b5ad_KLKOT_36197055\",\n        \"initiatedBy\": {\n            \"user\": {\n                \"displayName\": null,\n                \"homeTenantId\": null,\n                \"homeTenantName\": null,\n                \"id\": \"d7148226-7444-4884-aef7-b5fe693a6798\",\n                \"ipAddress\": \"X.X.X.x\",\n                \"userPrincipalName\": \"ga-x@x.onmicrosoft.com\"\n            }\n        },\n        \"loggedByService\": \"Self-service Group Management\",\n        \"result\": \"success\",\n        \"resultReason\": \"OK\",\n        \"targetResources\": [\n            {\n                \"displayName\": null,\n                \"groupType\": null,\n                \"id\": \"57126178-623b-4468-a96e-be2ee1611cc4\",\n                \"modifiedProperties\": [\n                ],\n                \"type\": \"Policy\",\n                \"userPrincipalName\": null\n            }\n        ],\n        \"userAgent\": null\n    },\n</code></pre>"},{"location":"2023/08/29/dude-wheres-my-audit-logs/#conditional-access-custom-controls","title":"Conditional Access custom controls","text":"<p>Now I get that this is a deprecated public preview, but, it\u2019s also existed for quite a long time, and it\u2019s surprising that changes to the control itself are not audited.</p>"},{"location":"2023/08/29/dude-wheres-my-audit-logs/#the-audit-data_2","title":"The audit data","text":"<p>Note the absence of any change data, as highlighted in the audit event:</p> <pre><code>    {\n        \"activityDateTime\": \"2023-08-07T20:18:39.6114596+00:00\",\n        \"activityDisplayName\": \"Update policy\",\n        \"additionalDetails\": [\n        ],\n        \"category\": \"Policy\",\n        \"correlationId\": \"21476eae-1b3f-45db-8e3e-e190cd19ad44\",\n        \"id\": \"Directory_21476eae-1b3f-45db-8e3e-e190cd19ad44_USKAS_28366729\",\n        \"initiatedBy\": {\n            \"user\": {\n                \"displayName\": null,\n                \"homeTenantId\": null,\n                \"homeTenantName\": null,\n                \"id\": \"d7148226-7444-4884-aef7-b5fe693a6798\",\n                \"ipAddress\": \"X.X.X.X\",\n                \"userPrincipalName\": \"ga-x@x.onmicrosoft.com\"\n            }\n        },\n        \"loggedByService\": \"Core Directory\",\n        \"result\": \"success\",\n        \"resultReason\": \"\",\n        \"targetResources\": [\n            {\n                \"displayName\": \"Default Policy\",\n                \"groupType\": null,\n                \"id\": \"77a1c6e8-877e-43fe-a4d0-0806472fe4a0\",\n                \"modifiedProperties\": [\n                    {\n                        \"displayName\": \"Included Updated Properties\",\n                        \"newValue\": \"\\\"\\\"\",\n                        \"oldValue\": null\n                    }\n                ],\n                \"type\": \"Policy\",\n                \"userPrincipalName\": null\n            }\n        ],\n        \"userAgent\": null\n    },\n</code></pre>"},{"location":"2023/08/29/dude-wheres-my-audit-logs/#ssprpassword-reset-settings","title":"SSPR/Password Reset Settings","text":"<p>Microsoft documents that most changes to SSPR are not audited, and in my analysis found that the following settings do not properly reflect any data in the audit logs, including a few that Microsoft seems to indicate should, such as enabling/disabling on-premises integration.</p> <p>Considering that these changes impact tenant-wide security controls around SSPR, it\u2019s surprising this service has existed for so long with what is effectively non-existent auditing. These logs don\u2019t even indicate who initiated the change.</p> <p>Yes, some of these are being overhauled/changed as authentication methods is an area of focus for Microsoft right now, but not all of these settings are encompassed in that.</p> <ul> <li>Registration, Days before users are asked to re-confirm their settings</li> <li>Notification settings</li> <li>Customizations</li> <li>On-premises integration</li> <li>Self-service password reset enablement/scoping</li> <li>Authentication methods (legacy methods)</li> </ul>"},{"location":"2023/08/29/dude-wheres-my-audit-logs/#the-audit-data_3","title":"The audit data","text":"<p>In testing, there isn\u2019t even a direct audit event logged for changes, but simply an update to the Microsoft password reset service service principle. The update provides no information on the actual change.</p> <pre><code>{\n        \"activityDateTime\": \"2023-08-07T20:28:04.2244435+00:00\",\n        \"activityDisplayName\": \"Update service principal\",\n        \"additionalDetails\": [\n            {\n                \"key\": \"AppId\",\n                \"value\": \"93625bc8-bfe2-437a-97e0-3d0060024faa\"\n            }\n        ],\n        \"category\": \"ApplicationManagement\",\n        \"correlationId\": \"aae6519f-15d9-4dec-9d12-a03b2639c60e\",\n        \"id\": \"Directory_aae6519f-15d9-4dec-9d12-a03b2639c60e_F0I2G_33925192\",\n        \"initiatedBy\": {\n            \"app\": {\n                \"appId\": null,\n                \"displayName\": \"Microsoft password reset service\",\n                \"servicePrincipalId\": \"a96c060c-dd1c-4229-9089-72aed43d85db\",\n                \"servicePrincipalName\": null\n            }\n        },\n        \"loggedByService\": \"Core Directory\",\n        \"result\": \"success\",\n        \"resultReason\": \"\",\n        \"targetResources\": [\n            {\n                \"displayName\": \"Microsoft password reset service\",\n                \"groupType\": null,\n                \"id\": \"a96c060c-dd1c-4229-9089-72aed43d85db\",\n                \"modifiedProperties\": [\n                    {\n                        \"displayName\": \"TargetId.ServicePrincipalNames\",\n                        \"newValue\": \"\\\"https://passwordreset.microsoftonline.com;https://passwordreset.microsoftonline.com/;93625bc8-bfe2-437a-97e0-3d0060024faa\\\"\",\n                        \"oldValue\": null\n                    }\n                ],\n                \"type\": \"ServicePrincipal\",\n                \"userPrincipalName\": null\n            }\n        ],\n        \"userAgent\": null\n    },\n</code></pre>"},{"location":"2023/08/29/dude-wheres-my-audit-logs/#external-identities-linked-subscriptions","title":"External Identities linked subscriptions","text":"<p>Microsoft has been pushing the migration of B2B guests/External Identities to use a linked subscription where organizations will receive 50,000 MAU for guests as far as licensing goes, compared to the prior model of a 1:5 user: guest license ratio.</p> <p>In order to implement this change, an organization must link their Entra ID tenant with an Azure subscription for billing purposes.</p> <p>When implementing this change, there is a proper audit even in the subscriptions activity log, however, a change like this should also be reflected in Entra ID audit logs. Instead, we get a series of useless audit log entries.</p>"},{"location":"2023/08/29/dude-wheres-my-audit-logs/#the-audit-data_4","title":"The audit data","text":"<p>When looking at the data in either entry for Create or update a Guest Usages resource, there is no data of value for the change.</p> <pre><code>{\n        \"activityDateTime\": \"2023-08-07T20:38:06.5858394+00:00\",\n        \"activityDisplayName\": \"Create or update a Guest Usages resource\",\n        \"additionalDetails\": [\n            {\n                \"key\": \"targetTenant\",\n                \"value\": \"Undefined tenant\"\n            },\n            {\n                \"key\": \"targetEntityType\",\n                \"value\": \"Resource\"\n            },\n            {\n                \"key\": \"actorIdentityType\",\n                \"value\": \"UPN\"\n            }\n        ],\n        \"category\": \"ResourceManagement\",\n        \"correlationId\": \"dda8b5c0-125d-4fc6-b8aa-971e9cb27f9a\",\n        \"id\": \"B2C_dda8b5c0-125d-4fc6-b8aa-971e9cb27f9a_VUR48_6835487\",\n        \"initiatedBy\": {\n            \"user\": {\n                \"displayName\": \"ga-x@x.onmicrosoft.com\",\n                \"homeTenantId\": null,\n                \"homeTenantName\": null,\n                \"id\": null,\n                \"ipAddress\": \"X.X.X.X\",\n                \"userPrincipalName\": \"ga-x@x.onmicrosoft.com\"\n            }\n        },\n        \"loggedByService\": \"B2C\",\n        \"result\": \"success\",\n        \"resultReason\": null,\n        \"targetResources\": [\n            {\n                \"displayName\": \"NotSet\",\n                \"groupType\": null,\n                \"id\": null,\n                \"modifiedProperties\": [\n                ],\n                \"type\": \"Directory\",\n                \"userPrincipalName\": null\n            }\n        ],\n        \"userAgent\": null\n    },\n</code></pre>"},{"location":"2023/08/29/dude-wheres-my-audit-logs/#external-collaboration-settings-guest-self-service-sign-up-via-user-flows","title":"External collaboration settings guest self-service sign up via user flows","text":"<p>Guest self-service sign-up (SSSU) is what one could consider a grey area in the B2B/B2C space, allowing users to self-register as guests in your tenant and access designated resources. While a somewhat niche feature, it\u2019s something that is rather powerful for controlling access to enterprise applications.</p> <p></p> <p>This setting can also be adjusted via Graph at https://graph.microsoft.com/v1.0/policies/authenticationFlowsPolicy.</p> <p>Surprisingly, changes that enable/disable this setting are not audited effectively.</p>"},{"location":"2023/08/29/dude-wheres-my-audit-logs/#the-audit-data_5","title":"The audit data","text":"<p>Toggling this on/off results in a long series of audit events from the B2C service, however, none of them actually indicate the change.</p> <p></p> <p>For all of these, the Modified Properties is null</p> <pre><code>{\n        \"activityDateTime\": \"2023-08-07T20:49:50.9366119+00:00\",\n        \"activityDisplayName\": \"Update authentication flows policy\",\n        \"additionalDetails\": [\n            {\n                \"key\": \"targetTenant\",\n                \"value\": \"Undefined tenant\"\n            },\n            {\n                \"key\": \"targetEntityType\",\n                \"value\": \"None\"\n            },\n            {\n                \"key\": \"actorIdentityType\",\n                \"value\": \"UPN\"\n            }\n        ],\n        \"category\": \"ResourceManagement\",\n        \"correlationId\": \"923307cf-b8ac-4e26-bd47-53650a88e9fb\",\n        \"id\": \"B2C_923307cf-b8ac-4e26-bd47-53650a88e9fb_VUR48_6870123\",\n        \"initiatedBy\": {\n            \"user\": {\n                \"displayName\": \"ga-x@x.onmicrosoft.com\",\n                \"homeTenantId\": null,\n                \"homeTenantName\": null,\n                \"id\": null,\n                \"ipAddress\": \"X.X.X.X\",\n                \"userPrincipalName\": \"ga-x@x.onmicrosoft.com\"\n            }\n        },\n        \"loggedByService\": \"B2C\",\n        \"result\": \"success\",\n        \"resultReason\": null,\n        \"targetResources\": [\n            {\n                \"displayName\": null,\n                \"groupType\": null,\n                \"id\": \"NotSet\",\n                \"modifiedProperties\": [\n                ],\n                \"type\": \"Other\",\n                \"userPrincipalName\": null\n            }\n        ],\n        \"userAgent\": null\n    },\n</code></pre>"},{"location":"2023/08/29/dude-wheres-my-audit-logs/#inconsistent-log-data","title":"Inconsistent log data","text":"<p>These are instances where changes are audited, however, they seem to disregard any sort of schema or consistency of auditing in Entra ID.</p>"},{"location":"2023/08/29/dude-wheres-my-audit-logs/#entra-id-protection","title":"Entra ID Protection","text":"<p>Entra ID Protection heavily offenses the senses with its audit logging of changes to the following policies:</p> <ul> <li>User risk policy</li> <li>Sign-in risk policy</li> <li>Multifactor authentication registration policy</li> </ul> <p>We could argue that you shouldn\u2019t be using the MFA registration policy at this point, as MFA should be an account day zero requirement. And while Microsoft wants you to move your ID Protection policies into Conditional Access, until they are gone, the changes really break the audit mold.</p>"},{"location":"2023/08/29/dude-wheres-my-audit-logs/#the-audit-data_6","title":"The audit data","text":"<p>Oddly the user risk policy and MFA registration policy indicate an update if either is changed, and updates to the sign-in risk policy appear separate. But for all three, two events are logged, a core directory change that contains no data, and secondary policy change, that oddly describes the change data under Status reason, which is highlighted in blue below. Where one should/would expect the change to appear is highlighted in yellow.</p> <pre><code>{\n        \"activityDateTime\": \"2023-08-30T03:00:57.8173676+00:00\",\n        \"activityDisplayName\": \"Update Sign-In Risk Policy\",\n        \"additionalDetails\": [\n        ],\n        \"category\": \"Policy\",\n        \"correlationId\": \"bcda8418-f5f0-42f4-a8c1-cc809be64050\",\n        \"id\": \"ADIbizaUX_bcda8418-f5f0-42f4-a8c1-cc809be64050_MZXCC_6463221\",\n        \"initiatedBy\": {\n            \"user\": {\n                \"displayName\": null,\n                \"homeTenantId\": null,\n                \"homeTenantName\": null,\n                \"id\": \"d7148226-7444-4884-aef7-b5fe693a6798\",\n                \"ipAddress\": \"X.X.X.X\",\n                \"userPrincipalName\": \"ga-x@x.onmicrosoft.com\"\n            }\n        },\n        \"loggedByService\": \"AAD Management UX\",\n        \"result\": \"success\",\n        \"resultReason\": \"Set sign-in risk policy successful. Enabled: True. Risk level for MFA: Never. Risk level for block: High. Include All Users: False. Include Users: 788aff42-e628-4ff9-8e17-a207350ed80b. Include Groups: . Exclude All Users: False. Exclude Users . Exclude Groups \",\n        \"targetResources\": [\n            {\n                \"displayName\": \"Sign-In Risk Policy\",\n                \"groupType\": null,\n                \"id\": \"5bf6637e-056a-4f1c-b887-6c7e99ed5ac6\",\n                \"modifiedProperties\": [\n                ],\n                \"type\": \"Policy\",\n                \"userPrincipalName\": null\n            }\n        ],\n        \"userAgent\": \"\"\n    },\n    {\n        \"activityDateTime\": \"2023-08-30T03:00:57.181057+00:00\",\n        \"activityDisplayName\": \"Update policy\",\n        \"additionalDetails\": [\n            {\n                \"key\": \"User-Agent\",\n                \"value\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/116.0\"\n            }\n        ],\n        \"category\": \"Policy\",\n        \"correlationId\": \"b06b42f1-4723-45bb-b205-59eae5ab7da3\",\n        \"id\": \"Directory_b06b42f1-4723-45bb-b205-59eae5ab7da3_FYNFV_398999217\",\n        \"initiatedBy\": {\n            \"user\": {\n                \"displayName\": null,\n                \"homeTenantId\": null,\n                \"homeTenantName\": null,\n                \"id\": \"d7148226-7444-4884-aef7-b5fe693a6798\",\n                \"ipAddress\": \"X.X.X.X\",\n                \"userPrincipalName\": \"ga-x@x.onmicrosoft.com\"\n            }\n        },\n        \"loggedByService\": \"Core Directory\",\n        \"result\": \"success\",\n        \"resultReason\": \"\",\n        \"targetResources\": [\n            {\n                \"displayName\": \"Sign-In Risk Policy\",\n                \"groupType\": null,\n                \"id\": \"5bf6637e-056a-4f1c-b887-6c7e99ed5ac6\",\n                \"modifiedProperties\": [\n                    {\n                        \"displayName\": \"Included Updated Properties\",\n                        \"newValue\": \"\\\"\\\"\",\n                        \"oldValue\": null\n                    }\n                ],\n                \"type\": \"Policy\",\n                \"userPrincipalName\": null\n            }\n        ],\n        \"userAgent\": null\n    },\n</code></pre>"},{"location":"2023/08/29/dude-wheres-my-audit-logs/#responsible-disclosure","title":"Responsible disclosure","text":"<p>After consideration and reading of what constitutes a security vulnerability at the Microsoft Security Response Center (MSRC), I do not believe that these deficiencies in auditing would be considered a security vulnerability, as the absence of audit data itself is not a vulnerability.</p> <p>On July 26th, 2023, through an MVP channel in the Customer Connected Program Entra Advisors, I reached out to the Microsoft Entra Product Group wanting to provide feedback on what I believe are audit gaps in Entra ID.</p> <p>After some exchanges to coordinate whom to send the feedback to, on August 7th I provided an email to the responsible parties in the PG covering audit logging. Microsoft did reply that they will investigate in response. Considering that this is not a security vulnerability, I do not believe there is harm in publishing this material prior to any (if any) changes occur on the part of Microsoft.</p> <p>A case with Microsoft support has not been opened on this subject to this point, on which I would open one if directed by the PG.</p>"},{"location":"2023/08/29/dude-wheres-my-audit-logs/#regarding-audit-log-analysis","title":"Regarding audit log analysis","text":"<p>In my endeavors to this point, I have not analyzed all audit log events in Entra ID, so there may still be additional gaps in what one might find to be acceptable auditing. While Microsoft may contend that they indicate in their own docs that some of these changes are not listed as being audited, I would counter that with the stances that every single configuration change in Entra ID should be audited and adhere to some sort of audit log schema for consistency.</p>"},{"location":"2025/09/02/entra-useless-insights-report/","title":"Entra Useless Insights Report","text":"<p>Yes. The name is snarky on purpose.</p> <p>With the drive to using phishing-resistant MFA something on the mind of many organizations, I\u2019ve been taking a look at the Usage &amp; Insights Report features in Entra, specifically the Authentication methods activity report.</p> <p>Enumerating the type of authentication methods registered on a user, on a per-user basis, can be time consuming, and would become untenable in extremely large organizations.</p> <p>Authentication methods activity reporting to the rescue \u2013 right? Not so much.</p> <p>In digging into the report, whether it\u2019s through the Entra admin center or through Microsoft Graph PowerShell SDK, the data reported through this is just astoundingly awful if you want to try and build some basic measurements around who is actually registered for passkeys (FIDO2); I haven\u2019t looked to see if it\u2019s as awful with other methods.</p> <p>Luckily in the tenant I\u2019m examining, there are only a few hundred user objects, so it\u2019s also feasible to enumerate each user the long way, which I\u2019ll cover below as the workaround. I\u2019ve posed a complaint to Microsoft in some channels and have yet to hear anything back, other than similar experiences from a few others.</p>"},{"location":"2025/09/02/entra-useless-insights-report/#the-problem","title":"The Problem","text":"<p>I\u2019m focused on finding users registered for passkeys in Entra, and by passkeys I mean using the Microsoft Authenticator App on either Android or iOS devices.</p> <p>The behavior I\u2019m seeing has been problematic over the last month, but I suspect the report has been broken for quite some time.</p> <p>In this instance, I go into the Usage &amp; Insights reports, Authentication methods, and filter by Method: Passkey (Microsoft Authenticator), and I see the following:</p> <p></p> <p>But based on what I know, that seems way off, so I decide to run a Graph PowerShell SDK command and get the same results:</p> <pre><code>(Get-MgReportAuthenticationMethodUserRegistrationDetail `\n -Filter \"methodsRegistered/any(x:x eq 'passKeyDeviceBoundAuthenticator')\" `\n | Select-Object -Property UserPrincipalName).count\n54\n</code></pre> <p>Note that in Graph passkeyDeviceBoundAuthenticator is what differentiates this from just passkeyDeviceBound, which would include FIDO2 security keys.</p> <p>Back to the point, this number is low, and it\u2019s been historically low. One thing that I find interesting, and while I\u2019m redacting the actual data, is when I run:</p> <pre><code>Get-MgReportAuthenticationMethodUserRegistrationDetail `\n -Filter \"methodsRegistered/any(x:x eq 'passKeyDeviceBoundAuthenticator')\"\n</code></pre> <p>and examine the LastUpdatedDateTime value, for most of the users it\u2019s showing a date that is about a week old. I know that Usage &amp; Insights reports are not real-time; trying to think back to my Microsoft days, in my head the delay I thought was roughly two hours. But there are other issues \u2013 a user who has registered for a passkey back in Feburary 2025 is missing from the report. If the report never does anything to reconcile itself, it\u2019s of zero value.</p> <p>To spot check this user I run:</p> <p><pre><code>Get-MgReportAuthenticationMethodUserRegistrationDetail `\n -Filter \"methodsRegistered/any(x:x eq 'passKeyDeviceBoundAuthenticator')\" `\n | Select-Object -Property UserPrincipalName,LastUpdatedDateTime `\n | Where-Object {$_.UserPrincipalName -eq \"user@domain.com\"}\n</code></pre> And receive nothing back.</p> <p>I went to check the Microsoft docs here, Usage and insights report \u2013 Microsoft Entra ID | Microsoft Learn, to see if there is any details around the frequency this runs or known issues, but found nothing.</p>"},{"location":"2025/09/02/entra-useless-insights-report/#the-workaround","title":"The Workaround","text":"<p>So, it\u2019s back to doing essentially what the report should do, which is enumerate all users within Entra.</p> <p>Of course, Microsoft specifically recommends that you don\u2019t do this in the docs, Microsoft Entra authentication methods API overview \u2013 Microsoft Graph v1.0 | Microsoft Learn, where they state:</p> <p>We don\u2019t recommend using the authentication methods APIs for scenarios where you need to iterate over your entire user population for auditing or security check purposes. For these types of scenarios, we recommend using the authentication method registration and usage reporting APIs (available on the beta endpoint only).</p> <p>registration and usage reporting APIs (available on the beta endpoint only).</p> <p>The code I slapped together is a mix of my brain and some vibe coding, it ended up looking like the following, with a bit of parralel processing thrown in:</p> <pre><code># Authenticator App AAGUIDS\n$targetAAGUIDs = @(\n    '90a3ccdf-635c-4729-a248-9b709135078f',\n    'de1e552d-db1d-4423-a619-566b625cdc84'\n)\n\n# Grab all users\n#$AllEmployees = Get-MgBetaUser -All -Filter \"userType eq 'Member'\" -Property Id,UserPrincipalName\n\n# Run up to 10 employees in parallel\n$PasskeysRegistered =\n    $AllEmployees |\n    ForEach-Object -Parallel {\n\n        $emp = $_\n\n        $fidos = Get-MgBetaUserAuthenticationFido2Method -UserId $emp.Id -All -ErrorAction SilentlyContinue |\n                 Where-Object { $_.AaGuid -in $using:targetAAGUIDs }\n\n        foreach ($key in $fidos) {\n            [pscustomobject]@{\n                UserPrincipalName       = $emp.UserPrincipalName\n                ObjectId     = $emp.Id\n                Passkey      = $key.Model\n                RegisteredOn = $key.CreatedDateTime\n            }\n        }\n    } -ThrottleLimit 10\n\n$PasskeysRegistered\n</code></pre> <p>And then if I run a count, and ensure I\u2019m focused on unique users, since the results could have multiple entries for some users:</p> <pre><code>($PasskeysRegistered | Select-Object -Property UserPrincipalName -Unique).count\n92\n</code></pre> <p>Further, if I go search for my missing user, sure enough they are there:</p> <pre><code>$PasskeysRegistered | Where-Object {$_.UserID -eq \"user@domain.com\"}\n\nUserID              ObjectId                             Passkey                       RegisteredOn\n------              --------                             -------                       ------------\nuser@domain.com     xxxxx                                Microsoft Authenticator - iOS 2/27/2025 10:23:40 PM\n</code></pre> <p>As a side not the problem, one could theorize something was broken around that time in Entra, and hence the user somehow fell off the report. But I can actually find another user on the report who registered within twenty minutes of the missing user \ud83e\udd14.</p>"},{"location":"2025/09/02/entra-useless-insights-report/#the-takeaway","title":"The Takeaway","text":"<p>Don\u2019t trust Usage &amp; Insights reports for passkey reporting. Hopefully this post can become irrelevant down the road.</p>"},{"location":"2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/","title":"Field Notes: Migration From Federation To Cloud Authentication","text":"<p>During my stint at Microsoft, I spent a good deal of time with Windows Hello for Business (WHfB), and subsequently would be involved in prerequisite work to set the stage. For the enablement of WHfB, one of these items is device join, and it usually would be Hybrid Azure AD Join (HAADJ) for existing devices already within Active Directory. Device join can be a bit of a rabbit hole if the organization has federated authentication with AD FS in place, as there are different ways you can configure the device join process.</p> <p>One customer I was working with decided that they wanted to use their WHfB prerequisite work as the same point to switch from federated to cloud authentication with PHS; they were already sending their passwords to Azure AD for use with Azure AD Identity Protection. I discussed high-level what was required to switch but figured the conversation would continue after lunch. Instead, the customer decided to implement the switch during lunch, and their thousand or so users were moved to cloud authentication, with relatively little planning.</p> <p>Luckily their environment was relatively straightforward from an identity architecture perspective; I wouldn\u2019t recommend going into the switch without more thorough planning. But the point being made here is that the actual period of cutover has a much lower actual risk than perceived risk.</p> <p>Note</p> <p>Managed authentication and managed domain can be used interchangeably with cloud authentication. In most documentation Microsoft has started to prefer using cloud authentication for the umbrella term for Password Hash Sync (PHS) and Pass-through Authentication (PTA)</p> <p>Note that this article should be considered a companion to some excellent documentation Microsoft already has published, which you can find here:</p> <p>Migrate from federation to cloud authentication in Azure Active Directory \u2013 Microsoft Entra | Microsoft Learn</p> <p>Azure AD Connect: Cloud authentication via Staged Rollout \u2013 Microsoft Entra | Microsoft Learn</p>"},{"location":"2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#ensuring-risk-is-mitigated","title":"Ensuring risk is mitigated","text":"<p>Migration risk falls into three buckets: pre-migration, during migration, and post migration. As we dig into them, you\u2019ll note that during and post migration risks are mitigated by taking proper pre-migration actions.</p>"},{"location":"2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#pre-migration-risk-mitigation","title":"Pre-migration risk mitigation","text":""},{"location":"2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#staged-rollout","title":"Staged rollout","text":"<p>While it was in public preview for over two years, staged rollout has been a pivotal piece in allowing organizations to mitigate migration risk in a few ways.</p> <p>From the perspective of pre-migration, risk becomes mitigated by allowing organizations to do what everyone loves the most \u2013 test in production. Staged rollout can start with as few users as desired, to dip your toes into the waters of what cloud authentication will look like.</p> <p>When a user is authenticating to Azure AD, upon the initial sign-in screen where you enter your UPN, Home Realm Discovery (HRD) is performed to determine where and how to authenticate you. Essentially Azure AD analyzes the UPN entered and routes you accordingly. This is how staged rollout can make decisions on who to continue to federate for authentication, and who should be authenticated in the cloud.</p> <p>The other key component is that staged rollout allows for the migration to happen in waves/phases/rings \u2013 however you want to put it. It\u2019s usually a business decision as to who gets to go when and how, and requires some planning, but with staged rollout, your users are essentially already migrated. I\u2019ve had some organizations move their entire user base to staged rollout so that it was a non-event when the actual switch from federated auth to cloud auth happened on the tenant level.</p>"},{"location":"2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#password-expiration-policies-if-using-phs","title":"Password expiration policies (if using PHS)","text":"<p>I\u2019ll stand on the side of the argument that for most personas, there is an overall usability benefit that also fosters better user behavior relative to risk of password phishing by not requiring password expiration in Azure AD.</p> <p>When relying on federated authentication, whatever password policies exist in Active Directory will impact user authentication in the cloud.</p> <p>Now, if you are choosing to go with PTA, Active Directory is still the final say on authentication, and so password policies in Azure AD for these hybrid users is not relevant. But if you are moving to PHS, you should weigh what your current password policy looks like and whether you want to continue to with password expiration with cloud authentication. If you do, you\u2019ll want to look here for details on how to ensure that users in the cloud continue to have their password expire, Implement password hash synchronization with Azure AD Connect sync \u2013 Microsoft Entra | Microsoft Learn.</p>"},{"location":"2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#virtual-desktop-infrastructure-vdi","title":"Virtual Desktop Infrastructure (VDI)","text":"<p>If your organization is running a VDI infrastructure, and you\u2019re leveraging non-persistent virtual machines, it\u2019s important to note that there are limitations for support with cloud authentication. More details can be found here, Device identity and desktop virtualization \u2013 Azure Active Directory \u2013 Microsoft Entra | Microsoft Learn.</p>"},{"location":"2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#ad-fs-access-control-policies","title":"AD FS Access Control policies","text":"<p>While not as common due to the broad uptake of Conditional Access policies, it\u2019s important to make sure that if you have any access control policies in AD FS 2016 or later, or any authorization rules in AD FS 2012 R2 (or earlier), that you translate those rules into CA policies.</p>"},{"location":"2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#ad-fs-certificate-based-authentication","title":"AD FS certificate based authentication","text":"<p>While too deep to cover within here, previously the lack of CBA was one of the reasons for organizations to continue to persist with AD FS. If you have CBA in place, you\u2019ll want to make sure you have your use cases documented and well tested in Azure AD; this is another great place for staged rollout.</p>"},{"location":"2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#azure-ad-hybrid-join-service-connection-point","title":"Azure AD Hybrid Join service connection point","text":"<p>Organizations that have been using HAADJ for a while and have had AD FS in play, may have configured their environment to use AD FS as the authentication service in the Service Connection Point (SCP) for hybrid join.</p> <p>Note that the SCP is only used for provisioning of hybrid join. Once devices have their trust relationship with Azure AD, there is nothing facilitated by the SCP. Because of this, there is not an ongoing dependency on the SCP for devices already hybrid joined.</p> <p>Downlevel devices (Windows 7/8/8.1) have dependencies for hybrid join in federated authentication on AD FS, but again this is for joining those devices, which hopefully the occurrences are low in spinning up new Windows 7 instances.</p> <p>As far as timing goes, the SCP should be re-configured before the final migration from federated to managed authentication.</p>"},{"location":"2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#windows-hello-for-business","title":"Windows Hello for Business","text":"<p>Organizations that may have been earlier adopters of WHfB and rolled out Hybrid Certificate Trust, are going to find that they need to convert to a Hybrid Key Trust, or Cloud Kerberos Trust (the new name for Hybrid Cloud Trust).</p> <p>If you currently are using Hybrid Key Trust, you don\u2019t have change anything to prepare for the migration.</p> <p>If you are using Hybrid Certificate Trust, you\u2019ll need to take a look at the work required for preparing users to re-enroll in Windows Hello for Business, which you can find here, Hybrid cloud Kerberos trust deployment (Windows Hello for Business) | Microsoft Learn. Note that Microsoft never officially supported migration from Hybrid Certificate Trust to Hybrid Key Trust, but if you wanted to move to HKT, the same steps essentially can be taken, with the difference of targeting Hybrid Key Trust.</p>"},{"location":"2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#sign-in-frequency-conditional-access-policies","title":"Sign-in frequency Conditional Access policies","text":"<p>If you have heavily restrictive sign-in frequency policies in place and are not using staged rollout on the targeted users, it is an area where the risk will be slightly higher during migration. You may want to evaluate to whom and how you have these policies applied, and potentially temporarily disable your CA policies ahead of the migration window.</p>"},{"location":"2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#continuous-access-evaluation","title":"Continuous Access Evaluation","text":"<p>Yet another feature that can be used to minimize any risk during migration, continuous access evaluation greatly extends access token lifetimes. Having long token lifetimes will reduce the likelihood of users needing to re-authenticate during the migration window itself. Note that CAE requires the application to support this, so the focus here primarily is on Exchange Online, SharePoint Online and Teams.</p>"},{"location":"2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#federated-applications","title":"Federated applications","text":"<p>It might be a surprise, but some organizations investigate migration to cloud authentication even when they still have applications federated to AD FS.</p> <p>While the thought may be that all applications must be migrated prior to cutover, that isn\u2019t necessarily the case, as long as the organization understands the user authentication experience and flows. As the applications have no tie to Azure AD already, they will continue to operate without issue within AD FS. And beyond the fact that the organization will have to continue to maintain AD FS, the organization needs to understand that the user experience for authentication may give a fragmented perception. Users will now have three providers for authentication \u2013 Active Directory, Azure AD, and AD FS. In reality the user experience overall should be improved because authentication will be seamless to anything using Azure AD, but then when hitting an application tied to AD FS, the user may be prompted for forms authentication if they don\u2019t have line-of-sight of Active Directory \u2013 which is likely the behavior they were already used to. I bring it up because it can become a place of optics and a lot of user subjectivity, and can make troubleshooting scenarios a bit more complex.</p>"},{"location":"2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#domain-hint-with-staged-rollout","title":"Domain hint with staged rollout","text":"<p>Some applications may pass a domain_hint to Azure AD, which is used to bypass the Azure AD sign-on screen. This can be popular in environments with AD FS in play so that users do not need to enter their username upon the initial sign-in screen with Azure AD.</p> <p>Where this comes into play with staged rollout, is users could be directed to AD FS still for authentication. If your organization is already hybrid joined, and subsequently your users will have a PRT, the domain_hint piece is not even in play for authentication. If you have scenarios of users accessing Azure AD from things like personal devices with no trust relationship with Azure AD, it\u2019s where you may want to see what the behavior for authentication looks like. You can read about domain hints here, Home Realm Discovery policy \u2013 Microsoft Entra | Microsoft Learn.</p>"},{"location":"2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#document-your-federation-settings","title":"Document your federation settings","text":"<p>It may go without saying, but make sure you documented your federation settings, and understand the process to reverse things in the case that an issue arises post migration. This generally would look like using Azure AD Connect to re-configure the tenant for federated authentication unless you only need to selectively roll some of the domains back to federated authentication.</p>"},{"location":"2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#azure-ad-connect-health-and-planning-the-migration","title":"Azure AD Connect Health and planning the migration","text":"<p>Along with all the technical checks, there is the question of when to perform the migration. Whether staged rollout is in place or not, the when is a key piece of information the business is going to want to understand (well, as noted in my intro, usually).</p> <p>For global organizations, the question can become an issue of \u201cthere is always someone working somewhere\u201d. The two paths forward:</p> <ul> <li>A slightly less refined approach operates under the principal that the organization already has an outage window defined for IT operations. 60 minutes fits into almost any defined outage window an organization would have, and so subsequently the work is just scheduled during that time.</li> <li>A more refined and risk-adverse approach leverages Azure AD Connect Health. Azure AD Connect Health can help organizations understand when authentication is happening within AD FS, and subsequently you can use the data from this to determine when AD FS is least utilized. Of course, if you have not already deployed Azure AD Connect Health, you\u2019ll likely want to let it run for a bit to allow it to gather a proper amount of data to make an educated decision. Rolling out Azure AD Connect Health is a relatively straightforward process, which you can read about its use here, Using Azure AD Connect Health with AD FS \u2013 Microsoft Entra | Microsoft Learn.</li> </ul>"},{"location":"2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#mitigating-risk-during-migration","title":"Mitigating risk during migration","text":"<p>The level of risk used to be higher when ActiveSync was still heavily with legacy authentication, up until even a year or so ago. The reason for this is due to Exchange Online (EXO) having up to a four-hour period in which it may still attempt to authenticate to the federated identity source. Considering that Azure AD no longer has a trust relationship with AD FS, that is where things break down. Recall that with legacy authentication, the service such as EXO captures the user credentials and authentications on behalf of the user.</p> <p>With modern authentication you don\u2019t have the same drawn-out risk. As long as your user has a valid refresh token (RT) for Azure AD, they will not hit AD FS upon renewal of their access token (AT). To put that another way, the user only talks to AD FS for initial authentication, and subsequent renewals of the AT only require silent interaction with Azure AD. As mentioned, if you have very restrictive sign-in frequency CA policies in place, that can impact this behavior.</p> <p>There still is a small window, Microsoft defines as up to 60 minutes, where the tenant is converting itself behind the scenes. But as long as you\u2019ve checked all the pre-migration areas, the migration should generate next to no noise.</p> <p>If you\u2019re curious to understand how to test the migration from the outside-in, Sander Berkouwer (@SanderBerkouwer) has a nice way of leveraging domain_hint for that, which you can find here, How to check if Azure AD has processed the hybrid authentication method change \u2013 The things that are better left unspoken (dirteam.com).</p>"},{"location":"2022/12/02/field-notes-migration-from-federation-to-cloud-authentication/#mitigating-risk-post-migration","title":"Mitigating risk post migration","text":"<p>As noted in the pre-migration tasks, documenting how federation is currently configured is what you\u2019ll need to help rollback any changes. I have not encountered an organization that planned properly needing to roll back to federated authentication.</p> <p>You may want to continue to keep your AD FS farm around for a bit of time. For those that managed AD FS, it will be a joyous occasion to decommission.</p>"},{"location":"2023/06/20/identiverse-2023-recap-and-highlights/","title":"Identiverse 2023: Recap And Highlights","text":"<p>Going to a conference like Identiverse is a privilege, even if the travel is funded by airline and hotel miles earned by the feverish pace of pre-COVID travel from my time at Microsoft. The recommendation that every identity and security practitioner should try to attend at least one Identiverse in their career comes with the understanding that the means of doing so could vary greatly. But for those that can \u2013 you should absolutely put Identiverse 2024 on your priority list of big conferences to attend, especially for those within North America.</p> <p>While I take in security content, and sometimes speak at regional events, as an identity practitioner there was no greater clarity provided on some hot topic items than at Identiverse this year. And despite working and living primarily in the Microsoft ecosystem of identity, a few of the most poignant sessions were from those who are not within that ecosystem at all; looking at identity from the angle of a pure practitioner is something that is a growth mindset activity.</p> <p></p> <p>With my new friend and Entra identity wiz, Chris Brumm (@cbrhh)</p>"},{"location":"2023/06/20/identiverse-2023-recap-and-highlights/#top-six-takeaways","title":"Top six takeaways","text":""},{"location":"2023/06/20/identiverse-2023-recap-and-highlights/#can-authorization-be-centralized","title":"Can authorization be centralized?","text":"<p>While practitioners currently in the field implementing the things may disagree, from a moving forward perspective, the industry has come a long way with centralizing authentication. So what\u2019s next? Authorization. Several vendors have built their own authorization policy engines and languages \u2013 AWS has recently released Cedar, Strata has IDQL, there are projects like OPAL. This list is neither extensive nor am I an expert in any existing centralized authorization platform.</p> <p>But the question at hand is \u2013 how can we centrally manage, and centrally audit, authorization within applications. Having worked on some broad IGA projects, it gets really sticky once you are trying to control authorization within those applications. We can easily say Tom gets access to Salesforce, while Fred does not. But how do we define what Tom can do within Salesforce? Currently, it\u2019s a lot of one-off integrations specific to the application at hand. We have similar issues within Cloud platforms on the management, data and workload planes, which CIEM solutions are trying to solve, but again are very vendor-specific. Rights and roles in AWS do not directly translate to rights and roles in Azure or GCP. So can this all be centrally managed with the rules being written in a vendor-agnostic language?</p> <p>During his keynote, Alex Simons hinted at that maybe we don\u2019t need to unify the languages across platforms, but it\u2019s a place where AI can be trained to translate between different platforms\u2026 cue the Security Copilot pitch. To be fair vendors are already working on policy orchestration across multi-cloud, multi-app scenarios, but it makes sense though that Microsoft, who generally embraces multi-cloud, attempt to take a swing at bringing their hand into the mix, without trying to muddy the water with their own new policy language. Where my curiosity leads though, will we just end up with orchestration and abstraction, or will there be an authorization policy adoption in the likes of the way the industry has adopted modern authentication.</p>"},{"location":"2023/06/20/identiverse-2023-recap-and-highlights/#ai-is-messing-things-up","title":"AI is messing things up","text":"<p>In a flashy opening keynote, Andre Durand sat silent for a few minutes while an AI generated audio clip played in the background. The clip was him calling into a colleague that knows him, acting as the executive in a time crunch, requesting that his password be reset. It\u2019s like the next generation of those texts people get from their \u201cCEO\u201d asking them to go buy a bunch of iTunes gift cards for them while they are in a meeting.</p> <p>As the keynote continued, Andre noted that he believes that in the realm of AI for bad vs AI for good, in the realm of identity security, AI for bad is going to be a great challenge, not just in combating it with AI for good, but how are we as identity practitioners going to deal with the rapid pace of change caused by AI.</p>"},{"location":"2023/06/20/identiverse-2023-recap-and-highlights/#identity-security-is-still-in-its-infancy","title":"Identity security is still in its infancy","text":"<p>There were several sessions related to securing Active Directory and hybrid identity, yet despite the quantity and quality of the sessions, the attendance was lower than one might expect. While conference attendees of Identiverse are split between identity practitioners working on the things of tomorrow and identity practitioners trying to wrangle with the present day, I wondered if this is also due to the echo-chamber effect of an identity conference \u2013 most practitioners here already knowing about and understanding the attack vectors relative to Active Directory, or if it\u2019s a question of whether identity security is still not taken seriously enough within the industry. I tend to lean somewhat towards the latter.</p> <p>During a fantastic keynote session from Ken Munro (@TheKenMunroShow) of Pen Test Partners, Ken discussed how he was able to obtain Domain Admin via a cars Telematics Control Unite (TCU) \ud83d\udc40. You can read the story here, From a TCU to Corporate Domain Admin | Pen Test Partners.</p> <p></p> <p>Guido Grillenmeier (@GGrillen) speaking about recovering Active Directory during an active attack</p>"},{"location":"2023/06/20/identiverse-2023-recap-and-highlights/#everyone-is-all-in-on-passkeys","title":"Everyone is all in on passkeys","text":"<p>The passkey theme ran throughout the conference. The FIDO Alliance (@FIDOAlliance) Executive Director Andrew Shikiar (@andrewshikiar) gave a keynote on advancements in passkey UX, and there were several sessions geared towards developers as well as practitioners on the uptake of passkeys in both commercial and consumer scenarios.</p> <p>One interesting highlight to come from the few passkey sessions I sat in on, is that the industry may be flipping the story a bit towards end users as far as how we \u201csell\u201d the passkey story to them. As we can tend to see across the industry, consumer uptake of strong authentication is relatively low, and most consumers do not tend to bother or care about securing their identity. The emphasis is changing to point out the ease of use and convenience of passkeys instead of their security origin for consumers. I\u2019m curious to see how this goes \u2013 the FIDO Alliance has put a lot of work into building out development guidelines around the user experience to ensure that it\u2019s quality, but as with most things time will tell if the use and convenience of passkeys is really something that consumers latch onto.</p> <p>In a bit of a chicken-and-egg problem, more services need to start supporting passkeys, but some organizations seem to hesitate in investing effort into them until there is a proven return on supporting passkeys.</p> <p>On the enterprise side of passkeys, a session from Dean Saxe of AWS gave a clear and concise deep-dive into the differences behind device-bound passkeys and synced (multi-device) passkeys. That session alone is worth a deeper recap in itself.</p> <p></p> <p>From Dean's session on passkeys</p>"},{"location":"2023/06/20/identiverse-2023-recap-and-highlights/#decentralized-identity-suffers-from-marketing-speak","title":"Decentralized identity suffers from marketing speak","text":"<p>One of the other sessions that drove lot of clarity for myself, and seemingly the quite packed room, was Vittorio Bertoccio (@vibronet) of Okta speaking about Verifiable Credentials for the Identity Practitioner.</p> <p>The session really helped build a strong understanding of what verifiable credentials and decentralized identity is, as well as what it is not, despite how companies and marketing may try to sell it.</p> <p></p> <p>Vittorio stressing that it can be difficult with many cooks in the kitchen</p> <p>The key takeaway is that while decentralized identity and verifiable credentials may put the holder (yourself) in control over who you provide identity data to, and that you can restrict what data you give out, that centralized identity repositories will still not go away, either on the issuers side (IdP) or the verifiers side (the application, relying party).</p> <p>The issuers are still ultimately the final source of truth, and therefore need to continue to retain the information that is given to the holder for their wallet. In the cases that the data is lost, for example, you need a way to retrieve an authentic copy. And likewise most verifiers will have a strong reason to also need to retain the data you\u2019ve presented to them.</p> <p>A paraphrased example that Vittorio gave \u2013 if a university issues you a digital credential representing your diploma, and your diploma is a requirement as part of your work visa program \u2013 neither the university is going to remove the original record showing that you received that diploma, nor would that employer not retain the diploma information in the case that they need to attest to that information. In the case of the university, you certainly want them to retain the records that you graduated. From the employer side, in most cases a metadata bit of information that represented that they checked for your diploma likely won\u2019t hold water; the employer is going to want to retain the information you provided, not an abstraction of it. Of course, where you have control is that you, as the holder of the digital credential for this, can only give your employer the information that you hold the degree \u2013 perhaps you don\u2019t need to provide your grade point average and other details about attending.</p>"},{"location":"2023/06/20/identiverse-2023-recap-and-highlights/#identity-needs-better-representation-in-the-organization-at-all-levels","title":"Identity needs better representation in the organization at all levels","text":"<p>In the series of Thursday morning keynotes, one that was particularly fascinating to myself was the panel discussion \u201cIdentity in the C-Suite? The role of the Chief Identity Officer\u201d. It\u2019s continually apparent that in many organizations, identity is underserved on all levels, from where and how individual contributors sit in the organization, to where and how identity rolls up. I\u2019ve for a long time believed that many CISO are not adequately adjusted to own an identity program, and yet the infrastructure roots that identity has in many organizations is no longer the place it should be retained. This keynote was taking things one step further, and really driven by the fact that while identity is as the center of security, security is not the only center of identity. When we start to explore all the other facets of identity that have varying degrees of how adjacent they are to security, it becomes clear that it may hinder usability, as an example. So the question arises, does identity receive its own seat at the table?</p> <p>When we turn to look at the IC, the strong focus of identity as a security function also falls short there. Lance Peterman (@LancePeterman) and Arynn Crow (@arynncrow) both gave strong sessions on generating new identity talent, and how the industry as a large is failing to really provide security professionals a strong identity foundation. Both were quite invigorating and for all identity practitioners it\u2019s a call to help us build up the surrounding community.</p> <p>The threads running through this felt close to my session from BSides Salt Lake City this past December, \u201cIdentity and Security: It\u2019s time for a hug\u201d.</p> <p>I have more thoughts on both of these topics, but those are for another time and another post.</p>"},{"location":"2023/06/20/identiverse-2023-recap-and-highlights/#other-takeaways","title":"Other takeaways","text":""},{"location":"2023/06/20/identiverse-2023-recap-and-highlights/#favorite-identity-adjacent-session","title":"Favorite identity adjacent session","text":"<p>I\u2019ve always been a huge proponent of change management, and while my Prosci is a bit rusty these days, I loved seeing Sarah Villarmarzo speak on this topic. I\u2019ve seen so many organizations dismiss the benefits of change management, only to then wonder why there is so much friction in the security changes they are implementing. A little bit of awareness and desire can go a long way for your employees.</p> <p></p>"},{"location":"2023/06/20/identiverse-2023-recap-and-highlights/#too-many-sessions","title":"Too many sessions","text":"<p>There were just too many sessions to really be able to take all the knowledge in that you\u2019d like, and even though for attendees there is access to recordings. we all know how it goes when recordings are available\u2026 they just never really get the mental attention they deserve.</p> <p>I missed the majority of David Lees (@iamhdavidlee) keynote unfortunately, and really wanted to attend more of the passkey and verifiable credential sessions. At certain points I had four sessions I bookmarked as attending that all ran at the same time, and would be back and forth in my head about which to attend. Trying to mix in some hallways conversations, forcing my introverted self to be more outgoing\u2026 it can be a lot.</p>"},{"location":"2023/06/20/identiverse-2023-recap-and-highlights/#it-is-absolutely-worth-attending-if-you-can","title":"It is absolutely worth attending if you can","text":"<p>I\u2019m looking forward to 2024, and hope to see other folks there. The amount of thoughts and ideas that I took away for my career, for the industry, for myself, for the community \u2013 it was all so much that I really needed the bit of downtime following the conference. If your employer doesn't pay your way\u2026 save up those points and miles, at least to make the journey one time.</p>"},{"location":"2021/12/13/living-in-a-passwordless-world-password-management/","title":"Living in a Passwordless World: Password Management","text":"<p>With Microsoft touting changes to personal Microsoft (MSA) accounts, allowing customers to go completely passwordless, it has brought heightened attention again to the world of passwordless for corporate customers in the Microsoft ecosystem.</p> <p>While attending an October 13th Microsoft passwordless event, highlighting the future for the corporate world, I noticed a trend \u2013 organizations asking how to deal with password management and compliance policies they must adhere to. As Microsoft calls out, the long-term goal is for organizations to forget that passwords are even a thing.</p> <p>However, being that directory services will still contain a password attribute, even if we aren\u2019t using it, how do we keep it compliant with password policies. And how do we prevent end users opting to attempt to use their password. In this series we will dive into what the answer to these questions looks like.</p> <p>One thing that is important to iterate in every conversation \u2013 the world is moving passwordless, and it\u2019s not just Microsoft who is heading in this direction. If organizations do not want to (and should not be) trailing from a security perspective, you should start investigating what passwordless looks like for you now \u2013 as with most things these days it is a journey, albeit easier than many organizations may realize.</p>"},{"location":"2021/12/13/living-in-a-passwordless-world-password-management/#killing-hybrid-identity-passwords-with-scril","title":"Killing hybrid identity passwords with SCRIL","text":"<p>SCRIL, the acronym for Smart Card is Required for Interactive Logon, is a userAccountControl property flag in Active Directory, which any organization that is heavily invested in smart cards may be familiar with. For the rest of the world, this flag goes unnoticed, beyond being a checkbox you scroll past in ADUC.</p> <p>In the Microsoft documentation on their Passwordless Strategy, Passwordless Strategy \u2013 Windows security | Microsoft Docs, they do a decent job covering what removing the ability to use passwords looks like in an organization, but they don\u2019t really cover specifics on what the behavior looks like.</p> <p>This is an area you\u2019ll want to explore in parallel with modernizing your applications \u2013 for most organizations, the biggest hurdle with cloud and passwordless are with applications that don\u2019t support modern authentication \u2013 I\u2019m looking at you LDAP and RADIUS. For most customers in the passwordless journey, SCRIL is something you would be working towards, and there are steps for many organizations that need to happen prior to this point \u2013 if you haven\u2019t read the strategy linked above, you should do so.</p>"},{"location":"2021/12/13/living-in-a-passwordless-world-password-management/#diving-into-scril","title":"Diving into SCRIL","text":"<p>SCRIL, when enabled, directs Active Directory that the user account must use a form of asymmetric key-based (certificate) authentication in Active Directory. Because Windows Hello for Business (WHfB) is also certificate-based authentication, we can leverage the same flag.</p> <p>When you enable SCRIL on a user account in Active Directory, the following happens for the user account:</p> <ul> <li>The users password is set to 128 bits of random data and next logon, and per Microsoft is likely to include non-typable characters</li> <li>The user is not asked to change their password anymore within Active Directory and Windows clients, even if it is expired</li> <li>Domain Controllers do not allow passwords for that user for interactive authentication</li> <li>The user has now lost knowledge of what their password is</li> </ul>"},{"location":"2021/12/13/living-in-a-passwordless-world-password-management/#enabling-scril-and-its-results","title":"Enabling SCRIL and its results","text":"<p>Before we enable SCRIL, let\u2019s examine a user account in AD. While SCRIL is a property flag on the userAccountControl attribute, it\u2019s exposed to us in a much more accessible manner in Active Directory; it appears as a checkbox on user accounts in ADUC and ADAC, but for this article we will be looking at the account through the AD PowerShell module.</p> <p>Let\u2019s look at the user lee.gu in AD:</p> <pre><code>Get-Aduser -Identity &lt;username&gt; -Properties `\nSmartcardLogonRequired,PasswordLastSet | `\nselect UserPrincipalName,SmartcardLogonRequired,PasswordLastSet\n</code></pre> <p></p> <p>To enable SCRIL, we toggle on SmartCardLogonRequired, which adjusts the userAccountControl attribute for us:</p> <pre><code>Set-Aduser -Identity &lt;username&gt; -SmartcardLogonRequired $true\n</code></pre> <p></p> <p>SCRIL is now enabled on the user account; one thing that might seem surprising is that the password on the user is not actually changed when enabled on the account, so let\u2019s look at how this behaves.</p>"},{"location":"2021/12/13/living-in-a-passwordless-world-password-management/#the-user-experience-and-ad-password-change","title":"The user experience and AD password change","text":"<p>Now we have Lee attempt to log into his Windows 11 device with a password:</p> <p></p> <p>When attempting to sign-in, we are presented with the following message:</p> <p></p> <p>Let\u2019s look at the account again in AD:</p> <p></p> <p>And we see that the time Lee attempted logon, his password was changed in AD.</p> <p>Takeaway #1</p> <p>Until the user attempts authentication against Active Directory, their password will not be changed within AD.</p> <p>Takeaway #2</p> <p>In our demonstration we show what happens if the user attempts to use their password. But if they are already enrolled in WHfB, it\u2019s likely that they wouldn\u2019t be trying to use their password for authentication.</p> <p>Thankfully, it does not matter what method the user leverages for authentication \u2013 if Lee authenticated for that first time with WHfB after SCRIL was enabled on the account, the password would be updated in Active Directory regardless.</p>"},{"location":"2021/12/13/living-in-a-passwordless-world-password-management/#dealing-with-password-policies","title":"Dealing with password policies","text":"<p>Up to this point we have enabled the ability to have Active Directory manage the users' password, but what about password policies? Complexity and history may be inherently covered, but what about if your organization is required to rotate passwords.</p> <p>If your organization does not require password rotation, or if the rotation period is an extended length of time, you should enable a password expiration policy on your SCRIL users. Why? Because a password still exists for our users, and in non-interactive scenarios, if the password becomes known through some malicious vector, it\u2019s leaving that account exposed. When we look at computer accounts and Group Managed Service Accounts (gMSA), those passwords are rotated behind the scenes by Active Directory; we need to think of our passwordless users as similar when SCRIL is enabled.</p> <p>For organizations that are at an AD Domain Functional Level of Server 2016 or higher, there is an easy button for allowing AD to manage rolling of secrets for users.</p> <p>If you are not at DFL 2016, this may be a point to prioritize upgrading so that you have this feature available to your organization, or else implement a scripted process to help roll them. Choosing not to roll your NTLM secrets is leaving the door open for lateral movement.</p> <p>If we launch ADAC, which is the path of least resistance for this setting, we want to right-click on the root of the domain in the left pane and select Properties. We will be presented with the following view, and want to check the box for Enable rolling of expiring NTLM secrets during sign on, for users who are required to use Microsoft Passport or smart card for interactive sign on.</p> <p></p> <p>Select OK, and now whenever the users password is going to expire, based on the policy applied to them, a new random 128 bit password will be assigned to the users account.</p> <p>As an example, let\u2019s look at a FGPP in AD applied to this user account, with a maximum password age of 1 day:</p> <p></p> <p>And the results from a few days of user authentication:</p> <p></p> <p>Takeaway #3</p> <p>Within Active Directory, we can apply password policies to our passwordless users, and be able to maintain compliance with rotation policies, all while still having a great user experience.</p>"},{"location":"2021/12/13/living-in-a-passwordless-world-password-management/#the-entra-id-side-of-the-story","title":"The Entra ID side of the story","text":"<p>Now that we have our user operating in a truly passwordless world in Active Directory, let\u2019s turn our eyes to the other half of the equation \u2013 Azure AD.</p> <p>Even though AD is managing the password, it\u2019s still an attribute that is synchronized to Azure AD. Recall that Azure AD synchronizes passwords in a channel that is separate from the rest of the synchronization process, so password changes show up in Azure AD shortly after changing them in AD.</p> <p>Let\u2019s look at our test user:</p> <p></p> <p>Shortly after updating the users' password in AD, the password change has synchronized to Azure AD.</p>"},{"location":"2021/12/13/living-in-a-passwordless-world-password-management/#entra-id-password-change-mechanisms","title":"Entra ID password change mechanisms","text":"<p>If we have password writeback enabled in Azure AD Connect, there are methods still available for our users to change their password \u2013 falling into two scenarios:</p> <ul> <li>Password change when the user knows their existing password</li> <li>Password change when the user has forgotten their password</li> </ul>"},{"location":"2021/12/13/living-in-a-passwordless-world-password-management/#password-change-with-existing-password","title":"Password change with existing password","text":"<p>Many times, when enabling password writeback, the focus is on enablement of Azure AD SSPR. However, under the MyAccount portal, users are also able to change their password if they know their existing password. This is already solved for us, as the user won\u2019t know their password any longer, and therefore this option is already unusable.</p>"},{"location":"2021/12/13/living-in-a-passwordless-world-password-management/#password-change-without-existing-password-sspr","title":"Password change without existing password (SSPR)","text":"<p>This is the one area where we need to potentially adjust our Azure AD tenant settings. While many organizations may have moved towards enabling SSPR for all users in the tenant, we now have a need to disallow SSPR for users who have SCRIL enabled.</p> <p>In Entra ID, Password reset, Properties, we can adjust the toggle to specify only users in a selected group are allowed to use SSPR; we would be disallowing SSPR for SCRIL users and wanting to ensure they are out of the scope for the group selected.</p> <p></p> <p>Takeaway #4</p> <p>With a little bit of work on the SSPR side of things, we can easily accommodate SCRIL within Azure AD, without worry that users can subvert our efforts.</p>"},{"location":"2021/12/13/living-in-a-passwordless-world-password-management/#final-notes","title":"Final notes","text":"<p>As with all things there are some caveats to going passwordless to this level for our end users. The most prominent is that our user has no way of falling back to a password. This is where this rolls into the bigger picture \u2013 allowing users to use the Authenticator App for passwordless, and allowing for FIDO2 security keys within the organization.</p> <p>TAP, or Temporary Access Pass also can fill in some instances if a user has lost all passwordless methods to bootstrap themselves back into the world, but unfortunately it cannot be used currently for enrollment in Windows Hello for Business.</p> <p>Lastly, to get to this point, you may need to start your journey of application modernization. Microsoft has some great documentation to get you started on the road to authentication migration with Migrate application authentication to Azure Active Directory.</p>"},{"location":"2023/03/28/march-23rd-2023-the-day-everyone-came-from-uzbekistan/","title":"March 23rd, 2023: The Day Everyone Came From Uzbekistan","text":"<p>According to Wikipedia, Toshkent (or Tashkent) is the largest city in, as well as the capital of, Uzbekistan, a country located in Central Asia. The city sports a population of 2.9 million people.</p> <p>Except for March 23rd, 2023. The day that everyone came from Toshkent City, UZ, at least according to Azure Active Directory.</p> <p>Note</p> <p>Not necessarily everyone may have been indicated as coming from Toshkent City, but incident MO531859 was globally impacting users.</p> <p></p> <p>#WeAreAllUzbekistan</p>"},{"location":"2023/03/28/march-23rd-2023-the-day-everyone-came-from-uzbekistan/#background","title":"Background","text":"<p>Per the Incident Report for incident MO531859, the incident started on March 23rd, 2023, at 3:30 AM UTC. As the day continued on for some folks, and the morning started for others, there was an increasing number of organizations noticing that Azure AD was indicating their users were coming from Toshkent City, UZ.</p> <p>If the organization was using Named Locations in Conditional Access, allowing access to resources only from certain geographic locations (countries), legitimate users would start being denied access by the CA policies.</p>"},{"location":"2023/03/28/march-23rd-2023-the-day-everyone-came-from-uzbekistan/#breaking-it-all-down","title":"Breaking it all down","text":""},{"location":"2023/03/28/march-23rd-2023-the-day-everyone-came-from-uzbekistan/#conditional-access-named-locations-and-countries","title":"Conditional access, named locations, and countries","text":"<p>Many organizations may implement geographic-based policies to reduce some identity surface area. Having worked with many US based organizations, they may implement a CA policy that contains an allowed location of the United States, and then in turn if that location condition is not met, access will be blocked.</p> <p>Even organizations that are global in workforce may implement regional or department specific policies. One manufacturing organization I worked with that was primarily based in the US, but had some salespeople that had to travel globally, chose to only allow access outside of the US for their sales department.</p> <p>For further details on Named Locations, see Using networks and countries in Azure Active Directory \u2013 Microsoft Entra | Microsoft Learn.</p>"},{"location":"2023/03/28/march-23rd-2023-the-day-everyone-came-from-uzbekistan/#authentication-to-azure-ad","title":"Authentication to Azure AD","text":"<p>When you authenticate to Azure AD, your egress, or public, IP address, is logged by Azure AD within your sign-in logs.</p> <p>If you are coming from your home internet, it\u2019s whatever public IP address your ISP is routing your traffic through. Some ISP\u2019s NAT network traffic, so that nodes (your home) may only have a private IP address, but at some point the traffic must route publicly. That\u2019s the IP address Azure AD sees.</p> <p>If you use a VPN, or Tor, or some other obfuscation thing, whatever that public IP address is, again, is what Azure AD sees.</p> <p>If you are coming from work, it\u2019s however work plumbs up to the internet, and whatever your work egress IP addresses are. Even if you have ExpressRoute, Azure AD still is connected to over a public network at some point, and that\u2019s the address that appears in your Azure AD sign-in logs. If your organization uses something like ZScaler, your traffic may appear to be coming from whatever their public IP addresses are.</p> <p></p> <p>Hello from Schenectady, New York</p>"},{"location":"2023/03/28/march-23rd-2023-the-day-everyone-came-from-uzbekistan/#but-how-does-azure-ad-correlate-ip-addresses-to-locations","title":"But how does Azure AD correlate IP addresses to locations","text":"<p>Per the incident report:</p> <p>\u2026Microsoft received an update in one of its Threat Intelligence data feeds from a third-party vendor that contained incorrect entries about the country in which certain IP addresses are located.</p> <p>That\u2019s a fancy way of saying that Microsoft subscribes to an external service that provides a database of IP address netblocks and the associated geographic location. Note that Microsoft does not indicate the company or companies that they use for this service, which it\u2019s understandable wanting to keep some secrecy around a security data provider. I have no idea what services Microsoft consumes, but an example of a provider is IP2Location.</p> <p>While there is the ability to use device-based GPS coordinates within Named Locations and Conditional Access, many organizations choose to use IP address-based location data. When organizations choose to use this data, they are leveraging this data provided to Microsoft.</p>"},{"location":"2023/03/28/march-23rd-2023-the-day-everyone-came-from-uzbekistan/#so-how-did-the-dataset-get-messed-up","title":"So how did the dataset get messed up?","text":"<p>I don\u2019t have insight into what exactly happened at the provider for an issue of this scale, but to simplify the incident \u2013 Microsoft received an incorrect copy of this data, and updated it in Azure AD.</p> <p>While you could blame Microsoft for not catching this mistake, consider the fact that on a smaller scaler this change is constant among the vast landscape of the internet. With a possible 4.3 billion IPv4 addresses carved up into all sorts of chunks, it\u2019s a lot of data for the companies that aggregate this data to manage. And Microsoft can\u2019t invest time in sorting out all the nuances of the data \u2013 you have to trust your data suppliers.</p>"},{"location":"2023/03/28/march-23rd-2023-the-day-everyone-came-from-uzbekistan/#a-much-more-common-example-of-geolocation-data-gone-wrong","title":"A much more common example of Geolocation data gone wrong","text":"<p>If you perform a quick google search, you\u2019ll find that the various services that offer this data aggregate it through several means. One of them is ISP\u2019s providing anonymized data to said services.</p> <p>When I\u2019ve worked with organizations over the years, occasionally you would encounter a situation on a microscale \u2013 a set of users coming from a certain cellular provider, all of a sudden are showing up as coming from some location far away. In the US it wouldn\u2019t usually manifest as a Conditional Access problem, as whether I\u2019m coming from Schenectady, NY or Sacramento, CA, it\u2019s all US traffic. However, organizations that have Azure AD Identity Protection deployed may have some sudden impossible travel or unfamiliar location stuff going on.</p> <p>Considering that the employees didn\u2019t move across the country, the common cause was said cellular provider made a network change \u2013 the netblock that had been servicing New York is now shifted to California. It\u2019s their IP address ranges; they can do whatever they want with them.</p> <p>In cases like these, the hope is that the geographic location data provider would have been notified, but again, mistakes happen. The course of action for the affected customer would be to open a support case with Microsoft. Microsoft then informs their data provider of the issue, and the provider does whatever magic it works to rectify the problem.</p> <p>When the dataset is corrected, it can be presumed that Microsoft then receives an updated copy of this data, because about a week later, the organization stops having the problem.</p>"},{"location":"2023/03/28/march-23rd-2023-the-day-everyone-came-from-uzbekistan/#deploying-updates-in-rings","title":"Deploying updates in rings","text":"<p>Without getting into the weeds, from the larger Azure AD outages over the past few years, Microsoft has indicated that they deploy changes to Azure AD in rings. You can call them waves or phases, but it\u2019s all the same. Azure AD is a globally distributed and deployed cloud identity provider, but there are still locations acting as the nodes that compose it, and a bunch of global traffic routing fanciness to ensure you land at the most relevant Azure AD endpoint.</p> <p>One could presume from the incident report that, as it would go with a ringed update of this nature, that initially user impact would be small, and as Microsoft increasingly pushed the changes out broader, the surface area of impact increased in step.</p> <p>And, in their efforts to ensure that they don\u2019t break things to reverse changes, one could presume that they have to follow similar deployment processes when undoing a change.</p>"},{"location":"2023/03/28/march-23rd-2023-the-day-everyone-came-from-uzbekistan/#speaking-of-traffic-routing","title":"Speaking of traffic routing","text":"<p>While Microsoft does not reveal how similar Azure AD and Azure AD B2C are as far as their geographical and back-end composition, working on an Azure AD B2C project of global scale really highlights the traffic routing wizardry going on the front end that users hit.</p> <p>For any Azure AD B2C system you encounter, you can determine the associated Microsoft datacenter by looking at the HTML comment tag found in the page source:</p> <pre><code>&lt;!DOCTYPE html&gt;\n&lt;!-- Build: 1.0.2873.0 --&gt;\n&lt;!-- StateVersion: 2.1.1 --&gt;\n&lt;!-- DeploymentMode: Production --&gt;\n&lt;!-- CorrelationId: xxx --&gt;\n&lt;!-- DataCenter: BL2 --&gt;\n&lt;!-- Slice: 001-000 --&gt;\n</code></pre> <p>And interestingly, you can also append a parameter to the request, &amp;DC=, which will allow you to specify a specific Microsoft datacenter if you know it. If I append &amp;DC=PNQ, which represents a Microsoft datacenter in India, and submit the request, the page source will now show:</p> <pre><code>&lt;!DOCTYPE html&gt;\n&lt;!-- Build: 1.0.2873.0 --&gt;\n&lt;!-- StateVersion: 2.1.1 --&gt;\n&lt;!-- DeploymentMode: Production --&gt;\n&lt;!-- CorrelationId: xxx --&gt;\n&lt;!-- DataCenter: PNQ --&gt;\n&lt;!-- Slice: 001-000 --&gt;\n</code></pre> <p>Non-B2C Azure AD tenants do not reveal this information within the source, and from some cursory testing, appending &amp;DC=location to the request does nothing. However, this circles back to highlighting that Microsoft performs traffic routing on the front end.</p> <p>During incident MO531859, when Microsoft indicates that they were:</p> <p>\u2026continually performed traffic rerouting and load balancing into healthy regions\u2026</p> <p>This does not mean that the incident had any correlation to an actual network traffic routing issue. What Microsoft is indicating, when we look back at the ring deployment model, is as datacenters with Azure AD endpoints were corrected with the prior IP geolocation data, Microsoft was adjusting their user traffic routing on a global scale. If I\u2019m in Europe, and the North Europe location has not updated, but the West Europe location has, Microsoft can easily send all traffic to West Europe, to help accelerate resolution for organizations while the things on the back end are rectified.</p>"},{"location":"2023/03/28/march-23rd-2023-the-day-everyone-came-from-uzbekistan/#how-to-move-forward","title":"How to move forward","text":"<p>Some organizations may look at this incident as a moment to change course in how they manage their Conditional Access policies. During the incident, it was left up to organizations to determine the risk in adjusting or disabling their impacted Conditional Access policies.</p> <p>There is not a one-size-fits-all answer to this. It is still best practice, if using geographic Named Locations, to build CA policies in an \u201callowed\u201d countries model, vs a \u201cdisallowed\u201d countries model (essentially an inverse policy). Some organizations may have already determined that a disallowed countries model works for them, however, there is a wider possibility of coverage gaps within this.</p> <p>Corporations that have used network location-based policies, whether IP ranges or country, may want to evaluate whether they need those policies at all, especially on devices that may be MDM managed and covered by something like M365 Defender. Or, with the beauty of Conditional Access, further refine and define user personas, to limit the need to rely on what, end of the day, are very implicit identity security choices.</p>"},{"location":"2023/07/17/protect-your-privilege-with-paw/","title":"Protect Your Privilege with PAW","text":"<p>According to the Microsoft Digital Defense Report 2022, weak identity controls are listed as a top three contributing factors found during ransomware incident response. One particularly troubling finding within identity controls is the lack of Privileged Access Workstations (PAW) found in any response engagement:</p> <p>None of the impacted organizations implemented proper administrative credential segregation and least privilege access principals via dedicated workstations during the management of their critical identity and high-value assets, such as proprietary systems and business-critical applications.</p> <p>Microsoft Digital Defense Report 2022, page 15 (Microsoft Digital Defense Report 2022 | Microsoft Security)</p> <p>The report does not speculate as to why the organizations were not using PAW, but for anyone seasoned out there in the world of consultancy the answers will look like:</p> <ul> <li>Lack of time/budget/resources/priority</li> <li>Lack of understanding and education</li> <li>Lack of sufficient desire to change privileged administrative behavior</li> <li>Belief that they have other sufficient compensating controls</li> </ul> <p>And these all really relate to each other \u2013 if you don\u2019t understand what a PAW is, you can easily believe other solutions such as PIM or PAM will sufficiently fill the gap. Likewise, if you don\u2019t understand how to articulate the value and principles behind PAW, it\u2019s difficult to run it up the chain to ensure that it has priority. Even in those instances where you may have a decent understanding of PAW, but as an admin don\u2019t want to change your working behavior \u2013 it\u2019s understandable, it\u2019s human to not want to change without knowing why.</p> <p>Awareness is the first principle of ADKAR (The Prosci ADKAR Model: Why it Works). May this article build that awareness, so you\u2019ll come out of it with the second principle, desire.</p>"},{"location":"2023/07/17/protect-your-privilege-with-paw/#keeping-it-clean","title":"Keeping it clean","text":"<p>One of the foundational components of privileged access is the clean source principle, which per Microsoft states:</p> <p>The clean source principle requires all security dependencies to be as trustworthy as the object being secured.</p> <p>Microsoft Learn, Success criteria for privileged access strategy | Microsoft Learn</p> <p>To phrase this another way, all components related to privileged access \u2013 the user accounts, the devices, the first- and third-party tools, all need to exist and be managed fully within the same security tier. Since the primary focus of PAW is for privileged access, that means everything related to PAW needs to be encompassed within the same tier as privileged access.</p> <p>Microsoft documents this in their privileged access implementation documentation, and diagrams this out as follows:</p> <p></p> <p>Note Privileged Security highlighted in the red box. Image courtesy Microsoft.</p> <p>Those that are seasoned with Active Directory security may be more familiar with the Tiered access model, composed of Tier 0, Tier 1, and Tier 2, as diagrammed below:</p> <p></p> <p>The Active Directory oriented privileged access model.</p> <p>What is important to understand is that in the new model of privileged security, Tier 0 does not go away. There are subsets of privileged security \u2013 Tier 0 effectively becomes the control plane, encompassing all existing Tier 0 assets, such as Active Directory and related systems such as Azure AD Connect and AD FS. Tier 0 now includes the Control Plane, which is highly privileged access that provides control over all resources. The credentials associated with the control plane are Global Administrator, and users that hold roles which can directly or indirectly obtain control over a Global Administrator. It has become important to include these accounts in that realm of Tier 0 access, as we tend to only focus on Global Administrator. As an example, Privileged Authentication Administrator roles can be used to reset authentication information on all accounts in a tenant. Intune Administrators, in a cloud-managed PAW deployment, become encompassed in Tier 0, as they can manipulate and manage PAW devices. Tier 1 becomes the Management and Data and Workload planes and still includes the Server Admin role; still privileged, but importantly still separated from the control plan and Tier 0. While the focus on the part of Microsoft is very cloud-oriented, privilege separation and the delineation are still critical for Active Directory, as well as using PAW for Active Directory management \u2013 majority of enterprises will still be leaning on Active Directory for a good while. And speaking of Active Directory, for the organizations that have hybrid identity, where Active Directory and Azure AD are connected, organizations need to understand the paths of lateral movement and privilege escalation between the two identity providers; there are known attack paths where Active Directory can be leveraged to takeover Azure AD, as well as the opposite flow. These are just some examples, and role delineation and definition can be an article on its own \u2013 let me know if that would interest you. In the meantime, you can read about this evolution and how Microsoft defines it here, Securing privileged access Enterprise access model | Microsoft Learn.</p> <p>Both models are still widely used and the principles behind them are valid. What is critical is that both models indicate that the device should be a PAW. Specifically, a physical device initiating session. The phrase clean keyboard may be thrown around at times as a bit of shorthand for the clean source principle.</p>"},{"location":"2023/07/17/protect-your-privilege-with-paw/#what-a-paw-is-not","title":"What a PAW is not","text":"<p>Organizations may take shortcuts to PAW, either by implementing something \u201cPAW like\u201d, such as jump boxes or bastion hosts, or virtualizing their PAW. The term \u201ccloud PAW\u201d floats around out there, which assumptions made that it equates to deploying PAW as virtual desktops.</p> <p>In all these scenarios you either run into:</p> <ul> <li>The chicken-and-egg problem</li> <li>A tiering breach</li> </ul>"},{"location":"2023/07/17/protect-your-privilege-with-paw/#bastion-hosts-jump-boxes-and-cloud-paw","title":"Bastion hosts, jump boxes and cloud PAW","text":"<p>Both bastion hosts and jump boxes can serve their purpose for managing resources, but they are not replacement for PAW. To adhere to the clean source principle, any remote access to a bastion host or jump box would need to be initiated from a device that already exists within the privileged security tier, otherwise you\u2019ll encounter an upward tiering breach.</p> <p></p> <p>Breaching tiers with a cloud-based solution such as bastion hosts or jump boxes</p> <p>Even in the case where you may be used advanced technologies such as passwordless for authentication, some component of the authentication process will be local to the enterprise device, putting the privileged user account at risk of exposure on a lower tier.</p> <p>And what about cloud PAW? This is a place of much confusion, as it\u2019s a term thrown about that is derived from the Microsoft model of using cloud managed PAW. That managed word being the key piece \u2013 Microsoft documents how organizations can build and deploy PAW that are managed by Intune and joined to Azure AD. You can find that documentation here, Deploying a privileged access solution | Microsoft Learn. As it goes with terminology, cloud managed PAW may sometimes be shortened to cloud PAW, and when people see cloud PAW, they presume that it means a PAW that exists within the cloud.</p> <p>You\u2019ll still find several articles and models out there where people attempt to build out a cloud-native PAW system, using things like Azure Virtual Desktop or Windows 365. And some of them might have an acceptable level of risk built into their design where there is enough monitoring and other compensating controls to minimize potential privileged access damage. Considering that ransomware can cost organizations millions of dollars in losses due to the inability to function, or even put them out of business, that\u2019s the risk that needs to be factored in with something like a cloud PAW design. I\u2019ve yet to see one that adheres to the clean source principle.</p>"},{"location":"2023/07/17/protect-your-privilege-with-paw/#virtualized-paw","title":"Virtualized PAW","text":"<p>Virtualizing your PAW results in the same series of issues as jump boxes and bastion hosts. Unless your virtualization environment is composed of resources that exist on and are managed in Tier 0, your Tier 1 administrators will be indirect administrators of those vPAW, and in turn access to other critical Tier 0 resources.</p> <p></p> <p>Tier 1 admins can become Tier 0 admins through the management plane</p> <p>It\u2019s also important to consider the implications of not managing business critical Tier 1 resources from a PAW. We can expand our breach model out another layer and see that we are putting all resources at risk when we don\u2019t use a physical PAW.</p> <p></p> <p>The cascading tier breach with virtualized PAW</p> <p>Some organizations may choose to run localized instances of virtualization software on their Enterprise devices, such as enabling Hyper-V within Windows 11. In these cases, the same problems apply: the enterprise user will still be authenticating with some mechanism local to the device with privileged credentials. The virtualized PAW will be susceptible to the same management plane attacks that would occur in an enterprise virtualization scenario.</p> <p></p> <p>Localized virtualization of a vPAW breaching tiers</p>"},{"location":"2023/07/17/protect-your-privilege-with-paw/#why-pim-and-pam-compliment-but-do-not-replace-paw","title":"Why PIM and PAM compliment, but do not replace, PAW","text":"<p>PIM and PAM solutions are great mechanisms from a defense-in-depth perspective, but they do little to protect credentials once the credential is resident on the device in question.</p> <p>A primary component of PAM solutions is password vaulting, which is great for granular control and auditing of who has access to secrets. Once that secret becomes resident on the device, however, it is as vulnerable as all the other credentials on the device. With more advanced and modern PAM solutions, there are mechanisms that provide a bastion host/jump box, to ensure that the vaulted credentials are not resident to the local device. However, you still will run into the same issues with bastion hosts and jump boxes \u2013 you still need to connect into the components providing this solution, which includes authenticating and creating a session. If you want to protect the session end-to-end, the source device still needs to adhere to the clean source principle, which in this case would be from a PAW.</p> <p>PIM also compliments PAW but is not a replacement on its own. While PIM is great for providing the least standing privilege and enabling the use of just-in-time (JIT) privileges, once privileges are elevated in a system, any threat actor obtains your credentials, or a representation of them (such as tokens) will be able to act as you, with those elevated privileges.</p>"},{"location":"2023/07/17/protect-your-privilege-with-paw/#paw-greatly-reduces-the-surface-area-on-privileged-accounts","title":"PAW greatly reduces the surface area on privileged accounts","text":"<p>The purpose of a defense-in-depth model is to ensure that if one component fails, there are other components that will ensure that data, the core of every modern business, is not exposed to those who should not have access to that data.</p> <p></p> <p>Defense-in-depth model</p> <p>If we drill down into this model further, we will see that each layer is composed of several different technologies \u2013 especially when we are talking about privileged access to that data.</p> <p>If we broke down the Identity &amp; Access layer of the model, we might see something like this:</p> <p></p> <p>A breakdown of the Identity &amp; Access Management Layer concerning privileged credentials</p> <p>PAW is foundational to the design theory of several other components \u2013 filling in the gaps PIM and PAM/secret vaulting present, but also building the strong foundation for which robust conditional access policies can be applied, device security policies can be pushed down from Intune, and account separation can be used to its fullest potential, ensuring that a mistake made with enterprise level credentials do not expose privileged creds.</p>"},{"location":"2023/07/17/protect-your-privilege-with-paw/#paw-doesnt-have-to-be-complex-to-deploy","title":"PAW doesn\u2019t have to be complex to deploy","text":"<p>As it goes with much of the privileged access documentation out there, there is the perception that everything is extremely time-consuming and overly complex. Organizations and security practitioners need to reshape their thinking relative to security privileged access, including the deployment of PAW.</p> <p>Yes, depending on how your organization is structured, cloud managed PAW will require knocking down some silos between the teams that manage identity and devices within the organization; that\u2019s work that should be happening anyway. Afterall, identity and device management practitioners are both security practitioners in modern environments.</p> <p>As with most guidance though, starting somewhere is better than nowhere. Having an incremental approach and open mindset is a stronger security posture than saying if we can\u2019t achieve 100% in x time, then it\u2019s not worth doing at all.</p> <p>If nothing else, justify the expense to procure some modern laptops to be used as the privileged devices for those Tier 0 Global Administrators and Domain Administrators, preferably one that is a secured-core device. You can find currently available ones here, Windows 11 Secured-Core PCs | Microsoft. The few thousand-dollar proactive expense is cheaper than the loss of business when your organization is breached. You can go one step further and configure some strong conditional access policies restricting what devices the privileged accounts can be used from. For details, see Filter for devices as a condition in Conditional Access policy \u2013 Microsoft Entra | Microsoft Learn.</p> <p>Eventually though make sure you take the time to go through the entire process, found here, Deploying a privileged access solution | Microsoft Learn.</p>"},{"location":"2023/07/17/protect-your-privilege-with-paw/#the-operational-change-shouldnt-be-a-showstopper","title":"The Operational change shouldn\u2019t be a showstopper","text":"<p>Once deployed, and enforced, the biggest change in organizations is the operational impact on the privileged administrators. Yes, you may not be able to copypasta that PowerShell snippet you found on Stack Overflow as easily, but in our modern landscape we all must adapt to new ways of working. We made it through the drastic changes with remote work, and transitioning to PAW is much less impactful on the overall organization than that was \u2013 even if it doesn\u2019t feel that way to your privileged admins.</p> <p>Organizations need to make sure that they support the change, as there will be needed ramp up time, and it\u2019s a suitable time to perform some incident handling testing to make sure administrators can perform all that they need to perform from their PAW. Organizations can be most vulnerable during an incident, whether it\u2019s cyber, operational, or natural forces, and the mode of operation can\u2019t be to just throw the PAW aside to fix things. Make sure that your IR, BC, and DR scenarios are reviewed and revised to support the use of PAW, as necessary.</p>"},{"location":"2023/07/17/protect-your-privilege-with-paw/#last-thoughts","title":"Last thoughts","text":"<p>One of my favorite tag lines is from Johnathan Fox, a Sr. Security Consultant from Microsoft. The tag is \u201cbe a good admin and protect your privilege!\u201d. Such a simple north star that we all should follow.</p> <p>And if you\u2019re an organization supporting your admins, make sure that you be a good organization and support your admins protecting their privilege. With the continually evolving landscape of threat actors, that protection is more critical than ever to ensuring that business doesn\u2019t stop.</p>"},{"location":"2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/","title":"SpAML: Spoofing Users In Azure AD With SAML Claims Transformations","text":"<p>For those that believe SAML is dead, they should take a look at the Azure AD Application Gallery. While the authentication standard finished baking almost two decades ago, it\u2019s still a staple for integration of applications with Azure AD. As of writing, the Azure AD App Gallery has 2015 applications available for SSO integration, and 1335 of them use SAML, roughly two-thirds. Beyond this, there are thousands of line-of-business (LOB) and other 3rd party applications that don\u2019t exist in the gallery but leverage SAML. Many well-known applications and platforms are published in the gallery using SAML \u2013 Salesforce, Google Workspace/Google Cloud, AWS, SAP, Oracle Cloud, ServiceNow, Workday\u2026 the list goes on and on.</p> <p>With the ease of federated identity, not only are we tying other cloud providers to Azure AD, but we are also bringing in business critical applications. With this, we need to keep in mind that threat actors are not always targeting critical IT resources; one can do plenty damage with access to records and data stored within SaaS applications.</p> <p>Azure AD makes it easier than ever to spoof (impersonate) a user within a SAML response. This relatively easy technique allows us to impersonate a highly privileged user in the target application. At the same time, authentication behavior for all other users of the application, including the legitimate user being spoofed, will not change. If your organization leverages SCIM for user provisioning, which is the direction the industry is going, this lends in favor of spoofing going undetected, as optional attributes in the SAML response will go unused by the application.</p> <p>Within Azure AD, you do not need to be a Global Administrator to configure an Enterprise Application. Anyone with Application Administrator, Cloud Application Administrator, or assigned Owner to a specific application can manage it. From a usability perspective, Microsoft pushes delegation of ownership to the business units. The users, however, that now can manage the application, likely fall under the bar of PIM or any privilege separation. Suffice to say, this opens our potential pool of targets in an organization; needing Global Administrator for movement into target applications is not necessary, just whoever has ownership. Likewise, it\u2019s ripe for abuse by insider threats.</p>"},{"location":"2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#azure-ad-saml-response-primer","title":"Azure AD SAML response primer","text":"<p>For a full refresh on the SAML authentication flow, I\u2019ll refer to the IDPro Body of Knowledge Article, Cloud Service Authenticates Via Delegation \u2013 SAML. For an understanding of the spoofing technique, the SAML response, which is passed from the Identity Provider (IdP, Azure AD) to the application (SP, Service Provider) via the user, contains both required and optional claims. One of these required claims is the name identifier, referred to in the response as the NameID.</p> <p>NameID is a unique attribute that represents the user within the application. It is what the application uses to lookup the user within its internal user database.</p> <p>Azure AD defaults to, and it is a common pattern these days, to use the Email Address (urn:oasis:namesSAML:1.1:nameid-format:emailAddress) format. The default source attribute that is emitted in the SAML response is user.userprincipalname.</p> <p>As an example, I authenticate to Azure AD as nestor.wilke@fabrikam.cloud, and subsequently when I connect to an Enterprise Application, say AWS, the SAML response contains the NameID below. On the identity layer, AWS uses this to match Nestor to his user account.</p> <pre><code>&lt;NameID Format=\"urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress\"&gt;nestor.wilke@fabrikam.cloud&lt;/NameID&gt; \n</code></pre> <p>Azure AD also provides the ability to create claim transformations. Claim transformations can be useful for several reasons. A simple example is if the application has case sensitivity requirements. One can apply a ToLowercase() and not have worry about needing to modify broader patterns in Azure AD to satisfy one application. Claims transformations are configured on a per-claim basis within each Enterprise Application that is using SAML.</p>"},{"location":"2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#setting-the-stage","title":"Setting the stage","text":"<p>An effective use of spoofing the SAML response is to impersonate a highly privileged user in an application. For our example, let\u2019s look at a few different user personas, in a somewhat simplified scenario:</p> <ul> <li>Nestor Wilke is an account owner in AWS, and because this is considered a highly privileged role, he has privileged credentials he uses for accessing AWS, p-nestor.wilke@fabrikam.cloud.</li> <li>Isaiah Langer is part of the Operations team that is tasked with providing support to Enterprise Applications, which provides rights over the AWS Enterprise Application. Groups are used for user assignment to AWS, and AWS role assignment happens in AWS IAM Identity Center. Isaiah can manage these applications with his normal user account, isaiah.langer@fabrikam.cloud. He has an account in AWS, but his privileges there are low.</li> </ul>"},{"location":"2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#configuring-our-malicious-transform","title":"Configuring our malicious transform","text":"<p>Once we gain access to an account with ownership over the application, we will want to jump into Azure AD, and browse to Enterprise Applications, and then open the target application.</p> <p>Within here, we will select Single sign-on in the left blade, and then under Attributes &amp; Claims on the right blade, select Edit:</p> <p></p> <p>In the new blade that opens, we want to select the Unique User Identifier (Name ID) claim:</p> <p></p> <p>Note that in our example we will be using a transform on user.userprincipalname, but this same technique can apply to any attribute that is being used for NameID.</p> <p>Within the Manage claim window, we want to select Transformation under Source. This will open a new Manage transformation blade on the right:</p> <p></p> <p>For spoofing, we need to know just two things \u2013 the UPN of the user we want to spoof, and the UPN of the user who will be used for performing the spoofing.</p> <p>Under Transformation, select Contains(). For Parameter 1 (Input) select user.userprincipalname. For Value, we will enter isaiah.langer@fabrikam.cloud. For Parameter 2 (Output), do not select an attribute from the dropdown menu. Instead, click into the window within the menu and enter p-nestor.wilke@fabrikam.cloud.</p> <p></p> <p>We then check the box for Specify output if no match, and for Parameter 3 (Output if no match) select user.userprincipalname.</p> <p>This last piece is what ensures that all other users accessing AWS will continue to have the same user experience, including Nestor. Our final transform will look like:</p> <p></p> <p>And we can confirm the pattern in the claims rule:</p> <pre><code>If 'user.userprincipalname' contains 'isaiah.langer@fabrikam.cloud' then output 'p-nestor.wilke@fabrikam.cloud'. Else, output 'user.userprincipalname'.\n</code></pre> <p>We select Add, and then Save.</p>"},{"location":"2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#using-our-malicious-transform","title":"Using our malicious transform","text":"<p>Now that we have things configured, let\u2019s look at this in action. Recall that Nestor is our target user, and Isaiah is the account that will be used for spoofing.</p> <p>This is just one example. This has been similarly tested and proofed with GCP and Salesforce and should be valid for any SAML application whether from the application gallery or a LOB application.</p>"},{"location":"2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#detecting-malicious-transforms","title":"Detecting malicious transforms","text":"<p>Unfortunately, the ability to detect a transform like this is difficult, as normal channels do not expose the data we expect and need.</p>"},{"location":"2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#audit-logging-is-broken","title":"Audit logging is broken","text":"<p>The first thought is to go to our Azure AD audit logs. After all, the change should be recorded in Azure AD, so we can ingest that data for detection.</p> <p>SAML claim policy auditing, is unfortunately, broken. If we look at our audit logs after Isaiah made the change, we will see the following:</p> <p></p> <p>We can drill into the Target(s) and see that there was a change made to a ClaimIssuancePolicy:</p> <p></p> <p>But when we look at the Modified Properties:</p> <p></p> <p>Note that there is nothing of value. Any SAML claim issuance policy changes in Azure AD show up the same way. To ensure this was not some sort of limitation of the portal itself, I looked at the data exported to Log Analytics:</p> <p></p> <p>I\u2019ve had a support case open with Microsoft through standard channels on this, but there has been no movement.</p>"},{"location":"2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#graph-api-does-not-expose-saml-claim-policies","title":"Graph API does not expose SAML claim policies","text":"<p>Figure the next place we may turn would be the Microsoft Graph API, but again we are blocked here. The Graph API does not expose SAML claim issuance policies, something that can be traced back to 2019 with customers asking for it, yet still is not supported from my recent check with Microsoft.</p> <p>Note</p> <p>Microsoft has claimed to resolve this by making claim transforms available through Graph API, however, it's a different set of transforms.</p>"},{"location":"2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#what-are-we-left-with","title":"What are we left with?","text":"<p>As Azure AD does not provide native means for easily tracking this, we can either go with something of relatively low fidelity, alerting on all changes to a ClaimIssuancePolicy, but this is also going to alert on all changes, good and bad. If there is little in the way of activity with SAML application onboarding in the environment, this may suffice.</p> <p>From a retroactive analysis perspective, because these are not exposed through the Graph API, the only way to verify the policy settings is through manual inspection.</p> <p>Using a SIEM platform for authentication log correlation may at first seem appealing but consider that authentication times are likely the only mechanism for correlation. If the platform has a high volume of user activity, that is going to create an immense level of complexity, as Azure AD and the application are highly likely going to be exposing the time the user authenticated into those systems, which may not align to the necessary precision.</p>"},{"location":"2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#preventing-malicious-transforms","title":"Preventing malicious transforms","text":"<p>Preventing malicious transforms becomes even more important when our ability to properly monitor for them is inhibited.</p> <p>From a prevention perspective it\u2019s back to the basics. The following should apply for all Global Administrators, as well as Application Administrator or Cloud Application Administrator roles if your organization heavily relies on them for management of Enterprise Applications:</p> <ul> <li>Privilege separated from daily driver accounts</li> <li>Accounts should not be mail-enabled</li> <li>Cloud-sourced and not synchronized from Active Directory</li> <li>Azure AD PIM should be used with MFA requirement for elevation</li> <li>Roles scoped with a Conditional Access policy requiring MFA for Azure management</li> <li>Passwordless should be enabled and required for these accounts</li> <li>Accounts should be scoped for Azure AD Identity Protection</li> <li>Require a Privileged Access Workstation (PAW) for highly privileged operations</li> </ul> <p>If you heavily delegate the owner role for specific Enterprise Applications, you may want to re-evaluate how you are securing the users with delegated access. While it\u2019s unlikely businesses will accept the model of privilege separation or a PAM implementation for the HR administrator team that owns Workday, it may be a place to reconsider if those delegations are necessary. If delegation primarily exists to assign membership to the application, the model could be changed to instead provide delegated ownership over the groups that are already assigned, or leverage entitlement management for application access lifecycle.</p> <p>The surface area for abuse by a threat actor can be reduced by application conditional access requiring compliant devices for all users with proper endpoint management in place, but from the perspective of insider threat or certain token theft scenarios, this may not be sufficient.</p> <p>Heavily restricted Conditional Access policies will not prevent user impersonation, as all CA policies are evaluated prior to the issuance of the SAML response. In our example, even if Nestor was restricted to using a PAW for accessing AWS, Isaiah would have been able to access AWS under whatever conditions CA was applying to his user account. If the application requires user assignment, or if a CA policy specifically blocked Isaiah from access, the risk is mitigated. For many business-critical applications, such as Workday, it\u2019s highly likely that blocking scenarios cannot be applied as the application is used across the workforce. Using mechanisms such as role assignment may be circumvented with a combination of claim conditions and transforms.</p> <p>If the target application provides mechanisms for privilege escalation management within, it may also stop the ability for impersonation, as the user would be presented to elevate privilege for the spoofed user within the target.</p>"},{"location":"2022/12/19/spaml-spoofing-users-in-azure-ad-with-saml-claims-transformations/#responsible-disclosure","title":"Responsible disclosure","text":"<p>When I initially came up with my proof case, I opened a case with MSRC, indicating that claims transforms should not allow for a constant output for NameID, as it enables for spoofing. Even though it is not a security risk within Azure AD, as the identity provider, proper controls should exist within the IdP to ensure that associated applications are not overly exposed to a security risk such as NameID spoofing.</p> <ul> <li>August 30th, 2022: Opened case with MSRC</li> <li>October 10th, 2022: Response from MSRC with case closed, \u201cWe determined that this behavior is considered to be by design.\u201d</li> </ul> <p>Likewise, a support case with Microsoft has been opened regarding deficiencies with SAML claim audit logging.</p> <ul> <li>October 20th, 2022: Opened support Sev C case with Microsoft</li> <li>October 26th, 2022: First response from SE with inaccurate understanding of case</li> <li>October 27th, 2022: Reply to SE with additional clarity</li> <li>November 8th, 2022: SE calls at a random time, follows up with email that a session will be scheduled on November 14th, at 9:30am EST</li> <li>November 14th, 2022: SE does not call at 9:30am EST</li> <li>November 14th, 2022: SE calls at 12:30pm EST, I request a call back at 1:00pm EST, SE agrees to call back at 1:00pm EST</li> <li>November 14th, 2022: SE does not call at 1:00pm EST</li> <li>November 17th, 2022: SE emails and schedules a call for November 18th, 2022 at 10:00am EST</li> <li>November 18th, 2022: SE does not call at 10:00am EST</li> <li>November 21st, 2022: SE emails indicating that I did not answer my phone at indeterminate time. Check with phone carrier, no call was ever received.</li> <li>November 28th, 2022: SE calls me outside of working hours.</li> <li>November 28th, 2022: I reply to an email with times that the SE can reach me</li> <li>December 9th, 2022: SE calls, able to finally have the screen sharing session. Walk the SE through the details I provided in my case showing the behavior of these changes not being properly audited. SE indicates that the case needs to be escalated.</li> <li>December 14th, 2022: SE calls me to let me know the case is still being investigated.</li> <li>January 9th, 2023: SE contacts me to let me know I need to reproduce the issue for fresh data for MS.</li> <li>January 25th, 2023: SE emails me to let me know the case is still being investigated.</li> <li>February 16th, 2023: SE emails me to let me know the case is still being investigated.</li> <li>February 20th, 2023: SE contacts me to let me know I need to reproduce the issue for fresh data for MS.</li> <li>March 15th, 2023: Case is re-assigned to an \u201cAzure Support Ambassador\u201d. It\u2019s indicated that the case is still being investigated.</li> <li>March 17th, 2023: I email the Support Ambassador asking if it would be possible to find out more details about the case directly from engineering.</li> <li>March 27th, 2023: Support Ambassador emails me to let me know that a bug has been filed to be fixed at a later date.</li> <li>March 29th, 2023: Support closes the case without asking if it\u2019s alright to do so.</li> </ul>"},{"location":"2025/01/13/spying-on-your-isvs-credential-choices/","title":"Spying On Your ISVs Credential Choices","text":"<p>Microsoft, and the general identity industry, has recommended that applications use certificates over secrets when it comes to credentials for things like applications. This recommendation has existed for about as long modern authentication and authorization systems have existed \u2013 over a decade now. Yet the reality is that there continues to be mystery shrouded around certificates, and sysadmins and developers still lean into using secrets.</p> <p>Secrets are problematic because they are nothing more than a password. Secrets are so much just a password that while Microsoft might refer to secrets as secrets in the UI for Entra, the underlying attribute name is passwordCredentials! While you can use systems like Azure Key Vault for secure management of who has access to the secrets, the reality is that secrets tend to be managed insecurely, both in transport and at rest. Identity Protection exists for workload identities, but it is not real time, and there are scenarios where it will not help you if the abuse is coming from inside the same trusted network.</p> <p>It\u2019s easy for organizations to determine what they are using with single-tenant applications, or if they are a developer of a multi-tenant app. A quick Microsoft Graph API call to applications/objectid of the application (app registration), and you can examine whether the application has certificates, secrets, or both assigned as credentials. You can also store credentials on the service principal, which I cover here, Entra App Registrations and Enterprise Applications: The Definitive Guide \u2013 Eric on Identity.</p> <pre><code>\"keyCredentials\": [\n    {\n        \"customKeyIdentifier\": \"2335C167C72B21C4ACA7F3AA191FA95F8A39A727\",\n        \"displayName\": \"Test certificate\",\n        \"endDateTime\": \"2024-11-06T18:47:27Z\",\n        \"key\": null,\n        \"keyId\": \"4ca658ff-a617-4161-93e0-465badaf7c3d\",\n        \"startDateTime\": \"2023-11-06T18:27:27Z\",\n        \"type\": \"AsymmetricX509Cert\",\n        \"usage\": \"Verify\"\n    }\n],\nExample certificate credentials\n\n\"passwordCredentials\": [\n    {\n        \"customKeyIdentifier\": null,\n        \"displayName\": \"test secret\",\n        \"endDateTime\": \"2025-07-07T23:25:23.333Z\",\n        \"hint\": \"zoZ\",\n        \"keyId\": \"e5ab0baa-5eb9-4180-9ad5-b1c693b7ee08\",\n        \"secretText\": null,\n        \"startDateTime\": \"2025-01-09T00:25:23.333Z\"\n    }\n],\n</code></pre> <p>Example secret credentials</p> <p>This is great, but this doesn\u2019t help you understand what your software vendor is using.</p>"},{"location":"2025/01/13/spying-on-your-isvs-credential-choices/#look-to-the-logs","title":"Look to the logs","text":"<p>Lucky for us, there are hints about the type of authentication vendors use in our Entra ID sign-in and Graph activity logs.</p>"},{"location":"2025/01/13/spying-on-your-isvs-credential-choices/#entra-id-sign-in-logs","title":"Entra ID Sign-in logs","text":"<p>In the Entra admin portal, you can browse to Identity, select show more, Monitoring &amp; health, and Sign-in logs. In the sign-in events blade that opens on the right, select Service principal sign-ins. Direct link to the sign-in logs is here, Sign-in events \u2013 Microsoft Entra admin center, but note that you\u2019ll need to still select Service principal sign-ins.</p> <p>Searching the logs is a bit different, as the portal will aggregate logs by the application. If you select the arrow on the left of the date, it will expand all the aggregated sign-in logs.</p> <p>In here, just select the date for one of the logs; make sure you don\u2019t select the service principal ID as it will actually open up the properties for the service principal instead.</p> <p>Once selected, an Activity Details: Sign-ins blade will open on the right. In here we simply need to examine the Client credential type.</p> <p>In the example below, we see that the client credential type is client secret, aka, password.</p> <p> Example client credential type of a secret (password)</p> <p>Whereas if the application is using certificates, the client credential type will show up as client assertion.</p> <p> Example client credential type of assertion (certificate)</p> <p>The unfortunate surprise is that the data available through Graph API does not match the data available in diagnostic logging.</p> <p>In the portal, the backend queries for the audit logs are coming from the Graph API endpoint https://graph.microsoft.com/beta/auditLogs/signIns. We can determine the exact queries being used with Graph X-Ray, and then make the same queries to Graph, and see the raw results:</p> <pre><code>\"value\": [\n    {\n        \"id\": \"c7db3bec-cb55-4ee7-8022-f51aa9603100\",\n        \"createdDateTime\": \"2025-01-09T11:00:51Z\",\n        \"userDisplayName\": null,\n        \"userPrincipalName\": null,\n        \"userId\": \"\",\n        \"appId\": \"86261278-59ef-4d12-8e21-\",\n        \"appDisplayName\": \"xxx\",\n        \"ipAddress\": \"xxx\",\n        \"ipAddressFromResourceProvider\": null,\n        \"clientAppUsed\": null,\n        \"userAgent\": null,\n        \"correlationId\": \"a22a7306-b6ae-4501-b2be-9fe5af3e327c\",\n        \"conditionalAccessStatus\": \"notApplied\",\n        \"originalRequestId\": \"\",\n        \"isInteractive\": false,\n        \"tokenIssuerName\": null,\n        \"tokenIssuerType\": \"UnknownFutureValue\",\n        \"clientCredentialType\": \"clientSecret\",\n        \"processingTimeInMilliseconds\": -1,\n        \"riskDetail\": \"none\",\n</code></pre> <p>The unfortunate surprise is that the data available through Entra diagnostic logging is not the same dataset.</p> <p>Querying AADServicePrincipalSignInLogs is as simple as running the following KQL query:</p> <pre><code>AADServicePrincipalSignInLogs\n</code></pre> <p>We could then further filter this by the service principal, time range, and such. But the results, when we expand them, do not contain any information about the type of authentication.</p> <p> Example log analytic result of a service principal sign-in</p> <p>The only bits of information relevant to the type of credential used are the servicePrincipalCredentialKeyId, but because the app registration is not in our tenant, we have no way of cross-referencing this. The service principal in our home tenant does not contain any references to the credentials on the app registration that we could correlate with either.</p>"},{"location":"2025/01/13/spying-on-your-isvs-credential-choices/#graph-activity-logs","title":"Graph Activity logs","text":"<p>Where our sign-in logs fail us, at least with our diagnostic logging, Graph activity logs have our back. Unfortunately, it\u2019s likely that this sort of snooping alone does not make it worth it to enable Graph activity logs; organizations need to evaluate the cost that would come along with enabling these logs and the additional overhead in Log Analytics.</p> <p>Because Graph activity logs can be a vast sea of data, the easiest way to examine a particular application is filtering by the service principal ID with a basic KQL query:</p> <pre><code>MicrosoftGraphActivityLogs | where ServicePrincipalId == \"insert id here\"\n</code></pre> <p>In the results, we can look at the ClientAuthMethod. If the method is 1, then a secret was used, such as below:</p> <p> Example graph activity log showing a secret credential used</p> <p>If ClientAuthMethod shows 2, then a certificate was used for authentication.</p> <p>If we wanted to more efficiently search for ISV applications that are using secrets, we could cross-reference a list of known Microsoft applications by the application (client) ID, and then search our Graph activity log, also filtering only for ClientAuthMethod of 1, like the following:</p> <pre><code>let MicrosoftApps = externaldata(AppId: string)\n    [@\"https://raw.githubusercontent.com/merill/microsoft-info/main/_info/MicrosoftApps.json\"]\n    with (format=\"json\");\nMicrosoftGraphActivityLogs | \nwhere ServicePrincipalId != \"\" and AppId !in (MicrosoftApps) and ClientAuthMethod == \"1\" | \ndistinct ServicePrincipalId\n</code></pre> <p>Our results should then show all service principal IDs for ISV software that are using secrets. Note my test tenant currently one has one:</p> <p></p> <p>The resulting list of IDs be used in Graph or searching in Enterprise Applications to determine what application(s) are using secrets.</p>"},{"location":"2025/01/13/spying-on-your-isvs-credential-choices/#what-to-do-with-this-data","title":"What to do with this data?","text":"<p>As a consumer of multi-tenant applications, the best (and only) way to impact change is to contact your software vendor, if you feel strongly that they should be using certificates. There is nothing from a technical standpoint, beyond stopping consumption of the application, that you can do to prevent the use of secrets.</p> <p>When contacting your vendor, remind them of Microsoft (and industry best practices), which you can find here, Security best practices for application properties \u2013 Microsoft identity platform | Microsoft Learn. But note that software is hard, switching the credential type might be more complex on the backend than you may realize, and it might take the voice of many customers to really impact change.</p>"},{"location":"2023/02/13/the-importance-of-identity-in-microsoft-certifications/","title":"The Importance Of Identity In Microsoft Certifications","text":"<p>As I\u2019ve taken Microsoft certification exams, or the exam renewals, I\u2019ve noticed that Azure AD and identity topics are a theme throughout. Now, focusing on the security space, it may seem like somewhat of a given.</p> <p>But it made me curious \u2013 how many Microsoft certification exams have an identity component to them?</p> <p>While the Microsoft Certification browser indicates 15 current exams (with four expired) that have a Microsoft Entra product component, the list has some obvious exclusions, such as AZ-900 and MS-900. Granted, those are fundamental exams, but Azure AD and Entra still come up on them in some shape or form.</p> <p>I decided to dig a bit deeper, and while I have not sat for the majority of exams outside the security space, the Microsoft official exam guides often give you a good breakdown of the skills and concepts within the exams. I found that 29 exams currently have an identity component to them, that would have an estimated weight of at least 5%.</p> <p>With this data, I came up with the following infographic:</p> <p></p> <p>The graphic above can be saved, and you can also download it as a PDF:</p> <p>the-Importance-of-Identity-in-Microsoft-Certifications</p>"},{"location":"2023/02/13/the-importance-of-identity-in-microsoft-certifications/#analysis-details","title":"Analysis details","text":"<p>As mentioned, I looked at the content of every single current Microsoft examination study guides. The exception are the Microsoft Office exams, the Dynamics exams, and the outliers, like the Technology Literacy for Educators exam.</p> <p>The exam study guides contain a section Skills measured, and it breaks down the skills by a general category.</p> <p>For example, this is the skills measure section for AZ-500, Microsoft Azure Security Technologies:</p> <ul> <li>Manage identity and access (25-30%)</li> <li>Secure networking (25-30%)</li> <li>Secure compute, storage, and databases (20-25%)</li> <li>Manage security operations (25-30%)</li> </ul> <p>I would look at this and, in this instance, indicate that the AZ-500 has an identity component of 30%, as you can see within the infographic.</p> <p>For exams that are more unassuming, such as the MS-700, Managing Microsoft Teams, I would dive deeper into the skills that compose the category.</p> <p>If we look at this exam, we would see the following categories:</p> <ul> <li>Plan and manage a Microsoft Teams environment (40-45%)</li> <li>Manage chat, teams, channels, and apps (25-30%)</li> <li>Manage calling and meetings (15-20%)</li> <li>Monitor, report, and troubleshoot a Microsoft Teams environment (10-15%)</li> </ul> <p>Identity doesn\u2019t seem to be present on this exam from the categories. But if we look at the subcategories of skills for Plan and Manage a Microsoft Teams environment:</p> <ul> <li>Plan and configure network settings for Microsoft Teams</li> <li>Identify licensing requirements for Microsoft Teams</li> <li>Manage security and compliance settings for Microsoft Teams</li> <li>Plan and implement governance and lifecycle management</li> <li>Configure and manage external collaboration</li> <li>Deploy and manage Microsoft Teams endpoints</li> </ul> <p>There are two, as highlighted, that have multiple Azure AD/Entra components to them, such as external collaboration settings, and using access reviews.</p> <p>In a case like this, since there are six subcategories, the best effort is estimating each has the same weight, so each having a weight of 7.5% in this example. However, because Azure AD does not fully compose each of these categories, I gave a weight based on the relative percentage. In this example, each of those had a rough weight of 5% of the 7.5% potential total, which is how I gave MS-700 a 10% total weight.</p> <p>Note that the math, especially on some of the exams with a lower portion of identity, will have a bit of fuzz to it. Microsoft indicates a 5% variation (range) that any skill category may make up an Individual exam. As such, you may see a few more, or less, identity-related questions on any given exam.</p>"},{"location":"2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/","title":"The Intersection of Graph and Entra ID: Application Permissions and Roles","text":"<p>When you work someplace that develops software that interacts with Entra ID, the question of Graph permissions eventually comes up. With the recent Midnight Blizzard attack against Microsoft, where a threat actor appears to have used service principals and Graph permissions to access resources in Microsoft\u2019s own Entra tenant, the scrutiny on permissions grows even more intense. You can read more about this with a great write-up from Andy Robbins here, Microsoft Breach \u2014 What Happened? What Should Azure Admins Do? | by Andy Robbins | Feb, 2024 | Posts By SpecterOps Team Members.</p>"},{"location":"2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#primer-on-the-microsoft-graph-api","title":"Primer on the Microsoft Graph API","text":"<p>Before jumping into the permission weeds, let\u2019s review a few things to set the stage. If you already understand the Graph API basics, feel free to scroll past.</p>"},{"location":"2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#what-is-graph-api","title":"What is Graph API","text":"<p>The Microsoft Graph API is the unified API endpoint into most Microsoft 365 services, which includes Entra ID. For purposes of this article, the terms Graph and Graph API refer to the Microsoft Graph API.</p> <p></p> <p>Microsoft Graph API diagram / Courtesy Microsoft Learn</p> <p>You can read more of an overview about the Graph API here, Microsoft Graph overview \u2013 Microsoft Graph | Microsoft Learn.</p>"},{"location":"2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#what-are-application-permissions","title":"What are application permissions","text":"<p>In Graph, there are two permission types, Delegated, and Application. The focus of this article is on application permissions, which allow an application to interact with Microsoft Graph, and the associated Microsoft services, without needing the context of a user.</p> <p>A common example might be scripts an organization developed that manage user objects in Entra ID \u2013 while there are robust third-party solutions that can also manage this stuff, many orgs still run scripts to maintain directory data. If the script is running as a scheduled task in something, somewhere, it\u2019s likely using application permissions (or hopefully is).</p> <p>Most third-party software applications that interact with Microsoft 365 without a user context use application permissions \u2013 this way their software can do its software \u201cthings\u201d behind the scenes, not centered around a user, for whatever purpose the software exists. If the software is a conference room integration it might require the ability to read all calendars in Exchange Online.</p> <p>We won\u2019t cover delegated permissions here, but for reference, these are permissions that allow an application to access resources on behalf of a user. A good example would be an application that wants to save files to OneDrive or read a calendar in Exchange Online. In this instance, the application is acting in the context of the user.</p>"},{"location":"2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#how-graph-interacts-with-entra-id","title":"How Graph interacts with Entra ID","text":"<p>As mentioned, Graph is the one-stop shop for all Microsoft 365 resources, including Entra ID. When you query Graph, the service you are reaching out to is derived from the path in the URL.</p> <p></p> <p>If we break down this example, we see two primary components:</p> <ul> <li>The version or endpoint. These terms are both used in Microsoft documentation and can be thought of interchangeably \u2013 this is what determines whether you are hitting the v1.0 or beta endpoint.</li> <li>The resource. The resource is a component of the service, but we don\u2019t need to make a specific reference to the service within the Graph API call, we can just let Graph determine what service to call on the backend based on the resource we are looking to interact with.</li> </ul> <p>One time that it does become important to know what service relates to the resources you are accessing is when you are heavily interacting with Graph, and potentially hitting the dreaded 429 response, which is the error you\u2019ll receive back from Graph if your requests are being throttled.</p> <p>Throttled or not, if you are curious to get an idea of how resources are aggregated into different services, check out the throttling limits here, Microsoft Graph service-specific throttling limits \u2013 Microsoft Graph | Microsoft Learn.</p>"},{"location":"2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#talking-to-graph","title":"Talking to Graph","text":"<p>As Microsoft Graph is a REST API, you use HTTP methods to interact with it. Those with a stronger sysadmin background, and less of a developer background, can be challenged to learn Graph times, but using Graph Explorer helps accelerate that process.</p> <p>It also helps to understand how the basic CRUD operations of a directory service translate into HTTP methods:</p> CRUD Operation HTTP Method Create POST Read GET Update PATCH Update PUT Delete DELETE <p>The translation is mostly 1:1. You\u2019ll notice that both PUT and PATCH are options for updating; searching the Graph API reference there are only five operations against Entra that use PUT. Point being, most update operations with Entra ID are going to use PATCH.</p>"},{"location":"2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#exploring-application-permissions","title":"Exploring Application permissions","text":"<p>If you are familiar with Access Control Lists and Access Control Entries in Active Directory, understanding permissions in Entra ID is not as difficult to grasp upfront as it might seem. For simplicity we\u2019ll stick to using the term permissions, and not delve into all the nuances of DACLS and ACE and the such that compose security in Active Directory, but if you want to read more, Microsoft has a nice article on them from an identity security perspective here, Active Directory Access Control List \u2013 Attacks and Defense \u2013 Microsoft Community Hub.</p>"},{"location":"2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#where-permissions-exist","title":"Where permissions exist","text":"<p>In Active Directory permissions are attached to the target objects, things like users and groups. If I want to grant Sarah permission to change a user\u2019s password, I will apply those permissions onto the user objects, granting Sarah Reset password.</p> <p>In many instances the permissions are applied onto an Organizational Unit (OU) and inherited down onto the objects, so I could also grant Sarah Reset password on an OU, and she would have the ability to reset the password of all users inheriting that entry in the OU.</p> <p></p> <p>Permission relationship in Active Directory</p> <p>The above diagram is high-level, not intended to describe the actual password reset process and the mechanisms that perform an access check in Active Directory, but to just help visualize the relationship.</p> <p>Similarly, if I wanted to allow Todd to create new groups, I would grant Create Group objects onto an OU; since the group doesn\u2019t exist, you have many scenarios where you are applying the permissions onto the structure above.</p> <p></p> <p>In Active Directory, whether a real service account that\u2019s a gMSA, or a user acting as a service account, the same model applies.</p> <p></p> <p>Permission relationship in Active Directory for a service account</p> <p>In Entra ID, Graph API permissions are applied on the requesting service principal, not on the target object. While an app registration is used to describe the desired permissions, the service principal is the object that holds the relationship to the delegated and application permission grants. If you are still uncertain of the difference between app registrations and enterprise applications, take a look at my deep dive here, Entra App Registrations and Enterprise Applications: The Definitive Guide \u2013 Eric on Identity.</p> <p>Application permissions are held as an appRoleAssignment resource type and are associated with a service principal.</p> <p>If we look at the example of creating a group, the permissions will look like the following:</p> <p></p> <p>Application permissions to create a group</p> <p>In this example, the application, a daemon, or backend type service, has the credentials necessary to authenticate to Entra ID as the service principal Cloud Application. Cloud Application has been given Graph API permissions of Group.Create, and subsequently can create a group in Entra ID.</p> <p>While the focus for service principals heavily targets developers, we should also think of service principals as modern service accounts. Just as we want to replace user-based service accounts with gMSA in Active Directory, wherever we can replace user objects with service principals in Entra ID, we want to do the same. For all those one-off scripts that we run as sysadmins, start looking service principals as a replacement.</p>"},{"location":"2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#consenting-to-graph-permissions","title":"Consenting to Graph permissions","text":"<p>When you create an app registration, you can go through and specify the permissions you want. In the Entra admin center portal, we must specify the permissions we want on the app registration.</p> <p>But how do we put those permissions into action? Through admin consent. Admin consent is the process of approving the requested permissions in your Entra tenant. While it may feel confusing, because app registrations and service principals serve multiple purposes for single and multi-tenant applications, even in a single-tenant app, you need to approve the permissions you are requesting.</p> <p>Admin consent has two additional and slightly confusing parts to it:</p> <ul> <li>Both the app registration and enterprise application blade in the Entra admin center have a Grant admin consent button. They both do the same exact thing. The button is added for convenience to the app registration blade. That\u2019s it. If you are creating an application that is going to be used by something like a script, it saves you the time of having to move between two different sections of the portal.</li> <li>Only a Global Administrator can grant consent to the Microsoft Graph API. Microsoft documentation will highlight that Application Administrator and Cloud Application Administrator role owners can grant consent, however, they cannot for Microsoft Graph.</li> </ul>"},{"location":"2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#putting-permissions-into-action","title":"Putting permissions into action","text":"<p>Let\u2019s walk through what it looks like to use application permissions in Entra ID.</p> <p>We\u2019ve created a new application, Cloud Application, and we\u2019ve specified and consented to the Group.Create permission.</p> <p></p> <p>For purposes of this article we\u2019ll be walking through connecting to Graph using the Microsoft Graph PowerShell SDK.</p> <p>We\u2019ve already configured our credentials, so we just specify the credentials and the tenant ID to connect to Graph. We then can also verify the context we are authenticated with by using Get-MGContext.</p> <p></p> <p>Looking at the output, we can see that we are connected as the application, and under scopes, we see the application permission assigned.</p> <p>Let\u2019s create a group.</p> <p></p> <p>We can check our audit logs and indeed see that the group was created by the Cloud Application</p> <p></p> <p></p> <p>As we only have the Group.Create permission, while we can go on a spree creating hundreds of groups, we can\u2019t update or delete them.</p> <p></p>"},{"location":"2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#when-application-permissions-can-become-tricky","title":"When application permissions can become tricky","text":"<p>We want our application to have the ability to delete groups.</p> <p>When we go into the permissions for Graph, what we\u2019ll find is that some of the precision we desire, and perhaps expect coming from the world of Active Directory, does not exist. We had a specific Group.Create permissions, so one might expect Group.Update, Group.Delete, and so on\u2026 unfortunately expectations will not be met here.</p> <p></p> <p>We can see that of the available application permissions for group, the only other options are Group.Read.All, and Group.ReadWrite.All. Group.ReadWrite.All provides us the ability to delete groups, but this ability extends across all groups in the Entra tenant.</p> <p></p> <p>Application permissions to create, manage, and delete groups</p> <p>We add our new permission, disconnect, and then reconnect to Graph. We can see our new permission is available under scopes.</p> <p></p> <p>With a simple one-liner, we can delete the group we had previously created, this time with no error.</p> <p></p> <p>We can now also add users to the group.</p> <p></p> <p>What if we want to allow the same permissions but only on certain groups? That\u2019s where application permissions start to fall short, and roles might become part of the solution.</p>"},{"location":"2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#roles-can-fill-the-application-permission-granularity-gap-somewhat","title":"Roles can fill the application permission granularity gap - somewhat","text":"<p>The problem we are facing is we want a scenario that looks like the following: the ability to only manage certain groups.</p> <p></p> <p>Our desired scenario</p> <p>With Active Directory, we could just move the groups into a sub OU and set the permissions, or if necessary, directly on the groups we wanted to allow the granular permissions for.</p> <p>With Entra ID, we can use Administrative Units similarly, but we\u2019ll find out that there are lots of caveats.</p> <p>Let\u2019s explore managing groups in an administrative unit. First, we remove all of our Graph API permissions.</p> <p></p> <p>Then we grant the Group Administrator role to Cloud Application, but we scope it to a target administrative unit.</p> <p></p> <p>We connect to Graph and run Get-MGContext to verify that we have no scopes (permissions). We can\u2019t see from Get-MGContext that we have the role assignment, but it\u2019s there.</p> <p></p> <p>Note the lack of scopes (permissions)</p> <p>We can verify that we don\u2019t have permissions across the directory by attempting to add a user to a group that exists outside the scope of our administrative unit.</p> <p></p> <p>Now let\u2019s try adding a user to a group that we have scoped to an administrative unit.</p> <p></p> <p>Great! So now we have the granular ability to update this group, and our combination of permissions and roles looks like this.</p> <p></p> <p>Role and permissions necessary to update a group in an administrative unit</p> <p>But the model we are operating with is inherently quite restrictive. In the example we know the Object ID of the group we want to modify. But what if we don\u2019t know what groups we have permissions to manage? We could enumerate the groups in the administrative unit.</p> <p>Except, we can\u2019t, at least not with the permissions and roles in scope.</p> <p></p>"},{"location":"2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#getting-into-the-thick-of-permissions-and-roles","title":"Getting into the thick of permissions and roles","text":"<p>We are starting to see that to perform actions as an application, it must either have associated permissions or roles assigned that grant the necessary actions.</p> <p>We add permissions for AdministrativeUnit.Read.All to our application.</p> <p></p> <p>And now we can enumerate the objects in our administrative unit.</p> <p></p> <p>But what if we want to enumerate users to determine who to place in the group? Again, it\u2019s another permission.</p> <p></p> <p>And if we want a way to determine if a group already exists before creating it? Yup, another permission.</p> <p></p> <p>For the handful of operations here, we now have the following permission and role model.</p> <p></p> <p>Whether it\u2019s a homegrown set of internal processes managing user or group lifecycles in Entra ID, or a software solution from an ISV, either deployed on-prem or consumed as a SaaS application, the permissions necessary can rapidly expand depending on the type of service being offered, especially if the software is providing broad management or tooling for Entra ID, or likely any M365 service.</p>"},{"location":"2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#take-the-time-to-understand-and-test-permissions-and-roles","title":"Take the time to understand, and test, permissions and roles","text":"<p>While the landscape of permissions and roles might be something less ventured, building an understanding of how they work, their strengths, their weaknesses, and the reality of how they work within Graph and Entra ID is critical to protecting our resources and enterprises. While it may be a little work upfront, refining your applications, scripts, and processes to only use the necessary permissions can go a long way in ensuring that it\u2019s not the next point of lateral movement or privilege escalation.</p>"},{"location":"2023/06/21/the-noauth-flaw-is-a-symptom-of-industry-antipatterns/","title":"The nOAuth \u201cflaw\u201d is a symptom of industry antipatterns","text":"<p>If you haven\u2019t followed the news recently, Descope released an article diving into how their security researchers were able to abuse OpenID Connect (OIDC) ID token claims to spoof the user they are authenticating as for multi-tenant SaaS applications. You can read their research article here, nOAuth: How Microsoft OAuth Misconfiguration Can Lead to Full Account Takeover (descope.com).</p> <p>In conjunction with this, Microsoft has updated developer guidance for OpenID Connect and SAML assertions, and provided a blog post covering all of this, which can be found here, The False Identifier Anti-pattern (microsoft.com).</p> <p>Multi-tenant SaaS applications are those applications, such as Canva or Sessionize, which allow you to authenticate with your Microsoft or Office 365 account. Without getting off track, this is what allows SaaS application vendors to develop applications that can integrate with an organizations Azure Active Directory environment requiring no effort on the part of administrators.</p> <p></p> <p>The Sessionize authentication screen allowing a user to select their identity provider.</p> <p>And as it goes whenever there is a security problem, someone must fall on the sword. In this case Microsoft is taking the hit; unfortunately most new articles are incorrectly reporting on this as an Azure AD \u201cflaw\u201d that Microsoft had to \u201cfix\u201d. Kudos to Kurt Mackie (@kurmac) at Redmond Mag for being the only article to accurately report on this problem, which you can find here, Microsoft Advises App Developers About \u2018nOAuth\u2019 Attack Route \u2014 Redmondmag.com. To be fair, Microsoft isn\u2019t completely innocent, as it took a case like this to really have them sharpen their guidance from a bit of a softer stance, but this is not really a technical flaw. I suppose we can\u2019t blame others for not wanting to write articles about developers using antipatterns.</p>"},{"location":"2023/06/21/the-noauth-flaw-is-a-symptom-of-industry-antipatterns/#the-real-flaw-starts-with-the-security-industry-letting-its-people-down","title":"The real flaw starts with the security industry letting its people down","text":"<p>So how exactly can we move from a technical problem to blaming the security industry as a whole? Microsoft speaks to the real flaw in their blog article \u2013 too many developers using antipatterns in software development for authentication and authorization. We can\u2019t truly blame the developers, as we shouldn\u2019t expect every developer to just magically be an expert at modern authentication. It\u2019s difficult to even get identity practitioners to accurately describe the flows many times, so how can we point the finger at others.</p>"},{"location":"2023/06/21/the-noauth-flaw-is-a-symptom-of-industry-antipatterns/#education-is-the-enemy-of-antipatterns-but-who-has-time-for-that","title":"Education is the enemy of antipatterns, but who has time for that","text":"<p>The antipattern word is key here. Antipatterns are patterns that are common enough to become known, yet go against effective design. In this case, the antipattern is developers using the email claim within an ID token to make a \u201cgood enough\u201d assessment of whom the user is.</p> <p>Antipatterns develop when there is a lack of education, which both the security and software development industry are ripe with. We need every application to do more things faster and quicker and always operating in some perpetual state of beta to ship things quicker to beat the competition. And no, we don\u2019t have time to slow down to understand what we are doing. Ship it now, fix it later, which is exactly what has happened in this case.</p>"},{"location":"2023/06/21/the-noauth-flaw-is-a-symptom-of-industry-antipatterns/#the-silos-of-security-infrastructure-and-development-hinder-progress","title":"The silos of security, infrastructure, and development hinder progress","text":"<p>The fact that most organizations still operate with varying degrees of silos is the secret everyone knows about but in most cases chooses to ignore.</p> <p>For proper modern authentication development, we need developers that cross the boundaries between identity practitioner and coder. While logically most organizations can\u2019t operate in a flat structure, we need to better adapt to remove these silos and let key players straddle the line. These key players need to be architects and engineers and developers who are allowed to cross-collaborate and want to cross-collaborate. If we enter a realm where identity security is dictated instead of collaborated, things rapidly break down.</p> <p>This collaborative team should be proportionately sized to the organization, but whether you are an identity software vendor (ISV) or an enterprise that develops line-of-business (LOB) applications, you will still greatly benefit from the collaboration around identity implementations within your software.</p>"},{"location":"2023/06/21/the-noauth-flaw-is-a-symptom-of-industry-antipatterns/#ignoring-the-need-for-change-continues-to-accrue-risk","title":"Ignoring the need for change continues to accrue risk","text":"<p>In the nOAuth case, the organizations selling SaaS applications were not named, and the problem was mitigated behind the scenes. But it\u2019s a case of luck in that the \u201cgood team\u201d was first to find the rampant use of these antipatterns. If things turned out worse, and account takeover has happened, it can become a very fast trip to the loss of consumer confidence and depending on your industry or geopolitical region regulator fines and other penalties, from data exfiltration and exposure. It also instills the fear, uncertainty, and doubt, in the industry, almost as a self-fulfilling prophecy that inhibits the industry to move forward. Imagine if your bank account could simply be taken over by someone spoofing your email address in a claim \u2013 it\u2019s a fast route to never modernizing identity and leaving us in our current state of too many accounts, too many passwords, too many ways to authenticate, failing our end users.</p>"},{"location":"2023/06/21/the-noauth-flaw-is-a-symptom-of-industry-antipatterns/#final-thoughts","title":"Final Thoughts","text":"<p>Start collaborating on identity within your organization across all the silos it touches. Prioritize education, for real this time. Your consumers will thank you for it, even if they don\u2019t know they need to.</p>"},{"location":"2022/10/12/vm-contributor-to-domain-admin-in-60-seconds/","title":"VM Contributor To Domain Admin In 60 Seconds","text":"<p>When Microsoft revamped the privileged access model in the late fall of 2020, it was received with mixed results. To some, it felt as if it was overcomplicating the simple three-tier model that had been the gold standard for protecting Active Directory and other critical business assets for about a decade.</p> <p>However, the shift was necessary, as it was acknowledging that business critical assets are not just the identity provider. The revamp changed how we look at things, with the proliferation of virtualization and cloud providers, and pointing out the management and control plane as critical privileged points of access.</p> <p></p> <p>The modern Enterprise access model, courtesy Microsoft</p> <p>It\u2019s quite a common pattern to extend Active Directory to Azure as the initial standup of infrastructure out there, to support all the other \u201cthings\u201d dependent on it.</p> <p>But as it goes with the cloud, there are new vectors to be on the watch for, and in this case, it\u2019s ensuring that your RBAC permissions over Tier 0 assets in Azure are properly defined.</p> <p>Even with a lot of strong guidance from Microsoft on the Cloud Adoption Framework (CAF) and Landing Zones, as well as adhering to the Well Architected Framework, it\u2019s not always clearly defined as to how the Enterprise access model ties into things.</p> <p></p> <p>Sample landing zone model, Identity subscription highlighted, courtesy Microsoft</p> <p>In the model depicted above, we see that Active Directory is living in its own subscription, but even when we drill into the details of that piece of the puzzle, there isn\u2019t direct guidance as far as what the RBAC model should look like over that subscription, beyond a bunch of circular references to products or how to achieve certain compliance levels. And while all this stuff is good, this is an area where sometimes it needs to be clearly spelled out.</p>"},{"location":"2022/10/12/vm-contributor-to-domain-admin-in-60-seconds/#when-permissions-go-wrong","title":"When permissions go wrong","text":"<p>When we examine the roles assigned to that identity subscription, it\u2019s important to realize that if you have certain levels of unassuming access over Domain Controller VMs it effectively provides means to gaining privileged access in Active Directory.</p> <p>If this isn\u2019t news to you, that\u2019s good. If you are still unsure what this means, or want a refresher, read on.</p> <p>Many organizations, especially those that have been in Azure a good long while before all the WAF and CAF, can range anywhere from 30 Global Administrators that are also Owners on all subscriptions (witnessed firsthand) to a NOC that has Virtual Machine Contributor to accounts separated and dedicated to the management of the Domain Controller VM\u2019s\u2026 and everything in between.</p> <p>If you\u2019re somewhere between too many Global Admins and to delegating out the Virtual Machine Contributor role, that is where you are leaving yourself exposed.</p> <p>Let\u2019s look at an example here with Isaiah Langer and the rights he has on the Domain Controller nwind-dc1:</p> <p></p> <p>Virtual Machine Contributor currently has 327 actions that compose the role, and a description</p> <p>Lets you manage the virtual machines, but not access to them, and not the virtual network or storage account they\u2019re connected to</p> <p>On the surface that sounds fine \u2013 we can\u2019t change the network configuration of the VM, and if we attempt to export the disk we are met with an error:</p> <p></p> <p>However, Isaiah does have the ability to use the Run command operation.</p> <p>Run Command leverages the VM agent installed on the machine when it\u2019s created; this requires no additional extension deployed. The VM agent runs in the SYSTEM context. And this all makes sense, needing certain privileges on the VM to be able to manage it.</p> <p>Before looking at what we can do with this Run command, we\u2019ll just look at a Domain Admin in AD. Note PasswordLastSet:</p> <p></p> <p>Back to Isaiah in the run command portal, let\u2019s try something simple:</p> <pre><code>net user da-eric P0wned1234! /domain\n</code></pre> <p></p> <p>And we hit Run.</p> <p>Twenty seconds or so later:</p> <p></p> <p>Back on the Domain Controller:</p> <p></p> <p>And we now successfully have changed the password for the Domain Admin da-eric. Considering how easy it is to glean this sort of knowledge from Active Directory, it\u2019s trivial to figure out who we want to target.</p> <p>Of course, if we would rather not disturb an existing Domain Admin, we can just create a new one:</p> <p><pre><code>net user da-isaiah P0wned1234! /add /logonpasswordchg:no /domain\n</code></pre> And then add the user to the Administrator group:</p> <pre><code>net localgroup Administrators da-isaiah /add\n</code></pre> <p>Back on the Domain Controller:</p> <p></p> <p>These are just some examples. While a threat actor may not be so obvious, it\u2019s also important to point out that once a VM contributor account is breached, the attack itself does not need to be overengineered or complicated. Whatever you can do within the SYSTEM context, you can pull off through Azure Run command with these rights.</p>"},{"location":"2022/10/12/vm-contributor-to-domain-admin-in-60-seconds/#tracking-run-command","title":"Tracking run command","text":"<p>If we look at the Azure activity logs, the Run command logs do not provide any insight into the command that ran. Look at the log below, from the last command Isaiah ran:</p> <pre><code>{\n    \"authorization\": {\n        \"action\": \"Microsoft.Compute/virtualMachines/runCommand/action\",\n        \"scope\": \"/subscriptions/6010f303-6259-4f47-bb99-9d461d36c1e4/resourceGroups/rg-lab/providers/Microsoft.Compute/virtualMachines/nwind-dc1\"\n    },\n    \"caller\": \"isaiah.langer@fabrikam.cloud\",\n    \"channels\": \"Operation\",\n    \"claims\": {\n        \"aud\": \"https://management.core.windows.net/\",\n        \"iss\": \"https://sts.windows.net/11ae06df-10e8-4b9e-bf66-2a91f4955339/\",\n        \"iat\": \"1665576850\",\n        \"nbf\": \"1665576850\",\n        \"exp\": \"1665581298\",\n        \"http://schemas.microsoft.com/claims/authnclassreference\": \"1\",\n        \"aio\": \"ATQAy/8TAAAA2Vzb2bVgvWc1B1/qZsCPq9nblD/9RdvCXf0Y87EX8swm9HGyVQXobsMvpWY7uuBp\",\n        \"http://schemas.microsoft.com/claims/authnmethodsreferences\": \"pwd\",\n        \"appid\": \"c44b4083-3bb0-49c1-b47d-974e53cbdf3c\",\n        \"appidacr\": \"2\",\n        \"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname\": \"Langer\",\n        \"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname\": \"Isaiah\",\n        \"groups\": \"310c96cf-5606-4d8d-ae59-cb698bc9fa5b,00242a6d-86d2-4351-9303-9bcf1bfb077a,c336cee6-a292-46a8-abb2-5faeb16d66d0,b04f480e-9056-45f4-be59-0ef1e2136fac,b492badd-d952-40fc-b1e8-32279fc8635e,dc61c347-aca1-4f92-bbf4-1389af8ea099,3e56b395-18bc-4305-9f6a-ac67612c912b\",\n        \"ipaddr\": \"\",\n        \"name\": \"Isaiah Langer\",\n        \"http://schemas.microsoft.com/identity/claims/objectidentifier\": \"5d2a4414-5fac-46ec-85d0-4ad537d75c77\",\n        \"onprem_sid\": \"S-1-5-21-131657314-4052732218-1597742569-2110\",\n        \"puid\": \"10032001710A0360\",\n        \"rh\": \"0.AVAA3wauEegQnku_ZiqR9JVTOUZIf3kAutdPukPawfj2MBNQAA0.\",\n        \"http://schemas.microsoft.com/identity/claims/scope\": \"user_impersonation\",\n        \"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier\": \"hf0X9izWHDY50kvXgOssXWjwzaMxLB9hLuSHj1aXPsA\",\n        \"http://schemas.microsoft.com/identity/claims/tenantid\": \"11ae06df-10e8-4b9e-bf66-2a91f4955339\",\n        \"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name\": \"isaiah.langer@fabrikam.cloud\",\n        \"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn\": \"isaiah.langer@fabrikam.cloud\",\n        \"uti\": \"gE43gRPnTU2aC5p7UGEwAA\",\n        \"ver\": \"1.0\",\n        \"xms_tcdt\": \"1629656520\"\n    },\n    \"correlationId\": \"cdd385b0-5df8-44f1-8d63-2036772306ba\",\n    \"description\": \"\",\n    \"eventDataId\": \"42f9771e-342b-4278-b78a-ca77184504ee\",\n    \"eventName\": {\n        \"value\": \"EndRequest\",\n        \"localizedValue\": \"End request\"\n    },\n    \"category\": {\n        \"value\": \"Administrative\",\n        \"localizedValue\": \"Administrative\"\n    },\n    \"eventTimestamp\": \"2022-10-12T13:00:11.66499Z\",\n    \"id\": \"/subscriptions/6010f303-6259-4f47-bb99-9d461d36c1e4/resourceGroups/rg-lab/providers/Microsoft.Compute/virtualMachines/nwind-dc1/events/42f9771e-342b-4278-b78a-ca77184504ee/ticks/638011764116649900\",\n    \"level\": \"Informational\",\n    \"operationId\": \"23192952-b8ef-4671-813e-36262ee112c3\",\n    \"operationName\": {\n        \"value\": \"Microsoft.Compute/virtualMachines/runCommand/action\",\n        \"localizedValue\": \"Run Command on Virtual Machine\"\n    },\n    \"resourceGroupName\": \"rg-lab\",\n    \"resourceProviderName\": {\n        \"value\": \"Microsoft.Compute\",\n        \"localizedValue\": \"Microsoft.Compute\"\n    },\n    \"resourceType\": {\n        \"value\": \"Microsoft.Compute/virtualMachines\",\n        \"localizedValue\": \"Microsoft.Compute/virtualMachines\"\n    },\n    \"resourceId\": \"/subscriptions/6010f303-6259-4f47-bb99-9d461d36c1e4/resourceGroups/rg-lab/providers/Microsoft.Compute/virtualMachines/nwind-dc1\",\n    \"status\": {\n        \"value\": \"Succeeded\",\n        \"localizedValue\": \"Succeeded\"\n    },\n    \"subStatus\": {\n        \"value\": \"\",\n        \"localizedValue\": \"\"\n    },\n    \"submissionTimestamp\": \"2022-10-12T13:01:24.1576475Z\",\n    \"subscriptionId\": \"6010f303-6259-4f47-bb99-9d461d36c1e4\",\n    \"tenantId\": \"11ae06df-10e8-4b9e-bf66-2a91f4955339\",\n    \"properties\": {\n        \"eventCategory\": \"Administrative\",\n        \"entity\": \"/subscriptions/6010f303-6259-4f47-bb99-9d461d36c1e4/resourceGroups/rg-lab/providers/Microsoft.Compute/virtualMachines/nwind-dc1\",\n        \"message\": \"Microsoft.Compute/virtualMachines/runCommand/action\",\n        \"hierarchy\": \"11ae06df-10e8-4b9e-bf66-2a91f4955339/6010f303-6259-4f47-bb99-9d461d36c1e4\"\n    },\n    \"relatedEvents\": []\n}\n</code></pre> <p>Note the absence of the command itself. Likewise, the VM agent has local logging, C:\\WindowsAzure\\Logs\\Plugins\\Microsoft.CPlat.Core.RunCommandWindows, but the logs themselves will not contain a copy of the command run.</p>"},{"location":"2022/10/12/vm-contributor-to-domain-admin-in-60-seconds/#its-not-just-the-azure-portal","title":"It's not just the Azure portal","text":"<p>While the examples shown here are using the Azure portal, you can perform the same commands using Azure CLI, the Azure PowerShell module Invoke-AzVMRunCommand, and the Azure Management API https://management.azure.com.</p> <p>An example from a run using Azure CLI:</p> <pre><code>isaiah@Azure:~$ az vm run-command invoke --command-id RuNPowerShellScript --name nwind-dc1 -g \"rg-lab\" --scripts \"net user da-eric P0wned1234! /domain\"\n{\n  \"value\": [\n    {\n      \"code\": \"ComponentStatus/StdOut/succeeded\",\n      \"displayStatus\": \"Provisioning succeeded\",\n      \"level\": \"Info\",\n      \"message\": \"The command completed successfully.\\n\",\n      \"time\": null\n    },\n    {\n      \"code\": \"ComponentStatus/StdErr/succeeded\",\n      \"displayStatus\": \"Provisioning succeeded\",\n      \"level\": \"Info\",\n      \"message\": \"\",\n      \"time\": null\n    }\n  ]\n}\nisaiah@Azure:~$\n</code></pre>"},{"location":"2022/10/12/vm-contributor-to-domain-admin-in-60-seconds/#mitigation-monitoring-and-recommendations","title":"Mitigation, monitoring and recommendations","text":"<p>The easiest course of action is to review who has ownership and of the subscription(s) containing Domain Controllers, as well as Virtual Machine Contributor. If those assigned are different from the staff that manages identity in your organization, investigate if the permissions can be removed/reduced. And if your Domain Controllers do not reside in their own subscription, now is the time to start planning to move them.</p> <p>Some organizations may still have standard processes to allow users who do not manage Active Directory the ability to do things like start/stop Domain Controllers, create a custom RBAC role. You can copy the Virtual Machine Contributor Role, and then use the Exclude Permissions feature to restrict the ability to use Run commands:</p> <p></p> <p>Exclude permissions is a great way to restrict certain permissions within a wildcard permission, so you don\u2019t need to manually define all the VirtualMachine permissions permitted.</p> <p>After building the custom role, assign it to whomever currently has Virtual Machine Contributor over Domain Controllers. Once you do, what you\u2019ll find is that the user will still have the visibility of Run command in the portal, but Azure will blackhole the process if a user attempts to use it.</p> <p>For management of critical Tier 0 VM\u2019s like Domain Controllers, PIM should be used for role elevation, even if it\u2019s to a role that has the Run command permissions removed. Remember, you can mix and match licenses \u2013 go buy some AAD P2 licenses for your organization to cover management of Tier 0 assets if P2 across the organization is not something on the financial forecast.</p> <p>Organizationally some may accept the risk here, which you shouldn\u2019t, as Mandiant indicates they have seen this actively exploited in incident response cases.</p> <p>Last thing, whether you mitigate or don\u2019t, a takeaway here is why it\u2019s critical to have robust monitoring of critical groups and users in Active Directory, and even better have an Identity Threat Detection and Response (ITDR) platform in place.</p>"},{"location":"2022/03/23/windows-hello-for-business-hybrid-cloud-trust/","title":"Windows Hello for Business: Hybrid Cloud Trust","text":"<p>When we talk about Windows Hello for Business (WHfB) rollout scenarios, the one that has consistently been the preferred path is Hybrid Key Trust. It is the lowest weight scenario for deployment requirements, and if you already had Active Directory Certificate Services (AD CS), it was only a matter of a few hours to configure your directory to be ready to start a rollout.</p> <p>While there are some smaller niche limitations, the most common limitation that every organization will encounter with Hybrid Key Trust, is that initial Windows of needing to wait for Azure AD Connect to synchronize the msDS-KeyCredentialLink attribute from Azure AD to the user object in Active Directory.</p> <p>This process is what informs Active Directory of the public side of the users WHfB key pair, and is what enables the user for certificate-based authentication, through WHfB, to AD. Historically this leaves many organizations needing to communicate to users that it will \u201ctake some time\u201d between when they enroll and when they can first start using WHfB \u2013 not the greatest way to introduce users into a passwordless experience.</p> <p>Note</p> <p>I\u2019ve received feedback from readers who have gone through this post, and following up with me that for their users who were already enrolled in Windows Hello for Business with Hybrid Key Trust are having issues with authentication when switching to Hybrid Cloud Trust.</p> <p>From my own conversations with folks at Microsoft, the path explained in this document is how an organization would go about switching existing Hybrid Key Trust users to Hybrid Cloud Trust.</p>"},{"location":"2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#enter-hybrid-cloud-trust","title":"Enter Hybrid Cloud Trust","text":"<p>The technology behind WHfB Hybrid Cloud Trust has existed for a while; it\u2019s the same mechanism that has been used to support hybrid FIDO2 Security Key authentication.</p> <p>Microsoft already has some very good documentation, Passwordless security key sign-in to on-premises resources \u2013 Azure Active Directory | Microsoft Docs, that explains how the whole process works, so I won\u2019t dive deep into paraphrasing things. But essentially we now are able to obtain a partial TGT from Azure AD, and subsequently exchange that for a full TGT in AD. Because of this key piece, we no longer need to wait for Azure AD Connect to inform AD of our users public key.</p>"},{"location":"2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#why-should-i-convert","title":"Why should I convert?","text":"<p>If you\u2019re asking yourself why you would want to convert from a Hybrid Key Trust to a Hybrid Cloud Trust, there are several benefits:</p>"},{"location":"2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#goodbye-pki","title":"Goodbye PKI","text":"<p>In reality, if you have a PKI in your environment, you likely are using it for several things. However, you will no longer need to maintain certificates on your Domain Controllers to be used for certificate-based authentication. That partial TGT is all you\u2019ll need to obtain a full Kerberos TGT from Active Directory.</p>"},{"location":"2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#no-more-enrollment-delays","title":"No more enrollment delays","text":"<p>Not having to wait for the sync back to AD of msDS-KeyCredentialLink, users will be able to use their WHfB credentials immediately after enrollment.</p>"},{"location":"2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#sets-the-stage-for-fido2-security-keys","title":"Sets the stage for FIDO2 security keys","text":"<p>The mechanisms to configure Hybrid Cloud Trust is the same leveraged for FIDO2 Security Key authentication in a hybrid scenario. This puts your environment in a great position to start exploring FIDO2 if you have not already.</p>"},{"location":"2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#convert-to-hybrid-cloud-trust","title":"Convert to Hybrid Cloud Trust","text":""},{"location":"2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#prerequisites","title":"Prerequisites","text":"<p>You\u2019ll need to first configure your tenant to support the ability for Azure AD to issue a Kerberos TGT for your Active Directory domain. I won\u2019t run through the process here, but it\u2019s straightforward, and the instructions can be found here, Passwordless security key sign-in to on-premises resources \u2013 Azure Active Directory | Microsoft Docs.</p>"},{"location":"2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#method-for-conversion","title":"Method for conversion","text":"<p>Microsoft has documented both the mechanisms for enabling Hybrid Cloud Trust through both Intune and Group Policy; here we will be examining the GPO route. The Microsoft documentation regarding the enablement of Hybrid Cloud Trust can be found here, Hybrid Cloud Trust Deployment (Windows Hello for Business) \u2013 Windows security | Microsoft Docs.</p> <p>Let\u2019s take a look at our existing GPO settings, which can be found under Computer Configuration, Windows Components, Windows Hello for Business:</p> <p></p> <p>Note</p> <p>While we can enable WHfB either as a Computer or User Configuration, the ability to modify the trust model only exists under the Computer Group Policy.</p> <p>The setting we want to toggle is Use cloud trust for on-premises authentication:</p> <p></p> <p>We just need to select OK to save our policy change, and let (or force) our clients pick up the changed GPO.</p> <p>Warning</p> <p>If you do not find the option for Use cloud trust for on-premises authentication within your GPO, you likely need to update your ADMX templates to a newer version.</p> <p>And that's it. The devices scoped to this group policy will be configured for Hybrid Cloud Trust.</p>"},{"location":"2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#verification-transition-and-cleanup","title":"Verification, transition, and cleanup","text":""},{"location":"2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#verification","title":"Verification","text":"<p>Info</p> <p>Please note that the process explained below for verification is not a required process. This verification piece is provided to explain the steps that would invalidate any local certificates in Active Directory, to ultimately prove that Hybrid Cloud Trust is working. For migration purposes, you only need to perform the group policy change indicated above.</p> <p>So we have our GPO updated and refreshed on our client. How can we tell that the device is in fact using Hybrid Cloud Trust and not Hybrid Key Trust?</p> <p>After the configuration change, we can look at some Event Viewer logs. If we expand Applications and Services Logs, Microsoft, Windows, Hello for Business, Operational, we can see the following Event that shows the device configured and having obtained a Cloud TGT:</p> <p></p> <p>We can further test things by deleting the msDS-KeyCredentialLink contents on the user object within Active Directory.</p> <p>If we look at Lee Gu, we can see there is a public key on his account in AD:</p> <p></p> <p>We can easily clear this, and then verify the attribute is empty:</p> <p></p> <p>After another sign-on with WHfB, we can go look at our Security logs in Active Directory, and find a successful 4624:</p> <p></p>"},{"location":"2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#transition","title":"Transition","text":"<p>Even though the transition has no visible impact on our end users, many organizations may still want to take a staged approach to transition to a Hybrid Cloud Trust. To that point, because we are altering the mechanism for authentication on a per-device level, there is nothing stopping an organization from moving to a Hybrid Cloud Trust in a staged approach.</p> <p>Long-term, from a troubleshooting perspective, it would behoove most organizations to not draw out the transition. Conversely, if an organization has edge use cases that are only supported by a Hybrid Key Trust, those users and their devices should still be able to continue to use Hybrid Key Trust while the rest of the organization operates with Hybrid Cloud Trust.</p>"},{"location":"2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#cleanup","title":"Cleanup","text":"<p>While in the demonstration above, we see that authentication happens without the need for the msDS-KeyCredentialLink to be populated in Active Directory, the behavior of Azure AD Connect is to still synchronize that value back ton AD, even for a Hybrid Cloud Trust. Remember \u2013 we are still performing asymmetric key-based authentication to Azure AD, so there is still a keypair that exists. The behavior change is on the client; the public key in the way it is written to Azure AD appears to have no mechanism to differentiate the type of authentication the client intends with it. Due to this, downstream, Azure AD Connect is still going to synchronize back to Active Directory the public key. I would be curious if Microsoft has intentions to modify this behavior down the road, but for the meantime, we can just ignore those attributes in AD.</p> <p>At this point, we can also evaluate whether to roll back the certificate policies issuing certs to our DC\u2019s for certificate-based authentication. If configured properly, this process should be no-maintenance, so it\u2019s not a critical item, but likely should be removed to clear up any confusion down the road. Would also caution though to ensure that you do not negatively impact anything else that might be leveraging AD for certificate-based auth before backing that out of Active Directory.</p>"},{"location":"2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#faq","title":"FAQ","text":""},{"location":"2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#do-i-still-need-line-of-sight-of-active-directory-for-enrollment","title":"Do I still need line-of-sight of Active Directory for enrollment?","text":"<p>Yes. For the underlying mechanisms that configure Windows for a cached sign-on experience, line-of-sight is required for Active Directory during the first use of the WHfB credentials that were configured.</p>"},{"location":"2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#what-identity-provider-is-authoritative-for-the-client","title":"What Identity Provider is Authoritative for the client?","text":"<p>One of the topics that almost always comes up when talking about a Hybrid device, is what Identity Provider (IdP) is authoritative for user authentication \u2013 Azure AD or Active Directory. This question arises because there is this duality of identity on the device; our user object is tied to two different identity providers. However, one of the identity providers is still considered the authoritative identity provider. The authoritative identity provider is the one that would handle things like providing account lockout for a disabled user account.</p> <p>For Hybrid Key Trust, Active Directory was authoritative, and Azure AD was secondary \u2013 you would receive/refresh your PRT after successful authentication to AD.</p> <p></p> <p>With Hybrid Cloud Trust, the model is now flipped, and Azure AD is authoritative, with AD as secondary.</p> <p></p> <p>We can observe this behavior in the security events on the device. When you first sign in to the device, you will receive a 4624 user logon event with a logon type of 11, which is cached interactive. This is observed even with line-of-sight of Active Directory. Very soon after, if you have line-of-sight of Active Directory, you will see another 4624 user logon event with a type of 7, which normally indicates workstation unlock.</p> <p>Now, during testing, you will notice that even if the user account is disabled in Azure AD and Active Directory, even with line-of-sight of both AAD and AD, local logon will still occur. However, when the user attempts to access cloud-based resources, they will receive an error in thick-client applications like Teams indicating they need to sign in (which will fail), and through the web, they will be informed their account is locked out. For AD resources, access will also be denied, and in the security event log, we will find a failed sign-on event, with a failure indicating the account is currently disabled.</p>"},{"location":"2022/03/23/windows-hello-for-business-hybrid-cloud-trust/#final-notes","title":"Final notes","text":"<p>If you\u2019ve happened to read this whole post and your organization is not using WHfB yet, now is a great time to strengthen the security posture of your organization, and to start examining what it takes to go passwordless.</p> <p>If you\u2019ve rolled out Windows Hello for Business, and want to take a look at what the next steps are to eliminating the use of passwords for those passwordless people, take a look at my post on SCRIL, Living in a Passwordless World: Password Management \u2013 Eric on Identity.</p>"},{"location":"2022/05/04/world-password-day/","title":"World Password Day","text":"<p>Forget passwords. Passwords are garbage. To celebrate World Password Day, I\u2019m curating blog articles that can help organizations on their passwordless journey.</p> <p>While much of the Microsoft documentation on passwordless is quite good, it can tend to be overwhelming at times; the hope is to give you some great leads on some clear, step-by-step instructions on how to get you from a password-filled to a passwordless world in Active Directory and Azure AD.</p> <p>With each link, I\u2019ve provided a rough time estimate for how long the process should take, given a dedicated effort. There may always be the fringe case or two where passwordless is more complex \u2013 if your existing environment has things such as AD FS and using smartcards, or has DC\u2019s older than 2016, you have a bunch of Macs in your environment, as examples. It always helps to review the documentation, which I also link to.</p> <p>If you want to dive further into why this is so important, I\u2019ll refer you to these two blog articles from Alex Weinert [@Alex_T_Weinert], the Director of Identity Security at Microsoft.</p> <p>Your Pa$$word doesn\u2019t matter \u2013 Microsoft Tech Community \u2013 Alex discusses why MFA is so important.</p> <p>All your creds are belong to us! \u2013 Microsoft Tech Community \u2013 Alex discusses why passwordless strong authentication is important and shows why more common forms of MFA are still phishable.</p> <p>See something missing? Still have questions? Not sure how the underlying technology works? Reach out to me.</p> <p>And if you are a fellow Microsoft blogger who thinks their article would be a good fit, but it\u2019s not on here? Reach out and I\u2019ll update accordingly.</p>"},{"location":"2022/05/04/world-password-day/#but-i-havent-started-the-passwordless-journey-yet","title":"But I haven't started the passwordless journey yet","text":"<p>You aren\u2019t alone. Many organizations find it difficult to fit yet another new project onto the docket.</p> <p>The thing about passwordless \u2013 while it may be a journey, it\u2019s also one of the easiest journeys to start. All major mechanisms of passwordless \u2013 Windows Hello for Business (WHfB), FIDO2 security keys, Authenticator App for primary authentication, and smartcards \u2013 they all can be implemented in a wave/phase/ring (pick your favorite descriptor) approach. And the underlying directory &amp; infrastructure changes (if any) can be implemented in a non-disruptive manner.</p> <p>Can\u2019t get the whole organization onboard? That\u2019s ok, x% is better than 0%.</p> <p>Don\u2019t have biometrics on all your devices? WHfB has PIN support.</p> <p>End-users not wanting to MDM enroll their devices? Authenticator App only requires Device Registration.</p> <p>FIDO2 feel odd or uncomfortable? It\u2019s essentially modern smartcards.</p> <p>Have some applications that still use legacy means of authentication? Most organizations do, but we can minimize the need to use passwords beyond them.</p> <p>Concerned users may still use their password because you can\u2019t fully get rid of it? When we give users an easier passwordless experience, they will not opt for something more complex. Users love easy things.</p> <p>When talking about the security of identity, the most important thing we can all do is change our mindset. Instead of focusing on the possibility that a single solution may not cover 100% of user personas, we need to focus on whatever percentage we can cover, which will reduce the password attack surface immensely for those users, and our organization.</p>"},{"location":"2022/05/04/world-password-day/#authenticator-app-for-primary-authentication","title":"Authenticator App for primary authentication","text":"<p>Infrastructure effort: 5-10 minutes End user enrollment effort: 5-10 minutes Can be rolled out selectively: Yes Can be enabled on an end user without forcing them to enroll: Yes</p> <p>Lots of folks might be familiar with the Microsoft Authenticator App, but did you know you can use it for passwordless authentication? You can. It\u2019s great for when users need to be passwordless when accessing company resources from a mobile device, or when they are on the go and need to auth through a web browser.</p> <p>Jason Samuel [@_JasonSamuel] has a good write-up here covering enablement. He also gets into Citrix Workspace stuff, but even if you don\u2019t have Citrix in your environment, the other parts are written straightforward:</p> <p>How to setup password-less phone sign-in authentication with Microsoft Authenticator, Azure AD, and Citrix Workspace \u2013 JasonSamuel.com</p> <p>Microsoft Docs article for reference can be found here:</p> <p>Passwordless sign-in with the Microsoft Authenticator app \u2013 Azure Active Directory | Microsoft Docs</p> <p>Info</p> <p>If you are also using the number matching preview for Authenticator App push notifications, the passwordless configuration is covered under the same settings in Azure AD. If you are using groups to selectively roll out these settings, I cover targeting groups here:</p> <p>Azure AD: Increasing Security within the MFA Experience \u2013 Eric on Identity</p>"},{"location":"2022/05/04/world-password-day/#fido2-security-keys","title":"FIDO2 Security Keys","text":"<p>Infrastructure effort: 20 minutes for AADJ devices. 40 minutes for HAADJ devices. End user enrollment effort: 5-10 minutes Can be rolled out selectively: Yes Can be enabled on an end user without forcing them to enroll: Yes</p> <p>FIDO2 security keys are the latest and greatest thing \u2013 it\u2019s based on asymmetric cryptography \u2013 what we generally refer to as certificates (even though a key is a piece within a certificate).</p> <p>Many organizations that have never operated in a highly secure environment where smartcards are prevalent may find the idea of a device containing a certificate for authentication seeming a bit odd. But we should look at FIDO2 security keys as smartcard 2.0 \u2013 it\u2019s all the great security features of smartcards, but packed and managed in a way that makes it easier to manage from both the IT and end-user side.</p> <p>For a great deep dive on how FIDO2 works, look at this article by Dominik Hoefling [@DominikHoefling]:</p> <p>Understanding How FIDO Makes Passwordless Authentication Possible (practical365.com)</p> <p>To see how to configure your environment to support FIDO2 for Azure AD Joined devices, Peter Klapwijk [@inthecloud_247] has us covered. He uses Feitian keys but any supported FIDO2 key will work:</p> <p>Enable passwordless authentication to Windows 10 with Feitian security keys | (inthecloud247.com)</p> <p>Peter also has a great article covering the same, but for Hybrid Azure AD Join:</p> <p>Enable passwordless security key sign-in in Hybrid Azure Active Directory environments | (inthecloud247.com)</p> <p>Microsoft Docs articles for reference can be found here:</p> <p>Passwordless security key sign-in \u2013 Azure Active Directory | Microsoft Docs</p> <p>Passwordless security key sign-in Windows \u2013 Azure Active Directory | Microsoft Docs</p> <p>Passwordless security key sign-in to on-premises resources \u2013 Azure Active Directory | Microsoft Docs</p>"},{"location":"2022/05/04/world-password-day/#windows-hello-for-business","title":"Windows Hello for Business","text":"<p>Infrastructure effort: 20 minutes [Azure AD Join Cloud Trust], 1-2 hours [Hybrid Cloud Trust], 2 hours-3 days [Hybrid Key Trust] End user enrollment effort: 2-5 minutes (plus 30-60 usability delay for Hybrid Key Trust) Can be rolled out selectively: Yes Can be enabled on an end user without forcing them to enroll: No There are mechanisms that can delay end-user enrollment, but the complexity usually is not worth the effort</p> <p>Windows Hello for Business. It\u2019s like Face ID, for Windows. Or is Face ID like Windows Hello for Business, but for iOS??</p> <p>If you don\u2019t have a fancy camera, it also works with your fingerprint. And if you have no fancy biometric thingies, you can use it with just a PIN. But wait, isn\u2019t a PIN the same as a password? NO. The PIN is entropy to unlock the key/certificate that is stored on the TPM chipset on your device. It\u2019s never emitted beyond the device. And yes, you always must create a PIN \u2013 the same way you always must create a PIN for mobile devices as backup for biometric\u2026 just in case.</p> <p>Also \u2013 if you are rolling out Hybrid Key Trust, you do not, I repeat, do not, need any premium licenses. The issue many organizations have theoretically faced is that to enroll in WHfB, you hit the part where you need to perform MFA, and organizations that do not have P1+/EMS E3+/M365 E3+ (and the variants) believe that they cannot use MFA. That is not the case. You need premium licensing when certain things are calling for MFA \u2013 such as per-user enablement (which is an O365 license thing), or more commonly thought of, conditional access. When Azure AD calls for MFA for WHfB enrollment, that MFA call is free. Considering that security defaults, which are also free, call for MFA potentially, this should be less of a concern. But it\u2019s always been a huge point of confusion. I learned about this in excruciating detail when I worked at Microsoft, rolling out WHfB with customers. Based on what I can gather regarding Hybrid Cloud Trust, I would say the case is the same. /endrant</p> <p>If you have Azure AD Joined devices and are looking to go cloud-only, Janusz Gal [@JanuszGal] has you covered with his article here:</p> <p>How to set up Windows Hello for Business for cloud-only devices \u2013 Device Advice</p> <p>If you want to ensure that those devices can still reach Active Directory based resources, look no further than this article by Ben Whitmore [@byteben] and Michael Mardahl [@michael_mardahl]:</p> <p>SSO to domain resources from Azure AD Joined Devices \u2013 The MEGA Series \u2013 Part 1 \u2013 Overview \u2013 MSEndpointMgr</p> <p>For rolling out what previously was (and technically still is, because Cloud Trust is in Public Preview) the recommended path for hybrid devices, Hybrid Key Trust, check out this article by Brooks Peppin [@brookspeppin]:</p> <p>How to Setup Windows Hello for Business (Key-Trust Method!) \u2013 Brooks Peppin\u2019s Blog</p> <p>For what will eventually become the recommended path for hybrid devices, Hybrid Cloud Trust, see this article by Pim Jacobs [@pimjacobs89]:</p> <p>Improving your Windows Hello for Business Hybrid Password less setup by using Cloud Trust \u2013 Identity Man (identity-man.eu)</p> <p>If you are curious what it looks like to convert from Hybrid Key Trust to Hybrid Cloud Trust, check out my article:</p> <p>Windows Hello for Business: Hybrid Cloud Trust \u2013 Eric on Identity</p> <p>And if you are far enough down the passwordless road that you want to take them away from end users, then check out this article I wrote:</p> <p>Living in a Passwordless World: Password Management \u2013 Eric on Identity</p> <p>Microsoft Docs articles for reference can be found here:</p> <p>Azure Active Directory join cloud only deployment \u2013 Windows security | Microsoft Docs</p> <p>Hybrid Cloud Trust Deployment (Windows Hello for Business) \u2013 Windows security | Microsoft Docs</p> <p>Hybrid Key Trust Deployment (Windows Hello for Business) \u2013 Windows security | Microsoft Docs</p> <p>Hybrid Certificate Trust Deployment (Windows Hello for Business) \u2013 Windows security | Microsoft Docs</p> <p>Azure AD Join Single Sign-on Deployment \u2013 Windows security | Microsoft Docs</p>"},{"location":"2022/05/04/world-password-day/#some-great-additional-resources","title":"Some great additional resources","text":"<p>Fabian Bader [@fabian_bader] has a long series on passwordless:</p> <p>Passwordless \u2013 Category \u2013 Cloudbrothers</p> <p>Jan Bakker [@janbakker_] has some quality articles covering FIDO2:</p> <p>FIDO \u2013 JanBakker.tech</p> <p>Harri Jaakkonen[@HarriJaakkonen] is constantly putting out new articles, and lots that cover passwordless:</p> <p>Set-AzWebApp -name \u201cAnything Microsoft and other stuff on the side\u201d (cloudpartner.fi)</p>"},{"location":"2022/05/04/world-password-day/#final-notes","title":"Final notes","text":"<p>Passwords will eventually have an expiration date. It\u2019s better to start the journey away from them now, than get caught behind the ball down the road.</p>"},{"location":"archive/2025/","title":"2025","text":""},{"location":"archive/2024/","title":"2024","text":""},{"location":"archive/2023/","title":"2023","text":""},{"location":"archive/2022/","title":"2022","text":""},{"location":"archive/2021/","title":"2021","text":""},{"location":"page/2/","title":"Home","text":""},{"location":"page/3/","title":"Home","text":""},{"location":"archive/2022/page/2/","title":"2022","text":""}]}