
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://new.ericonidentity.com/">
      
      
      
        <link rel="next" href="archive/2025/">
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>Eric on Identity</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.2a3383ac.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.06af60db.min.css">
      
      


  
  
    
      
      
        
      
      
    
  
  
  <style>:root{.md-tag.md-tag--nfc{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22M23.958%201.98C23.895%201%2023.143.256%2022.145.197c-1.102-.066-4.668-.12-5.693-.12%201.832%201.264%202.082%203.644%202.255%208.066.101%202.62.01%2011.799.002%2012.188l-.049%202.504-9.628-9.63v-3.014l7.656%207.658c.02-1.516.04-3.492.04-5.299%200-1.76-.026-3.354-.076-4.193-.288-4.819-.737-7.077-3.253-7.962-.77-.27-1.487-.335-2.683-.351C9.728.032%202.848.037%201.854.091.8.147.09.914.042%201.9c-.048.977-.064%2019.174%200%2020.165.062.98.815%201.724%201.812%201.782%201.102.067%204.668.075%205.694.075-1.832-1.264-2.083-3.643-2.255-8.066-.1-2.62-.009-11.8%200-12.188l.047-2.504%209.629%209.63v3.013L7.312%206.152c-.02%201.514-.04%203.49-.04%205.298%200%201.76.026%203.354.077%204.192.288%204.82.736%207.077%203.252%207.962.77.271%201.487.337%202.683.352.987.012%207.868.006%208.861-.047%201.056-.056%201.765-.822%201.813-1.811.048-.976.064-19.127%200-20.118%22/%3E%3C/svg%3E');}}</style>

    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="Eric on Identity" class="md-header__button md-logo" aria-label="Eric on Identity" data-md-component="logo">
      
  <img src="images/eidlogo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Eric on Identity
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Home
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="Eric on Identity" class="md-nav__button md-logo" aria-label="Eric on Identity" data-md-component="logo">
      
  <img src="images/eidlogo.svg" alt="logo">

    </a>
    Eric on Identity
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
    
      
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
      <a href="." class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Archive
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="archive/2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2025
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="archive/2024/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2024
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="archive/2023/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2023
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="archive/2022/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2022
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="archive/2021/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2021
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-09-02 00:00:00+00:00">September 2, 2025</time></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="entra-useless-insights-report"><a class="toclink" href="2025/09/02/entra-useless-insights-report/">Entra Useless Insights Report</a></h2>
<p>Yes. The name is snarky on purpose.</p>
<p>With the drive to using phishing-resistant MFA something on the mind of many organizations, I‚Äôve been taking a look at the Usage &amp; Insights Report features in Entra, specifically the <strong>Authentication methods</strong> activity report.</p>
<p>Enumerating the type of authentication methods registered on a user, on a per-user basis, can be time consuming, and would become untenable in extremely large organizations.</p>
<p>Authentication methods activity reporting to the rescue ‚Äì right? Not so much.</p>
<p>In digging into the report, whether it‚Äôs through the <a href="https://entra.microsoft.com/#view/Microsoft_AAD_IAM/AuthenticationMethodsMenuBlade/~/AuthMethodsActivity/menuId/AuthMethodsActivity">Entra admin center</a> or through Microsoft Graph PowerShell SDK, the data reported through this is just astoundingly awful if you want to try and build some basic measurements around who is actually registered for passkeys (FIDO2); I haven‚Äôt looked to see if it‚Äôs as awful with other methods.</p>
<p>Luckily in the tenant I‚Äôm examining, there are only a few hundred user objects, so it‚Äôs also feasible to enumerate each user the long way, which I‚Äôll cover below as the workaround. I‚Äôve posed a complaint to Microsoft in some channels and have yet to hear anything back, other than similar experiences from a few others.</p>
<h3 id="the-problem"><a class="toclink" href="2025/09/02/entra-useless-insights-report/#the-problem">The Problem</a></h3>
<p>I‚Äôm focused on finding users registered for passkeys in Entra, and by passkeys I mean using the Microsoft Authenticator App on either Android or iOS devices.</p>
<p>The behavior I‚Äôm seeing has been problematic over the last month, but I suspect the report has been broken for quite some time.</p>
<p>In this instance, I go into the Usage &amp; Insights reports, Authentication methods, and filter by <strong>Method: Passkey (Microsoft Authenticator)</strong>, and I see the following:</p>
<p><img alt="Figure 1" src="/images/2025/09/02/img1.png" /></p>
<p>But based on what I know, that seems way off, so I decide to run a Graph PowerShell SDK command and get the same results:</p>
<div class="highlight"><pre><span></span><code>(Get-MgReportAuthenticationMethodUserRegistrationDetail `
 -Filter &quot;methodsRegistered/any(x:x eq &#39;passKeyDeviceBoundAuthenticator&#39;)&quot; `
 | Select-Object -Property UserPrincipalName).count
54
</code></pre></div>
<p>Note that in Graph <strong>passkeyDeviceBoundAuthenticator</strong> is what differentiates this from just <strong>passkeyDeviceBound</strong>, which would include FIDO2 security keys.</p>
<p>Back to the point, this number is low, and it‚Äôs been historically low. One thing that I find interesting, and while I‚Äôm redacting the actual data, is when I run:</p>
<div class="highlight"><pre><span></span><code>Get-MgReportAuthenticationMethodUserRegistrationDetail `
 -Filter &quot;methodsRegistered/any(x:x eq &#39;passKeyDeviceBoundAuthenticator&#39;)&quot;
</code></pre></div>
<p>and examine the <strong>LastUpdatedDateTime</strong> value, for most of the users it‚Äôs showing a date that is about a week old. I know that Usage &amp; Insights reports are not real-time; trying to think back to my Microsoft days, in my head the delay I thought was roughly two hours. But there are other issues ‚Äì a user who has registered for a passkey back in Feburary 2025 is missing from the report. If the report never does anything to reconcile itself, it‚Äôs of zero value.</p>
<p>To spot check this user I run:</p>
<p><div class="highlight"><pre><span></span><code>Get-MgReportAuthenticationMethodUserRegistrationDetail `
 -Filter &quot;methodsRegistered/any(x:x eq &#39;passKeyDeviceBoundAuthenticator&#39;)&quot; `
 | Select-Object -Property UserPrincipalName,LastUpdatedDateTime `
 | Where-Object {$_.UserPrincipalName -eq &quot;user@domain.com&quot;}
</code></pre></div>
And receive nothing back.</p>
<p>I went to check the Microsoft docs here, <a href="https://learn.microsoft.com/en-us/entra/identity/monitoring-health/concept-usage-insights-report?tabs=microsoft-entra-admin-center?WT.mc_id=SEC-MVP-5005105">Usage and insights report ‚Äì Microsoft Entra ID | Microsoft Learn</a>, to see if there is any details around the frequency this runs or known issues, but found nothing.</p>
<h3 id="the-workaround"><a class="toclink" href="2025/09/02/entra-useless-insights-report/#the-workaround">The Workaround</a></h3>
<p>So, it‚Äôs back to doing essentially what the report should do, which is enumerate all users within Entra.</p>
<p>Of course, Microsoft specifically recommends that you don‚Äôt do this in the docs, <a href="https://learn.microsoft.com/en-us/graph/api/resources/authenticationmethods-overview?WT.mc_id=SEC-MVP-5005105">Microsoft Entra authentication methods API overview ‚Äì Microsoft Graph v1.0 | Microsoft Learn</a>, where they state:</p>
<p><em>We don‚Äôt recommend using the authentication methods APIs for scenarios where you need to iterate over your entire user population for auditing or security check purposes. For these types of scenarios, we recommend using the <a href="https://learn.microsoft.com/en-us/graph/api/resources/authenticationmethods-usage-insights-overview?WT.mc_id=SEC-MVP-5005105">authentication method registration and usage reporting APIs</a> (available on the beta endpoint only).</em></p>
<p>registration and usage reporting APIs (available on the beta endpoint only).</p>
<p>The code I slapped together is a mix of my brain and some vibe coding, it ended up looking like the following, with a bit of parralel processing thrown in:</p>
<div class="highlight"><pre><span></span><code># Authenticator App AAGUIDS
$targetAAGUIDs = @(
    &#39;90a3ccdf-635c-4729-a248-9b709135078f&#39;,
    &#39;de1e552d-db1d-4423-a619-566b625cdc84&#39;
)

# Grab all users
#$AllEmployees = Get-MgBetaUser -All -Filter &quot;userType eq &#39;Member&#39;&quot; -Property Id,UserPrincipalName

# Run up to 10 employees in parallel
$PasskeysRegistered =
    $AllEmployees |
    ForEach-Object -Parallel {

        $emp = $_

        $fidos = Get-MgBetaUserAuthenticationFido2Method -UserId $emp.Id -All -ErrorAction SilentlyContinue |
                 Where-Object { $_.AaGuid -in $using:targetAAGUIDs }

        foreach ($key in $fidos) {
            [pscustomobject]@{
                UserPrincipalName       = $emp.UserPrincipalName
                ObjectId     = $emp.Id
                Passkey      = $key.Model
                RegisteredOn = $key.CreatedDateTime
            }
        }
    } -ThrottleLimit 10

$PasskeysRegistered
</code></pre></div>
<p>And then if I run a count, and ensure I‚Äôm focused on unique users, since the results could have multiple entries for some users:</p>
<div class="highlight"><pre><span></span><code>($PasskeysRegistered | Select-Object -Property UserPrincipalName -Unique).count
92
</code></pre></div>
<p>Further, if I go search for my missing user, sure enough they are there:</p>
<div class="highlight"><pre><span></span><code>$PasskeysRegistered | Where-Object {$_.UserID -eq &quot;user@domain.com&quot;}

UserID              ObjectId                             Passkey                       RegisteredOn
------              --------                             -------                       ------------
user@domain.com     xxxxx                                Microsoft Authenticator - iOS 2/27/2025 10:23:40 PM
</code></pre></div>
<p>As a side not the problem, one could theorize something was broken around that time in Entra, and hence the user somehow fell off the report. But I can actually find another user on the report who registered within twenty minutes of the missing user ü§î.</p>
<h3 id="the-takeaway"><a class="toclink" href="2025/09/02/entra-useless-insights-report/#the-takeaway">The Takeaway</a></h3>
<p>Don‚Äôt trust Usage &amp; Insights reports for passkey reporting. Hopefully this post can become irrelevant down the road.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-02-20 00:00:00+00:00">February 20, 2025</time></li>
        
        
          
          <li class="md-meta__item">
            
              5 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="an-interesting-m365-billing-scam"><a class="toclink" href="2025/02/20/an-interesting-m365-billing-scam/">An Interesting M365 Billing Scam</a></h2>
<h3 id="update"><a class="toclink" href="2025/02/20/an-interesting-m365-billing-scam/#update">Update</a></h3>
<p>I called the 888 number this morning and it does indeed go to a scam call center. I played along with the person on the other end, who ultimately wanted my first and last name, email address, the order number, and most importantly, my credit card number, so they ‚Äúcould reverse the charge‚Äù ü§£</p>
<h3 id="the-scam"><a class="toclink" href="2025/02/20/an-interesting-m365-billing-scam/#the-scam">The Scam</a></h3>
<p>This is a case where I‚Äôd actually love to see how this plays out ‚Äì when you see the way that scammers try to string things together. I‚Äôve been receiving a rash of unpaid toll bill texts, which give themselves away pretty easily based on the source number. But I‚Äôm not here to talk about that scam.</p>
<p>Instead, I‚Äôm here to dig into this email I received last week:</p>
<p><img alt="Figure 1" src="/images/2025/02/20/img1.png" /></p>
<p><em>Last time I checked, I‚Äôm not Molly Wagner</em></p>
<p>It looked authentic, and when I checked the headers, it is indeed from Microsoft. I do subscribe to various Microsoft services and receiving emails like this are not abnormal, but I was certainly confused by the service, as well as who it was to.</p>
<p>I scroll down a bit more into the rest of the email:</p>
<p><img alt="Figure 1" src="/images/2025/02/20/img2.png" /></p>
<p>Notice anything unusual? At first, I didn‚Äôt. To give myself props, even though it all seemed legitimate, I didn‚Äôt click on the link.</p>
<p>But when I saw the domain JacksonLyons.onmicrosoft.com I decided to go look it up over at <a href="https://aadinternals.com/osint/">https://aadinternals.com/osint/</a>. The results:</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Default domain</td>
<td>JacksonLyons.onmicrosoft.com</td>
</tr>
<tr>
<td>Tenant name</td>
<td>null</td>
</tr>
<tr>
<td>Tenant brand</td>
<td>Microsoft We appreciate your purchase and have finished your recent order for 592.99 USD. Please contact us at (888) 929-1904 for help or cancelation.</td>
</tr>
<tr>
<td>Tenant id</td>
<td>6cc54dbc-77fb-44e7-9c6f-ca766a8e26b1</td>
</tr>
<tr>
<td>Tenant region</td>
<td>NA</td>
</tr>
<tr>
<td>Seamless single sign-on (SSSO)</td>
<td>disabled</td>
</tr>
<tr>
<td>Uses Azure AD Connect cloud sync</td>
<td>N/A</td>
</tr>
<tr>
<td>Certificate-based authentication (CBA)</td>
<td>N/A</td>
</tr>
</tbody>
</table>
<p>The results make me wonder if the tenant is turned off on the Microsoft side, as there are no verified domains, but there is a Tenant ID, and the interesting Tenant brand.</p>
<p>Of course, it appears that <em>smithkrause.onmicrosoft.com</em> is the vehicle behind this, and in particular <em>mollywagner@smithkrause.onmicrsoft.com</em>.</p>
<p>Back to another lookup courtesy of <a href="https://bsky.app/profile/drazuread.bsky.social">@drazuread.bksy.social</a>:</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Default domain</td>
<td>SmithKrause.onmicrosoft.com</td>
</tr>
<tr>
<td>Tenant name</td>
<td>SmithKrause.onmicrosoft.com</td>
</tr>
<tr>
<td>Tenant brand</td>
<td>SmithKrause</td>
</tr>
<tr>
<td>Tenant id</td>
<td>eecfe604-36e5-4e7c-86ee-2313e05112aa</td>
</tr>
<tr>
<td>Tenant region</td>
<td>NA</td>
</tr>
<tr>
<td>Seamless single sign-on (SSSO)</td>
<td>disabled</td>
</tr>
<tr>
<td>Uses Azure AD Connect cloud sync</td>
<td>N/A</td>
</tr>
<tr>
<td>Certificate-based authentication (CBA)</td>
<td>N/A</td>
</tr>
<tr>
<td>Verified domains</td>
<td>2</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Domain</th>
<th>Type</th>
<th>STS</th>
</tr>
</thead>
<tbody>
<tr>
<td>addiamaryellen.gigasphere.site</td>
<td>Managed</td>
<td></td>
</tr>
<tr>
<td>SmithKrause.onmicrosoft.com</td>
<td>Managed</td>
<td></td>
</tr>
</tbody>
</table>
<p>Pulling a whois of <em>gigasphere.site</em>, the domain is relatively fresh:</p>
<div class="highlight"><pre><span></span><code>Domain Name: GIGASPHERE.SITE
Registry Domain ID: D524536986-CNIC
Registrar WHOIS Server: whois.namecheap.com
Registrar URL: https://namecheap.com
Updated Date: 2025-02-05T10:49:53.0Z
Creation Date: 2025-02-05T10:49:48.0Z
Registry Expiry Date: 2026-02-05T23:59:59.0Z
Registrar: Namecheap
Registrar IANA ID: 1068
</code></pre></div>
<p>When digging into DNS, both <em>gigasphere.site</em> and <em>addiamaryellen.gigasphere.site</em> only have MX and SPF records for EXO (<em>gigasphere.site</em> DNS is hosted by Cloudflare).</p>
<p>Of course, the email originated from a <em>smithkrause.onmicrosoft.com</em> domain, which I can‚Äôt tell the age of, or at least not through AAD Internals OSINIT. Another interesting thing to note is that the people behind the scam are populating a distribution list with the target email addresses; when looking at the headers the To: is indeed <em>mollywagner@smithkrause.onmicrosoft.com</em>.</p>
<p>In due diligence I submitted the email review in M365 Defender, which came back with a no threats found</p>
<p><img alt="Figure 3" src="/images/2025/02/20/img3.png" /></p>
<p>Apparently, the body of the email containing <em>"Microsoft We appreciate your purchase and have finished your recent order for 592.99 USD. Please contact us at (888) 929-1904 for help or cancelation."</em> isn‚Äôt sufficient enough to be considered suspicious üôÑ.</p>
<p>For fun, I did call the number, but right now the scammers number just forwards to a voicemail box; if I‚Äôm able to get ahold of them and resolve my billing issues I‚Äôll follow up üòâ.</p>
<p>And the link? The link is benign, it just goes to the M365 admin billing portal, because the email as far as I can tell is legit from Microsoft.</p>
<p>The first few hops on the headers appear to be coming from some MS backend service and it hits the DL on hop 5, based on looking at the headers on <a href="https://mxtoolbox.com/EmailHeaders.aspx">https://mxtoolbox.com/EmailHeaders.aspx</a>:</p>
<table>
<thead>
<tr>
<th>Hop</th>
<th>Delay</th>
<th>From</th>
<th>By</th>
<th>With</th>
<th>Time (UTC)</th>
<th>Blacklist</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>*</td>
<td>outlook.office365.com 2603:10b6:303:18d::16</td>
<td>MW4PR20MB4527.namprd20.prod.outlook.com</td>
<td>HTTP</td>
<td>2/13/2025 2:40:06 PM</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>2</td>
<td>2 seconds</td>
<td>NAM10-DM6-obe.outbound.protection.outlook.com 2a01:111:f403:2413::720</td>
<td>SJ1PEPF00002313.mail.protection.outlook.com 2603:10b6:a0f:fc02::1a7</td>
<td>Microsoft SMTP Server (version=TLS1_3, cipher=TLS_AES_256_GCM_SHA384)</td>
<td>2/13/2025 2:40:08 PM</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>3</td>
<td>0 seconds</td>
<td>SJ1PEPF00002313.namprd03.prod.outlook.com 2603:10b6:a03:54:cafe::b3</td>
<td>BYAPR02CA0055.outlook.office365.com 2603:10b6:a03:54::32</td>
<td>Microsoft SMTP Server (version=TLS1_3, cipher=TLS_AES_256_GCM_SHA384)</td>
<td>2/13/2025 2:40:08 PM</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>4</td>
<td>0 seconds</td>
<td>BYAPR02CA0055.namprd02.prod.outlook.com 2603:10b6:a03:54::32</td>
<td>SJ2PR17MB6565.namprd17.prod.outlook.com 2603:10b6:a03:4f6::19</td>
<td>Microsoft SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384)</td>
<td>2/13/2025 2:40:08 PM</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>5</td>
<td>47 seconds</td>
<td>BY5PR17MB3063.namprd17.prod.outlook.com fe80::bf8c:c1de:31b1:4af5</td>
<td>BY5PR17MB3063.namprd17.prod.outlook.com fe80::bf8c:c1de:31b1:4af5</td>
<td>mapi</td>
<td>2/13/2025 2:40:55 PM</td>
<td>‚ùå</td>
</tr>
</tbody>
</table>
<p>Additionally, I would think if the email was fake, they wouldn‚Äôt include a legit link to the M365 Admin billing site.</p>
<p>Here is what I believe is going on:</p>
<ol>
<li>Scammer sets up junk tenant with the scam text tenant brand info</li>
<li>Distribution list is created with target email addresses</li>
<li>DL is used as the billing contact email</li>
<li>Scammer signs up for trial and/or service (not sure of this part in that when I looked up Dynamics 365 Sales Enterprise Edition, it‚Äôs $120 USD /month)</li>
<li>Email is blasted to all the targets via the DL</li>
</ol>
<p>Anyway, I thought it was worth a share as this seems like a new twist on using Microsoft tools to try and scam people.</p>
<p>In the meantime, I‚Äôll be trying to poke at Microsoft people to take down the smithkrause domain.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-01-13 00:00:00+00:00">January 13, 2025</time></li>
        
        
          
          <li class="md-meta__item">
            
              6 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="spying-on-your-isvs-credential-choices"><a class="toclink" href="2025/01/13/spying-on-your-isvs-credential-choices/">Spying On Your ISVs Credential Choices</a></h2>
<p>Microsoft, and the general identity industry, has recommended that applications use certificates over secrets when it comes to credentials for things like applications. This recommendation has existed for about as long modern authentication and authorization systems have existed ‚Äì over a decade now. Yet the reality is that there continues to be mystery shrouded around certificates, and sysadmins and developers still lean into using secrets.</p>
<p>Secrets are problematic because they are nothing more than a password. Secrets are so much just a password that while Microsoft might refer to secrets as secrets in the UI for Entra, the underlying attribute name is passwordCredentials! While you can use systems like Azure Key Vault for secure management of who has access to the secrets, the reality is that secrets tend to be managed insecurely, both in transport and at rest. Identity Protection exists for workload identities, but it is not real time, and there are scenarios where it will not help you if the abuse is coming from inside the same trusted network.</p>
<p>It‚Äôs easy for organizations to determine what they are using with single-tenant applications, or if they are a developer of a multi-tenant app. A quick Microsoft Graph API call to applications/objectid of the application (app registration), and you can examine whether the application has certificates, secrets, or both assigned as credentials. You can also store credentials on the service principal, which I cover here, <a href="https://ericonidentity.com/2023/03/11/aad-app-registrations-and-enterprise-applications-the-definitive-guide/">Entra App Registrations and Enterprise Applications: The Definitive Guide ‚Äì Eric on Identity</a>.</p>
<div class="highlight"><pre><span></span><code>&quot;keyCredentials&quot;: [
    {
        &quot;customKeyIdentifier&quot;: &quot;2335C167C72B21C4ACA7F3AA191FA95F8A39A727&quot;,
        &quot;displayName&quot;: &quot;Test certificate&quot;,
        &quot;endDateTime&quot;: &quot;2024-11-06T18:47:27Z&quot;,
        &quot;key&quot;: null,
        &quot;keyId&quot;: &quot;4ca658ff-a617-4161-93e0-465badaf7c3d&quot;,
        &quot;startDateTime&quot;: &quot;2023-11-06T18:27:27Z&quot;,
        &quot;type&quot;: &quot;AsymmetricX509Cert&quot;,
        &quot;usage&quot;: &quot;Verify&quot;
    }
],
Example certificate credentials

&quot;passwordCredentials&quot;: [
    {
        &quot;customKeyIdentifier&quot;: null,
        &quot;displayName&quot;: &quot;test secret&quot;,
        &quot;endDateTime&quot;: &quot;2025-07-07T23:25:23.333Z&quot;,
        &quot;hint&quot;: &quot;zoZ&quot;,
        &quot;keyId&quot;: &quot;e5ab0baa-5eb9-4180-9ad5-b1c693b7ee08&quot;,
        &quot;secretText&quot;: null,
        &quot;startDateTime&quot;: &quot;2025-01-09T00:25:23.333Z&quot;
    }
],
</code></pre></div>
<p><em>Example secret credentials</em></p>
<p>This is great, but this doesn‚Äôt help you understand what your software vendor is using.</p>
<h3 id="look-to-the-logs"><a class="toclink" href="2025/01/13/spying-on-your-isvs-credential-choices/#look-to-the-logs">Look to the logs</a></h3>
<p>Lucky for us, there are hints about the type of authentication vendors use in our Entra ID sign-in and Graph activity logs.</p>
<h4 id="entra-id-sign-in-logs"><a class="toclink" href="2025/01/13/spying-on-your-isvs-credential-choices/#entra-id-sign-in-logs">Entra ID Sign-in logs</a></h4>
<p>In the <a href="https://entra.microsoft.com/#home">Entra admin portal</a>, you can browse to <strong>Identity</strong>, select <strong>show more, Monitoring &amp; health</strong>, and <strong>Sign-in logs</strong>. In the sign-in events blade that opens on the right, select <strong>Service principal sign-ins</strong>. Direct link to the sign-in logs is here, <a href="https://entra.microsoft.com/#view/Microsoft_AAD_IAM/SignInEventsV3Blade/timeRangeType/last24hours/showApplicationSignIns~/true">Sign-in events ‚Äì Microsoft Entra admin center</a>, but note that you‚Äôll need to still select <strong>Service principal sign-ins</strong>.</p>
<p>Searching the logs is a bit different, as the portal will aggregate logs by the application. If you select the arrow on the left of the date, it will expand all the aggregated sign-in logs.</p>
<p>In here, just select the date for one of the logs; make sure you don‚Äôt select the service principal ID as it will actually open up the properties for the service principal instead.</p>
<p>Once selected, an <strong>Activity Details: Sign-ins</strong> blade will open on the right. In here we simply need to examine the <strong>Client credential type</strong>.</p>
<p>In the example below, we see that the client credential type is <strong>client secret</strong>, aka, password.</p>
<p><img alt="Figure 1" src="/images/2025/01/13/img1.png" />
<em>Example client credential type of a secret (password)</em></p>
<p>Whereas if the application is using certificates, the client credential type will show up as <strong>client assertion</strong>.</p>
<p><img alt="Figure 2" src="/images/2025/01/13/img2.png" />
<em>Example client credential type of assertion (certificate)</em></p>
<p>The unfortunate surprise is that the data available through Graph API does not match the data available in diagnostic logging.</p>
<p>In the portal, the backend queries for the audit logs are coming from the Graph API endpoint https://graph.microsoft.com/beta/auditLogs/signIns. We can determine the exact queries being used with <a href="https://graphxray.merill.net/">Graph X-Ray</a>, and then make the same queries to Graph, and see the raw results:</p>
<div class="highlight"><pre><span></span><code>&quot;value&quot;: [
    {
        &quot;id&quot;: &quot;c7db3bec-cb55-4ee7-8022-f51aa9603100&quot;,
        &quot;createdDateTime&quot;: &quot;2025-01-09T11:00:51Z&quot;,
        &quot;userDisplayName&quot;: null,
        &quot;userPrincipalName&quot;: null,
        &quot;userId&quot;: &quot;&quot;,
        &quot;appId&quot;: &quot;86261278-59ef-4d12-8e21-&quot;,
        &quot;appDisplayName&quot;: &quot;xxx&quot;,
        &quot;ipAddress&quot;: &quot;xxx&quot;,
        &quot;ipAddressFromResourceProvider&quot;: null,
        &quot;clientAppUsed&quot;: null,
        &quot;userAgent&quot;: null,
        &quot;correlationId&quot;: &quot;a22a7306-b6ae-4501-b2be-9fe5af3e327c&quot;,
        &quot;conditionalAccessStatus&quot;: &quot;notApplied&quot;,
        &quot;originalRequestId&quot;: &quot;&quot;,
        &quot;isInteractive&quot;: false,
        &quot;tokenIssuerName&quot;: null,
        &quot;tokenIssuerType&quot;: &quot;UnknownFutureValue&quot;,
        &quot;clientCredentialType&quot;: &quot;clientSecret&quot;,
        &quot;processingTimeInMilliseconds&quot;: -1,
        &quot;riskDetail&quot;: &quot;none&quot;,
</code></pre></div>
<p>The unfortunate surprise is that the data available through Entra diagnostic logging is not the same dataset.</p>
<p>Querying <strong>AADServicePrincipalSignInLogs</strong> is as simple as running the following KQL query:</p>
<div class="highlight"><pre><span></span><code>AADServicePrincipalSignInLogs
</code></pre></div>
<p>We could then further filter this by the service principal, time range, and such. But the results, when we expand them, do not contain any information about the type of authentication.</p>
<p><img alt="Figure 3" src="/images/2025/01/13/img3.png" />
<em>Example log analytic result of a service principal sign-in</em></p>
<p>The only bits of information relevant to the type of credential used are the <strong>servicePrincipalCredentialKeyId</strong>, but because the app registration is not in our tenant, we have no way of cross-referencing this. The service principal in our home tenant does not contain any references to the credentials on the app registration that we could correlate with either.</p>
<h4 id="graph-activity-logs"><a class="toclink" href="2025/01/13/spying-on-your-isvs-credential-choices/#graph-activity-logs">Graph Activity logs</a></h4>
<p>Where our sign-in logs fail us, at least with our diagnostic logging, Graph activity logs have our back. Unfortunately, it‚Äôs likely that this sort of snooping alone does not make it worth it to enable Graph activity logs; organizations need to evaluate the cost that would come along with enabling these logs and the additional overhead in Log Analytics.</p>
<p>Because Graph activity logs can be a vast sea of data, the easiest way to examine a particular application is filtering by the service principal ID with a basic KQL query:</p>
<div class="highlight"><pre><span></span><code>MicrosoftGraphActivityLogs | where ServicePrincipalId == &quot;insert id here&quot;
</code></pre></div>
<p>In the results, we can look at the <strong>ClientAuthMethod</strong>. If the method is <strong>1</strong>, then a secret was used, such as below:</p>
<p><img alt="Figure 4" src="/images/2025/01/13/img4.png" />
<em>Example graph activity log showing a secret credential used</em></p>
<p>If <strong>ClientAuthMethod</strong> shows <strong>2</strong>, then a certificate was used for authentication.</p>
<p>If we wanted to more efficiently search for ISV applications that are using secrets, we could cross-reference a list of known Microsoft applications by the application (client) ID, and then search our Graph activity log, also filtering only for ClientAuthMethod of 1, like the following:</p>
<div class="highlight"><pre><span></span><code>let MicrosoftApps = externaldata(AppId: string)
    [@&quot;https://raw.githubusercontent.com/merill/microsoft-info/main/_info/MicrosoftApps.json&quot;]
    with (format=&quot;json&quot;);
MicrosoftGraphActivityLogs | 
where ServicePrincipalId != &quot;&quot; and AppId !in (MicrosoftApps) and ClientAuthMethod == &quot;1&quot; | 
distinct ServicePrincipalId
</code></pre></div>
<p>Our results should then show all service principal IDs for ISV software that are using secrets. Note my test tenant currently one has one:</p>
<p><img alt="Figure 5" src="/images/2025/01/13/img5.png" /></p>
<p>The resulting list of IDs be used in Graph or searching in <strong>Enterprise Applications</strong> to determine what application(s) are using secrets.</p>
<h4 id="what-to-do-with-this-data"><a class="toclink" href="2025/01/13/spying-on-your-isvs-credential-choices/#what-to-do-with-this-data">What to do with this data?</a></h4>
<p>As a consumer of multi-tenant applications, the best (and only) way to impact change is to contact your software vendor, if you feel strongly that they should be using certificates. There is nothing from a technical standpoint, beyond stopping consumption of the application, that you can do to prevent the use of secrets.</p>
<p>When contacting your vendor, remind them of Microsoft (and industry best practices), which you can find here, <a href="https://learn.microsoft.com/en-us/entra/identity-platform/security-best-practices-for-app-registration#certificates-and-secrets?WT.mc_id=SEC-MVP-5005105">Security best practices for application properties ‚Äì Microsoft identity platform | Microsoft Learn</a>. But note that software is hard, switching the credential type might be more complex on the backend than you may realize, and it might take the voice of many customers to really impact change.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-03-26 00:00:00+00:00">March 26, 2024</time></li>
        
        
          
          <li class="md-meta__item">
            
              10 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="the-intersection-of-graph-and-entra-id-application-permissions-and-roles"><a class="toclink" href="2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/">The Intersection of Graph and Entra ID: Application Permissions and Roles</a></h2>
<p>When you build software that talks to Microsoft Entra ID, you eventually run into the question of which Microsoft Graph permissions to use. That question has gotten a lot more attention after the Midnight Blizzard intrusion at Microsoft, where attackers appear to have abused service principals and Graph permissions inside Microsoft‚Äôs own tenant.</p>
<p>For background on that incident and what it means for Azure and Entra admins, Andy Robbins has an excellent write-up that‚Äôs worth reading.</p>
<h3 id="primer-on-the-microsoft-graph-api"><a class="toclink" href="2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#primer-on-the-microsoft-graph-api">Primer on the Microsoft Graph API</a></h3>
<p>Before diving into the details of application permissions and roles, it helps to level-set how Microsoft Graph works. If you already live and breathe Graph, feel free to skim this section.</p>
<h4 id="what-is-graph-api"><a class="toclink" href="2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#what-is-graph-api">What is Graph API</a></h4>
<p>The Microsoft Graph API is the unified REST endpoint for most Microsoft 365 services, including Entra ID. In this post, when we say ‚ÄúGraph‚Äù or ‚ÄúGraph API,‚Äù we‚Äôre talking about Microsoft Graph specifically.</p>
<p><img alt="Microsoft Graph API Diagram" src="img1.png" /></p>
<p>You can think of Graph as the front door: behind it sit services such as Entra ID, Exchange Online, SharePoint, Teams, and more. Most modern integrations with Microsoft 365 are built on top of Graph.</p>
<p>Microsoft‚Äôs official documentation is the best place to go for a deeper overview of Graph‚Äôs capabilities and supported workloads.</p>
<h4 id="what-are-application-permissions"><a class="toclink" href="2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#what-are-application-permissions">What are Application Permissions</a></h4>
<p>Graph exposes two major permission types:</p>
<ul>
<li><strong>Delegated permissions</strong> ‚Äì the app acts on behalf of a user.</li>
<li><strong>Application permissions</strong> ‚Äì the app acts as itself, without a signed-in user.</li>
</ul>
<p>In this article we‚Äôll focus on <strong>application permissions</strong>. These are what you typically use for things like scheduled scripts, daemon services, or backend services that manage Entra ID objects on a schedule.  </p>
<p>A classic example is a script that creates or updates user objects in Entra ID. If it‚Äôs running as a background process, it should authenticate as an application (service principal) and rely on application permissions.</p>
<p>Many third-party SaaS products do the same: they authenticate as an app, not a person, and use application permissions to perform tasks like reading all calendars in Exchange Online or managing directory data.</p>
<p>Delegated permissions, in contrast, are about acting in the context of a user ‚Äì e.g., an app that reads <em>my</em> OneDrive or <em>my</em> calendar after I sign in and consent.</p>
<h4 id="how-graph-interacts-with-entra-id"><a class="toclink" href="2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#how-graph-interacts-with-entra-id">How Graph Interacts with Entra ID</a></h4>
<p>When you call Graph, the path in the URL determines which service you‚Äôre actually talking to. You don‚Äôt call Entra ID directly; you call Graph, and Graph routes the request.</p>
<p><img alt="Example breakdown of a Graph URL" src="img2.png" /></p>
<p>A Graph request has a couple of important pieces:</p>
<ul>
<li>The <strong>version/endpoint</strong> (<code>v1.0</code> or <code>beta</code>), and  </li>
<li>The <strong>resource</strong> path (users, groups, directoryObjects, etc.).</li>
</ul>
<p>In most everyday use, you don‚Äôt have to worry about which backend service is involved; Graph figures that out based on the resource path. It does start to matter when you run into throttling. Different resource families are backed by different services, each with its own limits. If you see a 429 response from Graph, you‚Äôre hitting those throttling limits.</p>
<p>Microsoft publishes service-specific throttling guidance that‚Äôs worth reviewing if you‚Äôre automating heavily against Graph.</p>
<h4 id="talking-to-graph"><a class="toclink" href="2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#talking-to-graph">Talking to Graph</a></h4>
<p>Graph is a REST API, so you use HTTP methods to interact with it. If you come from a traditional sysadmin background, the mapping between CRUD concepts and HTTP verbs looks like this:</p>
<table>
<thead>
<tr>
<th>CRUD operation</th>
<th>HTTP method</th>
</tr>
</thead>
<tbody>
<tr>
<td>Create</td>
<td>POST</td>
</tr>
<tr>
<td>Read</td>
<td>GET</td>
</tr>
<tr>
<td>Update</td>
<td>PATCH / PUT</td>
</tr>
<tr>
<td>Delete</td>
<td>DELETE</td>
</tr>
</tbody>
</table>
<p>In practice, most update operations for Entra ID resources use <strong>PATCH</strong> rather than PUT. There are only a handful of Entra operations that use PUT.</p>
<p>Tools like <strong>Graph Explorer</strong> make it easier to get hands-on with the API and see the raw requests and responses.</p>
<h3 id="exploring-application-permissions"><a class="toclink" href="2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#exploring-application-permissions">Exploring application permissions</a></h3>
<p>If you‚Äôve spent time with Active Directory access control lists and access control entries, the idea of permissions in Entra ID is not completely foreign‚Äîbut the model is different enough that it‚Äôs worth walking through.</p>
<h4 id="where-permissions-exist"><a class="toclink" href="2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#where-permissions-exist">Where permissions exist</a></h4>
<p>In on-prem Active Directory, you attach permissions directly to the <strong>target objects</strong>. For example, if Sarah needs to reset passwords, you grant the <strong>Reset password</strong> right on user objects (often via an OU so it inherits to multiple users).</p>
<p><img alt="High-level permission relationship in Active Directory" src="img3.png" /></p>
<p>To allow Todd to create new groups, you‚Äôd grant him a ‚Äúcreate group objects‚Äù right on an OU. The OU is the container, and the permissions cascade to the objects underneath it.</p>
<p><img alt="Granting create-group permissions in an OU" src="img4.png" /></p>
<p>You can think of service accounts the same way: whether it‚Äôs a gMSA or a user account acting as a service account, you still attach permissions to the objects being protected.</p>
<p><img alt="Service account permission relationship in Active Directory" src="img5.png" /></p>
<p>In Entra ID, Graph API permissions work differently. Permissions are applied to the <strong>requesting service principal</strong>, not to the target objects. App registrations describe what an application <em>wants</em>, but the <strong>service principal</strong> is what actually holds the delegated and application permission grants.</p>
<p>If you‚Äôre fuzzy on the difference between app registrations and enterprise applications, it‚Äôs worth reviewing that first ‚Äì app registrations are the app definitions, whereas enterprise applications (service principals) are the instances in a tenant.</p>
<p>Application permissions show up as <strong>appRoleAssignment</strong> resources linked to the service principal.</p>
<p>Imagine an example where an application needs to create a group.</p>
<p><img alt="Application permissions to create a group" src="img6.png" /></p>
<p>Here, a backend service (‚ÄúCloud Application‚Äù) authenticates as a service principal. That service principal has been granted the Graph application permission <strong>Group.Create</strong>, which allows it to create groups in Entra ID.</p>
<p>From an operational security perspective, we should treat these service principals as modern service accounts. Anywhere we can replace a traditional user-based service account with a service principal in Entra ID, we should. That applies just as much to one-off admin scripts as it does to ISV software.</p>
<h4 id="consenting-to-graph-permissions"><a class="toclink" href="2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#consenting-to-graph-permissions">Consenting to Graph permissions</a></h4>
<p>In the Entra admin center, you specify required permissions on the <strong>app registration</strong>. That‚Äôs only half the story, though ‚Äì the permissions must also be <strong>granted</strong> in the tenant.</p>
<p>That‚Äôs what <strong>admin consent</strong> does: it approves the requested Graph permissions for your organization.</p>
<p>There are two small but important nuances:</p>
<ul>
<li>Both the app registration blade and the enterprise application blade have a <strong>Grant admin consent</strong> button. They perform the same operation; the button on the app registration blade is just there for convenience.</li>
<li>Only <strong>Global Administrator</strong> can grant consent for <strong>Microsoft Graph application permissions</strong>. While documentation often suggests that Application Administrator or Cloud Application Administrator can grant consent, that does not apply to Graph app perms.</li>
</ul>
<h3 id="putting-permissions-into-action"><a class="toclink" href="2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#putting-permissions-into-action">Putting permissions into action</a></h3>
<p>Let‚Äôs walk through a simple scenario where an application uses Graph application permissions to create groups in Entra ID.</p>
<p>We‚Äôve created a new application, <strong>Cloud Application</strong>, and granted it the <strong>Group.Create</strong> application permission. After consenting to the permission, we can see it listed on the service principal.</p>
<p><img alt="Cloud Application with Group.Create permission" src="img7.png" /></p>
<p>For this walkthrough we‚Äôll use the <strong>Microsoft Graph PowerShell SDK</strong> to talk to Graph.</p>
<p>We connect using application credentials (for example, a client secret or certificate) and specify our tenant ID. We can then confirm our context with <code>Get-MgContext</code>.</p>
<p><img alt="Get-MgContext showing Group.Create scope" src="img8.png" /></p>
<p>The output shows that we‚Äôre connected as the <strong>Cloud Application</strong> app, and the <code>Scopes</code> field includes the application permission we assigned.</p>
<p>Next, we create a group using the SDK.</p>
<p><img alt="Creating a group via Graph PowerShell" src="img9.png" /></p>
<p>If we look at the Entra audit logs, we can see the group creation event attributed to the Cloud Application service principal.</p>
<p><img alt="Audit log details ‚Äì Activity tab" src="img10.png" /></p>
<p><img alt="Audit log details ‚Äì Modified properties" src="img11.png" /></p>
<p>However, because the app only has <strong>Group.Create</strong>, it can‚Äôt update or delete the group. Attempts to delete the group fail with an authorization error.</p>
<p><img alt="403 when trying to delete a group with only Group.Create" src="img12.png" /></p>
<h3 id="when-application-permissions-can-become-tricky"><a class="toclink" href="2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#when-application-permissions-can-become-tricky">When application permissions can become tricky</a></h3>
<p>Suppose we decide the app should be able to delete groups as well. Our initial intuition might be that there‚Äôs a <strong>Group.Delete</strong> permission we can add, similar to the precision we‚Äôre used to in AD.</p>
<p>When we look at Graph‚Äôs available application permissions for groups, reality looks different.</p>
<p><img alt="Available Graph application permissions for groups" src="img13.png" /></p>
<p>In addition to Group.Create, the only other group-related application permissions are:</p>
<ul>
<li><strong>Group.Read.All</strong></li>
<li><strong>Group.ReadWrite.All</strong></li>
</ul>
<p>To let the app delete groups, we have to assign <strong>Group.ReadWrite.All</strong>, which effectively gives it full read/write access across all groups in the tenant.</p>
<p><img alt="Service principal with Group.Create and Group.ReadWrite.All" src="img14.png" /></p>
<p>After we add the permission, disconnect, and reconnect, we can see both scopes in <code>Get-MgContext</code>.</p>
<p><img alt="Get-MgContext showing both application permissions" src="img15.png" /></p>
<p>Now a deletion that previously failed succeeds without error.</p>
<p><img alt="Successfully deleting a group via Graph PowerShell" src="img16.png" /></p>
<p>We can also add users to the group using the same context.</p>
<p><img alt="Adding a group member via Graph PowerShell" src="img17.png" /></p>
<p>The catch is obvious: we wanted the ability to manage <strong>some</strong> groups, but Group.ReadWrite.All applies to <strong>all</strong> groups in the directory. That‚Äôs where Entra roles, combined with admin units, can help.</p>
<h3 id="roles-can-fill-the-application-permission-granularity-gap-somewhat"><a class="toclink" href="2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#roles-can-fill-the-application-permission-granularity-gap-somewhat">Roles can fill the application permission granularity gap ‚Äì somewhat</a></h3>
<p>Our desired scenario is to let the application manage only a subset of groups, not every group in the tenant.</p>
<p><img alt="Desired scenario ‚Äì manage only certain groups" src="img18.png" /></p>
<p>In traditional Active Directory, we‚Äôd solve this by organizing groups into a dedicated OU and applying granular permissions on that OU (or on specific group objects).</p>
<p>In Entra ID, we can approximate this pattern using <strong>Administrative Units (AUs)</strong> and directory roles.</p>
<p>First, we strip away the Graph application permissions we‚Äôve granted.</p>
<p><img alt="Removing Graph application permissions from the app" src="img19.png" /></p>
<p>Then we assign the <strong>Groups Administrator</strong> role to the Cloud Application service principal, scoped to a specific administrative unit.</p>
<p><img alt="Groups Administrator role scoped to an administrative unit" src="img20.png" /></p>
<p>When we connect to Graph and run <code>Get-MgContext</code>, we see that there are no Graph scopes present. The app doesn‚Äôt have application permissions anymore, but it <em>does</em> have the directory role assignment in Entra.</p>
<p><img alt="Get-MgContext with no Graph scopes" src="img21.png" /></p>
<p>If we try to modify a group that sits <strong>outside</strong> the scoped administrative unit, the operation fails‚Äîexactly what we want.</p>
<p><em>(screenshot of failed attempt to modify an out-of-scope group ‚Äì img22.png)</em></p>
<p>When we target a group that <strong>is</strong> in the administrative unit, the operation succeeds.</p>
<p><img alt="Successfully managing a group in the scoped administrative unit" src="img23.png" /></p>
<p>So now, our combination of permissions and roles gives us the ability to manage just the groups we‚Äôve scoped to the AU.</p>
<p><img alt="Role and permissions model for managing a group in an administrative unit" src="img24.png" /></p>
<p>However, this model is somewhat restrictive. In the example above, we already know the object ID of the group we want to modify. If we don‚Äôt, we might want to list the groups in the administrative unit.</p>
<p>With only the current role assignment, we can‚Äôt enumerate them via Graph.</p>
<p><img alt="Attempt to enumerate groups in the AU fails" src="img25.png" /></p>
<h3 id="getting-into-the-thick-of-permissions-and-roles"><a class="toclink" href="2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#getting-into-the-thick-of-permissions-and-roles">Getting into the thick of permissions and roles</a></h3>
<p>At this point the pattern becomes clear: to perform operations as an application, we need some combination of <strong>Graph application permissions</strong> and <strong>directory roles</strong> that together authorize the actions we care about.</p>
<p>To list objects in the administrative unit, we add <strong>AdministrativeUnit.Read.All</strong> to the application.</p>
<p><img alt="Adding AdministrativeUnit.Read.All" src="img26.png" /></p>
<p>With that permission in place, we can enumerate members of the administrative unit via Graph.</p>
<p><img alt="Successfully enumerating objects in the administrative unit" src="img27.png" /></p>
<p>If we also want to enumerate users in the tenant to decide who to place in the group, that‚Äôs another permission. If we want to check whether a group already exists before we create it, that‚Äôs yet another permission.</p>
<p><img alt="Additional permissions required for users and groups" src="img28.png" /></p>
<p>For a relatively small set of operations‚Äîcreating and managing certain groups, reading users, and scoping everything to an AU‚Äîwe end up with a permission and role model that looks something like:</p>
<ul>
<li>Graph application permissions:</li>
<li>AdministrativeUnit.Read.All  </li>
<li>Group.Read.All / Group.ReadWrite.All (depending on needs)  </li>
<li>User.Read.All</li>
<li>Directory role:</li>
<li>Groups Administrator, scoped to the administrative unit</li>
</ul>
<p>Real-world software that manages large slices of Entra ID or Microsoft 365 tends to accumulate a lot of these permissions quickly. The more capabilities the tool has, the broader the Graph permissions usually need to be.</p>
<h3 id="take-the-time-to-understand-and-test-permissions-and-roles"><a class="toclink" href="2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#take-the-time-to-understand-and-test-permissions-and-roles">Take the time to understand, and test, permissions and roles</a></h3>
<p>Permissions and roles for applications in Entra ID can look intimidating at first, but understanding how they interact is critical if you want to secure your tenant.</p>
<p>A few practical takeaways:</p>
<ul>
<li>Invest the time to understand how Graph application permissions and directory roles overlap and differ.</li>
<li>Test your apps in a lab tenant to verify the <strong>minimum</strong> set of permissions they actually need.</li>
<li>Treat service principals as first-class security identities, just like user accounts or gMSAs.</li>
<li>Regularly review which apps have powerful permissions such as <code>*.Read.All</code> and <code>*.ReadWrite.All</code>.</li>
</ul>
<p>The goal is to ensure your apps and scripts only have the access they truly need. Otherwise, they become extremely attractive targets for lateral movement and privilege escalation.</p>
<h3 id="about-this-posts-featured-image"><a class="toclink" href="2024/03/26/the-intersection-of-graph-and-entra-id-application-permissions-and-roles/#about-this-posts-featured-image">About This Post‚Äôs Featured Image</a></h3>
<p>The featured image for this post is a photograph by Danielle Rice, used under the Unsplash license.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-08-29 00:00:00+00:00">August 29, 2023</time></li>
        
        
          
          <li class="md-meta__item">
            
              10 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="dude-wheres-my-audit-logs"><a class="toclink" href="2023/08/29/dude-wheres-my-audit-logs/">Dude, Where's My Audit Logs?</a></h2>
<p>Audit logs can provide all sorts of wonderful points of data. In the interest of identity security, we have historically seen that we can glean rich sets of information around what‚Äôs happening in a directory service with some properly functioning audit logging. For many identity practitioners, there is the expectation that while we may not always look at the audit logs or their details, if or when we need them, they‚Äôll be there to help us understand whatever it is we are investigating. Same goes for compliance and auditing as well.</p>
<p>Considering that customers have no ability to impact what or how auditing happens in Entra ID, in the shared responsibility model, it‚Äôs on Microsoft to ensure all events are audited.</p>
<p><img alt="Figure 1" src="/images/2023/08/29/img1.png" /></p>
<p><em>Shared responsiblity model, courtesy Microsoft, with identity and directory infrastructure highlighted.</em></p>
<p>Microsoft documents what is audited in Entra ID, which you can find here, <a href="https://learn.microsoft.com/en-us/azure/active-directory/reports-monitoring/reference-audit-activities?WT.mc_id=SEC-MVP-5005105">Azure Active Directory (Azure AD) audit activity reference ‚Äì Microsoft Entra | Microsoft Learn</a>.</p>
<h3 id="the-problem"><a class="toclink" href="2023/08/29/dude-wheres-my-audit-logs/#the-problem">The problem</a></h3>
<p>I‚Äôve recently been down the rabbit hole part time picking apart Entra ID audit logs, and in my analysis of the audit log data for Entra ID, some audit logs slot into one of two buckets:</p>
<ul>
<li>Data is missing</li>
<li>Data is inconsistent/poor quality</li>
</ul>
<p><img alt="Figure 2" src="/images/2023/08/29/img2.jpg" /></p>
<p><em>Or perhaps in our case, what has been unseen cannot be seen.</em></p>
<p>To be fair, a broad set of changes <strong>are</strong> audited in Entra ID, but at the same time I found it rather surprising that <strong>most SSPR</strong> configuration changes are not properly audited, which, if you look at the document above, Microsoft does not seem to argue. Considering recent events that surface what is logged in Entra ID and the M365 ecosystem, in this persons opinion Microsoft should be continually striving to audit 100% of all configuration changes in Entra ID.</p>
<h3 id="missing-log-data"><a class="toclink" href="2023/08/29/dude-wheres-my-audit-logs/#missing-log-data">Missing log data</a></h3>
<p>These are instances where Entra ID log data is incomplete, usually in that the modified properties data is null.</p>
<h4 id="self-service-group-management"><a class="toclink" href="2023/08/29/dude-wheres-my-audit-logs/#self-service-group-management">Self-service group management</a></h4>
<p>Neither of these settings are exposed via the Graph API, so the reference point for their control is under Entra ID -&gt; Groups -&gt; Group settings</p>
<p><img alt="Figure 3" src="/images/2023/08/29/img3.png" /></p>
<h5 id="the-audit-data"><a class="toclink" href="2023/08/29/dude-wheres-my-audit-logs/#the-audit-data">The audit data</a></h5>
<p>Note an absence of the actual change data, as highlighted in the audit event:</p>
<div class="highlight"><pre><span></span><code>{
        &quot;activityDateTime&quot;: &quot;2023-08-07T20:04:39.1390262+00:00&quot;,
        &quot;activityDisplayName&quot;: &quot;Update authorization policy&quot;,
        &quot;additionalDetails&quot;: [
            {
                &quot;key&quot;: &quot;User-Agent&quot;,
                &quot;value&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/116.0&quot;
            }
        ],
        &quot;category&quot;: &quot;AuthorizationPolicy&quot;,
        &quot;correlationId&quot;: &quot;1349713e-116b-4246-9c64-60b394884488&quot;,
        &quot;id&quot;: &quot;Directory_1349713e-116b-4246-9c64-60b394884488_NANEA_29121908&quot;,
        &quot;initiatedBy&quot;: {
            &quot;user&quot;: {
                &quot;displayName&quot;: null,
                &quot;homeTenantId&quot;: null,
                &quot;homeTenantName&quot;: null,
                &quot;id&quot;: &quot;d7148226-7444-4884-aef7-b5fe693a6798&quot;,
                &quot;ipAddress&quot;: &quot;X.X.X.X&quot;,
                &quot;userPrincipalName&quot;: &quot;ga-x@x.onmicrosoft.com&quot;
            }
        },
        &quot;loggedByService&quot;: &quot;Core Directory&quot;,
        &quot;result&quot;: &quot;success&quot;,
        &quot;resultReason&quot;: &quot;&quot;,
        &quot;targetResources&quot;: [
            {
                &quot;displayName&quot;: &quot;Authorization Policy&quot;,
                &quot;groupType&quot;: null,
                &quot;id&quot;: &quot;4bb7b039-71e4-474e-a7fc-5fe0bbf86fcc&quot;,
                &quot;modifiedProperties&quot;: [
                    {
                        &quot;displayName&quot;: &quot;Included Updated Properties&quot;,
                        &quot;newValue&quot;: &quot;\&quot;\&quot;&quot;,
                        &quot;oldValue&quot;: null
                    }
                ],
                &quot;type&quot;: &quot;Other&quot;,
                &quot;userPrincipalName&quot;: null
            }
        ],
        &quot;userAgent&quot;: null
    },
</code></pre></div>
<h4 id="group-lifecycle-policy-changes"><a class="toclink" href="2023/08/29/dude-wheres-my-audit-logs/#group-lifecycle-policy-changes">Group lifecycle policy changes</a></h4>
<p>More commonly known as the group expiration settings, the controls for these in the portal can be found under Groups -&gt; Group settings -&gt; Expiration.</p>
<p><img alt="Figure 4" src="/images/2023/08/29/img4.png" /></p>
<p>These are also exposed through Graph, <a href="https://graph.microsoft.com/beta/groupLifecyclePolicies/">https://graph.microsoft.com/beta/groupLifecyclePolicies/</a>.</p>
<h5 id="the-audit-data_1"><a class="toclink" href="2023/08/29/dude-wheres-my-audit-logs/#the-audit-data_1">The audit data</a></h5>
<p>Note the absence of any change data, as highlighted in the audit event:</p>
<div class="highlight"><pre><span></span><code>    {
        &quot;activityDateTime&quot;: &quot;2023-08-07T20:09:38.6970558+00:00&quot;,
        &quot;activityDisplayName&quot;: &quot;Update lifecycle management policy&quot;,
        &quot;additionalDetails&quot;: [
        ],
        &quot;category&quot;: &quot;GroupManagement&quot;,
        &quot;correlationId&quot;: &quot;8883b045-774b-4107-b85a-04df5252b5ad&quot;,
        &quot;id&quot;: &quot;SSGM_8883b045-774b-4107-b85a-04df5252b5ad_KLKOT_36197055&quot;,
        &quot;initiatedBy&quot;: {
            &quot;user&quot;: {
                &quot;displayName&quot;: null,
                &quot;homeTenantId&quot;: null,
                &quot;homeTenantName&quot;: null,
                &quot;id&quot;: &quot;d7148226-7444-4884-aef7-b5fe693a6798&quot;,
                &quot;ipAddress&quot;: &quot;X.X.X.x&quot;,
                &quot;userPrincipalName&quot;: &quot;ga-x@x.onmicrosoft.com&quot;
            }
        },
        &quot;loggedByService&quot;: &quot;Self-service Group Management&quot;,
        &quot;result&quot;: &quot;success&quot;,
        &quot;resultReason&quot;: &quot;OK&quot;,
        &quot;targetResources&quot;: [
            {
                &quot;displayName&quot;: null,
                &quot;groupType&quot;: null,
                &quot;id&quot;: &quot;57126178-623b-4468-a96e-be2ee1611cc4&quot;,
                &quot;modifiedProperties&quot;: [
                ],
                &quot;type&quot;: &quot;Policy&quot;,
                &quot;userPrincipalName&quot;: null
            }
        ],
        &quot;userAgent&quot;: null
    },
</code></pre></div>
<h4 id="conditional-access-custom-controls"><a class="toclink" href="2023/08/29/dude-wheres-my-audit-logs/#conditional-access-custom-controls">Conditional Access custom controls</a></h4>
<p>Now I get that this is a deprecated public preview, but, it‚Äôs also existed for quite a long time, and it‚Äôs surprising that changes to the control itself are not audited.</p>
<h5 id="the-audit-data_2"><a class="toclink" href="2023/08/29/dude-wheres-my-audit-logs/#the-audit-data_2">The audit data</a></h5>
<p>Note the absence of any change data, as highlighted in the audit event:</p>
<div class="highlight"><pre><span></span><code>    {
        &quot;activityDateTime&quot;: &quot;2023-08-07T20:18:39.6114596+00:00&quot;,
        &quot;activityDisplayName&quot;: &quot;Update policy&quot;,
        &quot;additionalDetails&quot;: [
        ],
        &quot;category&quot;: &quot;Policy&quot;,
        &quot;correlationId&quot;: &quot;21476eae-1b3f-45db-8e3e-e190cd19ad44&quot;,
        &quot;id&quot;: &quot;Directory_21476eae-1b3f-45db-8e3e-e190cd19ad44_USKAS_28366729&quot;,
        &quot;initiatedBy&quot;: {
            &quot;user&quot;: {
                &quot;displayName&quot;: null,
                &quot;homeTenantId&quot;: null,
                &quot;homeTenantName&quot;: null,
                &quot;id&quot;: &quot;d7148226-7444-4884-aef7-b5fe693a6798&quot;,
                &quot;ipAddress&quot;: &quot;X.X.X.X&quot;,
                &quot;userPrincipalName&quot;: &quot;ga-x@x.onmicrosoft.com&quot;
            }
        },
        &quot;loggedByService&quot;: &quot;Core Directory&quot;,
        &quot;result&quot;: &quot;success&quot;,
        &quot;resultReason&quot;: &quot;&quot;,
        &quot;targetResources&quot;: [
            {
                &quot;displayName&quot;: &quot;Default Policy&quot;,
                &quot;groupType&quot;: null,
                &quot;id&quot;: &quot;77a1c6e8-877e-43fe-a4d0-0806472fe4a0&quot;,
                &quot;modifiedProperties&quot;: [
                    {
                        &quot;displayName&quot;: &quot;Included Updated Properties&quot;,
                        &quot;newValue&quot;: &quot;\&quot;\&quot;&quot;,
                        &quot;oldValue&quot;: null
                    }
                ],
                &quot;type&quot;: &quot;Policy&quot;,
                &quot;userPrincipalName&quot;: null
            }
        ],
        &quot;userAgent&quot;: null
    },
</code></pre></div>
<h4 id="ssprpassword-reset-settings"><a class="toclink" href="2023/08/29/dude-wheres-my-audit-logs/#ssprpassword-reset-settings">SSPR/Password Reset Settings</a></h4>
<p>Microsoft documents that most changes to SSPR are not audited, and in my analysis found that the following settings do not properly reflect any data in the audit logs, including a few that Microsoft seems to indicate should, such as enabling/disabling on-premises integration.</p>
<p>Considering that these changes impact tenant-wide security controls around SSPR, it‚Äôs surprising this service has existed for so long with what is effectively non-existent auditing. These logs don‚Äôt even indicate who initiated the change.</p>
<p>Yes, some of these are being overhauled/changed as authentication methods is an area of focus for Microsoft right now, but not all of these settings are encompassed in that.</p>
<ul>
<li>Registration, Days before users are asked to re-confirm their settings</li>
<li>Notification settings</li>
<li>Customizations</li>
<li>On-premises integration</li>
<li>Self-service password reset enablement/scoping</li>
<li>Authentication methods (legacy methods)</li>
</ul>
<h5 id="the-audit-data_3"><a class="toclink" href="2023/08/29/dude-wheres-my-audit-logs/#the-audit-data_3">The audit data</a></h5>
<p>In testing, there isn‚Äôt even a direct audit event logged for changes, but simply an update to the <strong>Microsoft password reset service service</strong> principle. The update provides no information on the actual change.</p>
<div class="highlight"><pre><span></span><code>{
        &quot;activityDateTime&quot;: &quot;2023-08-07T20:28:04.2244435+00:00&quot;,
        &quot;activityDisplayName&quot;: &quot;Update service principal&quot;,
        &quot;additionalDetails&quot;: [
            {
                &quot;key&quot;: &quot;AppId&quot;,
                &quot;value&quot;: &quot;93625bc8-bfe2-437a-97e0-3d0060024faa&quot;
            }
        ],
        &quot;category&quot;: &quot;ApplicationManagement&quot;,
        &quot;correlationId&quot;: &quot;aae6519f-15d9-4dec-9d12-a03b2639c60e&quot;,
        &quot;id&quot;: &quot;Directory_aae6519f-15d9-4dec-9d12-a03b2639c60e_F0I2G_33925192&quot;,
        &quot;initiatedBy&quot;: {
            &quot;app&quot;: {
                &quot;appId&quot;: null,
                &quot;displayName&quot;: &quot;Microsoft password reset service&quot;,
                &quot;servicePrincipalId&quot;: &quot;a96c060c-dd1c-4229-9089-72aed43d85db&quot;,
                &quot;servicePrincipalName&quot;: null
            }
        },
        &quot;loggedByService&quot;: &quot;Core Directory&quot;,
        &quot;result&quot;: &quot;success&quot;,
        &quot;resultReason&quot;: &quot;&quot;,
        &quot;targetResources&quot;: [
            {
                &quot;displayName&quot;: &quot;Microsoft password reset service&quot;,
                &quot;groupType&quot;: null,
                &quot;id&quot;: &quot;a96c060c-dd1c-4229-9089-72aed43d85db&quot;,
                &quot;modifiedProperties&quot;: [
                    {
                        &quot;displayName&quot;: &quot;TargetId.ServicePrincipalNames&quot;,
                        &quot;newValue&quot;: &quot;\&quot;https://passwordreset.microsoftonline.com;https://passwordreset.microsoftonline.com/;93625bc8-bfe2-437a-97e0-3d0060024faa\&quot;&quot;,
                        &quot;oldValue&quot;: null
                    }
                ],
                &quot;type&quot;: &quot;ServicePrincipal&quot;,
                &quot;userPrincipalName&quot;: null
            }
        ],
        &quot;userAgent&quot;: null
    },
</code></pre></div>
<h4 id="external-identities-linked-subscriptions"><a class="toclink" href="2023/08/29/dude-wheres-my-audit-logs/#external-identities-linked-subscriptions">External Identities linked subscriptions</a></h4>
<p>Microsoft has been pushing the migration of B2B guests/External Identities to use a linked subscription where organizations will receive 50,000 MAU for guests as far as licensing goes, compared to the prior model of a 1:5 user: guest license ratio.</p>
<p>In order to implement this change, an organization must link their Entra ID tenant with an Azure subscription for billing purposes.</p>
<p>When implementing this change, there <strong>is</strong> a proper audit even in the subscriptions activity log, however, a change like this should also be reflected in Entra ID audit logs. Instead, we get a series of useless audit log entries.</p>
<h5 id="the-audit-data_4"><a class="toclink" href="2023/08/29/dude-wheres-my-audit-logs/#the-audit-data_4">The audit data</a></h5>
<p>When looking at the data in either entry for <strong>Create or update a Guest Usages resource</strong>, there is no data of value for the change.</p>
<div class="highlight"><pre><span></span><code>{
        &quot;activityDateTime&quot;: &quot;2023-08-07T20:38:06.5858394+00:00&quot;,
        &quot;activityDisplayName&quot;: &quot;Create or update a Guest Usages resource&quot;,
        &quot;additionalDetails&quot;: [
            {
                &quot;key&quot;: &quot;targetTenant&quot;,
                &quot;value&quot;: &quot;Undefined tenant&quot;
            },
            {
                &quot;key&quot;: &quot;targetEntityType&quot;,
                &quot;value&quot;: &quot;Resource&quot;
            },
            {
                &quot;key&quot;: &quot;actorIdentityType&quot;,
                &quot;value&quot;: &quot;UPN&quot;
            }
        ],
        &quot;category&quot;: &quot;ResourceManagement&quot;,
        &quot;correlationId&quot;: &quot;dda8b5c0-125d-4fc6-b8aa-971e9cb27f9a&quot;,
        &quot;id&quot;: &quot;B2C_dda8b5c0-125d-4fc6-b8aa-971e9cb27f9a_VUR48_6835487&quot;,
        &quot;initiatedBy&quot;: {
            &quot;user&quot;: {
                &quot;displayName&quot;: &quot;ga-x@x.onmicrosoft.com&quot;,
                &quot;homeTenantId&quot;: null,
                &quot;homeTenantName&quot;: null,
                &quot;id&quot;: null,
                &quot;ipAddress&quot;: &quot;X.X.X.X&quot;,
                &quot;userPrincipalName&quot;: &quot;ga-x@x.onmicrosoft.com&quot;
            }
        },
        &quot;loggedByService&quot;: &quot;B2C&quot;,
        &quot;result&quot;: &quot;success&quot;,
        &quot;resultReason&quot;: null,
        &quot;targetResources&quot;: [
            {
                &quot;displayName&quot;: &quot;NotSet&quot;,
                &quot;groupType&quot;: null,
                &quot;id&quot;: null,
                &quot;modifiedProperties&quot;: [
                ],
                &quot;type&quot;: &quot;Directory&quot;,
                &quot;userPrincipalName&quot;: null
            }
        ],
        &quot;userAgent&quot;: null
    },
</code></pre></div>
<h4 id="external-collaboration-settings-guest-self-service-sign-up-via-user-flows"><a class="toclink" href="2023/08/29/dude-wheres-my-audit-logs/#external-collaboration-settings-guest-self-service-sign-up-via-user-flows">External collaboration settings guest self-service sign up via user flows</a></h4>
<p>Guest self-service sign-up (SSSU) is what one could consider a grey area in the B2B/B2C space, allowing users to self-register as guests in your tenant and access designated resources. While a somewhat niche feature, it‚Äôs something that is rather powerful for controlling access to enterprise applications.</p>
<p><img alt="Figure 5" src="/images/2023/08/29/img5.png" /></p>
<p>This setting can also be adjusted via Graph at <a href="https://graph.microsoft.com/v1.0/policies/authenticationFlowsPolicy">https://graph.microsoft.com/v1.0/policies/authenticationFlowsPolicy</a>.</p>
<p>Surprisingly, changes that enable/disable this setting are not audited effectively.</p>
<h5 id="the-audit-data_5"><a class="toclink" href="2023/08/29/dude-wheres-my-audit-logs/#the-audit-data_5">The audit data</a></h5>
<p>Toggling this on/off results in a long series of audit events from the B2C service, however, none of them actually indicate the change.</p>
<p><img alt="Figure 6" src="/images/2023/08/29/img6.png" /></p>
<p>For all of these, the <strong>Modified Properties</strong> is null</p>
<div class="highlight"><pre><span></span><code>{
        &quot;activityDateTime&quot;: &quot;2023-08-07T20:49:50.9366119+00:00&quot;,
        &quot;activityDisplayName&quot;: &quot;Update authentication flows policy&quot;,
        &quot;additionalDetails&quot;: [
            {
                &quot;key&quot;: &quot;targetTenant&quot;,
                &quot;value&quot;: &quot;Undefined tenant&quot;
            },
            {
                &quot;key&quot;: &quot;targetEntityType&quot;,
                &quot;value&quot;: &quot;None&quot;
            },
            {
                &quot;key&quot;: &quot;actorIdentityType&quot;,
                &quot;value&quot;: &quot;UPN&quot;
            }
        ],
        &quot;category&quot;: &quot;ResourceManagement&quot;,
        &quot;correlationId&quot;: &quot;923307cf-b8ac-4e26-bd47-53650a88e9fb&quot;,
        &quot;id&quot;: &quot;B2C_923307cf-b8ac-4e26-bd47-53650a88e9fb_VUR48_6870123&quot;,
        &quot;initiatedBy&quot;: {
            &quot;user&quot;: {
                &quot;displayName&quot;: &quot;ga-x@x.onmicrosoft.com&quot;,
                &quot;homeTenantId&quot;: null,
                &quot;homeTenantName&quot;: null,
                &quot;id&quot;: null,
                &quot;ipAddress&quot;: &quot;X.X.X.X&quot;,
                &quot;userPrincipalName&quot;: &quot;ga-x@x.onmicrosoft.com&quot;
            }
        },
        &quot;loggedByService&quot;: &quot;B2C&quot;,
        &quot;result&quot;: &quot;success&quot;,
        &quot;resultReason&quot;: null,
        &quot;targetResources&quot;: [
            {
                &quot;displayName&quot;: null,
                &quot;groupType&quot;: null,
                &quot;id&quot;: &quot;NotSet&quot;,
                &quot;modifiedProperties&quot;: [
                ],
                &quot;type&quot;: &quot;Other&quot;,
                &quot;userPrincipalName&quot;: null
            }
        ],
        &quot;userAgent&quot;: null
    },
</code></pre></div>
<h3 id="inconsistent-log-data"><a class="toclink" href="2023/08/29/dude-wheres-my-audit-logs/#inconsistent-log-data">Inconsistent log data</a></h3>
<p>These are instances where changes are audited, however, they seem to disregard any sort of schema or consistency of auditing in Entra ID.</p>
<h4 id="entra-id-protection"><a class="toclink" href="2023/08/29/dude-wheres-my-audit-logs/#entra-id-protection">Entra ID Protection</a></h4>
<p>Entra ID Protection heavily offenses the senses with its audit logging of changes to the following policies:</p>
<ul>
<li>User risk policy</li>
<li>Sign-in risk policy</li>
<li>Multifactor authentication registration policy</li>
</ul>
<p>We could argue that you shouldn‚Äôt be using the MFA registration policy at this point, as MFA should be an account day zero requirement. And while Microsoft wants you to move your ID Protection policies into Conditional Access, until they are gone, the changes really break the audit mold.</p>
<h5 id="the-audit-data_6"><a class="toclink" href="2023/08/29/dude-wheres-my-audit-logs/#the-audit-data_6">The audit data</a></h5>
<p>Oddly the user risk policy and MFA registration policy indicate an update if either is changed, and updates to the sign-in risk policy appear separate. But for all three, two events are logged, a core directory change that contains no data, and secondary policy change, that oddly describes the change data under <strong>Status reason</strong>, which is highlighted in blue below. Where one should/would expect the change to appear is highlighted in yellow.</p>
<div class="highlight"><pre><span></span><code>{
        &quot;activityDateTime&quot;: &quot;2023-08-30T03:00:57.8173676+00:00&quot;,
        &quot;activityDisplayName&quot;: &quot;Update Sign-In Risk Policy&quot;,
        &quot;additionalDetails&quot;: [
        ],
        &quot;category&quot;: &quot;Policy&quot;,
        &quot;correlationId&quot;: &quot;bcda8418-f5f0-42f4-a8c1-cc809be64050&quot;,
        &quot;id&quot;: &quot;ADIbizaUX_bcda8418-f5f0-42f4-a8c1-cc809be64050_MZXCC_6463221&quot;,
        &quot;initiatedBy&quot;: {
            &quot;user&quot;: {
                &quot;displayName&quot;: null,
                &quot;homeTenantId&quot;: null,
                &quot;homeTenantName&quot;: null,
                &quot;id&quot;: &quot;d7148226-7444-4884-aef7-b5fe693a6798&quot;,
                &quot;ipAddress&quot;: &quot;X.X.X.X&quot;,
                &quot;userPrincipalName&quot;: &quot;ga-x@x.onmicrosoft.com&quot;
            }
        },
        &quot;loggedByService&quot;: &quot;AAD Management UX&quot;,
        &quot;result&quot;: &quot;success&quot;,
        &quot;resultReason&quot;: &quot;Set sign-in risk policy successful. Enabled: True. Risk level for MFA: Never. Risk level for block: High. Include All Users: False. Include Users: 788aff42-e628-4ff9-8e17-a207350ed80b. Include Groups: . Exclude All Users: False. Exclude Users . Exclude Groups &quot;,
        &quot;targetResources&quot;: [
            {
                &quot;displayName&quot;: &quot;Sign-In Risk Policy&quot;,
                &quot;groupType&quot;: null,
                &quot;id&quot;: &quot;5bf6637e-056a-4f1c-b887-6c7e99ed5ac6&quot;,
                &quot;modifiedProperties&quot;: [
                ],
                &quot;type&quot;: &quot;Policy&quot;,
                &quot;userPrincipalName&quot;: null
            }
        ],
        &quot;userAgent&quot;: &quot;&quot;
    },
    {
        &quot;activityDateTime&quot;: &quot;2023-08-30T03:00:57.181057+00:00&quot;,
        &quot;activityDisplayName&quot;: &quot;Update policy&quot;,
        &quot;additionalDetails&quot;: [
            {
                &quot;key&quot;: &quot;User-Agent&quot;,
                &quot;value&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/116.0&quot;
            }
        ],
        &quot;category&quot;: &quot;Policy&quot;,
        &quot;correlationId&quot;: &quot;b06b42f1-4723-45bb-b205-59eae5ab7da3&quot;,
        &quot;id&quot;: &quot;Directory_b06b42f1-4723-45bb-b205-59eae5ab7da3_FYNFV_398999217&quot;,
        &quot;initiatedBy&quot;: {
            &quot;user&quot;: {
                &quot;displayName&quot;: null,
                &quot;homeTenantId&quot;: null,
                &quot;homeTenantName&quot;: null,
                &quot;id&quot;: &quot;d7148226-7444-4884-aef7-b5fe693a6798&quot;,
                &quot;ipAddress&quot;: &quot;X.X.X.X&quot;,
                &quot;userPrincipalName&quot;: &quot;ga-x@x.onmicrosoft.com&quot;
            }
        },
        &quot;loggedByService&quot;: &quot;Core Directory&quot;,
        &quot;result&quot;: &quot;success&quot;,
        &quot;resultReason&quot;: &quot;&quot;,
        &quot;targetResources&quot;: [
            {
                &quot;displayName&quot;: &quot;Sign-In Risk Policy&quot;,
                &quot;groupType&quot;: null,
                &quot;id&quot;: &quot;5bf6637e-056a-4f1c-b887-6c7e99ed5ac6&quot;,
                &quot;modifiedProperties&quot;: [
                    {
                        &quot;displayName&quot;: &quot;Included Updated Properties&quot;,
                        &quot;newValue&quot;: &quot;\&quot;\&quot;&quot;,
                        &quot;oldValue&quot;: null
                    }
                ],
                &quot;type&quot;: &quot;Policy&quot;,
                &quot;userPrincipalName&quot;: null
            }
        ],
        &quot;userAgent&quot;: null
    },
</code></pre></div>
<h3 id="responsible-disclosure"><a class="toclink" href="2023/08/29/dude-wheres-my-audit-logs/#responsible-disclosure">Responsible disclosure</a></h3>
<p>After consideration and reading of what constitutes a security vulnerability at the Microsoft Security Response Center (MSRC), I do not believe that these deficiencies in auditing would be considered a security vulnerability, as the absence of audit data itself is not a vulnerability.</p>
<p>On July 26th, 2023, through an MVP channel in the Customer Connected Program Entra Advisors, I reached out to the Microsoft Entra Product Group wanting to provide feedback on what I believe are audit gaps in Entra ID.</p>
<p>After some exchanges to coordinate whom to send the feedback to, on August 7th I provided an email to the responsible parties in the PG covering audit logging. Microsoft did reply that they will investigate in response. Considering that this is not a security vulnerability, I do not believe there is harm in publishing this material prior to any (if any) changes occur on the part of Microsoft.</p>
<p>A case with Microsoft support has not been opened on this subject to this point, on which I would open one if directed by the PG.</p>
<h3 id="regarding-audit-log-analysis"><a class="toclink" href="2023/08/29/dude-wheres-my-audit-logs/#regarding-audit-log-analysis">Regarding audit log analysis</a></h3>
<p>In my endeavors to this point, I have not analyzed <strong>all</strong> audit log events in Entra ID, so there may still be additional gaps in what one might find to be acceptable auditing. While Microsoft may contend that they indicate in their own docs that some of these changes are not listed as being audited, I would counter that with the stances that every single configuration change in Entra ID should be audited <strong>and</strong> adhere to some sort of audit log schema for consistency.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-07-17 00:00:00+00:00">July 17, 2023</time></li>
        
        
          
          <li class="md-meta__item">
            
              11 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="protect-your-privilege-with-paw"><a class="toclink" href="2023/07/17/protect-your-privilege-with-paw/">Protect Your Privilege with PAW</a></h2>
<p>According to the Microsoft Digital Defense Report 2022, weak identity controls are listed as a top three contributing factors found during ransomware incident response. One particularly troubling finding within identity controls is the lack of Privileged Access Workstations (PAW) found in any response engagement:</p>
<p><em>None of the impacted organizations implemented proper administrative credential segregation and least privilege access principals via dedicated workstations during the management of their critical identity and high-value assets, such as proprietary systems and business-critical applications.</em></p>
<p><em><a href="https://www.microsoft.com/en-us/security/business/microsoft-digital-defense-report-2022?WT.mc_id=SEC-MVP-5005105">Microsoft Digital Defense Report 2022, page 15 (Microsoft Digital Defense Report 2022 | Microsoft Security)</a></em></p>
<p>The report does not speculate as to <strong>why</strong> the organizations were not using PAW, but for anyone seasoned out there in the world of consultancy the answers will look like:</p>
<ul>
<li>Lack of time/budget/resources/priority</li>
<li>Lack of understanding and education</li>
<li>Lack of sufficient desire to change privileged administrative behavior</li>
<li>Belief that they have other sufficient compensating controls</li>
</ul>
<p>And these all really relate to each other ‚Äì if you don‚Äôt understand what a PAW is, you can easily believe other solutions such as PIM or PAM will sufficiently fill the gap. Likewise, if you don‚Äôt understand how to articulate the value and principles behind PAW, it‚Äôs difficult to run it up the chain to ensure that it has priority. Even in those instances where you may have a decent understanding of PAW, but as an admin don‚Äôt want to change your working behavior ‚Äì it‚Äôs understandable, it‚Äôs human to not want to change without knowing why.</p>
<p>Awareness is the first principle of ADKAR (<a href="https://www.prosci.com/resources/articles/why-the-adkar-model-works">The Prosci ADKAR Model: Why it Works</a>). May this article build that awareness, so you‚Äôll come out of it with the second principle, desire.</p>
<h3 id="keeping-it-clean"><a class="toclink" href="2023/07/17/protect-your-privilege-with-paw/#keeping-it-clean">Keeping it clean</a></h3>
<p>One of the foundational components of privileged access is the clean source principle, which per Microsoft states:</p>
<p><em>The clean source principle requires all security dependencies to be as trustworthy as the object being secured.</em></p>
<p><em>Microsoft Learn, <a href="https://learn.microsoft.com/en-us/security/privileged-access-workstations/privileged-access-success-criteria?WT.mc_id=SEC-MVP-5005105#clean-source-principle">Success criteria for privileged access strategy | Microsoft Learn</a></em></p>
<p>To phrase this another way, all components related to privileged access ‚Äì the user accounts, the devices, the first- and third-party tools, all need to exist and be managed fully within the same security tier. Since the primary focus of PAW is for privileged access, that means everything related to PAW needs to be encompassed within the same tier as privileged access.</p>
<p>Microsoft documents this in their privileged access implementation documentation, and diagrams this out as follows:</p>
<p><img alt="Figure 1" src="/images/2023/07/17/img1.png" /></p>
<p><em>Note Privileged Security highlighted in the red box. Image courtesy Microsoft.</em></p>
<p>Those that are seasoned with Active Directory security may be more familiar with the Tiered access model, composed of Tier 0, Tier 1, and Tier 2, as diagrammed below:</p>
<p><img alt="Figure 2" src="/images/2023/07/17/img2.png" /></p>
<p><em>The Active Directory oriented privileged access model.</em></p>
<p>What is important to understand is that in the new model of privileged security, Tier 0 does not go away. There are subsets of privileged security ‚Äì Tier 0 effectively becomes the control plane, encompassing all existing Tier 0 assets, such as Active Directory and related systems such as Azure AD Connect and AD FS. Tier 0 now includes the <strong>Control Plane</strong>, which is highly privileged access that provides control over all resources. The credentials associated with the control plane are<strong> Global Administrator</strong>, and users that hold roles which can <strong>directly</strong> or <strong>indirectly obtain control</strong> over a Global Administrator. It has become important to include these accounts in that realm of Tier 0 access, as we tend to only focus on Global Administrator. As an example, Privileged Authentication Administrator roles can be used to reset authentication information on all accounts in a tenant. Intune Administrators, in a cloud-managed PAW deployment, become encompassed in Tier 0, as they can manipulate and manage PAW devices. Tier 1 becomes the Management and Data and Workload planes and still includes the Server Admin role; still privileged, but importantly still separated from the control plan and Tier 0. While the focus on the part of Microsoft is very cloud-oriented, privilege separation and the delineation are still critical for Active Directory, as well as using PAW for Active Directory management ‚Äì majority of enterprises will still be leaning on Active Directory for a good while. And speaking of Active Directory, for the organizations that have hybrid identity, where Active Directory and Azure AD are connected, organizations need to understand the paths of lateral movement and privilege escalation between the two identity providers; there are known attack paths where Active Directory can be leveraged to takeover Azure AD, as well as the opposite flow. These are just some examples, and role delineation and definition can be an article on its own ‚Äì let me know if that would interest you. In the meantime, you can read about this evolution and how Microsoft defines it here, <a href="https://learn.microsoft.com/en-us/security/privileged-access-workstations/privileged-access-access-model?WT.mc_id=SEC-MVP-5005105#evolution-from-the-legacy-ad-tier-model">Securing privileged access Enterprise access model | Microsoft Learn</a>.</p>
<p>Both models are still widely used and the principles behind them are valid. What is critical is that both models indicate that the <strong>device</strong> should be a PAW. Specifically, a <strong>physical device initiating session</strong>. The phrase clean keyboard may be thrown around at times as a bit of shorthand for the clean source principle.</p>
<h3 id="what-a-paw-is-not"><a class="toclink" href="2023/07/17/protect-your-privilege-with-paw/#what-a-paw-is-not">What a PAW is not</a></h3>
<p>Organizations may take shortcuts to PAW, either by implementing something ‚ÄúPAW like‚Äù, such as jump boxes or bastion hosts, or virtualizing their PAW. The term ‚Äúcloud PAW‚Äù floats around out there, which assumptions made that it equates to deploying PAW as virtual desktops.</p>
<p>In all these scenarios you either run into:</p>
<ul>
<li>The chicken-and-egg problem</li>
<li>A tiering breach</li>
</ul>
<h4 id="bastion-hosts-jump-boxes-and-cloud-paw"><a class="toclink" href="2023/07/17/protect-your-privilege-with-paw/#bastion-hosts-jump-boxes-and-cloud-paw">Bastion hosts, jump boxes and cloud PAW</a></h4>
<p>Both bastion hosts and jump boxes can serve their purpose for managing resources, but they are not replacement for PAW. To adhere to the clean source principle, any remote access to a bastion host or jump box would need to be initiated from a device that already exists within the privileged security tier, otherwise you‚Äôll encounter an upward tiering breach.</p>
<p><img alt="Figure 3" src="/images/2023/07/17/img3.png" /></p>
<p><em>Breaching tiers with a cloud-based solution such as bastion hosts or jump boxes</em></p>
<p>Even in the case where you may be used advanced technologies such as passwordless for authentication, some component of the authentication process will be local to the enterprise device, putting the privileged user account at risk of exposure on a lower tier.</p>
<p>And what about cloud PAW? This is a place of much confusion, as it‚Äôs a term thrown about that is derived from the Microsoft model of using <strong>cloud managed PAW</strong>. That managed word being the key piece ‚Äì Microsoft documents how organizations can build and deploy PAW that are managed by Intune and joined to Azure AD. You can find that documentation here, <a href="https://learn.microsoft.com/en-us/security/privileged-access-workstations/privileged-access-deployment?WT.mc_id=SEC-MVP-5005105">Deploying a privileged access solution | Microsoft Learn</a>. As it goes with terminology, cloud managed PAW may sometimes be shortened to cloud PAW, and when people see cloud PAW, they presume that it means a PAW that exists within the cloud.</p>
<p>You‚Äôll still find several articles and models out there where people attempt to build out a cloud-native PAW system, using things like Azure Virtual Desktop or Windows 365. And some of them <strong>might</strong> have an acceptable level of risk built into their design where there is enough monitoring and other compensating controls to minimize potential privileged access damage. Considering that ransomware can cost organizations millions of dollars in losses due to the inability to function, or even put them out of business, that‚Äôs the risk that needs to be factored in with something like a cloud PAW design. I‚Äôve yet to see one that adheres to the clean source principle.</p>
<h4 id="virtualized-paw"><a class="toclink" href="2023/07/17/protect-your-privilege-with-paw/#virtualized-paw">Virtualized PAW</a></h4>
<p>Virtualizing your PAW results in the same series of issues as jump boxes and bastion hosts. Unless your virtualization environment is composed of resources that exist on and are managed in Tier 0, your Tier 1 administrators will be indirect administrators of those vPAW, and in turn access to other critical Tier 0 resources.</p>
<p><img alt="Figure 4" src="/images/2023/07/17/img4.png" /></p>
<p><em>Tier 1 admins can become Tier 0 admins through the management plane</em></p>
<p>It‚Äôs also important to consider the implications of not managing business critical Tier 1 resources from a PAW. We can expand our breach model out another layer and see that we are putting all resources at risk when we don‚Äôt use a physical PAW.</p>
<p><img alt="Figure 5" src="/images/2023/07/17/img5.png" /></p>
<p><em>The cascading tier breach with virtualized PAW</em></p>
<p>Some organizations may choose to run localized instances of virtualization software on their Enterprise devices, such as enabling Hyper-V within Windows 11. In these cases, the same problems apply: the enterprise user will still be authenticating with some mechanism local to the device with privileged credentials. The virtualized PAW will be susceptible to the same management plane attacks that would occur in an enterprise virtualization scenario.</p>
<p><img alt="Figure 6" src="/images/2023/07/17/img6.png" /></p>
<p><em>Localized virtualization of a vPAW breaching tiers</em></p>
<h3 id="why-pim-and-pam-compliment-but-do-not-replace-paw"><a class="toclink" href="2023/07/17/protect-your-privilege-with-paw/#why-pim-and-pam-compliment-but-do-not-replace-paw">Why PIM and PAM compliment, but do not replace, PAW</a></h3>
<p>PIM and PAM solutions are great mechanisms from a defense-in-depth perspective, but they do little to protect credentials once the credential is resident on the device in question.</p>
<p>A primary component of PAM solutions is password vaulting, which is great for granular control and auditing of who has access to secrets. Once that secret becomes resident on the device, however, it is as vulnerable as all the other credentials on the device. With more advanced and modern PAM solutions, there are mechanisms that provide a bastion host/jump box, to ensure that the vaulted credentials are not resident to the local device. However, you still will run into the same issues with bastion hosts and jump boxes ‚Äì you still need to connect into the components providing this solution, which includes authenticating and creating a session. If you want to protect the session end-to-end, the source device still needs to adhere to the clean source principle, which in this case would be from a PAW.</p>
<p>PIM also compliments PAW but is not a replacement on its own. While PIM is great for providing the least standing privilege and enabling the use of just-in-time (JIT) privileges, once privileges are elevated in a system, any threat actor obtains your credentials, or a representation of them (such as tokens) will be able to act as you, with those elevated privileges.</p>
<h3 id="paw-greatly-reduces-the-surface-area-on-privileged-accounts"><a class="toclink" href="2023/07/17/protect-your-privilege-with-paw/#paw-greatly-reduces-the-surface-area-on-privileged-accounts">PAW greatly reduces the surface area on privileged accounts</a></h3>
<p>The purpose of a defense-in-depth model is to ensure that if one component fails, there are other components that will ensure that data, the core of every modern business, is not exposed to those who should not have access to that data.</p>
<p><img alt="Figure 7" src="/images/2023/07/17/img7.png" /></p>
<p><em>Defense-in-depth model</em></p>
<p>If we drill down into this model further, we will see that each layer is composed of several different technologies ‚Äì especially when we are talking about privileged access to that data.</p>
<p>If we broke down the Identity &amp; Access layer of the model, we might see something like this:</p>
<p><img alt="Figure 8" src="/images/2023/07/17/img8.png" /></p>
<p><em>A breakdown of the Identity &amp; Access Management Layer concerning privileged credentials</em></p>
<p>PAW is foundational to the design theory of several other components ‚Äì filling in the gaps PIM and PAM/secret vaulting present, but also building the strong foundation for which robust conditional access policies can be applied, device security policies can be pushed down from Intune, and account separation can be used to its fullest potential, ensuring that a mistake made with enterprise level credentials do not expose privileged creds.</p>
<h3 id="paw-doesnt-have-to-be-complex-to-deploy"><a class="toclink" href="2023/07/17/protect-your-privilege-with-paw/#paw-doesnt-have-to-be-complex-to-deploy">PAW doesn‚Äôt have to be complex to deploy</a></h3>
<p>As it goes with much of the privileged access documentation out there, there is the perception that everything is extremely time-consuming and overly complex. Organizations and security practitioners need to reshape their thinking relative to security privileged access, including the deployment of PAW.</p>
<p>Yes, depending on how your organization is structured, cloud managed PAW will require knocking down some silos between the teams that manage identity and devices within the organization; that‚Äôs work that should be happening anyway. Afterall, identity and device management practitioners are both security practitioners in modern environments.</p>
<p>As with most guidance though, starting somewhere is better than nowhere. Having an incremental approach and open mindset is a stronger security posture than saying if we can‚Äôt achieve 100% in x time, then it‚Äôs not worth doing at all.</p>
<p>If nothing else, justify the expense to procure some modern laptops to be used as the privileged devices for those Tier 0 Global Administrators and Domain Administrators, preferably one that is a secured-core device. You can find currently available ones here, <a href="https://www.microsoft.com/en-us/windows/business/windows-11-secured-core-computers?WT.mc_id=SEC-MVP-5005105">Windows 11 Secured-Core PCs | Microsoft</a>. The few thousand-dollar proactive expense is cheaper than the loss of business <strong>when</strong> your organization is breached. You can go one step further and configure some strong conditional access policies restricting what devices the privileged accounts can be used from. For details, see Filter for devices as a condition in <a href="https://learn.microsoft.com/en-us/azure/active-directory/conditional-access/concept-condition-filters-for-devices?WT.mc_id=SEC-MVP-5005105#create-a-conditional-access-policy">Conditional Access policy ‚Äì Microsoft Entra | Microsoft Learn</a>.</p>
<p>Eventually though make sure you take the time to go through the entire process, found here, <a href="https://learn.microsoft.com/en-us/security/privileged-access-workstations/privileged-access-deployment?WT.mc_id=SEC-MVP-5005105">Deploying a privileged access solution | Microsoft Learn</a>.</p>
<h3 id="the-operational-change-shouldnt-be-a-showstopper"><a class="toclink" href="2023/07/17/protect-your-privilege-with-paw/#the-operational-change-shouldnt-be-a-showstopper">The Operational change shouldn‚Äôt be a showstopper</a></h3>
<p>Once deployed, and enforced, the biggest change in organizations is the operational impact on the privileged administrators. Yes, you may not be able to copypasta that PowerShell snippet you found on Stack Overflow as easily, but in our modern landscape we all must adapt to new ways of working. We made it through the drastic changes with remote work, and transitioning to PAW is much less impactful on the overall organization than that was ‚Äì even if it doesn‚Äôt feel that way to your privileged admins.</p>
<p>Organizations need to make sure that they support the change, as there will be needed ramp up time, and it‚Äôs a suitable time to perform some incident handling testing to make sure administrators can perform all that they need to perform from their PAW. Organizations can be most vulnerable during an incident, whether it‚Äôs cyber, operational, or natural forces, and the mode of operation can‚Äôt be to just throw the PAW aside to fix things. Make sure that your IR, BC, and DR scenarios are reviewed and revised to support the use of PAW, as necessary.</p>
<h3 id="last-thoughts"><a class="toclink" href="2023/07/17/protect-your-privilege-with-paw/#last-thoughts">Last thoughts</a></h3>
<p>One of my favorite tag lines is from Johnathan Fox, a Sr. Security Consultant from Microsoft. The tag is ‚Äúbe a good admin and protect your privilege!‚Äù. Such a simple north star that we all should follow.</p>
<p>And if you‚Äôre an organization supporting your admins, make sure that you be a good organization and support your admins protecting their privilege. With the continually evolving landscape of threat actors, that protection is more critical than ever to ensuring that business doesn‚Äôt stop.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-06-21 00:00:00+00:00">June 21, 2023</time></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="the-noauth-flaw-is-a-symptom-of-industry-antipatterns"><a class="toclink" href="2023/06/21/the-noauth-flaw-is-a-symptom-of-industry-antipatterns/">The nOAuth ‚Äúflaw‚Äù is a symptom of industry antipatterns</a></h2>
<p>If you haven‚Äôt followed the news recently, Descope released an article diving into how their security researchers were able to abuse OpenID Connect (OIDC) ID token claims to spoof the user they are authenticating as for multi-tenant SaaS applications. You can read their research article here, <a href="https://www.descope.com/blog/post/noauth">nOAuth: How Microsoft OAuth Misconfiguration Can Lead to Full Account Takeover (descope.com)</a>.</p>
<p>In conjunction with this, Microsoft has updated developer guidance for OpenID Connect and SAML assertions, and provided a blog post covering all of this, which can be found here, <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/the-false-identifier-anti-pattern/ba-p/3846013">The False Identifier Anti-pattern (microsoft.com)</a>.</p>
<p>Multi-tenant SaaS applications are those applications, such as Canva or Sessionize, which allow you to authenticate with your Microsoft or Office 365 account. Without getting off track, this is what allows SaaS application vendors to develop applications that can integrate with an organizations Azure Active Directory environment requiring no effort on the part of administrators.</p>
<p><img alt="Figure 1" src="/images/2023/06/21/img1.png" /></p>
<p><em>The Sessionize authentication screen allowing a user to select their identity provider.</em></p>
<p>And as it goes whenever there is a security problem, someone must fall on the sword. In this case Microsoft is taking the hit; unfortunately most new articles are incorrectly reporting on this as an Azure AD ‚Äúflaw‚Äù that Microsoft had to ‚Äúfix‚Äù. Kudos to Kurt Mackie (<a href="https://twitter.com/kurmac">@kurmac</a>) at Redmond Mag for being the only article to accurately report on this problem, which you can find here, <a href="https://redmondmag.com/articles/2023/06/21/azure-active-directory-noauth-attack-route.aspx?m=1">Microsoft Advises App Developers About ‚ÄònOAuth‚Äô Attack Route ‚Äî Redmondmag.com</a>. To be fair, Microsoft isn‚Äôt completely innocent, as it took a case like this to really have them sharpen their guidance from a bit of a softer stance, but this is not really a technical flaw. I suppose we can‚Äôt blame others for not wanting to write articles about developers using antipatterns.</p>
<h3 id="the-real-flaw-starts-with-the-security-industry-letting-its-people-down"><a class="toclink" href="2023/06/21/the-noauth-flaw-is-a-symptom-of-industry-antipatterns/#the-real-flaw-starts-with-the-security-industry-letting-its-people-down">The real flaw starts with the security industry letting its people down</a></h3>
<p>So how exactly can we move from a technical problem to blaming the security industry as a whole? Microsoft speaks to the real flaw in their blog article ‚Äì too many developers using antipatterns in software development for authentication and authorization. We can‚Äôt truly blame the developers, as we shouldn‚Äôt expect every developer to just magically be an expert at modern authentication. It‚Äôs difficult to even get identity practitioners to accurately describe the flows many times, so how can we point the finger at others.</p>
<h3 id="education-is-the-enemy-of-antipatterns-but-who-has-time-for-that"><a class="toclink" href="2023/06/21/the-noauth-flaw-is-a-symptom-of-industry-antipatterns/#education-is-the-enemy-of-antipatterns-but-who-has-time-for-that">Education is the enemy of antipatterns, but who has time for that</a></h3>
<p>The antipattern word is key here. Antipatterns are patterns that are common enough to become known, yet go against effective design. In this case, the antipattern is developers using the email claim within an ID token to make a ‚Äúgood enough‚Äù assessment of whom the user is.</p>
<p>Antipatterns develop when there is a lack of education, which both the security and software development industry are ripe with. We need every application to do more things faster and quicker and always operating in some perpetual state of beta to ship things quicker to beat the competition. And no, we don‚Äôt have time to slow down to understand what we are doing. Ship it now, fix it later, which is exactly what has happened in this case.</p>
<h3 id="the-silos-of-security-infrastructure-and-development-hinder-progress"><a class="toclink" href="2023/06/21/the-noauth-flaw-is-a-symptom-of-industry-antipatterns/#the-silos-of-security-infrastructure-and-development-hinder-progress">The silos of security, infrastructure, and development hinder progress</a></h3>
<p>The fact that most organizations still operate with varying degrees of silos is the secret everyone knows about but in most cases chooses to ignore.</p>
<p>For proper modern authentication development, we need developers that cross the boundaries between identity practitioner and coder. While logically most organizations can‚Äôt operate in a flat structure, we need to better adapt to remove these silos and let key players straddle the line. These key players need to be architects and engineers and developers who are allowed to cross-collaborate and want to cross-collaborate. If we enter a realm where identity security is dictated instead of collaborated, things rapidly break down.</p>
<p>This collaborative team should be proportionately sized to the organization, but whether you are an identity software vendor (ISV) or an enterprise that develops line-of-business (LOB) applications, you will still greatly benefit from the collaboration around identity implementations within your software.</p>
<h3 id="ignoring-the-need-for-change-continues-to-accrue-risk"><a class="toclink" href="2023/06/21/the-noauth-flaw-is-a-symptom-of-industry-antipatterns/#ignoring-the-need-for-change-continues-to-accrue-risk">Ignoring the need for change continues to accrue risk</a></h3>
<p>In the nOAuth case, the organizations selling SaaS applications were not named, and the problem was mitigated behind the scenes. But it‚Äôs a case of luck in that the ‚Äúgood team‚Äù was first to find the rampant use of these antipatterns. If things turned out worse, and account takeover has happened, it can become a very fast trip to the loss of consumer confidence and depending on your industry or geopolitical region regulator fines and other penalties, from data exfiltration and exposure. It also instills the fear, uncertainty, and doubt, in the industry, almost as a self-fulfilling prophecy that inhibits the industry to move forward. Imagine if your bank account could simply be taken over by someone spoofing your email address in a claim ‚Äì it‚Äôs a fast route to never modernizing identity and leaving us in our current state of too many accounts, too many passwords, too many ways to authenticate, failing our end users.</p>
<h3 id="final-thoughts"><a class="toclink" href="2023/06/21/the-noauth-flaw-is-a-symptom-of-industry-antipatterns/#final-thoughts">Final Thoughts</a></h3>
<p>Start collaborating on identity within your organization across all the silos it touches. Prioritize education, for real this time. Your consumers will thank you for it, even if they don‚Äôt know they need to.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-05-04 00:00:00+00:00">May 4, 2022</time></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="world-password-day"><a class="toclink" href="2022/05/04/world-password-day/">World Password Day</a></h2>
<p>Forget passwords. Passwords are garbage. To celebrate World Password Day, I‚Äôm curating blog articles that can help organizations on their passwordless journey.</p>
<p>While much of the Microsoft documentation on passwordless is quite good, it can tend to be overwhelming at times; the hope is to give you some great leads on some clear, step-by-step instructions on how to get you from a password-filled to a passwordless world in Active Directory and Azure AD.</p>
<p>With each link, I‚Äôve provided a rough time estimate for how long the process should take, given a dedicated effort. There may always be the fringe case or two where passwordless is more complex ‚Äì if your existing environment has things such as ADFS and using smartcards, or has DC‚Äôs older than 2016, you have a bunch of Mac‚Äôs in your environment, as examples. It always helps to review the documentation, which I also link to.</p>
<p>If you want to dive further into why this is so important, I‚Äôll refer you to these two blog articles from Alex Weinert [<a href="https://twitter.com/Alex_T_Weinert">@Alex_T_Weinert</a>], the Director of Identity Security at Microsoft.</p>
<p>Your Pa$$word doesn‚Äôt matter ‚Äì Microsoft Tech Community ‚Äì Alex discusses why MFA is so important.</p>
<p>All your creds are belong to us! ‚Äì Microsoft Tech Community ‚Äì Alex discusses why passwordless strong authentication is important and shows why more common forms of MFA are still phishable.</p>
<p>See something missing? Still have questions? Not sure how the underlying technology works? Reach out to me.</p>
<p>And if you are a fellow Microsoft blogger who thinks their article would be a good fit, but it‚Äôs not on here? Reach out and I‚Äôll update accordingly.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-04-26 00:00:00+00:00">April 26, 2022</time></li>
        
        
          
          <li class="md-meta__item">
            
              6 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="azure-ad-you-should-disable-this-legacy-mfa-setting"><a class="toclink" href="2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/">Azure AD: You Should Disable This Legacy MFA Setting</a></h2>
<p>When talking with organizations about securing their Azure AD tenants, there is always a focus on the latest and greatest, and all the ways it brings everyone forward on the Zero Trust journey. Advancements in Conditional Access, Windows Hello for Business, FIDO2 ‚Äì the focus is on what‚Äôs new and where to go. Occasionally there is the reminder to block legacy authentication (speaking of ‚Äì have you?), but the focus tends to be on what‚Äôs new, and not reviewing what‚Äôs old.</p>
<p>There is one setting, however, that tends to lurk deep within Azure AD tenants, especially for organizations that have had their tenant for a long while, that goes unnoticed, and when left enabled, allows users to potentially interfere with what we believe to be their authentication pattern.</p>
<h3 id="whats-the-setting"><a class="toclink" href="2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#whats-the-setting">What's the setting?</a></h3>
<p>If we dig into the legacy multi-factor authentication service settings portal, which can be found by browsing to <strong>Azure AD -&gt; Security -&gt; MFA</strong>, and then on the <strong>right</strong>, under <strong>Configure</strong>, select <strong>Additional cloud-based MFA settings</strong>. It will bring you to the following:</p>
<p><img alt="Figure 1" src="/images/2022/04/26/img1.png" /></p>
<p>The setting we are focused on is at the bottom. Under <em>remember multi-factor authentication on trusted device, Allow users to remember multi-factor authentication on devices they trust.</em></p>
<h3 id="whats-the-problem"><a class="toclink" href="2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#whats-the-problem">What's the problem?</a></h3>
<p>The name of the setting doesn‚Äôt really explain it well. The Microsoft Docs article that explains the details of this setting can be found here, <a href="https://docs.microsoft.com/en-us/azure/active-directory/authentication/howto-mfa-mfasettings#remember-multi-factor-authentication">Configure Azure AD Multi-Factor Authentication ‚Äì Azure Active Directory | Microsoft Docs</a>.</p>
<p>Even though there is an additional note provided, a lot of organizations don‚Äôt even recall this setting exists ‚Äì either they have never had to come to this set of options to begin with, or it was enabled several years ago and never reviewed again. Unfortunately, this setting is not well exposed in Azure AD.</p>
<p>When enabled in an Azure AD tenant, it allows end-users to make the decision on what a ‚Äútrusted device‚Äù is. The heading for the setting, when glanced over, may make you believe it relates to trusted devices, as in compliant devices. But as we see within the details, the user is making that trust decision.</p>
<p>And the issue with that trust decision, is that it allows the user to choose to drop an MFA persistence cookie, <strong>completely separate</strong> from the refresh token, in the browser.</p>
<p>So even if our user chooses to <strong>sign-out</strong>, and even if they choose in the browser the option to <strong>forget</strong> their username from the sign-in menu, this cookie persists.</p>
<p>The user experience, with this setting enabled, will show the following during sign-in:</p>
<p><img alt="Figure 2" src="/images/2022/04/26/img2.png" /></p>
<p>When enabled, the <strong>Don‚Äôt ask again for 90 days</strong> (or whatever interval is set in your organization) shows up and is checked by default.</p>
<p>On subsequent user sign-in, the user <strong>will not be prompted for MFA</strong>, unless the time specified in the setting has lapsed, or the browser cookies have been cleared.</p>
<p>You will see the following in the Sign-in details:</p>
<p><img alt="Figure 3" src="/images/2022/04/26/img3.png" /></p>
<p>This setting is <strong>not the same</strong> as the <strong>Keep Me Signed In (KMSI)</strong> settings in Azure AD, which allow the user to retain their refresh token in their browser when they close it. The KMSI experience invalidates the token during user sign-out, and upon sign-in provides the expected behavior of calling for both primary authentication and MFA (if there is an MFA requirement).</p>
<h3 id="why-exactly-is-this-a-problem"><a class="toclink" href="2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#why-exactly-is-this-a-problem">Why exactly is this a problem</a></h3>
<p>While it may be alluded to above, this setting weakens the security posture regarding MFA. It allows users to subvert when we may be requiring Conditional Access to call for MFA. Now we are not saying our user is doing anything malicious ‚Äì this is a setting we enable and it‚Äôs logical that a user would select this. Users will pick whatever options make getting the job done with the least amount of friction.</p>
<p>If the device is or becomes compromised, the user account will become an easier target to malicious actors. Just think of any device you have the least amount of trust in, which usually is some sort of shared device outside the corporate boundaries, and then allow the user to make the trust decision. It‚Äôs not a great recipe.</p>
<h3 id="determining-the-usage"><a class="toclink" href="2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#determining-the-usage">Determining the usage</a></h3>
<p>If you‚Äôve looked at your settings, and you see that this setting is disabled, then you can just stop here.</p>
<p>If you‚Äôve found that this setting is enabled, you want to understand how widespread the usage is before disabling it. The fewer users leveraging it, the swifter the change process.</p>
<p>We want to explore our Azure AD Sign-in logs, however, we cannot filter granularly within the portal.</p>
<p>Using Log Analytics, the following query will help show who, where they are coming from, and the device information. The query is written to highlight distinct devices:</p>
<div class="highlight"><pre><span></span><code>SigninLogs
| where TimeGenerated &gt; ago(30d) //Set time period to within the last 30 days
| where Status.additionalDetails == &quot;MFA requirement skipped due to remembered device&quot; //String to search for
| project UserPrincipalName,IPAddress,OS = tostring(DeviceDetail.operatingSystem),Browser = tostring(DeviceDetail.browser),City = tostring(LocationDetails.city),State = tostring(LocationDetails.state),Country = tostring(LocationDetails.countryOrRegion) //Pull JSON data into strings
| distinct UserPrincipalName,IPAddress,OS,Browser,City,State,Country //Filter for distinct instances
</code></pre></div>
<p>If you do not have access to Log Analytics, you can export your Azure AD Sign-in logs in either CSV or JSON format and parse the data out accordingly, the string you will want to search for is <strong>MFA requirement skipped due to remembered device</strong>.</p>
<h3 id="remediation"><a class="toclink" href="2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#remediation">Remediation</a></h3>
<p>I‚Äôll preface that I‚Äôve had dozens of organizations disable this setting with little notice to end-users, and with little disruption to their lives. Many of those organizations did not even search their logs prior to disabling it.</p>
<p>This only impacts browser sessions. Client applications will never present this prompt, regardless of whether the client application is on a mobile device or Windows.</p>
<p>If we are using Windows Hello for Business, FIDO2 security keys, or Authenticator App for Primary Auth, all those mechanisms provide for strong-authentication within them, and are not impacted by this setting.</p>
<p>For Azure AD Joined (AADJ) or Hybrid Azure AD Joined (HAADJ) devices, even if our users are using passwords and are requested to perform MFA, their PRT will obtain an MFA claim within it during the first run, and users will not be frequently prompted for MFA subsequently.</p>
<p>That‚Äôs a long way of saying the impact is usually limited to web browsers on personal devices that have no relationship to the Azure AD tenant. The devices we trust the least.</p>
<p>Once comfortable turning off this setting, it‚Äôs simply a matter of unchecking the box in the MFA service settings portal we examined above.</p>
<h3 id="if-you-want-to-limit-mfa-lifetime"><a class="toclink" href="2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#if-you-want-to-limit-mfa-lifetime">If you want to limit MFA lifetime</a></h3>
<p>I‚Äôve encountered some organizations who have this setting enabled, and the number dialed way down. When talking about corporate devices or devices we have insight into, through either MDM, MAM, hybrid trust, or such, it‚Äôs not recommended to limit MFA lifetime. We already have a level of trust established and prompting users frequently for MFA will not only create friction in the user experience, as well as sets our users up to be both more susceptible to MFA phishing (you get trained to just perform MFA without thought) and devise ways around security.</p>
<p>If you have business scenarios that call for the desire to prompt more frequently for MFA, Conditional access offers Sign-in frequency session controls as well as Persistent browser session controls, which can be targeted to non-corporate managed devices. Authentication context also allows for scenarios where we want to call for strong authentication scenarios when users are accessing sensitive information. These settings offer a higher level of precision to target certain scenarios while not negatively impacting the broader user experience.</p>
<h3 id="final-notes"><a class="toclink" href="2022/04/26/azure-ad-you-should-disable-this-legacy-mfa-setting/#final-notes">Final notes</a></h3>
<p>This setting really has been a carry-over from when we didn‚Äôt have the power available from Conditional Access, and unfortunately, it‚Äôs well hidden in that dusty MFA settings portal almost nobody ever treks into. Lucky for us, it‚Äôs a quick win in the name of security to disable.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://new.ericonidentity.com/images/crazy-eric.jpg" alt="Eric Woodruff">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-04-21 00:00:00+00:00">April 21, 2022</time></li>
        
        
          
          <li class="md-meta__item">
            
              6 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="azure-ad-cross-tenant-access-settings-clarity"><a class="toclink" href="2022/04/21/azure-ad-cross-tenant-access-settings-clarity/">Azure AD: Cross-tenant Access Settings Clarity</a></h2>
<p>With the release of Azure AD cross-tenant access settings, I‚Äôve noted some confusion among folks as to what it <strong>is</strong>, and as importantly, what it <strong>isn‚Äôt</strong>.</p>
<p>I‚Äôll also be covering B2B Direct Connect, because even though it‚Äôs a separate feature, with release coinciding at the same time as cross-tenant access settings, I see it all being lumped ‚Äúinto the same‚Äù set of preview features.</p>
<p>The Microsoft Docs article on this is an excellent source of information, which can be found here, <a href="https://docs.microsoft.com/en-us/azure/active-directory/external-identities/cross-tenant-access-overview">Cross-tenant access overview ‚Äì Azure AD | Microsoft Docs</a>. Along with that, we‚Äôll dive into the background and use cases for this new suite of knobs and dials for our external identities.</p>
<h3 id="terminology"><a class="toclink" href="2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#terminology">Terminology</a></h3>
<p><strong>Guest</strong> ‚Äì For clarity, when speaking about guest users for the context of this post, we are talking about users invited into your Azure AD tenant.</p>
<p><strong>Resource Azure AD Tenant [Resource Tenant]</strong> ‚Äì If you are inviting guests <strong>into</strong> your Azure AD tenant, <strong>your</strong> tenant is the resource tenant. It represents your organization. If you are a <strong>guest</strong>, then the resource tenant is the tenant you have been invited into.</p>
<p><strong>Home Azure AD Tenant [Home Tenant]</strong> ‚Äì This is the tenant where the user objects live. If your user object exists in your organizations Azure AD tenant, your tenant is <strong>both</strong> the home tenant and resource tenant ‚Äì your users and applications all ‚Äúlive‚Äù in the same place. Guests into your tenant will have a <strong>different</strong> home tenant.</p>
<h3 id="what-it-is-not"><a class="toclink" href="2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#what-it-is-not">What it is not</a></h3>
<p>Before getting into what we can do with cross-tenant access settings, let‚Äôs cover what this is not (at least at the time of this writing).</p>
<h4 id="parity-to-an-active-directory-trust"><a class="toclink" href="2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#parity-to-an-active-directory-trust">Parity to an Active Directory trust</a></h4>
<p>Cross-tenant access settings may invoke a feeling of configuring a trust in Active Directory, which many Microsoft identity practitioners may be familiar with.</p>
<p>It is closer to the <strong>opposite</strong> of a trust, in the sense that by default Active Directory has no implicit trusts, and you must explicitly configure trusts. Azure AD historically is opposite, any organization, unless settings are adjusted, can invite users from any Azure AD tenant into the organization. These settings allow us to be more granular in how we <strong>restrict</strong> guest access inbound and outbound to our Azure AD tenant.</p>
<p>Further, when we examine B2B Direct Connect, we realize that the only use case, currently, is Teams shared channels.</p>
<p>When we think of an Active Directory trust, we think of the fact that user objects only exist in the source user forest. With cross-tenant access settings, and the limitations with B2B Direct Connect, we still must invite user objects into our resource tenant ‚Äì all the other ‚Äúthings‚Äù tied to our Azure AD tenant need the objectID within our resource tenant to reference.</p>
<h3 id="what-it-is"><a class="toclink" href="2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#what-it-is">What it is</a></h3>
<h4 id="a-mechanism-to-provide-granular-b2b-guest-control"><a class="toclink" href="2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#a-mechanism-to-provide-granular-b2b-guest-control">A mechanism to provide granular B2B guest control</a></h4>
<p>When speaking about B2B guests and external identities, many organizations tend to focus on the aspect of guests being invited <strong>into</strong> their tenant. There is the other side to that B2B coin, which is restricting what organizations you may want your users to have access to.</p>
<p>Certain organizations, especially those in the regulated industries, have concern over which external tenants their users can connect to. Up until now, organizations would need to apply tenant restrictions, <a href="https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/tenant-restrictions">Use tenant restrictions to manage access to SaaS apps ‚Äì Azure AD | Microsoft Docs</a>, which has a higher level of complexity to it ‚Äì the implementation requires a proxy to perform traffic inspection and HTTP header insertion.</p>
<p>Now, organizations that have strict requirements regarding outbound guest access can, by default, restrict outbound access, and then create a more granular allow list.</p>
<p>We also now can be granular down to user/group level of who can access certain organizations. Say you want to only allow employees from payroll to be able to access the tenant the vendor uses and restrict outbound access to everyone else ‚Äì now you can do that.</p>
<p>Likewise, there is granularity on the inbound side. Say you are that vendor that processes an organizations payroll and want to ensure that only the known users for the company you serve can come into your organization. You can restrict inbound as well, limiting what guests are allowed in.</p>
<h4 id="a-way-to-trust-external-mfa-and-device-compliance"><a class="toclink" href="2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#a-way-to-trust-external-mfa-and-device-compliance">A way to trust external MFA and Device Compliance</a></h4>
<p>Many organizations that are familiar with conditional access and guest policies have encountered the need to enroll in Azure AD MFA twice or more ‚Äì once for their home tenant and once in every other resource tenant they access. This experience, from a user perspective, is less than ideal.</p>
<p>With cross-tenant access settings, we can now choose to trust MFA from the guest users home tenant. We also can be granular ‚Äì if we want to trust MFA from certain tenants, but require MFA enrollment from others, we can do that.</p>
<p>More interestingly, we can now trust device compliance and hybrid join status, from the guest home tenant. While I still have certain reservations about the quality of relying on hybrid join alone, focusing on device compliance, it really opens a lot of cross-tenant collaboration, and brings an innovative approach to leveraging Zero Trust modeling when working with guests. While this still has the requirement that the guest home tenant must be leveraging Intune or a 3rd party MDM that can report in device compliance, it makes this a possibility.</p>
<p>In my own testing, I was able to leverage device compliance in conditional access for a device in a guest tenant, and it worked with ease.</p>
<h3 id="a-few-lingering-questions"><a class="toclink" href="2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#a-few-lingering-questions">A few lingering questions</a></h3>
<h4 id="where-is-conditional-access-processed"><a class="toclink" href="2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#where-is-conditional-access-processed">Where is Conditional Access processed?</a></h4>
<p>This hasn‚Äôt changed with the new cross-tenant access settings, but it‚Äôs a good time to review.</p>
<p>Conditional access is <strong>always</strong> evaluated in the <strong>resource</strong> tenant.</p>
<p>The resource tenant needs to ensure that their Conditional Access policies meet the needs of protecting their applications.</p>
<p>Likewise, the home tenant <strong>cannot</strong> restrict outbound access to another tenant with Conditional Access. Because the guest is not accessing resources in their tenant, even an all applications block CA policy will not prevent the user from accessing a resource tenant as a guest ‚Äì which really brings us back to what these new settings solve.</p>
<h4 id="where-is-identity-protection-processed"><a class="toclink" href="2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#where-is-identity-protection-processed">Where is Identity Protection processed?</a></h4>
<p>User risk is evaluated in the <strong>home</strong> tenant, and sign-in risk is evaluated in the <strong>resource</strong> tenant for B2B users. When firing up Tor, and accessing O365 with a guest, my test user was blocked by Identity Protection in the home tenant because it was flagged as a high user risk. So depending on the sort of threat detected by Identity Protection, you may find users being restricted by both the home and resource tenant when Identity Protection is in play.</p>
<p>The details on this are further elaborated on in the Microsoft Docs article, <a href="https://docs.microsoft.com/en-us/azure/active-directory/identity-protection/concept-identity-protection-b2b#how-does-identity-protection-work-for-b2b-users">Identity Protection and B2B users ‚Äì Azure Active Directory | Microsoft Docs</a>.</p>
<h3 id="one-new-trick-out-of-a-possible-many"><a class="toclink" href="2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#one-new-trick-out-of-a-possible-many">One new trick - out of a possible many</a></h3>
<h4 id="pim-in-the-home-tenant-for-outbound-guest-access"><a class="toclink" href="2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#pim-in-the-home-tenant-for-outbound-guest-access">PIM in the home tenant for outbound guest access</a></h4>
<p>The ability to apply PIM to guest user accounts is not new. But if we combine the preview feature of PIM for group membership, and apply outbound restrictions to a certain group, the <strong>home</strong> tenant can build a request process for outbound access.</p>
<p>In that this is quite restrictive, I would see a narrow range of use cases, as it really hampers collaboration between tenants. For those organizations who previously completely turned off the ability to collaborate with other organizations due to things like data sensitivity, the door might now be opened a bit.</p>
<h3 id="final-notes"><a class="toclink" href="2022/04/21/azure-ad-cross-tenant-access-settings-clarity/#final-notes">Final notes</a></h3>
<p>External Identities and B2B are continually evolving. While there is still a large gap to bridge for many situations, this definitely is bringing us one step closer. B2B Direct Access in particular will be interesting to see how Microsoft evolves it ‚Äì will it come closer to how an AD trust operates, or will there be improvements on how guests are invited into tenants.</p>
<p>As usual, any questions/concerns/comments please reach out to me, and if you find any new unique use cases for cross-tenant access settings, would love to hear them.</p>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <span class="md-pagination__current">1</span> <a class="md-pagination__link" href="page/2/">2</a>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": ".", "features": ["navigation.path", "navigation.top"], "search": "assets/javascripts/workers/search.973d3a69.min.js", "tags": {"NFC": "nfc"}, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="js/open_in_new_tab.js"></script>
      
    
  </body>
</html>